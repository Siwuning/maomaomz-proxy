const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["index.js","index.css"])))=>i.map(i=>d[i]);
import{d as e,r as n,w as t,c as a,a as o,o as r,b as s,e as i,f as l,g as d,t as c,v as p,h as u,n as g,F as f,i as m,j as x,u as b,s as h,k as y,l as v,m as w,p as k,q as T,x as I,_ as S,y as A,z as C,A as E,B as M,C as P,D as O,E as j,G as R,H as N,I as D,J as L,K as H,L as V,M as U,N as J,O as F,P as B,Q as Y}from'./index.js';function Z(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,'default')?e.default:e}var G,W;const q=Z(W?G:(W=1,G=toastr));function X(e,n,t){function a(t,a){var o;Object.defineProperty(t,'_zod',{value:t._zod??{},enumerable:!1}),(o=t._zod).traits??(o.traits=new Set),t._zod.traits.add(e),n(t,a);for(const e in _.prototype)e in t||Object.defineProperty(t,e,{value:_.prototype[e].bind(t)});t._zod.constr=_,t._zod.def=a}const o=t?.Parent??Object;class r extends o{}function _(e){var n;const o=t?.Parent?new r:this;a(o,e),(n=o._zod).deferred??(n.deferred=[]);for(const t of o._zod.deferred)t();return o}return Object.defineProperty(r,'name',{value:e}),Object.defineProperty(_,'init',{value:a}),Object.defineProperty(_,Symbol.hasInstance,{value:n=>!!(t?.Parent&&n instanceof t.Parent)||n?._zod?.traits?.has(e)}),Object.defineProperty(_,'name',{value:e}),_}class K extends Error{constructor(){super('Encountered Promise during synchronous parse. Use .parseAsync() instead.')}}class Q extends Error{constructor(e){super(`Encountered unidirectional transform during encode: ${e}`),this.name='ZodEncodeError'}}const ee={};function ne(e){return ee}function te(_,e){return'bigint'==typeof e?e.toString():e}function ae(e){return{get value(){{const n=e();return Object.defineProperty(this,'value',{value:n}),n}}}}function oe(e){return null==e}function re(e){const n=e.startsWith('^')?1:0,t=e.endsWith('$')?e.length-1:e.length;return e.slice(n,t)}const se=Symbol('evaluating');function ie(e,n,t){let a;Object.defineProperty(e,n,{get(){if(a!==se)return void 0===a&&(a=se,a=t()),a},set(t){Object.defineProperty(e,n,{value:t})},configurable:!0})}function le(e,n,t){Object.defineProperty(e,n,{value:t,writable:!0,enumerable:!0,configurable:!0})}function de(...e){const n={};for(const t of e){const e=Object.getOwnPropertyDescriptors(t);Object.assign(n,e)}return Object.defineProperties({},n)}function ce(e){return JSON.stringify(e)}const pe='captureStackTrace'in Error?Error.captureStackTrace:(...e)=>{};function ue(e){return'object'==typeof e&&null!==e&&!Array.isArray(e)}const ge=ae(()=>{if('undefined'!=typeof navigator&&navigator?.userAgent?.includes('Cloudflare'))return!1;try{return new Function(''),!0}catch(_){return!1}});function fe(e){if(!1===ue(e))return!1;const n=e.constructor;if(void 0===n)return!0;const t=n.prototype;return!1!==ue(t)&&!1!==Object.prototype.hasOwnProperty.call(t,'isPrototypeOf')}function me(e){return fe(e)?{...e}:Array.isArray(e)?[...e]:e}const xe=new Set(['string','number','symbol']);function be(e){return e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}function he(e,n,t){const a=new e._zod.constr(n??e._zod.def);return n&&!t?.parent||(a._zod.parent=e),a}function ye(e){const n=e;if(!n)return{};if('string'==typeof n)return{error:()=>n};if(void 0!==n?.message){if(void 0!==n?.error)throw new Error('Cannot specify both `message` and `error` params');n.error=n.message}return delete n.message,'string'==typeof n.error?{...n,error:()=>n.error}:n}function ve(e,n=0){if(!0===e.aborted)return!0;for(let t=n;t<e.issues.length;t++)if(!0!==e.issues[t]?.continue)return!0;return!1}function we(e,n){return n.map(n=>{var t;return(t=n).path??(t.path=[]),n.path.unshift(e),n})}function ke(e){return'string'==typeof e?e:e?.message}function _e(e,n,t){const a={...e,path:e.path??[]};if(!e.message){const o=ke(e.inst?._zod.def?.error?.(e))??ke(n?.error?.(e))??ke(t.customError?.(e))??ke(t.localeError?.(e))??'Invalid input';a.message=o}return delete a.inst,delete a.continue,n?.reportInput||delete a.input,a}function Te(e){return Array.isArray(e)?'array':'string'==typeof e?'string':'unknown'}function ze(...e){const[n,t,a]=e;return'string'==typeof n?{message:n,code:'custom',input:t,inst:a}:{...n}}const Ie=(e,n)=>{e.name='$ZodError',Object.defineProperty(e,'_zod',{value:e._zod,enumerable:!1}),Object.defineProperty(e,'issues',{value:n,enumerable:!1}),e.message=JSON.stringify(n,te,2),Object.defineProperty(e,'toString',{value:()=>e.message,enumerable:!1})},Se=X('$ZodError',Ie),Ae=X('$ZodError',Ie,{Parent:Error});const $e=e=>(n,t,a,o)=>{const r=a?Object.assign(a,{async:!1}):{async:!1},s=n._zod.run({value:t,issues:[]},r);if(s instanceof Promise)throw new K;if(s.issues.length){const n=new(o?.Err??e)(s.issues.map(e=>_e(e,r,ne())));throw pe(n,o?.callee),n}return s.value},Ce=e=>async(n,t,a,o)=>{const r=a?Object.assign(a,{async:!0}):{async:!0};let s=n._zod.run({value:t,issues:[]},r);if(s instanceof Promise&&(s=await s),s.issues.length){const n=new(o?.Err??e)(s.issues.map(e=>_e(e,r,ne())));throw pe(n,o?.callee),n}return s.value},Ee=e=>(n,t,a)=>{const o=a?{...a,async:!1}:{async:!1},r=n._zod.run({value:t,issues:[]},o);if(r instanceof Promise)throw new K;return r.issues.length?{success:!1,error:new(e??Se)(r.issues.map(e=>_e(e,o,ne())))}:{success:!0,data:r.value}},Me=Ee(Ae),Pe=e=>async(n,t,a)=>{const o=a?Object.assign(a,{async:!0}):{async:!0};let r=n._zod.run({value:t,issues:[]},o);return r instanceof Promise&&(r=await r),r.issues.length?{success:!1,error:new e(r.issues.map(e=>_e(e,o,ne())))}:{success:!0,data:r.value}},Oe=Pe(Ae),je=e=>(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return $e(e)(n,t,o)},Re=e=>(n,t,a)=>$e(e)(n,t,a),Ne=e=>async(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Ce(e)(n,t,o)},De=e=>async(n,t,a)=>Ce(e)(n,t,a),Le=e=>(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Ee(e)(n,t,o)},He=e=>(n,t,a)=>Ee(e)(n,t,a),Ve=e=>async(n,t,a)=>{const o=a?Object.assign(a,{direction:'backward'}):{direction:'backward'};return Pe(e)(n,t,o)},Ue=e=>async(n,t,a)=>Pe(e)(n,t,a),Je=/^[cC][^\s-]{8,}$/,Fe=/^[0-9a-z]+$/,Be=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Ye=/^[0-9a-vA-V]{20}$/,Ze=/^[A-Za-z0-9]{27}$/,Ge=/^[a-zA-Z0-9_-]{21}$/,We=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,qe=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Xe=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,Ke=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/;const Qe=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,en=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,nn=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,tn=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,an=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,on=/^[A-Za-z0-9_-]*$/,rn=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,sn=/^\+(?:[0-9]){6,14}[0-9]$/,ln='(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))',dn=new RegExp(`^${ln}$`);function cn(e){const n='(?:[01]\\d|2[0-3]):[0-5]\\d';return'number'==typeof e.precision?-1===e.precision?`${n}`:0===e.precision?`${n}:[0-5]\\d`:`${n}:[0-5]\\d\\.\\d{${e.precision}}`:`${n}(?::[0-5]\\d(?:\\.\\d+)?)?`}const pn=/^[^A-Z]*$/,un=/^[^a-z]*$/,gn=X('$ZodCheck',(e,n)=>{var t;e._zod??(e._zod={}),e._zod.def=n,(t=e._zod).onattach??(t.onattach=[])}),fn=X('$ZodCheckMaxLength',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag.maximum??Number.POSITIVE_INFINITY;n.maximum<t&&(e._zod.bag.maximum=n.maximum)}),e._zod.check=t=>{const a=t.value;if(a.length<=n.maximum)return;const o=Te(a);t.issues.push({origin:o,code:'too_big',maximum:n.maximum,inclusive:!0,input:a,inst:e,continue:!n.abort})}}),mn=X('$ZodCheckMinLength',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;n.minimum>t&&(e._zod.bag.minimum=n.minimum)}),e._zod.check=t=>{const a=t.value;if(a.length>=n.minimum)return;const o=Te(a);t.issues.push({origin:o,code:'too_small',minimum:n.minimum,inclusive:!0,input:a,inst:e,continue:!n.abort})}}),xn=X('$ZodCheckLengthEquals',(e,n)=>{var t;gn.init(e,n),(t=e._zod.def).when??(t.when=e=>{const n=e.value;return!oe(n)&&void 0!==n.length}),e._zod.onattach.push(e=>{const t=e._zod.bag;t.minimum=n.length,t.maximum=n.length,t.length=n.length}),e._zod.check=t=>{const a=t.value,o=a.length;if(o===n.length)return;const r=Te(a),s=o>n.length;t.issues.push({origin:r,...s?{code:'too_big',maximum:n.length}:{code:'too_small',minimum:n.length},inclusive:!0,exact:!0,input:t.value,inst:e,continue:!n.abort})}}),bn=X('$ZodCheckStringFormat',(e,n)=>{var t,a;gn.init(e,n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.format=n.format,n.pattern&&(t.patterns??(t.patterns=new Set),t.patterns.add(n.pattern))}),n.pattern?(t=e._zod).check??(t.check=t=>{n.pattern.lastIndex=0,n.pattern.test(t.value)||t.issues.push({origin:'string',code:'invalid_format',format:n.format,input:t.value,...n.pattern?{pattern:n.pattern.toString()}:{},inst:e,continue:!n.abort})}):(a=e._zod).check??(a.check=()=>{})}),hn=X('$ZodCheckRegex',(e,n)=>{bn.init(e,n),e._zod.check=t=>{n.pattern.lastIndex=0,n.pattern.test(t.value)||t.issues.push({origin:'string',code:'invalid_format',format:'regex',input:t.value,pattern:n.pattern.toString(),inst:e,continue:!n.abort})}}),yn=X('$ZodCheckLowerCase',(e,n)=>{n.pattern??(n.pattern=pn),bn.init(e,n)}),vn=X('$ZodCheckUpperCase',(e,n)=>{n.pattern??(n.pattern=un),bn.init(e,n)}),wn=X('$ZodCheckIncludes',(e,n)=>{gn.init(e,n);const t=be(n.includes),a=new RegExp('number'==typeof n.position?`^.{${n.position}}${t}`:t);n.pattern=a,e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(a)}),e._zod.check=t=>{t.value.includes(n.includes,n.position)||t.issues.push({origin:'string',code:'invalid_format',format:'includes',includes:n.includes,input:t.value,inst:e,continue:!n.abort})}}),kn=X('$ZodCheckStartsWith',(e,n)=>{gn.init(e,n);const t=new RegExp(`^${be(n.prefix)}.*`);n.pattern??(n.pattern=t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(t)}),e._zod.check=t=>{t.value.startsWith(n.prefix)||t.issues.push({origin:'string',code:'invalid_format',format:'starts_with',prefix:n.prefix,input:t.value,inst:e,continue:!n.abort})}}),_n=X('$ZodCheckEndsWith',(e,n)=>{gn.init(e,n);const t=new RegExp(`.*${be(n.suffix)}$`);n.pattern??(n.pattern=t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.patterns??(n.patterns=new Set),n.patterns.add(t)}),e._zod.check=t=>{t.value.endsWith(n.suffix)||t.issues.push({origin:'string',code:'invalid_format',format:'ends_with',suffix:n.suffix,input:t.value,inst:e,continue:!n.abort})}}),Tn=X('$ZodCheckOverwrite',(e,n)=>{gn.init(e,n),e._zod.check=e=>{e.value=n.tx(e.value)}});class zn{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if('function'==typeof e)return e(this,{execution:'sync'}),void e(this,{execution:'async'});const n=e.split('\n').filter(e=>e),t=Math.min(...n.map(e=>e.length-e.trimStart().length)),a=n.map(e=>e.slice(t)).map(e=>' '.repeat(2*this.indent)+e);for(const o of a)this.content.push(o)}compile(){const e=Function,n=this?.args;return new e(...n,[...(this?.content??['']).map(e=>`  ${e}`)].join('\n'))}}const In={major:4,minor:1,patch:12},Sn=X('$ZodType',(e,n)=>{var t;e??(e={}),e._zod.def=n,e._zod.bag=e._zod.bag||{},e._zod.version=In;const a=[...e._zod.def.checks??[]];e._zod.traits.has('$ZodCheck')&&a.unshift(e);for(const o of a)for(const n of o._zod.onattach)n(e);if(0===a.length)(t=e._zod).deferred??(t.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const n=(e,n,t)=>{let a,o=ve(e);for(const r of n){if(r._zod.def.when){if(!r._zod.def.when(e))continue}else if(o)continue;const n=e.issues.length,_=r._zod.check(e);if(_ instanceof Promise&&!1===t?.async)throw new K;if(a||_ instanceof Promise)a=(a??Promise.resolve()).then(async()=>{await _;e.issues.length!==n&&(o||(o=ve(e,n)))});else{if(e.issues.length===n)continue;o||(o=ve(e,n))}}return a?a.then(()=>e):e},t=(t,o,r)=>{if(ve(t))return t.aborted=!0,t;const s=n(o,a,r);if(s instanceof Promise){if(!1===r.async)throw new K;return s.then(n=>e._zod.parse(n,r))}return e._zod.parse(s,r)};e._zod.run=(o,r)=>{if(r.skipChecks)return e._zod.parse(o,r);if('backward'===r.direction){const n=e._zod.parse({value:o.value,issues:[]},{...r,skipChecks:!0});return n instanceof Promise?n.then(e=>t(e,o,r)):t(n,o,r)}const s=e._zod.parse(o,r);if(s instanceof Promise){if(!1===r.async)throw new K;return s.then(e=>n(e,a,r))}return n(s,a,r)}}e['~standard']={validate:n=>{try{const t=Me(e,n);return t.success?{value:t.data}:{issues:t.error?.issues}}catch(_){return Oe(e,n).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:'zod',version:1}}),An=X('$ZodString',(e,n)=>{var t;Sn.init(e,n),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(t=e._zod.bag,new RegExp(`^${t?`[\\s\\S]{${t?.minimum??0},${t?.maximum??''}}`:'[\\s\\S]*'}$`)),e._zod.parse=(t,_)=>{if(n.coerce)try{t.value=String(t.value)}catch(_){}return'string'==typeof t.value||t.issues.push({expected:'string',code:'invalid_type',input:t.value,inst:e}),t}}),$n=X('$ZodStringFormat',(e,n)=>{bn.init(e,n),An.init(e,n)}),Cn=X('$ZodGUID',(e,n)=>{n.pattern??(n.pattern=qe),$n.init(e,n)}),En=X('$ZodUUID',(e,n)=>{if(n.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[n.version];if(void 0===e)throw new Error(`Invalid UUID version: "${n.version}"`);n.pattern??(n.pattern=Xe(e))}else n.pattern??(n.pattern=Xe());$n.init(e,n)}),Mn=X('$ZodEmail',(e,n)=>{n.pattern??(n.pattern=Ke),$n.init(e,n)}),Pn=X('$ZodURL',(e,n)=>{$n.init(e,n),e._zod.check=t=>{try{const a=t.value.trim(),o=new URL(a);return n.hostname&&(n.hostname.lastIndex=0,n.hostname.test(o.hostname)||t.issues.push({code:'invalid_format',format:'url',note:'Invalid hostname',pattern:rn.source,input:t.value,inst:e,continue:!n.abort})),n.protocol&&(n.protocol.lastIndex=0,n.protocol.test(o.protocol.endsWith(':')?o.protocol.slice(0,-1):o.protocol)||t.issues.push({code:'invalid_format',format:'url',note:'Invalid protocol',pattern:n.protocol.source,input:t.value,inst:e,continue:!n.abort})),void(n.normalize?t.value=o.href:t.value=a)}catch(_){t.issues.push({code:'invalid_format',format:'url',input:t.value,inst:e,continue:!n.abort})}}}),On=X('$ZodEmoji',(e,n)=>{n.pattern??(n.pattern=new RegExp('^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$','u')),$n.init(e,n)}),jn=X('$ZodNanoID',(e,n)=>{n.pattern??(n.pattern=Ge),$n.init(e,n)}),Rn=X('$ZodCUID',(e,n)=>{n.pattern??(n.pattern=Je),$n.init(e,n)}),Nn=X('$ZodCUID2',(e,n)=>{n.pattern??(n.pattern=Fe),$n.init(e,n)}),Dn=X('$ZodULID',(e,n)=>{n.pattern??(n.pattern=Be),$n.init(e,n)}),Ln=X('$ZodXID',(e,n)=>{n.pattern??(n.pattern=Ye),$n.init(e,n)}),Hn=X('$ZodKSUID',(e,n)=>{n.pattern??(n.pattern=Ze),$n.init(e,n)}),Vn=X('$ZodISODateTime',(e,n)=>{n.pattern??(n.pattern=function(e){const n=cn({precision:e.precision}),t=['Z'];e.local&&t.push(''),e.offset&&t.push('([+-](?:[01]\\d|2[0-3]):[0-5]\\d)');const a=`${n}(?:${t.join('|')})`;return new RegExp(`^${ln}T(?:${a})$`)}(n)),$n.init(e,n)}),Un=X('$ZodISODate',(e,n)=>{n.pattern??(n.pattern=dn),$n.init(e,n)}),Jn=X('$ZodISOTime',(e,n)=>{n.pattern??(n.pattern=new RegExp(`^${cn(n)}$`)),$n.init(e,n)}),Fn=X('$ZodISODuration',(e,n)=>{n.pattern??(n.pattern=We),$n.init(e,n)}),Bn=X('$ZodIPv4',(e,n)=>{n.pattern??(n.pattern=Qe),$n.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.format='ipv4'})}),Yn=X('$ZodIPv6',(e,n)=>{n.pattern??(n.pattern=en),$n.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.format='ipv6'}),e._zod.check=t=>{try{new URL(`http://[${t.value}]`)}catch{t.issues.push({code:'invalid_format',format:'ipv6',input:t.value,inst:e,continue:!n.abort})}}}),Zn=X('$ZodCIDRv4',(e,n)=>{n.pattern??(n.pattern=nn),$n.init(e,n)}),Gn=X('$ZodCIDRv6',(e,n)=>{n.pattern??(n.pattern=tn),$n.init(e,n),e._zod.check=t=>{const a=t.value.split('/');try{if(2!==a.length)throw new Error;const[e,n]=a;if(!n)throw new Error;const t=Number(n);if(`${t}`!==n)throw new Error;if(t<0||t>128)throw new Error;new URL(`http://[${e}]`)}catch{t.issues.push({code:'invalid_format',format:'cidrv6',input:t.value,inst:e,continue:!n.abort})}}});function Wn(e){if(''===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const qn=X('$ZodBase64',(e,n)=>{n.pattern??(n.pattern=an),$n.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding='base64'}),e._zod.check=t=>{Wn(t.value)||t.issues.push({code:'invalid_format',format:'base64',input:t.value,inst:e,continue:!n.abort})}});const Xn=X('$ZodBase64URL',(e,n)=>{n.pattern??(n.pattern=on),$n.init(e,n),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding='base64url'}),e._zod.check=t=>{(function(e){if(!on.test(e))return!1;const n=e.replace(/[-_]/g,e=>'-'===e?'+':'/');return Wn(n.padEnd(4*Math.ceil(n.length/4),'='))})(t.value)||t.issues.push({code:'invalid_format',format:'base64url',input:t.value,inst:e,continue:!n.abort})}}),Kn=X('$ZodE164',(e,n)=>{n.pattern??(n.pattern=sn),$n.init(e,n)});const Qn=X('$ZodJWT',(e,n)=>{$n.init(e,n),e._zod.check=t=>{(function(e,n=null){try{const t=e.split('.');if(3!==t.length)return!1;const[a]=t;if(!a)return!1;const o=JSON.parse(atob(a));return!('typ'in o&&'JWT'!==o?.typ||!o.alg||n&&(!('alg'in o)||o.alg!==n))}catch{return!1}})(t.value,n.alg)||t.issues.push({code:'invalid_format',format:'jwt',input:t.value,inst:e,continue:!n.abort})}}),et=X('$ZodUnknown',(e,n)=>{Sn.init(e,n),e._zod.parse=e=>e}),nt=X('$ZodNever',(e,n)=>{Sn.init(e,n),e._zod.parse=(n,t)=>(n.issues.push({expected:'never',code:'invalid_type',input:n.value,inst:e}),n)});function tt(e,n,t){e.issues.length&&n.issues.push(...we(t,e.issues)),n.value[t]=e.value}const at=X('$ZodArray',(e,n)=>{Sn.init(e,n),e._zod.parse=(t,a)=>{const o=t.value;if(!Array.isArray(o))return t.issues.push({expected:'array',code:'invalid_type',input:o,inst:e}),t;t.value=Array(o.length);const r=[];for(let e=0;e<o.length;e++){const s=o[e],i=n.element._zod.run({value:s,issues:[]},a);i instanceof Promise?r.push(i.then(n=>tt(n,t,e))):tt(i,t,e)}return r.length?Promise.all(r).then(()=>t):t}});function ot(e,n,t,a){e.issues.length&&n.issues.push(...we(t,e.issues)),void 0===e.value?t in a&&(n.value[t]=void 0):n.value[t]=e.value}function rt(e){const n=Object.keys(e.shape);for(const o of n)if(!e.shape?.[o]?._zod?.traits?.has('$ZodType'))throw new Error(`Invalid element at key "${o}": expected a Zod schema`);const t=(a=e.shape,Object.keys(a).filter(e=>'optional'===a[e]._zod.optin&&'optional'===a[e]._zod.optout));var a;return{...e,keys:n,keySet:new Set(n),numKeys:n.length,optionalKeys:new Set(t)}}function st(e,n,t,a,o,r){const s=[],i=o.keySet,l=o.catchall._zod,d=l.def.type;for(const c of Object.keys(n)){if(i.has(c))continue;if('never'===d){s.push(c);continue}const o=l.run({value:n[c],issues:[]},a);o instanceof Promise?e.push(o.then(e=>ot(e,t,c,n))):ot(o,t,c,n)}return s.length&&t.issues.push({code:'unrecognized_keys',keys:s,input:n,inst:r}),e.length?Promise.all(e).then(()=>t):t}const it=X('$ZodObject',(e,n)=>{Sn.init(e,n);const t=Object.getOwnPropertyDescriptor(n,'shape');if(!t?.get){const e=n.shape;Object.defineProperty(n,'shape',{get:()=>{const t={...e};return Object.defineProperty(n,'shape',{value:t}),t}})}const a=ae(()=>rt(n));ie(e._zod,'propValues',()=>{const e=n.shape,t={};for(const n in e){const a=e[n]._zod;if(a.values){t[n]??(t[n]=new Set);for(const e of a.values)t[n].add(e)}}return t});const o=ue,r=n.catchall;let s;e._zod.parse=(n,t)=>{s??(s=a.value);const i=n.value;if(!o(i))return n.issues.push({expected:'object',code:'invalid_type',input:i,inst:e}),n;n.value={};const l=[],d=s.shape;for(const e of s.keys){const a=d[e]._zod.run({value:i[e],issues:[]},t);a instanceof Promise?l.push(a.then(t=>ot(t,n,e,i))):ot(a,n,e,i)}return r?st(l,i,n,t,a.value,e):l.length?Promise.all(l).then(()=>n):n}}),lt=X('$ZodObjectJIT',(e,n)=>{it.init(e,n);const t=e._zod.parse,a=ae(()=>rt(n));let o;const r=ue,s=!ee.jitless,i=s&&ge.value,l=n.catchall;let d;e._zod.parse=(c,p)=>{d??(d=a.value);const u=c.value;return r(u)?s&&i&&!1===p?.async&&!0!==p.jitless?(o||(o=(e=>{const n=new zn(['shape','payload','ctx']),t=a.value,o=e=>{const n=ce(e);return`shape[${n}]._zod.run({ value: input[${n}], issues: [] }, ctx)`};n.write('const input = payload.value;');const r=Object.create(null);let s=0;for(const a of t.keys)r[a]='key_'+s++;n.write('const newResult = {};');for(const a of t.keys){const e=r[a],t=ce(a);n.write(`const ${e} = ${o(a)};`),n.write(`\n        if (${e}.issues.length) {\n          payload.issues = payload.issues.concat(${e}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${t}, ...iss.path] : [${t}]\n          })));\n        }\n        \n        \n        if (${e}.value === undefined) {\n          if (${t} in input) {\n            newResult[${t}] = undefined;\n          }\n        } else {\n          newResult[${t}] = ${e}.value;\n        }\n        \n      `)}n.write('payload.value = newResult;'),n.write('return payload;');const i=n.compile();return(n,t)=>i(e,n,t)})(n.shape)),c=o(c,p),l?st([],u,c,p,d,e):c):t(c,p):(c.issues.push({expected:'object',code:'invalid_type',input:u,inst:e}),c)}});function dt(e,n,t,a){for(const r of e)if(0===r.issues.length)return n.value=r.value,n;const o=e.filter(e=>!ve(e));return 1===o.length?(n.value=o[0].value,o[0]):(n.issues.push({code:'invalid_union',input:n.value,inst:t,errors:e.map(e=>e.issues.map(e=>_e(e,a,ne())))}),n)}const ct=X('$ZodUnion',(e,n)=>{Sn.init(e,n),ie(e._zod,'optin',()=>n.options.some(e=>'optional'===e._zod.optin)?'optional':void 0),ie(e._zod,'optout',()=>n.options.some(e=>'optional'===e._zod.optout)?'optional':void 0),ie(e._zod,'values',()=>{if(n.options.every(e=>e._zod.values))return new Set(n.options.flatMap(e=>Array.from(e._zod.values)))}),ie(e._zod,'pattern',()=>{if(n.options.every(e=>e._zod.pattern)){const e=n.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>re(e.source)).join('|')})$`)}});const t=1===n.options.length,a=n.options[0]._zod.run;e._zod.parse=(o,r)=>{if(t)return a(o,r);let s=!1;const i=[];for(const e of n.options){const n=e._zod.run({value:o.value,issues:[]},r);if(n instanceof Promise)i.push(n),s=!0;else{if(0===n.issues.length)return n;i.push(n)}}return s?Promise.all(i).then(n=>dt(n,o,e,r)):dt(i,o,e,r)}}),pt=X('$ZodIntersection',(e,n)=>{Sn.init(e,n),e._zod.parse=(e,t)=>{const a=e.value,o=n.left._zod.run({value:a,issues:[]},t),r=n.right._zod.run({value:a,issues:[]},t);return o instanceof Promise||r instanceof Promise?Promise.all([o,r]).then(([n,t])=>gt(e,n,t)):gt(e,o,r)}});function ut(e,n){if(e===n)return{valid:!0,data:e};if(e instanceof Date&&n instanceof Date&&+e===+n)return{valid:!0,data:e};if(fe(e)&&fe(n)){const t=Object.keys(n),a=Object.keys(e).filter(e=>-1!==t.indexOf(e)),o={...e,...n};for(const r of a){const t=ut(e[r],n[r]);if(!t.valid)return{valid:!1,mergeErrorPath:[r,...t.mergeErrorPath]};o[r]=t.data}return{valid:!0,data:o}}if(Array.isArray(e)&&Array.isArray(n)){if(e.length!==n.length)return{valid:!1,mergeErrorPath:[]};const t=[];for(let a=0;a<e.length;a++){const o=ut(e[a],n[a]);if(!o.valid)return{valid:!1,mergeErrorPath:[a,...o.mergeErrorPath]};t.push(o.data)}return{valid:!0,data:t}}return{valid:!1,mergeErrorPath:[]}}function gt(e,n,t){if(n.issues.length&&e.issues.push(...n.issues),t.issues.length&&e.issues.push(...t.issues),ve(e))return e;const a=ut(n.value,t.value);if(!a.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(a.mergeErrorPath)}`);return e.value=a.data,e}const ft=X('$ZodEnum',(e,n)=>{Sn.init(e,n);const t=function(e){const n=Object.values(e).filter(e=>'number'==typeof e);return Object.entries(e).filter(([e,_])=>-1===n.indexOf(+e)).map(([_,e])=>e)}(n.entries),a=new Set(t);e._zod.values=a,e._zod.pattern=new RegExp(`^(${t.filter(e=>xe.has(typeof e)).map(e=>'string'==typeof e?be(e):e.toString()).join('|')})$`),e._zod.parse=(n,o)=>{const r=n.value;return a.has(r)||n.issues.push({code:'invalid_value',values:t,input:r,inst:e}),n}}),mt=X('$ZodTransform',(e,n)=>{Sn.init(e,n),e._zod.parse=(t,a)=>{if('backward'===a.direction)throw new Q(e.constructor.name);const o=n.transform(t.value,t);if(a.async){return(o instanceof Promise?o:Promise.resolve(o)).then(e=>(t.value=e,t))}if(o instanceof Promise)throw new K;return t.value=o,t}});function xt(e,n){return e.issues.length&&void 0===n?{issues:[],value:void 0}:e}const bt=X('$ZodOptional',(e,n)=>{Sn.init(e,n),e._zod.optin='optional',e._zod.optout='optional',ie(e._zod,'values',()=>n.innerType._zod.values?new Set([...n.innerType._zod.values,void 0]):void 0),ie(e._zod,'pattern',()=>{const e=n.innerType._zod.pattern;return e?new RegExp(`^(${re(e.source)})?$`):void 0}),e._zod.parse=(e,t)=>{if('optional'===n.innerType._zod.optin){const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(n=>xt(n,e.value)):xt(a,e.value)}return void 0===e.value?e:n.innerType._zod.run(e,t)}}),ht=X('$ZodNullable',(e,n)=>{Sn.init(e,n),ie(e._zod,'optin',()=>n.innerType._zod.optin),ie(e._zod,'optout',()=>n.innerType._zod.optout),ie(e._zod,'pattern',()=>{const e=n.innerType._zod.pattern;return e?new RegExp(`^(${re(e.source)}|null)$`):void 0}),ie(e._zod,'values',()=>n.innerType._zod.values?new Set([...n.innerType._zod.values,null]):void 0),e._zod.parse=(e,t)=>null===e.value?e:n.innerType._zod.run(e,t)}),yt=X('$ZodDefault',(e,n)=>{Sn.init(e,n),e._zod.optin='optional',ie(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);if(void 0===e.value)return e.value=n.defaultValue,e;const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(e=>vt(e,n)):vt(a,n)}});function vt(e,n){return void 0===e.value&&(e.value=n.defaultValue),e}const wt=X('$ZodPrefault',(e,n)=>{Sn.init(e,n),e._zod.optin='optional',ie(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>('backward'===t.direction||void 0===e.value&&(e.value=n.defaultValue),n.innerType._zod.run(e,t))}),kt=X('$ZodNonOptional',(e,n)=>{Sn.init(e,n),ie(e._zod,'values',()=>{const e=n.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(t,a)=>{const o=n.innerType._zod.run(t,a);return o instanceof Promise?o.then(n=>_t(n,e)):_t(o,e)}});function _t(e,n){return e.issues.length||void 0!==e.value||e.issues.push({code:'invalid_type',expected:'nonoptional',input:e.value,inst:n}),e}const Tt=X('$ZodCatch',(e,n)=>{Sn.init(e,n),ie(e._zod,'optin',()=>n.innerType._zod.optin),ie(e._zod,'optout',()=>n.innerType._zod.optout),ie(e._zod,'values',()=>n.innerType._zod.values),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(a=>(e.value=a.value,a.issues.length&&(e.value=n.catchValue({...e,error:{issues:a.issues.map(e=>_e(e,t,ne()))},input:e.value}),e.issues=[]),e)):(e.value=a.value,a.issues.length&&(e.value=n.catchValue({...e,error:{issues:a.issues.map(e=>_e(e,t,ne()))},input:e.value}),e.issues=[]),e)}}),zt=X('$ZodPipe',(e,n)=>{Sn.init(e,n),ie(e._zod,'values',()=>n.in._zod.values),ie(e._zod,'optin',()=>n.in._zod.optin),ie(e._zod,'optout',()=>n.out._zod.optout),ie(e._zod,'propValues',()=>n.in._zod.propValues),e._zod.parse=(e,t)=>{if('backward'===t.direction){const a=n.out._zod.run(e,t);return a instanceof Promise?a.then(e=>It(e,n.in,t)):It(a,n.in,t)}const a=n.in._zod.run(e,t);return a instanceof Promise?a.then(e=>It(e,n.out,t)):It(a,n.out,t)}});function It(e,n,t){return e.issues.length?(e.aborted=!0,e):n._zod.run({value:e.value,issues:e.issues},t)}const St=X('$ZodReadonly',(e,n)=>{Sn.init(e,n),ie(e._zod,'propValues',()=>n.innerType._zod.propValues),ie(e._zod,'values',()=>n.innerType._zod.values),ie(e._zod,'optin',()=>n.innerType._zod.optin),ie(e._zod,'optout',()=>n.innerType._zod.optout),e._zod.parse=(e,t)=>{if('backward'===t.direction)return n.innerType._zod.run(e,t);const a=n.innerType._zod.run(e,t);return a instanceof Promise?a.then(At):At(a)}});function At(e){return e.value=Object.freeze(e.value),e}const $t=X('$ZodCustom',(e,n)=>{gn.init(e,n),Sn.init(e,n),e._zod.parse=(e,_)=>e,e._zod.check=t=>{const a=t.value,o=n.fn(a);if(o instanceof Promise)return o.then(n=>Ct(n,t,a,e));Ct(o,t,a,e)}});function Ct(e,n,t,a){if(!e){const e={code:'custom',input:t,inst:a,path:[...a._zod.def.path??[]],continue:!a._zod.def.abort};a._zod.def.params&&(e.params=a._zod.def.params),n.issues.push(ze(e))}}class Et{constructor(){this._map=new WeakMap,this._idmap=new Map}add(e,...n){const t=n[0];if(this._map.set(e,t),t&&'object'==typeof t&&'id'in t){if(this._idmap.has(t.id))throw new Error(`ID ${t.id} already exists in the registry`);this._idmap.set(t.id,e)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(e){const n=this._map.get(e);return n&&'object'==typeof n&&'id'in n&&this._idmap.delete(n.id),this._map.delete(e),this}get(e){const n=e._zod.parent;if(n){const t={...this.get(n)??{}};delete t.id;const a={...t,...this._map.get(e)};return Object.keys(a).length?a:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function Mt(){return new Et}const Pt=Mt();function Ot(e,n){return new e({type:'string',format:'guid',check:'string_format',abort:!1,...ye(n)})}function jt(e,n){return new fn({check:'max_length',...ye(n),maximum:e})}function Rt(e,n){return new mn({check:'min_length',...ye(n),minimum:e})}function Nt(e,n){return new xn({check:'length_equals',...ye(n),length:e})}function Dt(e){return new Tn({check:'overwrite',tx:e})}function Lt(e){const n=function(e,n){const t=new gn({check:'custom',...ye(n)});return t._zod.check=e,t}(t=>(t.addIssue=e=>{if('string'==typeof e)t.issues.push(ze(e,t.value,n._zod.def));else{const a=e;a.fatal&&(a.continue=!1),a.code??(a.code='custom'),a.input??(a.input=t.value),a.inst??(a.inst=n),a.continue??(a.continue=!n._zod.def.abort),t.issues.push(ze(a))}},e(t.value,t)));return n}const Ht=X('ZodISODateTime',(e,n)=>{Vn.init(e,n),pa.init(e,n)});function Vt(e){return function(e,n){return new e({type:'string',format:'datetime',check:'string_format',offset:!1,local:!1,precision:null,...ye(n)})}(Ht,e)}const Ut=X('ZodISODate',(e,n)=>{Un.init(e,n),pa.init(e,n)});function Jt(e){return function(e,n){return new e({type:'string',format:'date',check:'string_format',...ye(n)})}(Ut,e)}const Ft=X('ZodISOTime',(e,n)=>{Jn.init(e,n),pa.init(e,n)});function Bt(e){return function(e,n){return new e({type:'string',format:'time',check:'string_format',precision:null,...ye(n)})}(Ft,e)}const Yt=X('ZodISODuration',(e,n)=>{Fn.init(e,n),pa.init(e,n)});function Zt(e){return function(e,n){return new e({type:'string',format:'duration',check:'string_format',...ye(n)})}(Yt,e)}const Gt=X('ZodError',(e,n)=>{Se.init(e,n),e.name='ZodError',Object.defineProperties(e,{format:{value:n=>function(e,n=e=>e.message){const t={_errors:[]},a=e=>{for(const o of e.issues)if('invalid_union'===o.code&&o.errors.length)o.errors.map(e=>a({issues:e}));else if('invalid_key'===o.code)a({issues:o.issues});else if('invalid_element'===o.code)a({issues:o.issues});else if(0===o.path.length)t._errors.push(n(o));else{let e=t,a=0;for(;a<o.path.length;){const t=o.path[a];a===o.path.length-1?(e[t]=e[t]||{_errors:[]},e[t]._errors.push(n(o))):e[t]=e[t]||{_errors:[]},e=e[t],a++}}};return a(e),t}(e,n)},flatten:{value:n=>function(e,n=e=>e.message){const t={},a=[];for(const o of e.issues)o.path.length>0?(t[o.path[0]]=t[o.path[0]]||[],t[o.path[0]].push(n(o))):a.push(n(o));return{formErrors:a,fieldErrors:t}}(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,te,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,te,2)}},isEmpty:{get:()=>0===e.issues.length}})},{Parent:Error}),Wt=$e(Gt),qt=Ce(Gt),Xt=Ee(Gt),Kt=Pe(Gt),Qt=je(Gt),ea=Re(Gt),na=Ne(Gt),ta=De(Gt),aa=Le(Gt),oa=He(Gt),ra=Ve(Gt),sa=Ue(Gt),ia=X('ZodType',(e,n)=>(Sn.init(e,n),e.def=n,e.type=n.type,Object.defineProperty(e,'_def',{value:n}),e.check=(...t)=>e.clone(de(n,{checks:[...n.checks??[],...t.map(e=>'function'==typeof e?{_zod:{check:e,def:{check:'custom'},onattach:[]}}:e)]})),e.clone=(n,t)=>he(e,n,t),e.brand=()=>e,e.register=(n,t)=>(n.add(e,t),e),e.parse=(n,t)=>Wt(e,n,t,{callee:e.parse}),e.safeParse=(n,t)=>Xt(e,n,t),e.parseAsync=async(n,t)=>qt(e,n,t,{callee:e.parseAsync}),e.safeParseAsync=async(n,t)=>Kt(e,n,t),e.spa=e.safeParseAsync,e.encode=(n,t)=>Qt(e,n,t),e.decode=(n,t)=>ea(e,n,t),e.encodeAsync=async(n,t)=>na(e,n,t),e.decodeAsync=async(n,t)=>ta(e,n,t),e.safeEncode=(n,t)=>aa(e,n,t),e.safeDecode=(n,t)=>oa(e,n,t),e.safeEncodeAsync=async(n,t)=>ra(e,n,t),e.safeDecodeAsync=async(n,t)=>sa(e,n,t),e.refine=(n,t)=>e.check(function(e,n={}){return function(e,n,t){return new e({type:'custom',check:'custom',fn:n,...ye(t)})}(Qa,e,n)}(n,t)),e.superRefine=n=>e.check(Lt(n)),e.overwrite=n=>e.check(Dt(n)),e.optional=()=>Ja(e),e.nullable=()=>Ba(e),e.nullish=()=>Ja(Ba(e)),e.nonoptional=n=>function(e,n){return new Ga({type:'nonoptional',innerType:e,...ye(n)})}(e,n),e.array=()=>{return function(e,n,t){return new e({type:'array',element:n,...ye(t)})}(ja,e,n);var n},e.or=n=>{return new Da({type:'union',options:[e,n],...ye(t)});var t},e.and=n=>new La({type:'intersection',left:e,right:n}),e.transform=n=>Xa(e,new Va({type:'transform',transform:n})),e.default=n=>{return t=n,new Ya({type:'default',innerType:e,get defaultValue(){return'function'==typeof t?t():me(t)}});var t},e.prefault=n=>{return t=n,new Za({type:'prefault',innerType:e,get defaultValue(){return'function'==typeof t?t():me(t)}});var t},e.catch=n=>{return new Wa({type:'catch',innerType:e,catchValue:'function'==typeof(t=n)?t:()=>t});var t},e.pipe=n=>Xa(e,n),e.readonly=()=>new Ka({type:'readonly',innerType:e}),e.describe=n=>{const t=e.clone();return Pt.add(t,{description:n}),t},Object.defineProperty(e,'description',{get:()=>Pt.get(e)?.description,configurable:!0}),e.meta=(...n)=>{if(0===n.length)return Pt.get(e);const t=e.clone();return Pt.add(t,n[0]),t},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),la=X('_ZodString',(e,n)=>{An.init(e,n),ia.init(e,n);const t=e._zod.bag;e.format=t.format??null,e.minLength=t.minimum??null,e.maxLength=t.maximum??null,e.regex=(...n)=>e.check(function(e,n){return new hn({check:'string_format',format:'regex',...ye(n),pattern:e})}(...n)),e.includes=(...n)=>e.check(function(e,n){return new wn({check:'string_format',format:'includes',...ye(n),includes:e})}(...n)),e.startsWith=(...n)=>e.check(function(e,n){return new kn({check:'string_format',format:'starts_with',...ye(n),prefix:e})}(...n)),e.endsWith=(...n)=>e.check(function(e,n){return new _n({check:'string_format',format:'ends_with',...ye(n),suffix:e})}(...n)),e.min=(...n)=>e.check(Rt(...n)),e.max=(...n)=>e.check(jt(...n)),e.length=(...n)=>e.check(Nt(...n)),e.nonempty=(...n)=>e.check(Rt(1,...n)),e.lowercase=n=>e.check(function(e){return new yn({check:'string_format',format:'lowercase',...ye(e)})}(n)),e.uppercase=n=>e.check(function(e){return new vn({check:'string_format',format:'uppercase',...ye(e)})}(n)),e.trim=()=>e.check(Dt(e=>e.trim())),e.normalize=(...n)=>e.check(function(e){return Dt(n=>n.normalize(e))}(...n)),e.toLowerCase=()=>e.check(Dt(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(Dt(e=>e.toUpperCase()))}),da=X('ZodString',(e,n)=>{An.init(e,n),la.init(e,n),e.email=n=>e.check(function(e,n){return new e({type:'string',format:'email',check:'string_format',abort:!1,...ye(n)})}(ua,n)),e.url=n=>e.check(function(e,n){return new e({type:'string',format:'url',check:'string_format',abort:!1,...ye(n)})}(ma,n)),e.jwt=n=>e.check(function(e,n){return new e({type:'string',format:'jwt',check:'string_format',abort:!1,...ye(n)})}(Ca,n)),e.emoji=n=>e.check(function(e,n){return new e({type:'string',format:'emoji',check:'string_format',abort:!1,...ye(n)})}(xa,n)),e.guid=n=>e.check(Ot(ga,n)),e.uuid=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,...ye(n)})}(fa,n)),e.uuidv4=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v4',...ye(n)})}(fa,n)),e.uuidv6=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v6',...ye(n)})}(fa,n)),e.uuidv7=n=>e.check(function(e,n){return new e({type:'string',format:'uuid',check:'string_format',abort:!1,version:'v7',...ye(n)})}(fa,n)),e.nanoid=n=>e.check(function(e,n){return new e({type:'string',format:'nanoid',check:'string_format',abort:!1,...ye(n)})}(ba,n)),e.guid=n=>e.check(Ot(ga,n)),e.cuid=n=>e.check(function(e,n){return new e({type:'string',format:'cuid',check:'string_format',abort:!1,...ye(n)})}(ha,n)),e.cuid2=n=>e.check(function(e,n){return new e({type:'string',format:'cuid2',check:'string_format',abort:!1,...ye(n)})}(ya,n)),e.ulid=n=>e.check(function(e,n){return new e({type:'string',format:'ulid',check:'string_format',abort:!1,...ye(n)})}(va,n)),e.base64=n=>e.check(function(e,n){return new e({type:'string',format:'base64',check:'string_format',abort:!1,...ye(n)})}(Sa,n)),e.base64url=n=>e.check(function(e,n){return new e({type:'string',format:'base64url',check:'string_format',abort:!1,...ye(n)})}(Aa,n)),e.xid=n=>e.check(function(e,n){return new e({type:'string',format:'xid',check:'string_format',abort:!1,...ye(n)})}(wa,n)),e.ksuid=n=>e.check(function(e,n){return new e({type:'string',format:'ksuid',check:'string_format',abort:!1,...ye(n)})}(ka,n)),e.ipv4=n=>e.check(function(e,n){return new e({type:'string',format:'ipv4',check:'string_format',abort:!1,...ye(n)})}(_a,n)),e.ipv6=n=>e.check(function(e,n){return new e({type:'string',format:'ipv6',check:'string_format',abort:!1,...ye(n)})}(Ta,n)),e.cidrv4=n=>e.check(function(e,n){return new e({type:'string',format:'cidrv4',check:'string_format',abort:!1,...ye(n)})}(za,n)),e.cidrv6=n=>e.check(function(e,n){return new e({type:'string',format:'cidrv6',check:'string_format',abort:!1,...ye(n)})}(Ia,n)),e.e164=n=>e.check(function(e,n){return new e({type:'string',format:'e164',check:'string_format',abort:!1,...ye(n)})}($a,n)),e.datetime=n=>e.check(Vt(n)),e.date=n=>e.check(Jt(n)),e.time=n=>e.check(Bt(n)),e.duration=n=>e.check(Zt(n))});function ca(e){return function(e,n){return new e({type:'string',...ye(n)})}(da,e)}const pa=X('ZodStringFormat',(e,n)=>{$n.init(e,n),la.init(e,n)}),ua=X('ZodEmail',(e,n)=>{Mn.init(e,n),pa.init(e,n)}),ga=X('ZodGUID',(e,n)=>{Cn.init(e,n),pa.init(e,n)}),fa=X('ZodUUID',(e,n)=>{En.init(e,n),pa.init(e,n)}),ma=X('ZodURL',(e,n)=>{Pn.init(e,n),pa.init(e,n)}),xa=X('ZodEmoji',(e,n)=>{On.init(e,n),pa.init(e,n)}),ba=X('ZodNanoID',(e,n)=>{jn.init(e,n),pa.init(e,n)}),ha=X('ZodCUID',(e,n)=>{Rn.init(e,n),pa.init(e,n)}),ya=X('ZodCUID2',(e,n)=>{Nn.init(e,n),pa.init(e,n)}),va=X('ZodULID',(e,n)=>{Dn.init(e,n),pa.init(e,n)}),wa=X('ZodXID',(e,n)=>{Ln.init(e,n),pa.init(e,n)}),ka=X('ZodKSUID',(e,n)=>{Hn.init(e,n),pa.init(e,n)}),_a=X('ZodIPv4',(e,n)=>{Bn.init(e,n),pa.init(e,n)}),Ta=X('ZodIPv6',(e,n)=>{Yn.init(e,n),pa.init(e,n)}),za=X('ZodCIDRv4',(e,n)=>{Zn.init(e,n),pa.init(e,n)}),Ia=X('ZodCIDRv6',(e,n)=>{Gn.init(e,n),pa.init(e,n)}),Sa=X('ZodBase64',(e,n)=>{qn.init(e,n),pa.init(e,n)}),Aa=X('ZodBase64URL',(e,n)=>{Xn.init(e,n),pa.init(e,n)}),$a=X('ZodE164',(e,n)=>{Kn.init(e,n),pa.init(e,n)}),Ca=X('ZodJWT',(e,n)=>{Qn.init(e,n),pa.init(e,n)}),Ea=X('ZodUnknown',(e,n)=>{et.init(e,n),ia.init(e,n)});function Ma(){return new Ea({type:'unknown'})}const Pa=X('ZodNever',(e,n)=>{nt.init(e,n),ia.init(e,n)});function Oa(e){return function(e,n){return new e({type:'never',...ye(n)})}(Pa,e)}const ja=X('ZodArray',(e,n)=>{at.init(e,n),ia.init(e,n),e.element=n.element,e.min=(n,t)=>e.check(Rt(n,t)),e.nonempty=n=>e.check(Rt(1,n)),e.max=(n,t)=>e.check(jt(n,t)),e.length=(n,t)=>e.check(Nt(n,t)),e.unwrap=()=>e.element});const Ra=X('ZodObject',(e,n)=>{lt.init(e,n),ia.init(e,n),ie(e,'shape',()=>n.shape),e.keyof=()=>function(e,n){const t=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new Ha({type:'enum',entries:t,...ye(n)})}(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:Ma()}),e.loose=()=>e.clone({...e._zod.def,catchall:Ma()}),e.strict=()=>e.clone({...e._zod.def,catchall:Oa()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>function(e,n){if(!fe(n))throw new Error('Invalid input to extend: expected a plain object');const t=e._zod.def.checks;if(t&&t.length>0)throw new Error('Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.');const a=de(e._zod.def,{get shape(){const t={...e._zod.def.shape,...n};return le(this,'shape',t),t},checks:[]});return he(e,a)}(e,n),e.safeExtend=n=>function(e,n){if(!fe(n))throw new Error('Invalid input to safeExtend: expected a plain object');const t={...e._zod.def,get shape(){const t={...e._zod.def.shape,...n};return le(this,'shape',t),t},checks:e._zod.def.checks};return he(e,t)}(e,n),e.merge=n=>function(e,n){const t=de(e._zod.def,{get shape(){const t={...e._zod.def.shape,...n._zod.def.shape};return le(this,'shape',t),t},get catchall(){return n._zod.def.catchall},checks:[]});return he(e,t)}(e,n),e.pick=n=>function(e,n){const t=e._zod.def;return he(e,de(e._zod.def,{get shape(){const e={};for(const a in n){if(!(a in t.shape))throw new Error(`Unrecognized key: "${a}"`);n[a]&&(e[a]=t.shape[a])}return le(this,'shape',e),e},checks:[]}))}(e,n),e.omit=n=>function(e,n){const t=e._zod.def,a=de(e._zod.def,{get shape(){const a={...e._zod.def.shape};for(const e in n){if(!(e in t.shape))throw new Error(`Unrecognized key: "${e}"`);n[e]&&delete a[e]}return le(this,'shape',a),a},checks:[]});return he(e,a)}(e,n),e.partial=(...n)=>function(e,n,t){const a=de(n._zod.def,{get shape(){const a=n._zod.def.shape,o={...a};if(t)for(const n in t){if(!(n in a))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(o[n]=e?new e({type:'optional',innerType:a[n]}):a[n])}else for(const n in a)o[n]=e?new e({type:'optional',innerType:a[n]}):a[n];return le(this,'shape',o),o},checks:[]});return he(n,a)}(Ua,e,n[0]),e.required=(...n)=>function(e,n,t){const a=de(n._zod.def,{get shape(){const a=n._zod.def.shape,o={...a};if(t)for(const n in t){if(!(n in o))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(o[n]=new e({type:'nonoptional',innerType:a[n]}))}else for(const n in a)o[n]=new e({type:'nonoptional',innerType:a[n]});return le(this,'shape',o),o},checks:[]});return he(n,a)}(Ga,e,n[0])});function Na(e,n){const t={type:'object',shape:e??{},...ye(n)};return new Ra(t)}const Da=X('ZodUnion',(e,n)=>{ct.init(e,n),ia.init(e,n),e.options=n.options});const La=X('ZodIntersection',(e,n)=>{pt.init(e,n),ia.init(e,n)});const Ha=X('ZodEnum',(e,n)=>{ft.init(e,n),ia.init(e,n),e.enum=n.entries,e.options=Object.values(n.entries);const t=new Set(Object.keys(n.entries));e.extract=(e,a)=>{const o={};for(const r of e){if(!t.has(r))throw new Error(`Key ${r} not found in enum`);o[r]=n.entries[r]}return new Ha({...n,checks:[],...ye(a),entries:o})},e.exclude=(e,a)=>{const o={...n.entries};for(const n of e){if(!t.has(n))throw new Error(`Key ${n} not found in enum`);delete o[n]}return new Ha({...n,checks:[],...ye(a),entries:o})}});const Va=X('ZodTransform',(e,n)=>{mt.init(e,n),ia.init(e,n),e._zod.parse=(t,a)=>{if('backward'===a.direction)throw new Q(e.constructor.name);t.addIssue=a=>{if('string'==typeof a)t.issues.push(ze(a,t.value,n));else{const n=a;n.fatal&&(n.continue=!1),n.code??(n.code='custom'),n.input??(n.input=t.value),n.inst??(n.inst=e),t.issues.push(ze(n))}};const o=n.transform(t.value,t);return o instanceof Promise?o.then(e=>(t.value=e,t)):(t.value=o,t)}});const Ua=X('ZodOptional',(e,n)=>{bt.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType});function Ja(e){return new Ua({type:'optional',innerType:e})}const Fa=X('ZodNullable',(e,n)=>{ht.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType});function Ba(e){return new Fa({type:'nullable',innerType:e})}const Ya=X('ZodDefault',(e,n)=>{yt.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});const Za=X('ZodPrefault',(e,n)=>{wt.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Ga=X('ZodNonOptional',(e,n)=>{kt.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Wa=X('ZodCatch',(e,n)=>{Tt.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});const qa=X('ZodPipe',(e,n)=>{zt.init(e,n),ia.init(e,n),e.in=n.in,e.out=n.out});function Xa(e,n){return new qa({type:'pipe',in:e,out:n})}const Ka=X('ZodReadonly',(e,n)=>{St.init(e,n),ia.init(e,n),e.unwrap=()=>e._zod.def.innerType});const Qa=X('ZodCustom',(e,n)=>{$t.init(e,n),ia.init(e,n)});const eo={style:{color:'#667eea',margin:'0 0 15px 0'}},no={style:{color:'#888',margin:'0 0 25px 0','line-height':'1.6'}},to=['placeholder'],ao={key:1,style:{'margin-bottom':'25px'}},oo={key:0,style:{'margin-top':'20px',padding:'15px',background:'#1a1a1a','border-radius':'8px',border:'1px solid #444'}},ro={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'10px'}},so={style:{color:'#667eea','font-size':'13px','font-weight':'600'}},io={style:{color:'#e0e0e0','font-size':'14px','font-weight':'700'}},lo={style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden','margin-bottom':'10px'}},co={style:{display:'flex','justify-content':'space-between','align-items':'center'}},po={style:{color:'#888','font-size':'12px'}},uo={key:0,style:{color:'#888','font-size':'12px'}},go={style:{display:'flex',gap:'12px'}},fo=['disabled'],mo=['disabled'],xo=(e,n)=>{const t=e.__vccOpts||e;for(const[a,o]of n)t[a]=o;return t},bo=xo(e({__name:'AIGenerateDialog',props:{show:{type:Boolean},title:{},description:{},placeholder:{},isGenerating:{type:Boolean},showInput:{type:Boolean},progress:{}},emits:['close','confirm'],setup(e,{emit:f}){const m=e,x=f,b=n('');t(()=>m.show,e=>{e&&(b.value='')});const h=()=>{m.isGenerating||(m.showInput?x('confirm',b.value):x('confirm'))},y=()=>{m.isGenerating||x('close')};return(n,t)=>e.show?(r(),a('div',{key:0,onClick:s(y,['self']),style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'}},[i('div',{style:{background:'#2a2a2a',border:'2px solid #667eea','border-radius':'12px',padding:'30px','max-width':'500px',width:'100%','text-align':'center'},onClick:t[1]||(t[1]=s(()=>{},['stop']))},[i('h3',eo,[t[2]||(t[2]=i('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(e.title||'AI 生成'),1)]),i('p',no,c(e.description||'AI 正在为你生成内容...'),1),e.showInput?l((r(),a('textarea',{key:0,'onUpdate:modelValue':t[0]||(t[0]=e=>b.value=e),placeholder:e.placeholder||'输入你的需求...',style:{width:'100%','min-height':'120px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical','box-sizing':'border-box'}},null,8,to)),[[p,b.value]]):o('',!0),e.isGenerating?(r(),a('div',ao,[t[3]||(t[3]=u('<div style="position:relative;display:inline-block;width:80px;height:80px;" data-v-9c81d390><div style="position:absolute;width:100%;height:100%;border:3px solid rgba(102, 126, 234, 0.1);border-radius:50%;" data-v-9c81d390></div><div style="position:absolute;width:100%;height:100%;border:4px solid transparent;border-top-color:#667eea;border-right-color:#764ba2;border-radius:50%;animation:spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;" data-v-9c81d390></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:40%;height:40%;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:50%;animation:pulse 1.5s ease-in-out infinite;" data-v-9c81d390></div></div><p style="color:#888;margin-top:20px;font-size:14px;font-weight:500;" data-v-9c81d390><span style="background:linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:gradient-shift 2s linear infinite;" data-v-9c81d390> 正在生成中，请稍候... </span></p><div style="display:flex;justify-content:center;gap:8px;margin-top:10px;" data-v-9c81d390><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0s infinite;" data-v-9c81d390></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0.2s infinite;" data-v-9c81d390></div><div style="width:8px;height:8px;background:#667eea;border-radius:50%;animation:bounce 1.4s ease-in-out 0.4s infinite;" data-v-9c81d390></div></div>',3)),e.progress?(r(),a('div',oo,[i('div',ro,[i('span',so,' 步骤 '+c(e.progress.step)+'/'+c(e.progress.total)+': '+c(e.progress.stepName),1),i('span',io,c(e.progress.percentage)+'% ',1)]),i('div',lo,[i('div',{style:g([{height:'100%',background:'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',transition:'width 0.4s ease','box-shadow':'0 0 10px rgba(102, 126, 234, 0.5)'},{width:e.progress.percentage+'%'}])},null,4)]),i('div',co,[i('span',po,c(e.progress.message),1),e.progress.elapsedTime?(r(),a('span',uo,' 已耗时: '+c(e.progress.elapsedTime)+'秒 ',1)):o('',!0)])])):o('',!0)])):o('',!0),i('div',go,[e.isGenerating?o('',!0):(r(),a('button',{key:0,onClick:h,disabled:e.showInput&&!b.value,style:g([{flex:'1',background:'#667eea',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:e.showInput&&!b.value?.5:1}])},[...t[4]||(t[4]=[i('i',{class:'fa-solid fa-check'},null,-1),d(' 确认生成 ',-1)])],12,fo)),i('button',{onClick:y,disabled:e.isGenerating,style:g([{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:e.isGenerating?.5:1}])},c(e.isGenerating?'生成中...':'取消'),13,mo)])])])):o('',!0)}}),[['__scopeId','data-v-9c81d390']]),ho={style:{color:'#ffc107',margin:'0 0 20px 0'}},yo={style:{color:'#888',margin:'0 0 15px 0','line-height':'1.6'}},vo={key:0,style:{color:'#888',margin:'0 0 20px 0','padding-left':'20px','line-height':'1.8'}},wo=['placeholder'],ko={key:1,style:{'margin-bottom':'20px',background:'#1a1a1a','border-radius':'8px',padding:'15px',border:'1px solid #444'}},_o={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'8px'}},To={style:{color:'#ffc107','font-size':'13px','font-weight':'600'}},zo={style:{color:'#e0e0e0','font-size':'14px','font-weight':'700'}},Io={style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden','margin-bottom':'8px'}},So={style:{display:'flex','justify-content':'space-between','align-items':'center'}},Ao={style:{color:'#888','font-size':'12px'}},$o={key:0,style:{color:'#888','font-size':'12px'}},Co={style:{display:'flex',gap:'12px'}},Eo=['disabled'],Mo=['disabled'],Po=xo(e({__name:'AIModifyDialog',props:{show:{type:Boolean},title:{},description:{},examples:{},placeholder:{},isModifying:{type:Boolean},progress:{}},emits:['close','confirm'],setup(e,{emit:u}){const b=e,h=u,y=n('');t(()=>b.show,e=>{e&&(y.value='')});const v=()=>{y.value&&!b.isModifying&&h('confirm',y.value)};return(n,t)=>e.show?(r(),a('div',{key:0,onClick:t[3]||(t[3]=s(e=>n.$emit('close'),['self'])),style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'}},[i('div',{style:{background:'#2a2a2a',border:'2px solid #ffc107','border-radius':'12px',padding:'30px','max-width':'600px',width:'100%','max-height':'80vh','overflow-y':'auto'},onClick:t[2]||(t[2]=s(()=>{},['stop']))},[i('h3',ho,[t[4]||(t[4]=i('i',{class:'fa-solid fa-edit'},null,-1)),d(' '+c(e.title||'AI 修改'),1)]),i('p',yo,c(e.description||'描述你想要修改的地方，AI 会在当前基础上进行调整。'),1),e.examples&&e.examples.length>0?(r(),a('ul',vo,[(r(!0),a(f,null,m(e.examples,(e,n)=>(r(),a('li',{key:n},c(e),1))),128))])):o('',!0),l(i('textarea',{'onUpdate:modelValue':t[0]||(t[0]=e=>y.value=e),placeholder:e.placeholder||'输入修改建议...',style:{width:'100%','min-height':'150px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical','box-sizing':'border-box'}},null,8,wo),[[p,y.value]]),e.isModifying?(r(),a('div',ko,[t[7]||(t[7]=i('div',{style:{display:'flex','align-items':'center',gap:'12px','margin-bottom':'10px'}},[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{color:'#ffc107','font-size':'18px',animation:'pulse 1.5s infinite'}}),i('span',{style:{color:'#ffc107','font-weight':'600','font-size':'14px'}},'AI 正在生成中...')],-1)),e.progress?(r(),a(f,{key:0},[i('div',_o,[i('span',To,' 步骤 '+c(e.progress.step)+'/'+c(e.progress.total)+': '+c(e.progress.stepName),1),i('span',zo,c(e.progress.percentage)+'% ',1)]),i('div',Io,[i('div',{style:g([{height:'100%',background:'linear-gradient(90deg, #ffc107 0%, #ffb300 100%)',transition:'width 0.4s ease','box-shadow':'0 0 10px rgba(255, 193, 7, 0.5)'},{width:e.progress.percentage+'%'}])},null,4)]),i('div',So,[i('span',Ao,c(e.progress.message),1),e.progress.elapsedTime?(r(),a('span',$o,' 已耗时: '+c(e.progress.elapsedTime)+'秒 ',1)):o('',!0)])],64)):(r(),a(f,{key:1},[t[5]||(t[5]=i('div',{style:{width:'100%',height:'6px',background:'#333','border-radius':'3px',overflow:'hidden',position:'relative'}},[i('div',{class:'progress-bar'})],-1)),t[6]||(t[6]=i('p',{style:{color:'#888','font-size':'12px',margin:'8px 0 0 0','text-align':'center'}},'请稍候，这可能需要几秒钟',-1))],64))])):o('',!0),i('div',Co,[i('button',{onClick:v,disabled:!y.value||e.isModifying,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s',position:'relative',overflow:'hidden'},{opacity:!y.value||e.isModifying?.5:1}])},[i('i',{class:x(['fa-solid fa-wand-magic-sparkles',{'icon-spin':e.isModifying}])},null,2),d(' '+c(e.isModifying?'生成中...':'确认生成'),1)],12,Eo),i('button',{onClick:t[1]||(t[1]=e=>n.$emit('close')),disabled:e.isModifying,style:g([{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'10px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},{opacity:e.isModifying?.5:1}])},' 取消 ',12,Mo)])])])):o('',!0)}}),[['__scopeId','data-v-386271e6']]),Oo={class:'greetings-tab',style:{display:'flex','flex-direction':'column',height:'100%',background:'#1a1a1a !important'}},jo={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a'}},Ro={class:'header-actions',style:{display:'flex','align-items':'center',gap:'10px'}},No={key:0,class:'count-badge',style:{background:'#667eea',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},Do={style:{flex:'1',display:'flex',gap:'20px',padding:'20px',overflow:'hidden'}},Lo={style:{flex:'1','overflow-y':'auto','padding-right':'10px'}},Ho={key:0,style:{display:'flex','flex-direction':'column','align-items':'center','justify-content':'center',padding:'60px 20px','text-align':'center',color:'#888'}},Vo={key:1,style:{background:'#2a2a2a',border:'1px solid #667eea','border-radius':'8px',padding:'20px','margin-bottom':'20px'}},Uo={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'15px'}},Jo={key:2,style:{display:'flex','flex-direction':'column',gap:'15px'}},Fo={style:{display:'flex','align-items':'center',gap:'10px','margin-bottom':'12px','padding-bottom':'10px','border-bottom':'1px solid #3a3a3a'}},Bo={style:{background:'#667eea',color:'white',padding:'4px 10px','border-radius':'6px','font-size':'12px','font-weight':'bold','min-width':'35px','text-align':'center'}},Yo=['onUpdate:modelValue'],Zo=['onUpdate:modelValue','placeholder'],Go=['onClick'],Wo=['onClick'],qo=['onUpdate:modelValue'],Xo=['onClick'],Ko={key:3,style:{position:'sticky',bottom:'0',padding:'20px',background:'linear-gradient(to top, #1a1a1a 80%, transparent)','border-top':'1px solid #3a3a3a',display:'flex','justify-content':'center',gap:'15px','margin-top':'20px'}},Qo={style:{flex:'1',display:'flex','flex-direction':'column',background:'#2a2a2a','border-radius':'16px',overflow:'hidden',border:'1px solid #3a3a3a','box-shadow':'0 4px 12px rgba(0, 0, 0, 0.3)'}},er={style:{padding:'15px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},nr={style:{flex:'1',position:'relative',overflow:'hidden',background:'#1e1e1e'}},tr=['srcdoc'],ar={key:1,style:{width:'100%',height:'100%',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px',padding:'20px','text-align':'center','line-height':'1.8'}},or={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'16px'}},rr={style:{background:'#1a1a1a','border-radius':'8px',padding:'16px',color:'#e0e0e0','font-size':'14px','line-height':'1.6','overflow-y':'auto',flex:'1','white-space':'pre-wrap','word-wrap':'break-word'}},sr={style:{display:'flex','justify-content':'flex-end','margin-top':'16px'}},ir={style:{padding:'20px','overflow-y':'auto',flex:'1'}},lr={style:{background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px','max-height':'400px','overflow-y':'auto','margin-bottom':'15px'}},dr={style:{margin:'0','white-space':'pre-wrap','word-wrap':'break-word'}},cr={style:{color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.6'}},pr=xo(e({__name:'GreetingsTab',setup(e){const t=Na({icon:ca().default(''),title:ca().default(''),description:ca().default('')}),x=Na({customHtml:ca().default('')}),C=b(),{settings:E}=h(C),M=y(),P=n([]),O=n(x.parse({})),j=n(!1),R=n(''),N=n('复制代码'),D=n(!1),L=n(!1),H=n(!1),V=n(!1),U=n(-1),J=n(!1),F=n(''),B=n(null),Y=n(!1),Z=n(''),G=n(!1),W=n(!1),X=n({step:0,total:4,stepName:'',percentage:0,message:'',startTime:0});let K=null;function Q(e,n,t){X.value.step=e,X.value.stepName=n,X.value.message=t,X.value.percentage=Math.round(e/X.value.total*100),console.log(`📊 [进度 ${X.value.percentage}%] ${n}: ${t}`)}function ee(){K&&clearInterval(K),X.value.startTime=Date.now(),K=setInterval(()=>{Math.round((Date.now()-X.value.startTime)/1e3),X.value={...X.value}},1e3)}function ne(){K&&(clearInterval(K),K=null)}const te=v(()=>{const e=Math.round((Date.now()-X.value.startTime)/1e3);return{...X.value,elapsedTime:e}});function ae(){try{if(void 0!==window.TavernHelper){const e=window.TavernHelper.getCharData('current');if(e)return console.log('找到角色卡 (TavernHelper):',e.name),e}if('undefined'!=typeof SillyTavern){const e=SillyTavern.getContext?.()?.characters?.[0];if(e)return console.log('找到角色卡 (SillyTavern):',e.name),e}return console.log('未找到角色卡'),null}catch(e){return console.error('获取角色卡失败:',e),null}}async function oe(){try{const a=ae();if(!a)return P.value=[],void console.log('未找到角色卡');console.log('当前角色卡:',a.name);const o=[a.first_mes,...a.data?.alternate_greetings||[]];console.log('找到',o.length,'个开场白');const r=`${T()}_greetings_${a.avatar}`;let s=[],i=null;const l=localStorage.getItem(r);if(l)try{const e=JSON.parse(l);s=e?.greetings_config||[],i=e?.ui_config,console.log('✅ 从 localStorage 加载开场白配置')}catch(e){console.error('解析开场白配置失败:',e)}P.value=o.map((_,e)=>{const n=s[e];try{return t.parse(n||{})}catch(a){return console.warn('解析开场白配置失败，使用默认值:',a),t.parse({})}});try{const e=i||{};O.value=x.parse(e)}catch(n){console.warn('解析UI配置失败，使用默认值:',n),O.value=x.parse({})}console.log('开场白配置已加载:',P.value.length,'个'),console.log('UI配置已加载, 自定义HTML长度:',O.value.customHtml.length),B.value=a,ue()}catch(n){console.error('加载配置失败:',n),q.error('加载配置失败: '+n.message)}}function re(){try{const e=ae();if(!e)return void console.warn('无法保存：未找到角色卡');const n=`${T()}_greetings_${e.avatar}`,t={greetings_config:I(P.value),ui_config:I(O.value)};localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 已保存开场白配置到 localStorage'),ue()}catch(e){console.error('保存配置失败:',e)}}function se(){if(confirm(`确定要清空所有开场白的配置吗？\n\n当前共有 ${P.value.length} 个开场白，清空后所有图标、标题、描述都将恢复默认。\n\n⚠️ 此操作不会删除角色卡的开场白原文，只清空显示配置！`))try{P.value=P.value.map(()=>t.parse({icon:'',title:'',description:''})),O.value.customHtml='',re(),ue(),q.success('已清空所有开场白配置，预览已恢复默认样式')}catch(e){console.error('清空配置失败:',e),q.error('清空失败: '+e.message)}}function ie(){H.value||(D.value=!1)}async function le(e){const n=U.value;if(n<0||n>=P.value.length)return;const t=M.createTask('ui_modify',`编辑开场白#${n}描述`);X.value.startTime=Date.now(),X.value.total=4,Q(0,'准备中','正在初始化 AI 编辑任务...'),ee(),V.value=!0;try{if(Q(1,'检查配置','正在验证 API 配置和权限...'),M.updateTaskProgress(t,10,'检查配置'),!E.value.api_endpoint||!E.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),L.value=!1,V.value=!1,ne(),void M.failTask(t,'API 未配置');Q(2,'读取数据','正在读取当前描述内容...'),M.updateTaskProgress(t,30,'读取当前描述');const a=P.value[n].description;if(!a.trim())return q.warning('当前描述为空，请先使用 AI 生成'),L.value=!1,V.value=!1,ne(),void M.failTask(t,'当前描述为空');Q(3,'调用 AI',`正在请求 ${E.value.model} 编辑描述...`),M.updateTaskProgress(t,50,`调用 AI (${E.value.model})`);const o='你是一个专业的文案编辑助手，擅长根据用户需求修改文案。\n\n要求：\n1. 根据用户的修改需求调整描述\n2. 保持描述简洁有力，控制在 20-50 字以内\n3. 保留原描述的核心信息，只进行必要的调整\n4. 直接输出修改后的描述文本，不要添加引号或其他标记',r=`当前描述：\n${a}\n\n修改需求：\n${e}\n\n请输出修改后的描述：`;console.log('🚀 直接调用 AI API (插件环境)...');const{filterApiParams:s}=await S(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),i=s({model:E.value.model,messages:[{role:'system',content:o},{role:'user',content:r}],temperature:E.value.temperature,max_tokens:E.value.max_tokens,top_p:E.value.top_p,presence_penalty:E.value.presence_penalty,frequency_penalty:E.value.frequency_penalty},E.value.api_endpoint),l=await fetch(E.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${E.value.api_key}`},body:JSON.stringify(i)});if(!l.ok)throw new Error(`API 调用失败: ${l.status} ${l.statusText}`);const d=await l.json();let c=d.choices?.[0]?.message?.content;if(console.log('📝 [编辑] AI 原始返回:',c),!c||!c.trim())throw new Error('AI 未返回有效内容，请检查：\n1. API Key 是否有效\n2. 模型是否可用\n3. 账户余额');if(Q(4,'处理结果','正在清理和应用编辑后的描述...'),M.updateTaskProgress(t,80,'处理结果'),c=c.replace(/^["']|["']$/g,''),c=c.replace(/^```.*?\n?|```$/g,'').trim(),!c)throw new Error('AI 返回内容清理后为空');console.log('✨ [编辑] AI 清理后的描述:',c),P.value[n].description=c,re();const p=((Date.now()-X.value.startTime)/1e3).toFixed(1);q.success(`描述修改成功！耗时 ${p} 秒`,'',{timeOut:3e3}),M.completeTask(t,{description:c}),setTimeout(()=>{L.value=!1},500)}catch(a){console.error('❌ [编辑] AI 编辑失败:',a);const e='编辑失败: '+a.message;q.error(e),M.failTask(t,e)}finally{ne(),V.value=!1}}async function de(e){if(!e.trim())return void q.warning('请输入界面风格描述');const n=M.createTask('ui_generate','生成开场白界面样式');if(X.value.startTime=Date.now(),X.value.total=5,Q(0,'准备中','正在初始化界面样式生成任务...'),ee(),!E.value.api_endpoint||!E.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),G.value=!1,ne(),void M.failTask(n,'API 未配置');W.value=!0;try{Q(1,'准备数据','正在收集开场白卡片信息...'),M.updateTaskProgress(n,10,'准备数据');const t=P.value.map((e,n)=>{const t=e.icon||'💬',a=e.title||(0===n?'默认开场白':`开场白 ${n}`),o=e.description||'点击开始对话';return'      <div class="scene-card" onclick="switchGreeting('+n+')"><div class="card-badge">'+(0===n?'默认':String(n).padStart(2,'0'))+'</div><div class="card-icon">'+t+'</div><div class="card-title">'+a+'</div><div class="card-desc">'+o+'</div></div>'}).join('\n'),a='你是一个专业的前端开发专家，擅长创建美观的HTML/CSS界面。\n\n任务：根据用户的风格描述，生成一个完整的HTML页面代码，用于展示开场白选择界面。\n\n要求：\n1. 包含完整的 HTML 结构（<html>、<head>、<body>）\n2. 在 <head> 中包含 Font Awesome 图标库：<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">\n3. 所有样式写在 <style> 标签内，不要使用外部 CSS 文件\n4. 必须包含以下HTML结构（保持类名不变）：\n   - body（页面背景）\n   - .container（主容器）\n   - .header（标题区域）\n     - h1（主标题）\n     - p（副标题）\n   - .scene-grid（卡片网格容器）\n   - .scene-card（单个卡片，需要 onclick 属性）\n   - .card-badge（序号徽章）\n   - .card-icon（图标）\n   - .card-title（卡片标题）\n   - .card-desc（卡片描述）\n   - .loading（加载提示）\n5. 必须包含 switchGreeting(id) 函数的完整 JavaScript 代码\n6. 根据用户的风格描述设计颜色、字体、布局、动画等样式\n7. 确保响应式设计，在不同屏幕尺寸下都好看\n8. 直接输出完整的HTML代码，不要添加任何解释文字或markdown标记\n\n【重要】样式要求：\n- body 必须使用 "min-height: 100vh; height: auto;" 而不是固定高度\n- body 必须使用 "display: flex; align-items: center; justify-content: center;" 来居中内容\n- .container 不要设置固定高度，使用 "height: auto;" 让内容自适应\n- .scene-card 卡片必须使用 "min-height" 而不是固定 "height"，让卡片自适应内容\n- .card-desc 描述文字要完整显示，可以使用 line-clamp 限制行数但要显示省略号\n- 不要在卡片上使用 "overflow: hidden" 除非配合 line-clamp 使用\n- 确保所有内容都能完整显示，不会被截断\n\n【重要】HTML结构必须严格遵守：\n- 必须有一个 class="scene-grid" 的div作为卡片容器\n- 所有卡片必须在 scene-grid 容器内\n- 不要改变scene-grid这个类名，不要用grid-container、cards-grid等其他名字',o=`风格描述：${e}\n\n以下是需要展示的开场白卡片（每个卡片需要有 onclick="switchGreeting(序号)" 属性）：\n${t}\n\n【重要】必须在 </body> 前添加以下 JavaScript 代码：\n<script>\n${'async function switchGreeting(id) {\n      try {\n        const loading = document.getElementById("loading");\n        const mainContainer = document.getElementById("mainContainer");\n        if (loading) loading.classList.add("active");\n        if (mainContainer) mainContainer.style.display = "none";\n\n        if (typeof window.getChatMessages !== "function") {\n          alert("请在酒馆环境中使用此功能");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        // 使用 TavernHelper 获取消息\n        let messages;\n        if (typeof (window as any).TavernHelper !== \'undefined\' && \n            typeof (window as any).TavernHelper.getChatMessages === \'function\') {\n          messages = (window as any).TavernHelper.getChatMessages(\'0\');\n        } else {\n          alert("TavernHelper 不可用");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n        \n        if (!messages || messages.length === 0) {\n          alert("未找到消息");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        const content = messages[0].swipes[id];\n        if (!content) {\n          alert("该开场白暂无内容");\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n          return;\n        }\n\n        await window.setChatMessage(content, 0, { swipe_id: id, refresh: "display_and_render_current" });\n\n        setTimeout(() => {\n          if (loading) loading.classList.remove("active");\n          if (mainContainer) mainContainer.style.display = "block";\n        }, 500);\n      } catch (err) {\n        console.error("切换失败:", err);\n        alert("切换失败: " + err.message);\n        const loading = document.getElementById("loading");\n        const mainContainer = document.getElementById("mainContainer");\n        if (loading) loading.classList.remove("active");\n        if (mainContainer) mainContainer.style.display = "block";\n      }\n    }'}\n<\/script>\n\n【重要】每个 .scene-card 必须添加 onclick="switchGreeting(序号)" 属性，例如：\n<div class="scene-card" onclick="switchGreeting(0)">\n\n【重要】必须包含一个 loading 提示元素：\n<div class="loading" id="loading" style="display: none; text-align: center; padding: 40px;">\n  <p style="color: #888; font-size: 18px;">切换中...</p>\n</div>\n\n请生成完整的HTML代码，确保包含以上所有要求：`;Q(2,'构建提示','正在准备 AI 提示词和示例代码...'),M.updateTaskProgress(n,30,'构建提示'),console.log('🚀 直接调用 AI API (插件环境)...'),Q(3,'调用 AI',`正在请求 ${E.value.model} 生成界面样式...`),M.updateTaskProgress(n,50,`调用 AI (${E.value.model})`);const{filterApiParams:r}=await S(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),s=r({model:E.value.model,messages:[{role:'system',content:a},{role:'user',content:o}],temperature:E.value.temperature,max_tokens:E.value.max_tokens,top_p:E.value.top_p,presence_penalty:E.value.presence_penalty,frequency_penalty:E.value.frequency_penalty},E.value.api_endpoint),i=await fetch(E.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${E.value.api_key}`},body:JSON.stringify(s)});if(!i.ok)throw new Error(`API 调用失败: ${i.status} ${i.statusText}`);const l=await i.json();let d=l.choices?.[0]?.message?.content;if(console.log('📝 [样式生成] AI 原始返回:',d?d.substring(0,500):'(空)'),!d||!d.trim())throw new Error('AI 未返回有效内容，请检查 API 配置和模型是否支持该任务');if(Q(4,'处理结果','正在清理和验证生成的代码...'),M.updateTaskProgress(n,75,'处理结果'),d=d.replace(/^```html\n?|^```\n?|```$/gm,'').trim(),!d)throw new Error('AI 返回内容清理后为空');console.log('✨ [样式生成] AI 清理后的HTML长度:',d.length),Q(5,'保存配置','正在保存生成的界面样式...'),M.updateTaskProgress(n,90,'保存配置'),O.value.customHtml=d,re(),ue();const c=((Date.now()-X.value.startTime)/1e3).toFixed(1);q.success(`界面样式生成成功！耗时 ${c} 秒`,'',{timeOut:3e3}),M.completeTask(n,{htmlLength:d.length}),setTimeout(()=>{G.value=!1},500)}catch(t){console.error('❌ [样式生成] AI 生成失败:',t),q.error('生成失败: '+t.message,'',{timeOut:5e3}),M.failTask(n,t.message)}finally{ne(),W.value=!1}}async function ce(){if(ae())return O.value.customHtml&&O.value.customHtml.trim()?(R.value=O.value.customHtml,void(j.value=!0)):void q.warning('请先使用"AI生成界面样式"功能生成自定义HTML');q.warning('未找到角色卡')}async function pe(){await A(R.value,'✅ 代码已复制到剪贴板')&&(N.value='✓ 已复制',setTimeout(()=>{N.value='复制代码'},2e3))}function ue(){if(0!==P.value.length)if(O.value.customHtml&&O.value.customHtml.trim()){console.log('🎨 使用AI生成的自定义HTML预览');try{const e=P.value.map((e,n)=>{const t=e.icon||'💬',a=e.title||(0===n?'默认开场白':`开场白 ${n}`),o=e.description||'点击开始对话';return`\n            <div class="scene-card" onclick="switchGreeting(${n})">\n              <span class="card-badge">${0===n?'默认':String(n).padStart(2,'0')}</span>\n              <div class="card-icon">${t}</div>\n              <h3 class="card-title">${a}</h3>\n              <p class="card-desc">${o}</p>\n            </div>\n          `.trim()}).join('\n          ');let n=O.value.customHtml;n=n.replace(/<div class="scenes-grid">[\s\S]*?<\/div>/,`<div class="scenes-grid">\n          ${e}\n        </div>`),F.value=n,console.log('✅ 预览更新成功')}catch(e){console.error('❌ 预览更新失败:',e),F.value=''}}else F.value='';else F.value=''}function ge(){j.value=!1}function fe(){if(!F.value)return void q.error('没有可预览的内容');const e=ae(),n=e?`${e.name} - 开场白选择`:'开场白预览',t=window.open('','_blank','width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');t?(t.document.write(F.value),t.document.close(),t.document.title=n,q.success('已在新窗口打开预览')):q.error('无法打开新窗口，请检查浏览器弹窗设置')}async function me(){try{if(await ce(),!R.value)return void q.error('请先生成代码');const e=ae(),n=e?.name||'角色',t={id:crypto.randomUUID(),scriptName:`${n}-开场白前端`,disabled:!1,runOnEdit:!0,findRegex:'/【开场白】/g',replaceString:'```html\n'+R.value+'\n```',trimStrings:[],placement:[1,2],substituteRegex:0,minDepth:null,maxDepth:null,markdownOnly:!0,promptOnly:!1},a=JSON.stringify(t,null,4),o=new Blob([a],{type:'application/json'}),r=URL.createObjectURL(o),s=document.createElement('a');s.href=r,s.download=`${n}-开场白前端.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r),q.success('已生成并下载JSON文件')}catch(e){console.error('下载失败:',e),q.error('下载失败: '+e.message)}}return w(()=>{oe()}),(e,n)=>(r(),a('div',Oo,[i('div',jo,[n[32]||(n[32]=i('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-comments',style:{color:'#667eea'}}),d(' 开场白管理器 ')],-1)),i('div',Ro,[P.value.length>0?(r(),a('span',No,c(P.value.length)+' 个开场白 ',1)):o('',!0),P.value.length>0?(r(),a('button',{key:1,class:'mini-button',style:g([{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},{color:J.value?'#667eea':'#e0e0e0',borderColor:J.value?'#667eea':'#3a3a3a'}]),onClick:n[0]||(n[0]=e=>J.value=!J.value)},[n[28]||(n[28]=i('i',{class:'fa-solid fa-circle-question'},null,-1)),d(' '+c(J.value?'隐藏帮助':'显示帮助'),1)],4)):o('',!0),P.value.length>0?(r(),a('button',{key:2,class:'mini-button',style:{padding:'6px 12px',background:'#dc2626',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:se,onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[29]||(n[29]=[i('i',{class:'fa-solid fa-eraser'},null,-1),d(' 清空配置 ',-1)])],32)):o('',!0),P.value.length>0?(r(),a('button',{key:3,class:'mini-button',style:{padding:'6px 12px',background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:n[3]||(n[3]=e=>G.value=!0),onMouseenter:n[4]||(n[4]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[5]||(n[5]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[30]||(n[30]=[i('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1),d(' AI生成界面样式 ',-1)])],32)):o('',!0),i('button',{class:'mini-button refresh-button',style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:oe},[...n[31]||(n[31]=[i('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新 ',-1)])])])]),i('div',Do,[i('div',Lo,[0===P.value.length?(r(),a('div',Ho,[...n[33]||(n[33]=[i('i',{class:'fa-solid fa-comment-dots',style:{'font-size':'64px','margin-bottom':'20px',opacity:'0.3'}},null,-1),i('div',{style:{'font-size':'18px','font-weight':'600',color:'#e0e0e0','margin-bottom':'10px'}},'暂无开场白',-1),i('div',{style:{'font-size':'14px',color:'#888','max-width':'400px','line-height':'1.6'}},' 请在酒馆中选择一个有开场白的角色卡，或点击上方的刷新按钮 ',-1)])])):J.value?(r(),a('div',Vo,[i('div',Uo,[n[35]||(n[35]=i('h4',{style:{color:'#667eea',margin:'0',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-circle-info'}),d(' 使用说明 ')],-1)),i('button',{style:{background:'transparent',border:'none',color:'#888',cursor:'pointer','font-size':'18px',padding:'4px'},onClick:n[6]||(n[6]=e=>J.value=!1)},[...n[34]||(n[34]=[i('i',{class:'fa-solid fa-times'},null,-1)])])]),n[36]||(n[36]=u('<ol style="color:#ccc;margin:0;padding-left:20px;line-height:1.8;" data-v-5041ebab><li data-v-5041ebab>工具会自动读取当前角色卡的所有开场白</li><li data-v-5041ebab>为每个开场白设置图标、标题和描述</li><li data-v-5041ebab>使用AI生成描述功能，根据开场白内容自动生成吸引人的描述</li><li data-v-5041ebab>点击&quot;AI生成界面样式&quot;按钮，描述你想要的风格（如：深蓝色背景、金色标题）</li><li data-v-5041ebab>AI会根据你的描述生成完整的HTML样式代码</li><li data-v-5041ebab>右侧实时预览生成的界面样式效果</li><li data-v-5041ebab>点击&quot;生成前端选择界面代码&quot;查看完整代码</li><li data-v-5041ebab>点击&quot;下载为STScript JSON&quot;导出配置文件</li><li data-v-5041ebab>在酒馆中导入JSON文件，输入 /【开场白】 使用</li></ol><div style="margin-top:15px;padding-top:15px;border-top:1px solid #3a3a3a;" data-v-5041ebab><p style="color:#888;font-size:13px;margin:0;" data-v-5041ebab><i class="fa-solid fa-lightbulb" style="color:#ffc107;" data-v-5041ebab></i><strong data-v-5041ebab>提示：</strong>生成的序号对应角色卡中的开场白序号（0为默认开场白） </p></div>',2))])):(r(),a('div',Jo,[(r(!0),a(f,null,m(P.value,(e,t)=>(r(),a('div',{key:t,class:'greeting-item',style:{background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[i('div',Fo,[i('span',Bo,' #'+c(t),1),l(i('input',{'onUpdate:modelValue':n=>e.icon=n,style:{width:'60px','text-align':'center','font-size':'20px',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'6px',color:'#e0e0e0'},placeholder:'图标',maxlength:'4',onInput:re},null,40,Yo),[[p,e.icon]]),l(i('input',{'onUpdate:modelValue':n=>e.title=n,style:{flex:'1',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'8px 12px',color:'#e0e0e0','font-size':'14px'},placeholder:0===t?'默认开场白':'开场白 '+t,onInput:re},null,40,Zo),[[p,e.title]]),i('button',{style:{background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none',color:'white',padding:'8px 16px','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center',gap:'6px','font-size':'13px','font-weight':'600','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.3)'},title:'根据开场白内容自动生成描述',onClick:e=>async function(e){U.value=e;const n=M.createTask('ui_generate',`生成开场白#${e}描述`);X.value.startTime=Date.now(),X.value.total=4,Q(0,'准备中','正在初始化 AI 生成任务...'),ee(),D.value=!0,H.value=!0;const t=e;if(t<0||t>=P.value.length)return H.value=!1,D.value=!1,void M.failTask(n,'无效的开场白索引');try{if(Q(1,'检查配置','正在验证 API 配置和权限...'),M.updateTaskProgress(n,10,'检查配置'),!E.value.api_endpoint||!E.value.api_key)return q.error('请先在设置页面配置 API 端点和 API Key'),D.value=!1,H.value=!1,void M.failTask(n,'API 未配置');Q(2,'读取数据',`正在读取开场白 #${t} 的内容...`),M.updateTaskProgress(n,30,'读取开场白内容');const e=ae();if(!e)return q.error('未找到角色卡'),D.value=!1,H.value=!1,void M.failTask(n,'未找到角色卡');const a=[e.first_mes,...e.data?.alternate_greetings||[]][t]||'';if(!a.trim())return q.warning('该开场白内容为空'),D.value=!1,H.value=!1,void M.failTask(n,'开场白内容为空');Q(3,'调用 AI',`正在请求 ${E.value.model} 生成描述...`),M.updateTaskProgress(n,50,`调用 AI (${E.value.model})`);const o='你是一个专业的文案编辑助手，擅长为小说、游戏等创作简洁吸引人的开场白描述。\n\n要求：\n1. 描述要简洁有力，控制在 20-50 字以内\n2. 突出开场白的核心场景、情感或冲突点\n3. 使用吸引人的语言，让读者产生阅读兴趣\n4. 不要使用"这是一个..."、"在这个开场白中..."等冗余表述\n5. 直接输出描述文本，不要添加引号或其他标记',r=`请为以下开场白内容生成一个简洁吸引人的描述：\n\n${a}\n\n直接输出描述文本：`;console.log('🚀 直接调用 AI API (插件环境)...');const{filterApiParams:s}=await S(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),i=s({model:E.value.model,messages:[{role:'system',content:o},{role:'user',content:r}],temperature:E.value.temperature,max_tokens:E.value.max_tokens,top_p:E.value.top_p,presence_penalty:E.value.presence_penalty,frequency_penalty:E.value.frequency_penalty},E.value.api_endpoint),l=await fetch(E.value.api_endpoint+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${E.value.api_key}`},body:JSON.stringify(i)});if(!l.ok)throw new Error(`API 调用失败: ${l.status} ${l.statusText}`);const d=await l.json();let c=d.choices?.[0]?.message?.content;if(console.log('📝 [生成] AI 原始返回:',c),!c||!c.trim())throw new Error('AI 未返回有效内容，请检查：\n1. API Key 是否有效\n2. 模型是否可用\n3. 账户余额');if(Q(4,'处理结果','正在清理和应用生成的描述...'),M.updateTaskProgress(n,80,'处理结果'),c=c.replace(/^["']|["']$/g,''),c=c.replace(/^```.*?\n?|```$/g,'').trim(),!c)throw new Error('AI 返回内容清理后为空');console.log('✨ [生成] AI 清理后的描述:',c),P.value[t].description=c,re();const p=((Date.now()-X.value.startTime)/1e3).toFixed(1);q.success(`描述生成成功！耗时 ${p} 秒`,'',{timeOut:3e3}),M.completeTask(n,{description:c}),setTimeout(()=>{D.value=!1},500)}catch(a){console.error('❌ [生成] AI 生成失败:',a);const e='生成失败: '+a.message;q.error(e),M.failTask(n,e),setTimeout(()=>{},5e3)}finally{ne(),H.value=!1}}(t),onMouseenter:n[7]||(n[7]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.5)'}),onMouseleave:n[8]||(n[8]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.3)'})},[...n[37]||(n[37]=[i('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1),i('span',null,'AI 生成描述',-1)])],40,Go),e.description?(r(),a('button',{key:0,style:{background:'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',border:'none',color:'white',padding:'8px 16px','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center',gap:'6px','font-size':'13px','font-weight':'600','box-shadow':'0 2px 8px rgba(59, 130, 246, 0.3)'},title:'根据需求修改已有描述',onClick:e=>function(e){U.value=e,L.value=!0}(t),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.5)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.3)'})},[...n[38]||(n[38]=[i('i',{class:'fa-solid fa-edit'},null,-1),i('span',null,'AI 编辑描述',-1)])],40,Wo)):o('',!0)]),l(i('textarea',{'onUpdate:modelValue':n=>e.description=n,style:{width:'100%',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',padding:'10px',color:'#e0e0e0','font-size':'13px','font-family':'inherit',resize:'vertical','min-height':'60px'},placeholder:'输入简短描述...',onInput:re},'            ',40,qo),[[p,e.description]]),i('button',{style:{width:'100%',padding:'10px',background:'transparent',border:'1px solid #667eea','border-radius':'6px',color:'#667eea','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease',display:'flex','align-items':'center','justify-content':'center',gap:'6px','margin-top':'10px'},onClick:e=>function(e){try{const n=ae();if(!n)return void q.error('未找到角色卡');const t=[n.first_mes,...n.data?.alternate_greetings||[]][e]||'';if(!t.trim())return void q.warning('该开场白内容为空');Z.value=t,Y.value=!0}catch(n){console.error('查看开场白失败:',n),q.error('查看开场白失败: '+n.message)}}(t),onMouseenter:n[11]||(n[11]=e=>e.currentTarget.style.background='rgba(102, 126, 234, 0.1)'),onMouseleave:n[12]||(n[12]=e=>e.currentTarget.style.background='transparent')},[...n[39]||(n[39]=[i('i',{class:'fa-solid fa-file-lines'},null,-1),i('span',null,'查看角色卡中的开场白原文',-1)])],40,Xo)]))),128))])),P.value.length>0?(r(),a('div',Ko,[i('button',{style:{padding:'15px 35px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'10px',color:'white','font-size':'15px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'10px','box-shadow':'0 4px 15px rgba(102, 126, 234, 0.4)'},onClick:ce,onMouseenter:n[13]||(n[13]=e=>{e.currentTarget.style.transform='translateY(-3px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.6)'}),onMouseleave:n[14]||(n[14]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'})},[...n[40]||(n[40]=[i('i',{class:'fa-solid fa-code',style:{'font-size':'16px'}},null,-1),d(' 生成HTML代码 ',-1)])],32),i('button',{style:{padding:'15px 35px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'10px',color:'white','font-size':'15px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'10px','box-shadow':'0 4px 15px rgba(16, 185, 129, 0.4)'},onClick:me,onMouseenter:n[15]||(n[15]=e=>{e.currentTarget.style.transform='translateY(-3px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.6)'}),onMouseleave:n[16]||(n[16]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.4)'})},[...n[41]||(n[41]=[i('i',{class:'fa-solid fa-download',style:{'font-size':'16px'}},null,-1),d(' 下载为STScript JSON ',-1)])],32)])):o('',!0)]),i('div',Qo,[i('div',er,[n[43]||(n[43]=i('h4',{style:{margin:'0',color:'white','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-eye'}),d(' 实时预览 ')],-1)),F.value?(r(),a('button',{key:0,title:'新窗口打开',style:{width:'32px',height:'32px',background:'rgba(255, 255, 255, 0.2)',border:'none','border-radius':'6px',color:'white','font-size':'14px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center'},onClick:fe},[...n[42]||(n[42]=[i('i',{class:'fa-solid fa-external-link-alt'},null,-1)])])):o('',!0)]),i('div',nr,[F.value?(r(),a('iframe',{key:0,srcdoc:F.value,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,tr)):(r(),a('div',ar,[...n[44]||(n[44]=[i('div',null,[i('i',{class:'fa-solid fa-eye-slash',style:{'font-size':'48px','margin-bottom':'15px',opacity:'0.3'}}),i('p',{style:{margin:'0'}},'配置开场白后将显示预览')],-1)])]))])])]),k(bo,{show:D.value,'is-generating':H.value,title:'AI 生成简短描述',description:'AI 正在根据开场白的实际内容自动生成吸引人的简短描述（20-50字）...','show-input':!1,progress:H.value?te.value:void 0,onClose:ie,onConfirm:()=>{}},null,8,['show','is-generating','progress']),k(Po,{show:L.value,'is-modifying':V.value,title:'AI 编辑简短描述',description:'描述你想要修改的地方，AI 会在当前描述的基础上进行调整。注意：仅修改描述，不会改变开场白内容本身。',progress:V.value?te.value:void 0,examples:['更简洁一些','更文艺一些','更活泼一些','添加情感色彩'],onClose:n[17]||(n[17]=e=>L.value=!1),onConfirm:le},null,8,['show','is-modifying','progress']),k(Po,{show:G.value,'is-modifying':W.value,title:'AI 生成开场白界面样式',description:'描述你想要的界面风格，AI 会生成完整的HTML样式代码。例如：深蓝色背景、金色标题、圆角卡片等。',progress:W.value?te.value:void 0,examples:['深蓝色渐变背景，白色圆角卡片，金色标题','粉色可爱风格，带阴影的卡片','深色科技风格，霓虹灯效果','典雅金色风格，高贵大气','游戏像素风格，方形卡片'],onClose:n[18]||(n[18]=e=>G.value=!1),onConfirm:de},null,8,['show','is-modifying','progress']),Y.value?(r(),a('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:n[26]||(n[26]=s(e=>Y.value=!1,['self']))},[i('div',{style:{background:'linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%)','border-radius':'16px',padding:'24px','max-width':'700px',width:'100%','max-height':'80vh',display:'flex','flex-direction':'column','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'},onClick:n[25]||(n[25]=s(()=>{},['stop']))},[i('div',or,[n[46]||(n[46]=i('h3',{style:{margin:'0',color:'white',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-file-lines'}),i('span',null,'开场白原文')],-1)),i('button',{style:{background:'transparent',border:'none',color:'rgba(255, 255, 255, 0.7)',cursor:'pointer','font-size':'20px',padding:'4px 8px',transition:'all 0.2s'},onClick:n[19]||(n[19]=e=>Y.value=!1),onMouseenter:n[20]||(n[20]=e=>e.currentTarget.style.color='white'),onMouseleave:n[21]||(n[21]=e=>e.currentTarget.style.color='rgba(255, 255, 255, 0.7)')},[...n[45]||(n[45]=[i('i',{class:'fa-solid fa-times'},null,-1)])],32)]),i('div',rr,c(Z.value),1),i('div',sr,[i('button',{style:{padding:'10px 24px',background:'white',border:'none','border-radius':'6px',color:'#1e3a8a','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.2s'},onClick:n[22]||(n[22]=e=>Y.value=!1),onMouseenter:n[23]||(n[23]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[24]||(n[24]=e=>e.currentTarget.style.transform='translateY(0)')},' 关闭 ',32)])])])):o('',!0),j.value?(r(),a('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000','backdrop-filter':'blur(5px)'},onClick:ge},[i('div',{style:{background:'#2a2a2a','border-radius':'15px','max-width':'800px',width:'90%','max-height':'80vh',display:'flex','flex-direction':'column','box-shadow':'0 20px 60px rgba(0, 0, 0, 0.5)'},onClick:n[27]||(n[27]=s(()=>{},['stop']))},[i('div',{style:{padding:'20px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},[n[48]||(n[48]=i('h3',{style:{color:'#e0e0e0','font-size':'18px',margin:'0',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-code'}),d(' 生成的前端代码 ')],-1)),i('button',{style:{background:'transparent',border:'none',color:'#888','font-size':'20px',cursor:'pointer',padding:'5px 10px',transition:'color 0.2s ease'},onClick:ge},[...n[47]||(n[47]=[i('i',{class:'fa-solid fa-times'},null,-1)])])]),i('div',ir,[n[50]||(n[50]=i('div',{style:{background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'8px',padding:'15px','margin-bottom':'20px',color:'#e0e0e0'}},[i('p',{style:{'margin-bottom':'10px','font-weight':'600'}},[i('strong',null,'使用方法：')]),i('ol',{style:{'margin-left':'20px',color:'#aaa','line-height':'1.8'}},[i('li',null,'复制下面的代码'),i('li',null,[d(' 在消息中输入占位符（如 '),i('code',{style:{background:'#2a2a2a',padding:'2px 6px','border-radius':'4px',color:'#667eea'}},'【开场白】'),d('） ')]),i('li',null,'创建正则脚本，将占位符替换为此代码')])],-1)),i('div',lr,[i('pre',dr,[i('code',cr,c(R.value),1)])]),i('button',{style:{width:'100%',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',padding:'12px','border-radius':'8px','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center','justify-content':'center',gap:'8px'},onClick:pe},[n[49]||(n[49]=i('i',{class:'fa-solid fa-copy'},null,-1)),d(' '+c(N.value),1)])])])])):o('',!0)]))}}),[['__scopeId','data-v-5041ebab']]),ur={class:'help-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},gr={style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','margin-bottom':'20px','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},fr={style:{color:'#e0e0e0','font-size':'14px','line-height':'1.8',animation:'fadeIn 0.3s ease-in'}},mr={style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','margin-bottom':'20px','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},xr={style:{color:'#e0e0e0','font-size':'14px','line-height':'1.8',animation:'fadeIn 0.3s ease-in'}},br=xo(e({__name:'HelpTab',setup(e){const n=C({usageGuide:!0,changelog:!0}),t=e=>{n[e]=!n[e]};return(e,o)=>(r(),a('div',ur,[o[8]||(o[8]=u('<div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:35px 30px;border-radius:20px;margin-bottom:25px;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);text-align:center;position:relative;overflow:hidden;" data-v-e8f4bfa8><div style="position:absolute;top:-50px;right:-50px;width:150px;height:150px;background:rgba(255, 255, 255, 0.1);border-radius:50%;" data-v-e8f4bfa8></div><div style="position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;background:rgba(255, 255, 255, 0.1);border-radius:50%;" data-v-e8f4bfa8></div><div style="position:relative;z-index:1;" data-v-e8f4bfa8><div style="font-size:48px;margin-bottom:10px;" data-v-e8f4bfa8>🐱</div><h2 style="margin:0 0 10px 0;color:white;font-size:24px;font-weight:600;" data-v-e8f4bfa8>mzrodyu猫猫的小破烂</h2><div style="color:rgba(255, 255, 255, 0.9);font-size:14px;" class="version-info" data-v-e8f4bfa8>版本 v1.36</div><div style="margin-top:25px;padding:20px;background:rgba(220, 53, 69, 0.15);border:2px solid rgba(220, 53, 69, 0.3);border-radius:12px;backdrop-filter:blur(10px);" data-v-e8f4bfa8><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;justify-content:center;" data-v-e8f4bfa8><i class="fa-solid fa-shield-halved" style="color:#ffc107;font-size:16px;" data-v-e8f4bfa8></i><span style="color:white;font-weight:600;font-size:14px;" data-v-e8f4bfa8>版权声明</span></div><div style="color:rgba(255, 255, 255, 0.95);font-size:13px;line-height:1.8;text-align:left;" data-v-e8f4bfa8><div style="margin-bottom:5px;" data-v-e8f4bfa8>📌 本脚本仅发布在类脑/旅程</div><div style="margin-bottom:5px;" data-v-e8f4bfa8>🚫 禁止二传</div><div style="margin-bottom:5px;" data-v-e8f4bfa8>⚠️ 二改需要获得作者允许</div><div data-v-e8f4bfa8>❌ 商业化绝对禁止</div></div></div></div></div>',1)),i('div',gr,[i('h3',{onClick:o[0]||(o[0]=e=>t('usageGuide')),style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px',cursor:'pointer','user-select':'none'}},[o[2]||(o[2]=i('i',{class:'fa-solid fa-book',style:{color:'#17a2b8','font-size':'18px'}},null,-1)),o[3]||(o[3]=d(' 使用说明 ',-1)),i('i',{class:x([n.usageGuide?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{'margin-left':'auto','font-size':'14px',transition:'transform 0.3s',color:'#888'}},null,2)]),l(i('div',fr,[...o[4]||(o[4]=[u('<div style="margin-bottom:20px;" data-v-e8f4bfa8><h4 style="color:#4a9eff;margin-bottom:12px;font-size:16px;" data-v-e8f4bfa8>📋 功能简介</h4><ul style="list-style:none;padding:0;margin:0;" data-v-e8f4bfa8><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>总结：</strong>自动/手动总结对话，存入世界书</li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>写卡辅助：</strong>生成角色卡、世界书条目，支持流式传输和 AI 修改 </li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>状态栏生成：</strong>可视化配置状态栏，生成正则 JSON 和世界书条目 </li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>MVU Beta：</strong>生成变量结构、提示词模板、meta 配置</li><li data-v-e8f4bfa8><strong data-v-e8f4bfa8>其他：</strong>去八股、正则界面生成、前端项目管理、表格生成</li></ul></div><div data-v-e8f4bfa8><h4 style="color:#ffc107;margin-bottom:12px;font-size:16px;" data-v-e8f4bfa8>💡 使用方法</h4><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ff6b6b;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>⚠️ API 配置</div><div style="margin-bottom:10px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>支持的格式：</strong><ul style="margin:8px 0;padding-left:20px;" data-v-e8f4bfa8><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://api.openai.com</code> → 自动补全为 <code data-v-e8f4bfa8>/v1</code></li><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://api.openai.com/v1</code> → 直接使用</li><li data-v-e8f4bfa8><code data-v-e8f4bfa8>https://your-proxy.com/v1/chat/completions</code> → 直接使用</li></ul></div></div><ul style="list-style:disc;padding-left:20px;margin:0;" data-v-e8f4bfa8><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>导入：</strong>酒馆助手 → 脚本库 → 导入 → 全局脚本</li><li style="margin-bottom:8px;" data-v-e8f4bfa8><strong data-v-e8f4bfa8>首次使用：</strong>先去&quot;设置&quot;页配置 API</li><li data-v-e8f4bfa8><strong data-v-e8f4bfa8>自动总结：</strong>建议开启，每 20-30 楼自动生成一次</li></ul></div>',2)])],512),[[E,n.usageGuide]])]),i('div',mr,[i('h3',{onClick:o[1]||(o[1]=e=>t('changelog')),style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px',cursor:'pointer','user-select':'none'}},[o[5]||(o[5]=i('i',{class:'fa-solid fa-clock-rotate-left',style:{color:'#28a745','font-size':'18px'}},null,-1)),o[6]||(o[6]=d(' 更新日志 ',-1)),i('i',{class:x([n.changelog?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{'margin-left':'auto','font-size':'14px',transition:'transform 0.3s',color:'#888'}},null,2)]),l(i('div',xr,[...o[7]||(o[7]=[u('<div style="padding:20px;background:rgba(76, 175, 80, 0.05);border-left:4px solid #4caf50;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#4caf50;display:flex;align-items:center;gap:8px;" data-v-e8f4bfa8> v1.34 </div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月8日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>🐛 修复：移除 vue-i18n 国际化系统，改为直接使用中文</li><li class="update-item" data-v-e8f4bfa8>🔧 优化：精简代码，提高加载速度</li><li class="update-item" data-v-e8f4bfa8>✨ 改进：界面显示更加稳定</li></ul></div><div style="padding:20px;background:rgba(255, 152, 0, 0.05);border-left:4px solid #ff9800;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#ff9800;display:flex;align-items:center;gap:8px;" data-v-e8f4bfa8> v1.33 - 🎨 开场白管理器 </div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月5日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>新增：开场白美化选择器工具</li><li class="update-item" data-v-e8f4bfa8>自动读取角色卡的所有开场白</li><li class="update-item" data-v-e8f4bfa8>为每个开场白配置美化样式（图标、标题、描述）</li><li class="update-item" data-v-e8f4bfa8>AI 生成描述：根据开场白原文内容自动生成吸引人的描述</li><li class="update-item" data-v-e8f4bfa8>AI 编辑描述：根据需求快速修改描述</li><li class="update-item" data-v-e8f4bfa8>⭐ AI 生成界面样式：直接告诉AI你想要什么风格，自动生成完整HTML界面</li><li class="update-item" data-v-e8f4bfa8>实时预览生成的美化界面样式效果</li><li class="update-item" data-v-e8f4bfa8>一键导出为 STScript JSON 格式</li><li class="update-item" data-v-e8f4bfa8>配置自动保存到角色卡变量</li></ul></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.32</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年11月2日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>最小化图标支持拖动，可随意调整位置</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.31</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月30日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ffc107;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>✨ 新功能</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>同层对话：AI 回复直接显示在面板内，支持流式传输和正则过滤</li><li class="update-item" data-v-e8f4bfa8>状态栏生成器新增 AI 解析 XML 和自然语言生成字段功能</li></ul></div><div data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>完整的移动端适配：响应式布局、标签栏滚动、滑动切换</li><li class="update-item" data-v-e8f4bfa8>所有 AI 功能统一使用设置页的 API 配置</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;margin-bottom:15px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.30</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月26日</div></div><div style="margin-bottom:15px;" data-v-e8f4bfa8><div style="color:#ffc107;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>✨ 新功能</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>新增 MVU Beta 标签页：变量结构、提示词模板、meta 配置生成</li><li class="update-item" data-v-e8f4bfa8>新增状态栏生成器：可视化配置状态栏，生成正则 JSON 和世界书条目</li><li class="update-item" data-v-e8f4bfa8>状态栏生成器支持 ABO 模板快速加载</li></ul></div><div data-v-e8f4bfa8><div style="color:#6366f1;font-weight:600;margin-bottom:8px;" data-v-e8f4bfa8>🔧 优化</div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>所有 AI 工具统一从设置页读取 max_tokens 和 temperature</li><li class="update-item" data-v-e8f4bfa8>MVU Beta 和状态栏生成器支持数据持久化</li></ul></div></div><div style="padding:20px;background:rgba(99, 102, 241, 0.05);border-left:4px solid #6366f1;border-radius:8px;" data-v-e8f4bfa8><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;" data-v-e8f4bfa8><div style="font-size:16px;font-weight:600;color:#6366f1;" data-v-e8f4bfa8>v1.00</div><div style="font-size:13px;color:#888;" data-v-e8f4bfa8>2025年10月20日</div></div><ul class="update-list" data-v-e8f4bfa8><li class="update-item" data-v-e8f4bfa8>🎉 初始版本发布</li><li class="update-item" data-v-e8f4bfa8>支持自动/手动总结、表格生成、反八股、世界书条目管理、楼层隐藏/显示</li></ul></div>',6)])],512),[[E,n.changelog]])]),o[9]||(o[9]=i('div',{style:{background:'linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%)',padding:'25px','border-radius':'20px','text-align':'center','box-shadow':'0 4px 16px rgba(0, 0, 0, 0.2)'}},[i('div',{style:{color:'#888','font-size':'13px','line-height':'1.8'}},[i('p',{style:{margin:'0 0 8px 0'}},'Made with ❤️ by mzrodyu'),i('p',{style:{margin:'0'}},'基于 Vue 和 Pinia')])],-1))]))}}),[['__scopeId','data-v-e8f4bfa8']]),hr={class:'tools-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},yr={class:'tool-section'},vr={key:0,class:'tool-content'},wr={style:{background:'linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08))',border:'1px solid rgba(102, 126, 234, 0.3)','border-radius':'8px',padding:'15px','margin-bottom':'20px'}},kr={class:'form-group',style:{margin:'0 0 12px 0'}},_r=['disabled'],Tr={style:{position:'relative','z-index':'1'}},zr={class:'form-group',style:{margin:'15px 0'}},Ir={class:'form-group',style:{margin:'15px 0'}},Sr={key:0,class:'output-section'},Ar={class:'code-output'},$r={style:{'margin-top':'15px',padding:'12px',background:'rgba(74, 158, 255, 0.05)',border:'1px solid rgba(74, 158, 255, 0.2)','border-radius':'8px'}},Cr={style:{display:'flex',gap:'10px','flex-wrap':'wrap'}},Er={class:'tool-section'},Mr={key:0,class:'tool-content'},Pr={style:{background:'linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(245, 158, 11, 0.08))',border:'1px solid rgba(251, 191, 36, 0.3)','border-radius':'8px',padding:'15px','margin-bottom':'20px'}},Or={class:'form-group',style:{margin:'0 0 12px 0'}},jr=['disabled'],Rr={style:{position:'relative','z-index':'1'}},Nr={key:0,class:'form-group',style:{margin:'15px 0'}},Dr={key:1,class:'output-section'},Lr={class:'code-output'},Hr=e({__name:'MvuBetaTab',setup(e){const s=b(),{settings:m}=h(s),y=n({structure:!0,prompt:!1});function v(e){y.value[e]=!y.value[e]}const I=n(''),S=n(!1),A=n(''),C=n(!1),E=n(''),P=n(''),O=n(!1),j=n(!1),R=n(!1),N=n(!1),D=n(''),L=n(''),H=n(''),V=n(''),U=n('');function J(e){navigator.clipboard.writeText(e).then(()=>{window.toastr.success('已复制到剪贴板')})}function F(){if(!D.value.trim())return void window.toastr.error('请输入变量名称');const e={$meta:{extensible:!1,strictSet:!0}};e[D.value]=function(){const e=L.value.split('\n').filter(e=>e.trim()),n={};return e.forEach(e=>{const t=e.split(':').map(e=>e.trim()),a=t[0],o=t[1]||'string',r=t[2]||'描述...';a&&(n[a]='number'===o?[0,r]:'string'===o?['',r]:'array'===o?[[],r]:'object'===o?[{},r]:[null,r])}),n}(),H.value=JSON.stringify(e,null,2)}function B(){J(H.value)}async function Y(){if(I.value.trim())if(m.value.api_endpoint&&m.value.api_key){E.value=I.value,S.value=!0;try{const n='你是 MVU Beta 变量系统专家，负责生成精确、实用的 [InitVar] 初始化数据。\n\n# 核心格式规范\n\n## ⚠️ 关键规则（必须严格遵守）\n1. **不包含 "stat_data" 根节点**（系统会自动添加）\n2. **所有字段格式**: `[默认值, "描述"]`（数组格式，两个元素）\n3. **$meta 位置**: 必须在 JSON 根级别（与变量名同级）\n4. **字符串要求**: 必须在一行内，不能换行\n5. **描述长度**: 15-20字以内，简洁准确\n\n## JSON 结构模板\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "变量分组名": {\n    "字段名1": [默认值, "字段用途说明"],\n    "字段名2": [默认值, "字段用途说明"]\n  }\n}\n```\n\n---\n\n# 类型选择指南\n\n## 1️⃣ number（数字）\n**何时使用**：\n- 计数、等级、属性值（如：好感度、金币）\n- 时间戳、进度值\n- 任何需要加减运算的值\n\n**格式**: `[初始数字, "描述"]`\n**示例**:\n- `"好感度": [0, "与角色的亲密程度，-30到100"]`\n- `"等级": [1, "当前等级，影响解锁内容"]`\n- `"金币": [100, "可用于购买物品"]`\n\n## 2️⃣ string（字符串）\n**何时使用**：\n- 名称、状态、描述性文本\n- 时间（如 "10:00"）、地点\n- 单选状态（如 "进行中"/"已完成"）\n\n**格式**: `["初始文本", "描述"]`\n**示例**:\n- `"当前状态": ["空闲", "角色当前的行为状态"]`\n- `"时间": ["09:00", "故事中的当前时间"]`\n- `"关系": ["陌生人", "与user的关系定位"]`\n\n## 3️⃣ array（数组）\n**何时使用**：\n- 列表、集合（如：背包、成就列表）\n- 需要添加/删除元素的内容\n- 多个同类型数据\n\n**格式**: `[[], "描述"]` 或 `[[示例项], "描述"]`\n**示例**:\n- `"背包": [[], "角色拥有的物品列表"]`\n- `"成就": [["新手"], "已解锁的成就"]`\n- `"记忆片段": [[], "重要的记忆事件"]`\n\n## 4️⃣ object（对象）\n**何时使用**：\n- 键值对数据（如：物品→数量）\n- 复杂的嵌套数据\n- 需要动态添加属性的结构\n\n**格式**: `[{}, "描述"]` 或 `[{"示例键": "示例值"}, "描述"]`\n**示例**:\n- `"物品数量": [{"苹果": 3}, "物品名与数量的映射"]`\n- `"关系网": [{}, "NPC名与好感度的映射"]`\n\n---\n\n# 命名规范\n\n## ✅ 好的命名\n- **简洁明确**: "好感度"、"时间"、"背包"\n- **中文优先**: 便于理解和使用\n- **符合语境**: 与角色卡/游戏设定一致\n\n## ❌ 避免的命名\n- 过于抽象: "数据1"、"值A"\n- 过长: "角色与玩家之间的好感度数值"\n- 英文混杂: "favor_value"（除非必要）\n\n---\n\n# 描述编写规范\n\n## ✅ 好的描述（15-20字）\n- "与角色的亲密程度，-30到100"\n- "故事中的当前时间，格式HH:MM"\n- "角色拥有的物品列表，可增删"\n- "当前所在位置，影响剧情走向"\n\n## ❌ 避免的描述\n- 太短: "好感度"（无信息量）\n- 太长: "这是一个用于记录玩家与角色之间的情感联系强度的数值变量，范围..."\n- 无意义: "描述..."、"数据"\n\n---\n\n# 完整示例\n\n## 示例1：角色属性系统\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "角色": {\n    "姓名": ["未命名", "角色的名字"],\n    "等级": [1, "当前等级，影响技能解锁"],\n    "好感度": [0, "与user的亲密度，-30到100"],\n    "状态": ["正常", "当前的身体/精神状态"],\n    "背包": [[], "拥有的物品列表"],\n    "成就": [{}, "已解锁成就与解锁时间"]\n  }\n}\n```\n\n## 示例2：时间与地点系统\n```json\n{\n  "$meta": {\n    "extensible": false,\n    "strictSet": true\n  },\n  "世界": {\n    "时间": ["09:00", "故事中的当前时间"],\n    "日期": ["2024年1月1日", "当前日期"],\n    "地点": ["起始镇", "角色所在的位置"],\n    "天气": ["晴朗", "当前天气状况"],\n    "已完成任务": [[], "完成的任务列表"]\n  }\n}\n```\n\n---\n\n# 最终要求\n\n1. **只输出 JSON**，不要任何解释或注释\n2. **确保格式正确**：字符串在一行内，无尾随逗号\n3. **变量名有意义**：符合用户需求的实际场景\n4. **类型选择准确**：根据用途选择最合适的类型\n5. **描述精准简洁**：15-20字，说清楚用途和变化规则\n\n现在开始根据用户需求生成 [InitVar] JSON。',t=M(m.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${m.value.api_key}`},body:JSON.stringify({model:m.value.model,messages:[{role:'system',content:n},{role:'user',content:`需求：${I.value}\n\n请生成 [InitVar] JSON。`}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||4e3})}),o=await a.text();if(!a.ok){let t=`API 错误: ${a.status}`;try{const e=JSON.parse(o);t=e.error?`${t} - ${e.error.message||JSON.stringify(e.error)}`:e.message?`${t} - ${e.message}`:`${t} - ${JSON.stringify(e)}`}catch(e){t=`${t} - ${o.slice(0,200)}`}throw console.error('API 请求失败:',t),console.error('请求 URL:',m.value.api_endpoint),console.error('请求体:',JSON.stringify({model:m.value.model,messages:[{role:'system',content:n.substring(0,100)+'...'},{role:'user',content:`需求：${I.value.substring(0,100)}...`}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||4e3},null,2)),new Error(t)}const r=JSON.parse(o);let s='';r.choices&&r.choices[0]&&r.choices[0].message?s=r.choices[0].message.content||'':r.data&&r.data.choices&&r.data.choices[0]?s=r.data.choices[0].message?.content||'':r.content&&(s='string'==typeof r.content?r.content:JSON.stringify(r.content)),console.log('AI 返回内容:',s);let i=s;i=i.replace(/```json\s*/gi,'').replace(/```\s*$/g,'');const l=i.match(/\{[\s\S]*$/);if(!l)throw new Error('未找到 JSON 对象');i=l[0];let d,c=0,p=!1,u=!1,g=i.length;for(let e=0;e<i.length;e++){const n=i[e];if(u)u=!1;else if('\\'!==n)if('"'!==n||p){if('"'===n&&p)p=!1;else if(!p&&('{'===n?c++:'}'===n&&c--,0===c)){g=e+1;break}}else p=!0;else u=!0}i=i.substring(0,g),c>0&&(console.warn(`JSON 不完整，缺少 ${c} 个闭合括号，尝试补全...`),i+='}'.repeat(c)),i=i.replace(/,(\s*[}\]])/g,'$1'),i=i.replace(/\/\/[^\n]*/g,''),i=i.replace(/\/\*[\s\S]*?\*\//g,'');try{d=JSON.parse(i)}catch(e){throw console.error('JSON 解析失败，原始内容:',i),new Error(`JSON 解析失败: ${e.message}。请让 AI 输出正确的 JSON（字符串在一行内，无尾随逗号）`)}const f=Object.keys(d).find(e=>'$meta'!==e)||'myVar';D.value=f;const x=d[f]||{},b=[];for(const e in x){if('$meta'===e)continue;const n=x[e];if(Array.isArray(n)&&2===n.length){const t=n[0],a='number'==typeof t?'number':'string'==typeof t?'string':Array.isArray(t)?'array':'object',o=n[1]||'描述...';b.push(`${e}:${a}:${o}`)}}L.value=b.join('\n'),H.value=JSON.stringify(d,null,2),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI生成失败:',n),window.toastr.error(`AI生成失败: ${n.message}`)}finally{S.value=!1}}else window.toastr.error('请先在设置页面配置 API 端点和 API Key');else window.toastr.error('请输入需求描述')}function Z(){if(H.value)try{const e=JSON.parse(H.value),n=Object.keys(e).find(e=>'$meta'!==e)||'myVar',t=e[n]||{};let a=0;for(const o in t)'$meta'!==o&&a++;V.value=`${n} - ${a} fields`,y.value.prompt=!0,G(),window.toastr.success('已基于结构自动生成 COT 提示词'),setTimeout(()=>{const e=document.querySelector('.tool-section:nth-child(2)');e?.scrollIntoView({behavior:'smooth',block:'nearest'})},100)}catch(e){console.error('生成提示词失败:',e),window.toastr.error('生成失败，请检查变量结构格式')}else window.toastr.error('请先生成 [InitVar] 结构')}function G(){const e=`<%_ setLocalVar('initialized_lorebooks.-YourLorebook[0]', true); _%>\n【变量更新】\n在所有文本的最后，进行变量更新。\n\n以下是故事中需要追踪的关键变量，当前状态以这些变量的值为准。\n\n<status_current_variables>\n{{get_message_variable::stat_data}}\n</status_current_variables>\n\n严格按照以下规则和格式进行输出，并确定每一个变量是否需要更新，不要遗漏：\n\nrule:\n  description:\n    - Output update analysis at the end of response\n    - Variable updates are omitted in context but you must still add them\n    - **CRITICAL**: For MVU format [value, description], ALWAYS use [0] suffix to access the value part\n    - 4 commands available: \\\`_.set\\\` (2-3 args), \\\`_.insert\\\` (2-3 args), \\\`_.remove\\\` (1-2 args), \\\`_.add\\\` (2 args)\n    - **RECOMMENDED**: Use \\\`_.insert\\\` instead of \\\`_.assign\\\`\n    - strictSet enabled: [0] suffix is mandatory for all value access\n\n  command_usage:\n    - \\\`_.set('path[0]', old?, new);//reason\\\` - Replace value\n    - \\\`_.add('path[0]', delta);//reason\\\` - Add/subtract numbers only\n    - \\\`_.insert('path[0]', value);//reason\\\` - Add to array end\n    - \\\`_.insert('path[0]', index, value);//reason\\\` - Insert to array at position\n    - \\\`_.insert('path', key, value);//reason\\\` - Add key-value to object\n    - \\\`_.remove('path[0]', value);//reason\\\` - Remove from array/object\n\n  analysis:\n    You MUST follow this Chain-of-Thought (COT) analysis process step by step:\n\n    **STEP 1: Scene Analysis (50 words max, IN ENGLISH)**\n    - Identify current scene/stage/phase\n    - Describe what happened\n    - Determine what changes occurred (time/location/status/progress)\n\n    **STEP 2: Time & Key Status Check**\n    - Extract current time/status from story context\n    - Read key variables from <status_current_variables>\n    - Calculate changes\n    - Decision: What needs to be updated?\n\n    **STEP 3: Systematic Variable Review (check EVERY variable category)**\n    Go through each variable category systematically and mark Y or N:\n\n    ${V.value.trim()||'变量分类 - X fields'}:\n      - 变量1[0]: [Y/N] - explain\n      - 变量2[0]: [Y/N] - explain\n\n    **STEP 4: Command Selection**\n    For each variable marked Y, determine which command to use\n\n    **STEP 5: Analyze Other Variable Systems**\n    - stat_data detailed COT: COMPLETED\n    - Other variable groups? [YES/NO]\n\n    **STEP 6: Final Validation Checklist**\n    - All [0] suffixes present? [YES/NO]\n    - All Y variables have corresponding commands? [YES/NO]\n    - All commands have clear Chinese comments? [YES/NO]\n\n  format: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            [50 words]\n\n            **STEP 2: Time & Key Status Check**\n            - Current status: ...\n            - Stored variable[0]: ...\n            - Changes: ...\n            - Update decision: ...\n\n            **STEP 3: Variable Review (stat_data)**\n            [List categories with Y/N]\n\n            **STEP 4: Command Selection**\n            [For each Y variable, state which command]\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set('path[0]', old?, new);//reason\n        _.add('path[0]', delta);//reason\n        _.insert('path[0]', value);//reason\n        _.remove('path[0]', value);//reason\n    </UpdateVariable>\n\n  example: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            User and character had conversation at library. User helped find a book. Time advanced from 10:00 to 10:30. Character's impression improved.\n\n            **STEP 2: Time & Key Status Check**\n            - Current time: 10:30\n            - Stored 时间[0]: "10:00"\n            - Time passed: 30 minutes\n            - Update decision: Time, Favor\n\n            **STEP 3: Variable Review (stat_data)**\n            基础信息 - 3 fields:\n              - 时间[0]: Y - Time advanced\n              - 日期[0]: N - Same day\n              - 当前位置[0]: N - Still at library\n\n            人物关系 - 1 field:\n              - 好感度[0]: Y - Positive interaction\n\n            **STEP 4: Command Selection**\n            - 时间: use _.set\n            - 好感度: use _.add\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set('时间[0]', '10:00', '10:30');//时间推进30分钟\n        _.add('角色.好感度[0]', 3);//愉快的交流，好感度小幅提升\n    </UpdateVariable>\n\n  specific_rules:\n    - 时间推进：每次互动后更新具体时间，使用 _.set 更新\n    - 状态切换：当状态/阶段切换时，必须更新对应的状态变量\n    - 计数器：使用 _.add 增加或减少计数\n    - 数组操作：添加元素必须用 _.insert，删除元素必须用 _.remove\n    - [0]后缀：所有变量访问都必须加[0]后缀\n    - 扩展数组：带有 $__META_EXTENSIBLE__$ 标记的数组使用 _.insert 添加元素\n    - 对象添加键值：使用 _.insert('路径', 键名, 值) 向对象添加新的键值对`;U.value=e}function W(){J(U.value)}async function q(){if(A.value.trim())if(m.value.api_endpoint&&m.value.api_key){P.value=A.value,C.value=!0;try{const n='你是 MVU Beta COT（思维链）提示词专家，负责生成完整、规范的 6 步分析流程提示词。\n\n# 核心要求\n\n## ⚠️ 必须包含的元素\n1. **变量读取**: `{{get_message_variable::stat_data}}`\n2. **[0] 后缀**: 所有MVU变量访问必须加 `[0]` 后缀\n3. **推荐命令**: 优先使用 `_.insert` 而非 `_.assign`\n4. **6步COT**: 完整的思维链分析流程\n\n## 提示词结构\n\n```ejs\n<%_ setLocalVar(\'initialized_lorebooks.-YourLorebook[0]\', true); _%>\n【变量更新】\n在所有文本的最后，进行变量更新。\n\n以下是故事中需要追踪的关键变量，当前状态以这些变量的值为准。\n\n<status_current_variables>\n{{get_message_variable::stat_data}}\n</status_current_variables>\n\n严格按照以下规则和格式进行输出，并确定每一个变量是否需要更新，不要遗漏：\n\nrule:\n  description:\n    - Output update analysis at the end of response\n    - Variable updates are omitted in context but you must still add them\n    - **CRITICAL**: For MVU format [value, description], ALWAYS use [0] suffix to access the value part\n    - 4 commands available: _.set (2-3 args), _.insert (2-3 args), _.remove (1-2 args), _.add (2 args)\n    - **RECOMMENDED**: Use _.insert instead of _.assign\n    - strictSet enabled: [0] suffix is mandatory for all value access\n\n  command_usage:\n    - _.set(\'path[0]\', old?, new);//reason - Replace value\n    - _.add(\'path[0]\', delta);//reason - Add/subtract numbers only\n    - _.insert(\'path[0]\', value);//reason - Add to array end\n    - _.insert(\'path[0]\', index, value);//reason - Insert to array at position\n    - _.insert(\'path\', key, value);//reason - Add key-value to object\n    - _.remove(\'path[0]\', value);//reason - Remove from array/object\n\n  analysis:\n    You MUST follow this Chain-of-Thought (COT) analysis process step by step:\n\n    **STEP 1: Scene Analysis (50 words max, IN ENGLISH)**\n    - Identify current scene/stage/phase\n    - Describe what happened\n    - Determine what changes occurred (time/location/status/progress)\n\n    **STEP 2: Time & Key Status Check**\n    - Extract current time/status from story context\n    - Read key variables from <status_current_variables>\n    - Calculate changes\n    - Decision: What needs to be updated?\n\n    **STEP 3: Systematic Variable Review (check EVERY variable category)**\n    Go through each variable category systematically and mark Y or N:\n\n    [基于用户需求生成的变量分类]:\n      - 变量1[0]: [Y/N] - explain\n      - 变量2[0]: [Y/N] - explain\n\n    **STEP 4: Command Selection**\n    For each variable marked Y, determine which command to use\n\n    **STEP 5: Analyze Other Variable Systems**\n    - stat_data detailed COT: COMPLETED\n    - Other variable groups? [YES/NO]\n\n    **STEP 6: Final Validation Checklist**\n    - All [0] suffixes present? [YES/NO]\n    - All Y variables have corresponding commands? [YES/NO]\n    - All commands have clear Chinese comments? [YES/NO]\n\n  format: |-\n    <UpdateVariable>\n        <ThinkingProcess>\n            **STEP 1: Scene Analysis**\n            [50 words]\n\n            **STEP 2: Time & Key Status Check**\n            - Current status: ...\n            - Stored variable[0]: ...\n            - Changes: ...\n            - Update decision: ...\n\n            **STEP 3: Variable Review (stat_data)**\n            [List categories with Y/N]\n\n            **STEP 4: Command Selection**\n            [For each Y variable, state which command]\n\n            **STEP 5: Other Systems**\n            - stat_data COT: COMPLETED\n            - Other groups? NO\n\n            **STEP 6: Final Check**\n            - [0] suffixes? YES\n            - All Y have commands? YES\n            - Chinese comments? YES\n        </ThinkingProcess>\n\n        _.set(\'path[0]\', old?, new);//reason\n        _.add(\'path[0]\', delta);//reason\n        _.insert(\'path[0]\', value);//reason\n        _.remove(\'path[0]\', value);//reason\n    </UpdateVariable>\n\n  specific_rules:\n    - 时间推进：每次互动后更新具体时间，使用 _.set 更新\n    - 状态切换：当状态/阶段切换时，必须更新对应的状态变量\n    - 计数器：使用 _.add 增加或减少计数\n    - 数组操作：添加元素必须用 _.insert，删除元素必须用 _.remove\n    - [0]后缀：所有变量访问都必须加[0]后缀\n    - 扩展数组：带有 $__META_EXTENSIBLE__$ 标记的数组使用 _.insert 添加元素\n    - 对象添加键值：使用 _.insert(\'路径\', 键名, 值) 向对象添加新的键值对\n```\n\n---\n\n# 生成要求\n\n1. **完整性**: 包含所有必需部分（变量读取、6步COT、命令示例）\n2. **准确性**: 变量名与用户的InitVar结构一致\n3. **实用性**: 具体规则要符合用户的实际使用场景\n4. **格式**: 直接输出EJS格式，可直接使用\n\n直接输出完整的 COT 提示词内容。',t=M(m.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${m.value.api_key}`},body:JSON.stringify({model:m.value.model,messages:[{role:'system',content:n},{role:'user',content:`场景：${A.value}\n\n请生成 COT 提示词。`}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||3e3})}),o=await a.text();if(!a.ok){let t=`API 错误: ${a.status}`;try{const e=JSON.parse(o);t=e.error?`${t} - ${e.error.message||JSON.stringify(e.error)}`:e.message?`${t} - ${e.message}`:`${t} - ${JSON.stringify(e)}`}catch(e){t=`${t} - ${o.slice(0,200)}`}throw console.error('API 请求失败:',t),console.error('请求 URL:',m.value.api_endpoint),console.error('请求体:',JSON.stringify({model:m.value.model,messages:[{role:'system',content:n.substring(0,100)+'...'},{role:'user',content:`场景：${A.value.substring(0,100)}...`}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||3e3},null,2)),new Error(t)}const r=JSON.parse(o);let s='';r.choices&&r.choices[0]&&r.choices[0].message?s=r.choices[0].message.content||'':r.data&&r.data.choices&&r.data.choices[0]?s=r.data.choices[0].message?.content||'':r.content&&(s='string'==typeof r.content?r.content:JSON.stringify(r.content)),U.value=s.trim(),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI生成失败:',n),window.toastr.error(`AI生成失败: ${n.message}`)}finally{C.value=!1}}else window.toastr.error('请先在设置页面配置 API 端点和 API Key');else window.toastr.error('请输入场景描述')}async function X(e){if(E.value){j.value=!0;try{window.toastr.info('AI 正在修改中...');const n='你是 MVU Beta 变量系统专家。基于原始需求，应用用户的修改建议，生成更新后的 [InitVar] JSON。\n\n# 核心原则\n1. **保持原有结构**：除非明确要求改动，否则保留原有字段\n2. **精确修改**：只修改用户明确指出的部分\n3. **格式一致**：`[默认值, "描述"]`，$meta在根级别\n4. **字符串在一行内**，无尾随逗号\n\n# 修改类型\n\n## 1️⃣ 添加字段\n用户说"增加XX字段"时：\n- 选择合适的类型（number/string/array/object）\n- 设置合理的默认值\n- 写清楚15-20字的描述\n\n## 2️⃣ 删除字段\n用户说"删除XX字段"时：\n- 直接从JSON中移除该字段\n- 不要留下任何痕迹\n\n## 3️⃣ 修改描述\n用户说"改描述"时：\n- 保持字段名和默认值不变\n- 只更新描述部分\n- 保持15-20字长度\n\n## 4️⃣ 调整顺序\n用户说"调整顺序"时：\n- 按要求重新排列字段\n- 内容不变，只改顺序\n\n## 5️⃣ 修改默认值/类型\n用户说"改初始值"或"改类型"时：\n- 更新默认值或更改数据类型\n- 确保新值合理\n\n---\n\n只输出更新后的 JSON，不要解释。',t=`# 原始需求：\n${E.value}\n\n# 修改建议：\n${e}\n\n请根据原始需求和修改建议，重新生成 [InitVar] JSON。`,a=M(m.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${m.value.api_key}`},body:JSON.stringify({model:m.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||4e3})});if(!o.ok)throw new Error(`API 错误: ${o.status}`);const r=await o.json();let s=(r.choices?.[0]?.message?.content||'').replace(/```json\s*/gi,'').replace(/```\s*$/g,'');const i=s.match(/\{[\s\S]*$/);i&&(s=i[0]),s=s.replace(/,(\s*[}\]])/g,'$1');const l=JSON.parse(s),d=Object.keys(l).find(e=>'$meta'!==e)||'myVar';D.value=d;const c=l[d]||{},p=[];for(const e in c){if('$meta'===e)continue;const n=c[e];if(Array.isArray(n)&&2===n.length){const t=n[0],a='number'==typeof t?'number':'string'==typeof t?'string':Array.isArray(t)?'array':'object',o=n[1]||'描述...';p.push(`${e}:${a}:${o}`)}}L.value=p.join('\n'),H.value=JSON.stringify(l,null,2),E.value+=`\n\n【已应用的修改】：${e}`,window.toastr.success('✅ AI 修改完成！'),O.value=!1}catch(n){console.error('AI 修改失败:',n),window.toastr.error('AI 修改失败: '+n.message)}finally{j.value=!1}}else window.toastr.warning('请先生成结构')}async function K(e){if(P.value){N.value=!0;try{window.toastr.info('AI 正在修改中...');const n='你是 MVU Beta COT（思维链）提示词专家。基于原始场景描述，应用用户的修改建议，生成更新后的 6 步思维链提示词。\n\n# 核心原则\n1. **保持原有结构**：除非明确要求改动，否则保留原有内容\n2. **精确修改**：只修改用户明确指出的部分\n3. **格式一致**：EJS格式，包含所有必需元素\n4. **6步完整**：确保6步COT流程不缺失\n\n# 修改类型\n\n## 1️⃣ 修改STEP内容\n用户说"修改STEP X"时：\n- 保持其他STEP不变\n- 只更新指定的STEP内容\n- 保持逻辑连贯性\n\n## 2️⃣ 添加/删除规则\n用户说"添加/删除XX规则"时：\n- 在specific_rules部分操作\n- 保持规则格式一致\n\n## 3️⃣ 调整变量分类\n用户说"修改变量分类"时：\n- 更新STEP 3中的分类\n- 保持所有字段都被覆盖\n\n## 4️⃣ 强化某个方面\n用户说"强调XX"时：\n- 在相应STEP中增加说明\n- 或在specific_rules中添加规则\n\n---\n\n必须包含的元素：\n- `{{get_message_variable::stat_data}}`\n- [0] 后缀说明\n- 6步完整COT流程\n- 命令使用示例\n\n直接输出完整的 EJS 格式提示词。',t=`# 原始场景描述：\n${P.value}\n\n# 修改建议：\n${e}\n\n请根据原始场景描述和修改建议，重新生成 COT 提示词。`,a=M(m.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${m.value.api_key}`},body:JSON.stringify({model:m.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:m.value.temperature||.7,max_tokens:m.value.max_tokens||3e3})});if(!o.ok)throw new Error(`API 错误: ${o.status}`);const r=await o.json();let s=r.choices?.[0]?.message?.content||'';U.value=s.trim(),P.value+=`\n\n【已应用的修改】：${e}`,window.toastr.success('✅ AI 修改完成！'),R.value=!1}catch(n){console.error('AI 修改失败:',n),window.toastr.error('AI 修改失败: '+n.message)}finally{N.value=!1}}else window.toastr.warning('请先生成提示词')}function Q(){H.value?(U.value||Z(),setTimeout(()=>{!function(){if(!H.value||!U.value)return void window.toastr.error('请先生成 [InitVar] 结构和 COT 提示词');let e='myVar';try{const n=JSON.parse(H.value);e=Object.keys(n).find(e=>'$meta'!==e)||'myVar'}catch(s){console.error('解析变量名失败:',s)}const n=[{uid:ee(),key:[],keysecondary:[],comment:'[InitVar]',content:H.value,constant:!1,vectorized:!1,selective:!0,selectiveLogic:0,addMemo:!1,order:100,position:0,disable:!1,excludeRecursion:!1,delayUntilRecursion:!1,probability:100,useProbability:!0,depth:4,group:'',groupOverride:!1,groupWeight:100,scanDepth:null,caseSensitive:null,matchWholeWords:null,useGroupScoring:!1,automationId:'',role:0,sticky:0,cooldown:0,delay:0},{uid:ee(),key:[],keysecondary:[],comment:'变量',content:U.value,constant:!0,vectorized:!1,selective:!1,selectiveLogic:0,addMemo:!1,order:100,position:1,disable:!1,excludeRecursion:!1,delayUntilRecursion:!1,probability:100,useProbability:!0,depth:0,group:'',groupOverride:!1,groupWeight:100,scanDepth:null,caseSensitive:null,matchWholeWords:null,useGroupScoring:!1,automationId:'',role:0,sticky:0,cooldown:0,delay:0}],t=JSON.stringify(n,null,2),a=new Blob([t],{type:'application/json'}),o=URL.createObjectURL(a),r=document.createElement('a');r.href=o,r.download=`${e}_MVU_worldbook.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),window.toastr.success('✅ 已导出世界书 JSON：[InitVar] + 变量规则')}()},100)):window.toastr.error('请先生成 [InitVar] 结构')}function ee(){return Date.now()+Math.floor(1e3*Math.random())}w(()=>{!function(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法加载 MVU 配置');const n=`${e}_mvu_beta_config`,t=localStorage.getItem(n);if(t){const e=JSON.parse(t);e.varName&&(D.value=e.varName),e.subFields&&(L.value=e.subFields),e.generatedStructure&&(H.value=e.generatedStructure),e.variableCategories&&(V.value=e.variableCategories),e.generatedPrompt&&(U.value=e.generatedPrompt),console.log('✅ 已加载保存的 MVU Beta 配置')}}catch(e){console.error('加载 MVU Beta 配置失败:',e)}}()});let ne=null;return t([D,L,H,V,U],()=>{ne&&clearTimeout(ne),ne=window.setTimeout(()=>{!function(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存 MVU 配置');const n=`${e}_mvu_beta_config`,t={varName:D.value,subFields:L.value,generatedStructure:H.value,variableCategories:V.value,generatedPrompt:U.value};localStorage.setItem(n,JSON.stringify(t))}catch(e){console.error('保存 MVU Beta 配置失败:',e)}}()},1e3)}),(e,n)=>(r(),a(f,null,[i('div',hr,[i('div',yr,[i('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'16px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>v('structure')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[n[41]||(n[41]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-database',style:{color:'#4a9eff','font-size':'18px'}}),d(' [InitVar] 变量结构生成器 ')],-1)),i('i',{class:x(y.value.structure?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),y.value.structure?(r(),a('div',vr,[n[57]||(n[57]=u('<div class="tool-instructions" style="margin-bottom:15px;" data-v-27231230><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-27231230><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-27231230></i> 生成符合 MVU Beta 规范的 <strong style="color:#4a9eff;" data-v-27231230>[InitVar]</strong> 初始化数据。 </p><p style="margin:0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-27231230> ⚠️ 重要：InitVar JSON 中<strong data-v-27231230>不要包含 &quot;stat_data&quot; 根节点</strong>，系统会自动添加 </p></div>',1)),i('div',wr,[n[46]||(n[46]=i('h4',{style:{color:'#667eea','font-size':'14px',margin:'0 0 12px 0',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-wand-magic-sparkles'}),d(' AI 智能生成（推荐） ')],-1)),i('div',kr,[n[42]||(n[42]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 描述你的变量需求： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>I.value=e),placeholder:'例如：我需要一个角色属性系统，包含名字（字符串）、等级（数字，初始为1）、好感度（数字，范围-30到100）、背包（可扩展数组）、成就（可扩展对象）',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[4]||(n[4]=e=>e.target.style.borderColor='#667eea'),onBlur:n[5]||(n[5]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,I.value]])]),i('button',{class:'ai-generate-btn',disabled:S.value||!I.value.trim(),style:g([{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},{opacity:S.value||!I.value.trim()?.6:1,cursor:S.value||!I.value.trim()?'not-allowed':'pointer'}]),onClick:Y,onMouseenter:n[6]||(n[6]=e=>{!S.value&&I.value.trim()&&(e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)')}),onMouseleave:n[7]||(n[7]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[n[43]||(n[43]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[44]||(n[44]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1)),i('span',Tr,c(S.value?'AI 生成中...':'AI 智能生成'),1)],44,_r),H.value&&E.value?(r(),a('button',{key:0,style:{'margin-left':'12px',padding:'10px 20px',background:'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',border:'1px solid rgba(251, 191, 36, 0.4)','border-radius':'8px',color:'#fbbf24','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.2)'},onClick:n[8]||(n[8]=e=>O.value=!0),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.35), rgba(245, 158, 11, 0.45))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.6)',e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.35)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.4)',e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.2)'})},[...n[45]||(n[45]=[i('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1),d(' AI 修改 ',-1)])],32)):o('',!0),n[47]||(n[47]=i('p',{style:{color:'#888','font-size':'11px',margin:'8px 0 0 0'}},' 💡 AI 会根据你的描述自动生成结构、选择类型、配置 $meta ',-1))]),n[58]||(n[58]=i('div',{style:{'text-align':'center',margin:'20px 0',position:'relative'}},[i('span',{style:{background:'#1a1a1a',padding:'0 12px',color:'#666','font-size':'12px',position:'relative','z-index':'1'}},'或手动配置'),i('div',{style:{position:'absolute',top:'50%',left:'0',right:'0',height:'1px',background:'rgba(255, 255, 255, 0.1)','z-index':'0'}})],-1)),i('div',zr,[n[48]||(n[48]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 变量名称： ',-1)),l(i('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>D.value=e),type:'text',placeholder:'例如：角色、背包、技能',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'all 0.2s ease'},onFocus:n[12]||(n[12]=e=>e.target.style.borderColor='#4a9eff'),onBlur:n[13]||(n[13]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,D.value]])]),i('div',Ir,[n[49]||(n[49]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 子字段（每行一个，格式：字段名:类型:描述）： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[14]||(n[14]=e=>L.value=e),placeholder:'例如：\n好感度:number:[-30,100]之间，与角色交流时变化\n名字:string:角色名称\n背包:array:获得或使用物品时更新',rows:'5',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'\'Courier New\', monospace','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[15]||(n[15]=e=>e.target.style.borderColor='#4a9eff'),onBlur:n[16]||(n[16]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,L.value]]),n[50]||(n[50]=i('p',{style:{color:'#888','font-size':'11px',margin:'6px 0 0 0'}},'💡 支持类型：number、string、array、object',-1))]),i('button',{class:'generate-btn',style:{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:F,onMouseenter:n[17]||(n[17]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'}),onMouseleave:n[18]||(n[18]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[...n[51]||(n[51]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1),i('span',{style:{position:'relative','z-index':'1'}},'生成 [InitVar] 结构',-1)])],32),H.value?(r(),a('div',Sr,[n[56]||(n[56]=i('h4',{style:{color:'#4a9eff','font-size':'14px','margin-bottom':'10px'}},'生成的 [InitVar] 结构：',-1)),i('div',Ar,[i('pre',null,c(H.value),1),i('button',{class:'copy-btn-abs',onClick:B},[...n[52]||(n[52]=[i('i',{class:'fa-solid fa-copy'},null,-1)])])]),i('div',$r,[n[55]||(n[55]=i('p',{style:{margin:'0 0 10px 0',color:'#4a9eff','font-size':'12px','font-weight':'600'}},[i('i',{class:'fa-solid fa-link'}),d(' 基于此结构继续生成： ')],-1)),i('div',Cr,[i('button',{style:{flex:'1','min-width':'140px',padding:'8px 16px',background:'linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3))',color:'#10b981',border:'1px solid rgba(16, 185, 129, 0.4)','border-radius':'6px','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:Z,onMouseenter:n[19]||(n[19]=e=>{e.currentTarget.style.transform='translateY(-1px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'}),onMouseleave:n[20]||(n[20]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='none'})},[...n[53]||(n[53]=[i('i',{class:'fa-solid fa-file-alt'},null,-1),d(' 生成 COT 提示词 ',-1)])],32),i('button',{style:{flex:'1','min-width':'140px',padding:'8px 16px',background:'linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.3))',color:'#f59e0b',border:'1px solid rgba(245, 158, 11, 0.4)','border-radius':'6px','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:Q,onMouseenter:n[21]||(n[21]=e=>{e.currentTarget.style.transform='translateY(-1px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'}),onMouseleave:n[22]||(n[22]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='none'})},[...n[54]||(n[54]=[i('i',{class:'fa-solid fa-book'},null,-1),d(' 导出世界书 JSON ',-1)])],32)])])])):o('',!0)])):o('',!0)]),i('div',Er,[i('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'16px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[23]||(n[23]=e=>v('prompt')),onMouseenter:n[24]||(n[24]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[25]||(n[25]=e=>e.currentTarget.style.transform='translateY(0)')},[n[59]||(n[59]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-file-code',style:{color:'#fbbf24','font-size':'18px'}}),d(' COT 提示词生成器（6 步思维链） ')],-1)),i('i',{class:x(y.value.prompt?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),y.value.prompt?(r(),a('div',Mr,[n[71]||(n[71]=i('div',{class:'tool-instructions',style:{'margin-bottom':'15px'}},[i('p',{style:{margin:'0 0 8px 0',color:'#ccc','font-size':'12px'}},[i('i',{class:'fa-solid fa-info-circle',style:{'margin-right':'6px',color:'#17a2b8'}}),d(' 生成适用于 MVU Beta 的 '),i('strong',{style:{color:'#fbbf24'}},'COT（思维链）提示词模板'),d('，包含 6 步分析流程。 ')])],-1)),i('div',Pr,[n[64]||(n[64]=i('h4',{style:{color:'#fbbf24','font-size':'14px',margin:'0 0 12px 0',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-wand-magic-sparkles'}),d(' AI 智能生成（推荐） ')],-1)),i('div',Or,[n[60]||(n[60]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 描述你的变量系统和使用场景： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[26]||(n[26]=e=>A.value=e),placeholder:'例如：我的角色卡有一个好感度系统和时间系统，需要 AI 在每次互动后更新时间和好感度',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[27]||(n[27]=e=>e.target.style.borderColor='#fbbf24'),onBlur:n[28]||(n[28]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,A.value]])]),i('button',{class:'ai-generate-btn',disabled:C.value||!A.value.trim(),style:g([{padding:'12px 24px',background:'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(251, 191, 36, 0.3)',position:'relative',overflow:'hidden'},{opacity:C.value||!A.value.trim()?.6:1,cursor:C.value||!A.value.trim()?'not-allowed':'pointer'}]),onClick:q,onMouseenter:n[29]||(n[29]=e=>{!C.value&&A.value.trim()&&(e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.4)')}),onMouseleave:n[30]||(n[30]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(251, 191, 36, 0.3)'})},[n[61]||(n[61]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[62]||(n[62]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1)),i('span',Rr,c(C.value?'AI 生成中...':'AI 智能生成'),1)],44,jr),U.value&&P.value?(r(),a('button',{key:0,style:{'margin-left':'12px',padding:'10px 20px',background:'linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',border:'1px solid rgba(251, 191, 36, 0.4)','border-radius':'8px',color:'#fbbf24','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 8px rgba(251, 191, 36, 0.2)'},onClick:n[31]||(n[31]=e=>R.value=!0),onMouseenter:n[32]||(n[32]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.35), rgba(245, 158, 11, 0.45))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.6)',e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 4px 12px rgba(251, 191, 36, 0.35)'}),onMouseleave:n[33]||(n[33]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.3))',e.currentTarget.style.borderColor='rgba(251, 191, 36, 0.4)',e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 2px 8px rgba(251, 191, 36, 0.2)'})},[...n[63]||(n[63]=[i('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1),d(' AI 修改 ',-1)])],32)):o('',!0),n[65]||(n[65]=i('p',{style:{color:'#888','font-size':'11px',margin:'8px 0 0 0'}},' 💡 AI 会根据你的描述自动生成完整的 6 步 COT 提示词 ',-1))]),n[72]||(n[72]=i('div',{style:{'text-align':'center',margin:'20px 0',position:'relative'}},[i('span',{style:{background:'#1a1a1a',padding:'0 12px',color:'#666','font-size':'12px',position:'relative','z-index':'1'}},'或手动配置'),i('div',{style:{position:'absolute',top:'50%',left:'0',right:'0',height:'1px',background:'rgba(255, 255, 255, 0.1)','z-index':'0'}})],-1)),H.value?(r(),a('div',Nr,[n[66]||(n[66]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 变量分类（用于 STEP 3，每行一个分类）： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[34]||(n[34]=e=>V.value=e),placeholder:'例如：\n基础信息 - 3 fields\n人物关系 - 2 fields\n重要记忆 - 1 field',rows:'4',style:{width:'100%',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'\'Courier New\', monospace','line-height':'1.5',transition:'all 0.2s ease'},onFocus:n[35]||(n[35]=e=>e.target.style.borderColor='#fbbf24'),onBlur:n[36]||(n[36]=e=>e.target.style.borderColor='#3a3a3a')},null,544),[[p,V.value]]),n[67]||(n[67]=i('p',{style:{color:'#888','font-size':'11px',margin:'6px 0 0 0'}},'💡 AI 会在 STEP 3 中按照这些分类逐个检查变量',-1))])):o('',!0),i('button',{class:'generate-btn',style:{'margin-top':'10px',padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:G,onMouseenter:n[37]||(n[37]=e=>{e.currentTarget.style.transform='translateY(-2px)',e.currentTarget.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'}),onMouseleave:n[38]||(n[38]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.boxShadow='0 3px 12px rgba(102, 126, 234, 0.3)'})},[...n[68]||(n[68]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px',position:'relative','z-index':'1'}},null,-1),i('span',{style:{position:'relative','z-index':'1'}},'生成 COT 提示词',-1)])],32),U.value?(r(),a('div',Dr,[n[70]||(n[70]=i('h4',{style:{color:'#fbbf24','font-size':'14px','margin-bottom':'10px'}},'生成的 COT 提示词：',-1)),i('div',Lr,[i('pre',null,c(U.value),1),i('button',{class:'copy-btn-abs',onClick:W},[...n[69]||(n[69]=[i('i',{class:'fa-solid fa-copy'},null,-1)])])])])):o('',!0)])):o('',!0)])]),k(Po,{show:O.value,'is-modifying':j.value,title:'AI 修改 [InitVar] 结构',description:'告诉 AI 你想如何修改当前的 MVU 结构',examples:['增加一个【健康值】字段，类型为 number','删除【背包】字段','将【好感度】的描述改为更详细的说明','调整字段顺序，把【时间】放到最前面'],onClose:n[39]||(n[39]=e=>O.value=!1),onConfirm:X},null,8,['show','is-modifying']),k(Po,{show:R.value,'is-modifying':N.value,title:'AI 修改 COT 提示词',description:'告诉 AI 你想如何修改当前的提示词',examples:['在 STEP 2 中添加对场景变化的检查','强调时间必须精确到分钟','增加对特殊状态的处理说明','简化 STEP 3 的分析步骤'],onClose:n[40]||(n[40]=e=>R.value=!1),onConfirm:K},null,8,['show','is-modifying'])],64))}}),Vr=xo(Hr,[['__scopeId','data-v-27231230']]),Ur={key:0,class:'progress-overlay',style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.85)',display:'flex','align-items':'center','justify-content':'center','z-index':'999999',animation:'fadeIn 0.2s ease'}},Jr={class:'progress-card',style:{background:'linear-gradient(145deg, #2a2a2a, #1e1e1e)','border-radius':'16px',padding:'35px',width:'520px','max-width':'90vw','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',border:'1px solid #3a3a3a',animation:'slideUp 0.3s ease'}},Fr={style:{display:'flex','align-items':'center',gap:'12px','margin-bottom':'24px'}},Br={style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600'}},Yr={class:'progress-bar-container',style:{width:'100%',height:'10px',background:'rgba(30, 30, 30, 0.8)','border-radius':'5px',overflow:'hidden','margin-bottom':'20px','box-shadow':'inset 0 1px 3px rgba(0, 0, 0, 0.3)'}},Zr={class:'current-stage',style:{color:'#e0e0e0','font-size':'14px','margin-bottom':'12px','min-height':'20px'}},Gr={key:0,class:'details-area',style:{'max-height':'150px','overflow-y':'auto',background:'rgba(10, 10, 10, 0.5)','border-radius':'8px',padding:'12px','margin-bottom':'16px','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'11px',color:'#a0a0a0','line-height':'1.6'}},Wr={style:{display:'flex','justify-content':'space-between','align-items':'center'}},qr={class:'progress-percent',style:{color:'#4a9eff','font-size':'16px','font-weight':'600'}},Xr={class:'elapsed-time',style:{color:'#888','font-size':'12px'}},Kr=xo(e({__name:'ProgressDialog',props:{show:{type:Boolean},title:{default:'AI 正在处理'},initialMessage:{default:'正在准备...'},cancellable:{type:Boolean,default:!1}},emits:['cancel'],setup(e,{expose:s}){const l=e,p=n(0),u=n(0),x=n(l.initialMessage),b=n([]),h=n(0),y=n(0);let v=null,w=null;return t(()=>l.show,e=>{e?(p.value=0,u.value=0,x.value=l.initialMessage,b.value=[],h.value=Date.now(),y.value=0,v&&clearInterval(v),v=window.setInterval(()=>{y.value=Math.floor((Date.now()-h.value)/1e3)},1e3),w&&clearInterval(w),w=window.setInterval(()=>{if(u.value<p.value){const e=p.value-u.value;u.value+=Math.max(.5,.1*e),u.value>p.value&&(u.value=p.value)}else p.value<95&&u.value>=p.value-.5&&(u.value+=.2,u.value>p.value+5&&(u.value=p.value+5))},100)):(v&&(clearInterval(v),v=null),w&&(clearInterval(w),w=null))}),P(()=>{v&&clearInterval(v),w&&clearInterval(w)}),s({setProgress:function(e){p.value=Math.min(100,Math.max(0,e))},setMessage:function(e){x.value=e},addDetail:function(e){b.value.push(e),setTimeout(()=>{const e=document.querySelector('.details-area');e&&(e.scrollTop=e.scrollHeight)},50)},clearDetails:function(){b.value=[]},complete:function(){p.value=100,x.value='完成！'}}),(n,t)=>e.show?(r(),a('div',Ur,[i('div',Jr,[i('div',Fr,[t[3]||(t[3]=i('div',{class:'spinner',style:{width:'28px',height:'28px',border:'3px solid #3a3a3a','border-top-color':'#4a9eff','border-radius':'50%',animation:'spin 0.8s linear infinite'}},null,-1)),i('h3',Br,c(e.title),1)]),i('div',Yr,[i('div',{class:'progress-bar',style:g({width:u.value+'%',height:'100%',background:'#4a9eff',transition:'width 0.5s ease-out',boxShadow:'0 0 10px rgba(74, 158, 255, 0.5)'})},null,4)]),i('div',Zr,c(x.value),1),b.value.length>0?(r(),a('div',Gr,[(r(!0),a(f,null,m(b.value,(e,n)=>(r(),a('div',{key:n,style:{'margin-bottom':'4px'}},[t[4]||(t[4]=i('span',{style:{color:'#4a9eff'}},'•',-1)),d(' '+c(e),1)]))),128))])):o('',!0),i('div',Wr,[i('div',qr,c(Math.round(u.value))+'% ',1),i('div',Xr,'已耗时: '+c(y.value)+'秒',1)]),e.cancellable?(r(),a('button',{key:1,style:{width:'100%','margin-top':'20px',padding:'10px',background:'#3a3a3a',border:'1px solid #4a4a4a','border-radius':'8px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s'},onMouseenter:t[0]||(t[0]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:t[1]||(t[1]=e=>e.currentTarget.style.background='#3a3a3a'),onClick:t[2]||(t[2]=e=>n.$emit('cancel'))},' 取消 ',32)):o('',!0)])])):o('',!0)}}),[['__scopeId','data-v-e188e1f6']]),Qr={class:'project-tab'},es={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 28px',background:'#2a2a2a','backdrop-filter':'blur(12px)','border-radius':'14px','margin-bottom':'20px',border:'1px solid #333','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'}},ns={class:'project-action-buttons',style:{display:'flex',gap:'10px'}},ts={style:{display:'grid','grid-template-columns':'220px 1fr 650px',gap:'20px','min-height':'500px'}},as={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},os={key:0,style:{'text-align':'center',color:'#666','font-size':'12px',padding:'20px 10px'}},rs=['onClick','onMouseenter','onMouseleave'],ss={style:{'font-size':'13px',flex:'1'}},is=['onClick'],ls={key:1,style:{'margin-top':'20px','border-top':'1px solid #3a3a3a','padding-top':'15px'}},ds={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'10px'}},cs={style:{display:'flex',gap:'5px'}},ps=['onClick','onMouseenter','onMouseleave'],us=['onClick'],gs={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},fs={key:0,style:{flex:'1',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px'}},ms={key:1,style:{flex:'1',display:'flex','align-items':'center','justify-content':'center',color:'#666','font-size':'14px'}},xs={key:2,style:{display:'flex','flex-direction':'column',height:'100%'}},bs={style:{'margin-bottom':'10px',display:'flex','justify-content':'space-between','align-items':'center'}},hs={style:{display:'flex','align-items':'center',gap:'8px'}},ys={style:{color:'#fff','font-size':'14px','font-weight':'500'}},vs={style:{display:'flex','align-items':'center',gap:'10px'}},ws=['placeholder'],ks={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},_s={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'15px'}},Ts={style:{display:'flex',gap:'8px'}},zs={style:{flex:'1',background:'#1e1e1e','border-radius':'8px',overflow:'auto',position:'relative','min-height':'400px'}},Is=['srcdoc'],Ss={key:1,style:{position:'absolute',top:'50%',left:'50%',transform:'translate(-50%, -50%)',color:'#666','font-size':'12px','text-align':'center'}},As={style:{background:'#2a2a2a','border-radius':'16px',padding:'25px',width:'90%','max-width':'600px',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},$s={style:{'margin-bottom':'15px'}},Cs={style:{'margin-top':'12px'}},Es={style:{display:'flex','flex-wrap':'wrap',gap:'8px'}},Ms=['onClick'],Ps={style:{display:'flex','align-items':'center',gap:'10px','margin-bottom':'15px',padding:'10px',background:'#252525','border-radius':'6px'}},Os={style:{display:'flex','align-items':'center',gap:'8px',cursor:'pointer',color:'#ccc','font-size':'13px','user-select':'none'}},js={key:0,style:{'margin-bottom':'15px',padding:'15px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px','max-height':'200px','overflow-y':'auto','font-family':'\'Consolas\', monospace','font-size':'12px',color:'#e0e0e0','line-height':'1.5','white-space':'pre-wrap'}},Rs={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Ns=['disabled'],Ds={key:0,class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},Ls={key:1,class:'fa-solid fa-spinner fa-spin',style:{'margin-right':'6px'}},Hs={style:{background:'#2a2a2a','border-radius':'16px',padding:'25px',width:'90%','max-width':'650px',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},Vs={style:{'margin-bottom':'15px'}},Us={style:{'margin-bottom':'15px'}},Js={style:{'margin-bottom':'15px'}},Fs={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Bs=['disabled'],Ys={key:0,class:'fa-solid fa-wrench',style:{'margin-right':'6px'}},Zs={key:1,class:'fa-solid fa-spinner fa-spin',style:{'margin-right':'6px'}},Gs={key:2,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.9)',display:'flex','align-items':'center','justify-content':'center','z-index':'10001',padding:'20px'}},Ws={style:{background:'#2a2a2a','border-radius':'16px',width:'95%',height:'90%',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',display:'flex','flex-direction':'column'}},qs={style:{padding:'20px 25px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},Xs={style:{display:'flex',gap:'10px'}},Ks={style:{flex:'1',display:'grid','grid-template-columns':'1fr 1fr 1.5fr',gap:'15px',padding:'20px',overflow:'hidden'}},Qs={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},ei={style:{flex:'1','overflow-y':'auto',padding:'15px'}},ni={style:{color:'#4a9eff','font-size':'12px','font-weight':'600','margin-bottom':'8px',display:'flex','align-items':'center',gap:'6px'}},ti={style:{margin:'0',padding:'12px',background:'#1a1a1a','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.5','overflow-x':'auto',border:'1px solid #3a3a3a'}},ai={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},oi={style:{flex:'1','overflow-y':'auto',padding:'15px'}},ri={style:{color:'#4a9eff','font-size':'12px','font-weight':'600','margin-bottom':'8px',display:'flex','align-items':'center',gap:'6px'}},si={style:{margin:'0',padding:'12px',background:'#1a1a1a','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'12px','line-height':'1.5','overflow-x':'auto',border:'1px solid #3a3a3a'}},ii={style:{display:'flex','flex-direction':'column',background:'#1e1e1e','border-radius':'8px',overflow:'hidden'}},li={style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},di={style:{display:'flex',gap:'8px'}},ci={style:{flex:'1',background:'white',overflow:'hidden'}},pi=['srcdoc'],ui={style:{background:'#2a2a2a','border-radius':'16px',width:'90%','max-width':'900px','max-height':'80%',border:'1px solid #3a3a3a','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)',display:'flex','flex-direction':'column'}},gi={style:{padding:'20px 25px','border-bottom':'1px solid #3a3a3a',display:'flex','justify-content':'space-between','align-items':'center'}},fi={style:{flex:'1','overflow-y':'auto',padding:'20px'}},mi={key:0,style:{'text-align':'center',color:'#666',padding:'40px 20px'}},xi={style:{display:'flex','justify-content':'space-between','align-items':'start','margin-bottom':'10px'}},bi={style:{color:'#fff','font-size':'14px','font-weight':'600','margin-bottom':'5px'}},hi={style:{color:'#888','font-size':'12px'}},yi=['onClick'],vi={style:{color:'#ccc','font-size':'13px','margin-top':'10px'}},wi={style:{'margin-top':'5px',display:'flex','flex-wrap':'wrap',gap:'8px'}},ki={style:{background:'#1e1e1e','border-radius':'16px','max-width':'850px',width:'100%','max-height':'90vh','overflow-y':'auto','box-shadow':'0 20px 60px rgba(0, 0, 0, 0.8)',border:'1px solid #333'}},_i={style:{padding:'24px 28px','border-bottom':'1px solid #2a2a2a',display:'flex','justify-content':'space-between','align-items':'center'}},Ti={style:{padding:'28px'}},zi={style:{display:'grid','grid-template-columns':'repeat(auto-fit, minmax(240px, 1fr))',gap:'20px'}},Ii=e({__name:'ProjectManager',setup(e){const u=n([]),h=n(''),w=n(''),S=n(''),A=n(''),C=n(!1),E=n(''),P=n(!1),L=n(!1),H=n(''),V=n(!1),U=n([]),J=n('after'),F=n(!1),B=n({}),Y=['添加响应式布局，支持移动端和桌面端','添加深色/浅色主题切换功能','优化代码结构，提取可复用组件','添加加载动画和骨架屏','添加表单验证和错误提示','优化性能，减少不必要的渲染','添加键盘快捷键支持','改进无障碍访问（ARIA）'],Z=n(!1),G=n(null),W=y(),q=n(!1),X=n(!1),K=n(''),Q=n(''),ee=n(''),ne=n(null),te=v(()=>u.value.find(e=>e.id===h.value)),ae=v(()=>B.value[h.value]||[]),oe=v(()=>{if(0===U.value.length)return'';const e=te.value;if(!e)return'';return me(e.files.map(e=>{const n=U.value.find(n=>n.path===e.path);return{...e,content:n?'after'===J.value?n.newContent:n.oldContent:e.content}}))}),re={'同层对话界面':{name:'同层对话界面',description:'流式对话、消息历史、正则清理',icon:'💬',color:'#4a9eff',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>同层对话界面</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="chat-container">\n      <div class="message-list" id="messageList"></div>\n      <div class="input-area">\n        <textarea id="userInput" placeholder="输入消息..."></textarea>\n        <button id="sendBtn">发送</button>\n      </div>\n    </div>\n  </div>\n  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"><\/script>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n}\n\n.chat-container {\n  max-width: 800px;\n  margin: 20px auto;\n  height: calc(100vh - 40px);\n  display: flex;\n  flex-direction: column;\n  background: #2a2a2a;\n  border-radius: 12px;\n  overflow: hidden;\n}\n\n.message-list {\n  flex: 1;\n  padding: 20px;\n  overflow-y: auto;\n}\n\n.message {\n  margin-bottom: 15px;\n  padding: 10px 15px;\n  border-radius: 8px;\n  max-width: 70%;\n}\n\n.message.user {\n  background: #4a9eff;\n  margin-left: auto;\n  text-align: right;\n}\n\n.message.assistant {\n  background: #3a3a3a;\n}\n\n.input-area {\n  padding: 15px;\n  background: #2a2a2a;\n  border-top: 1px solid #3a3a3a;\n  display: flex;\n  gap: 10px;\n}\n\n#userInput {\n  flex: 1;\n  padding: 10px;\n  background: #1a1a1a;\n  border: 1px solid #3a3a3a;\n  border-radius: 6px;\n  color: #e0e0e0;\n  resize: none;\n  height: 60px;\n}\n\n#sendBtn {\n  padding: 10px 20px;\n  background: #4a9eff;\n  border: none;\n  border-radius: 6px;\n  color: white;\n  cursor: pointer;\n  font-weight: 600;\n}\n\n#sendBtn:hover {\n  background: #357abd;\n}','script.js':'// 聊天历史\nlet chatHistory = [];\n\n// 从 localStorage 加载历史\nfunction loadHistory() {\n  try {\n    const saved = localStorage.getItem(\'chat_history_demo\');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } catch (e) {\n    console.error(\'加载历史失败:\', e);\n    chatHistory = [];\n  }\n  renderMessages();\n}\n\n// 保存到 localStorage\nfunction saveHistory() {\n  try {\n    localStorage.setItem(\'chat_history_demo\', JSON.stringify(chatHistory));\n  } catch (e) {\n    console.error(\'保存历史失败:\', e);\n  }\n}\n\n// 渲染消息\nfunction renderMessages() {\n  const list = document.getElementById(\'messageList\');\n  list.innerHTML = \'\';\n  chatHistory.forEach(msg => {\n    const div = document.createElement(\'div\');\n    div.className = \'message \' + msg.sender;\n    div.textContent = msg.content;\n    list.appendChild(div);\n  });\n  list.scrollTop = list.scrollHeight;\n}\n\n// 发送消息\nasync function sendMessage() {\n  const input = document.getElementById(\'userInput\');\n  const text = input.value.trim();\n  if (!text) return;\n\n  // 添加用户消息\n  chatHistory.push({\n    id: Date.now(),\n    sender: \'user\',\n    content: text,\n    timestamp: new Date().toLocaleTimeString()\n  });\n  input.value = \'\';\n  renderMessages();\n  saveHistory();\n\n  // 调用 AI（流式）\n  const prompt = \'【对话历史】\\n\' + chatHistory.map(m => m.sender + \': \' + m.content).join(\'\\n\');\n\n  let aiText = \'\';\n  await generate({\n    should_stream: true,\n    prompt: prompt,\n    on_stream_chunk: (chunk) => {\n      aiText += chunk;\n      // 实时显示\n      const tempMsg = { id: \'temp\', sender: \'assistant\', content: aiText };\n      const tempIndex = chatHistory.findIndex(m => m.id === \'temp\');\n      if (tempIndex >= 0) {\n        chatHistory[tempIndex] = tempMsg;\n      } else {\n        chatHistory.push(tempMsg);\n      }\n      renderMessages();\n    },\n    on_stream_end: () => {\n      // 完成，替换为正式消息\n      const tempIndex = chatHistory.findIndex(m => m.id === \'temp\');\n      if (tempIndex >= 0) {\n        chatHistory[tempIndex] = {\n          id: Date.now(),\n          sender: \'assistant\',\n          content: aiText,\n          timestamp: new Date().toLocaleTimeString()\n        };\n      }\n      renderMessages();\n      saveHistory();\n    }\n  });\n}\n\n// 初始化\n$(() => {\n  loadHistory();\n  document.getElementById(\'sendBtn\').addEventListener(\'click\', sendMessage);\n  document.getElementById(\'userInput\').addEventListener(\'keydown\', (e) => {\n    if (e.key === \'Enter\' && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  });\n});'}},'状态栏面板':{name:'状态栏面板',description:'HP/MP/经验值，进度条动画',icon:'📊',color:'#10b981',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>状态栏</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="status-panel">\n      <h2>角色状态</h2>\n      <div class="stat-item">\n        <label>生命值 (HP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill hp" id="hpBar"></div>\n        </div>\n        <span id="hpText">0/0</span>\n      </div>\n      <div class="stat-item">\n        <label>魔法值 (MP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill mp" id="mpBar"></div>\n        </div>\n        <span id="mpText">0/0</span>\n      </div>\n      <div class="stat-item">\n        <label>经验值 (EXP)</label>\n        <div class="progress-bar">\n          <div class="progress-fill exp" id="expBar"></div>\n        </div>\n        <span id="expText">0/0</span>\n      </div>\n    </div>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n  padding: 20px;\n}\n\n.status-panel {\n  max-width: 500px;\n  margin: 0 auto;\n  background: #2a2a2a;\n  border-radius: 12px;\n  padding: 25px;\n  border: 1px solid #3a3a3a;\n}\n\nh2 {\n  margin-bottom: 20px;\n  color: #4a9eff;\n}\n\n.stat-item {\n  margin-bottom: 20px;\n}\n\n.stat-item label {\n  display: block;\n  margin-bottom: 8px;\n  font-weight: 600;\n  font-size: 14px;\n}\n\n.progress-bar {\n  width: 100%;\n  height: 24px;\n  background: #1a1a1a;\n  border-radius: 12px;\n  overflow: hidden;\n  margin-bottom: 5px;\n}\n\n.progress-fill {\n  height: 100%;\n  transition: width 0.5s ease;\n  border-radius: 12px;\n}\n\n.progress-fill.hp {\n  background: linear-gradient(90deg, #ef4444, #10b981);\n}\n\n.progress-fill.mp {\n  background: linear-gradient(90deg, #3b82f6, #06b6d4);\n}\n\n.progress-fill.exp {\n  background: linear-gradient(90deg, #fbbf24, #f59e0b);\n}\n\n.stat-item span {\n  font-size: 13px;\n  color: #94a3b8;\n}','script.js':'// 从 localStorage 加载数据\nfunction loadStats() {\n  const saved = localStorage.getItem(\'rpg_stats_demo\');\n  const data = saved ? JSON.parse(saved) : {};\n\n  const hp = data.hp || 850;\n  const maxHp = data.maxHp || 1000;\n  const mp = data.mp || 340;\n  const maxMp = data.maxMp || 500;\n  const exp = data.exp || 1250;\n  const maxExp = data.maxExp || 2000;\n\n  // 更新进度条\n  updateBar(\'hp\', hp, maxHp);\n  updateBar(\'mp\', mp, maxMp);\n  updateBar(\'exp\', exp, maxExp);\n}\n\nfunction updateBar(type, current, max) {\n  const percent = (current / max) * 100;\n  document.getElementById(type + \'Bar\').style.width = percent + \'%\';\n  document.getElementById(type + \'Text\').textContent = current + \'/\' + max;\n}\n\n// 初始化\ndocument.addEventListener(\'DOMContentLoaded\', loadStats);'}},'好感度面板':{name:'好感度面板',description:'多角色卡片，爱心图标，好感度展示',icon:'💝',color:'#ec4899',files:{'index.html':'<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>好感度面板</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div id="app">\n    <div class="affection-container">\n      <h2>角色好感度</h2>\n      <div class="character-grid" id="characterGrid"></div>\n    </div>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>','style.css':'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', sans-serif;\n  background: #1a1a1a;\n  color: #e0e0e0;\n  padding: 20px;\n}\n\n.affection-container {\n  max-width: 900px;\n  margin: 0 auto;\n}\n\nh2 {\n  margin-bottom: 25px;\n  color: #ec4899;\n  text-align: center;\n}\n\n.character-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));\n  gap: 20px;\n}\n\n.character-card {\n  background: #2a2a2a;\n  border-radius: 12px;\n  padding: 20px;\n  border: 2px solid #3a3a3a;\n  transition: all 0.3s ease;\n}\n\n.character-card:hover {\n  transform: translateY(-5px);\n  border-color: #ec4899;\n  box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3);\n}\n\n.character-name {\n  font-size: 18px;\n  font-weight: 600;\n  margin-bottom: 15px;\n  color: #e0e0e0;\n}\n\n.affection-bar {\n  width: 100%;\n  height: 20px;\n  background: #1a1a1a;\n  border-radius: 10px;\n  overflow: hidden;\n  margin-bottom: 8px;\n}\n\n.affection-fill {\n  height: 100%;\n  background: linear-gradient(90deg, #ec4899, #f472b6);\n  transition: width 0.5s ease;\n  border-radius: 10px;\n}\n\n.affection-text {\n  font-size: 13px;\n  color: #94a3b8;\n}','script.js':'// 从 localStorage 加载角色数据\nfunction loadCharacters() {\n  const saved = localStorage.getItem(\'characters_affection_demo\');\n  const data = saved ? JSON.parse(saved) : {};\n  const characters = data.characters || [\n    { name: \'角色 A\', affection: 75 },\n    { name: \'角色 B\', affection: 50 },\n    { name: \'角色 C\', affection: 90 }\n  ];\n\n  const grid = document.getElementById(\'characterGrid\');\n  grid.innerHTML = \'\';\n\n  characters.forEach(char => {\n    const card = document.createElement(\'div\');\n    card.className = \'character-card\';\n    card.innerHTML = `\n      <div class="character-name">${char.name}</div>\n      <div class="affection-bar">\n        <div class="affection-fill" style="width: ${char.affection}%"></div>\n      </div>\n      <div class="affection-text">好感度: ${char.affection}/100</div>\n    `;\n    grid.appendChild(card);\n  });\n}\n\n// 初始化\ndocument.addEventListener(\'DOMContentLoaded\', loadCharacters);'}}};function se(){q.value=!0}function ie(e){const n=re[e];if(!n)return;const t=prompt('项目名称:',n.name);if(!t||!t.trim())return;const a={id:Date.now().toString(),name:t.trim(),files:Object.entries(n.files).map(([e,n])=>({path:e,name:e,content:n}))};u.value.push(a),h.value=a.id,w.value=a.files[0]?.name||'',S.value=a.files[0]?.content||'',be(),q.value=!1,window.toastr.success('✅ 项目"'+t.trim()+'"创建成功！')}function le(){ne.value&&(ne.value.value='',ne.value.click())}async function de(e){const n=e.target.files;if(n&&0!==n.length)try{const e=n[0],t=e.webkitRelativePath.split('/')[0]||'导入的项目',a=prompt('项目名称:',t);if(!a||!a.trim())return;const o=['.html','.css','.js','.ts','.scss','.sass','.json','.txt','.md'],r=[],s=[];for(let l=0;l<n.length;l++){const e=n[l],t=e.webkitRelativePath.split('/').slice(1).join('/');if(!t||t.startsWith('.')||t.includes('/.'))continue;if(t.includes('node_modules/')||t.includes('dist/')||t.includes('.git/')||t.includes('build/'))continue;const a='.'+t.split('.').pop()?.toLowerCase();if(!o.includes(a))continue;const i=new Promise((n,a)=>{const o=new FileReader;o.onload=e=>{const a=e.target?.result,o=t.split('/').pop()||t;r.push({path:t,name:o,content:a||''}),n()},o.onerror=()=>a(new Error(`读取文件失败: ${t}`)),o.readAsText(e)});s.push(i)}if(await Promise.all(s),0===r.length)return void window.toastr.warning('未找到可导入的文件（支持的格式：HTML、CSS、JS、TS、SCSS 等）');const i={id:Date.now().toString(),name:a.trim(),files:r};u.value.push(i),h.value=i.id,w.value=i.files[0]?.path||'',S.value=i.files[0]?.content||'',be(),xe(),window.toastr.success(`成功导入项目"${a}"，共 ${r.length} 个文件`)}catch(t){console.error('导入文件夹失败:',t),window.toastr.error('导入文件夹失败: '+t.message)}}function ce(){const e=prompt('项目名称:');if(!e||!e.trim())return;const n=`<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>${e.trim()}</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div class="container">\n    <h1>欢迎来到 ${e.trim()}!</h1>\n    <p>开始你的创作之旅</p>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>`,t={id:Date.now().toString(),name:e.trim(),files:[{path:'index.html',name:'index.html',content:n},{path:'style.css',name:'style.css',content:'* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n\nbody {\n  font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  color: #333;\n  min-height: 100vh;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.container {\n  background: white;\n  padding: 60px 40px;\n  border-radius: 20px;\n  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n  text-align: center;\n  max-width: 600px;\n}\n\nh1 {\n  font-size: 2.5em;\n  color: #667eea;\n  margin-bottom: 20px;\n}\n\np {\n  font-size: 1.2em;\n  color: #666;\n  line-height: 1.6;\n}'},{path:'script.js',name:'script.js',content:'console.log(\'项目已启动！\');\n\n// 使用 jQuery 确保 DOM 加载完成\n$(function() {\n  console.log(\'页面加载完成\');\n\n  // ========== 检测是否在酒馆环境中 ==========\n  const isInTavern = typeof SillyTavern !== \'undefined\';\n\n  if (!isInTavern) {\n    console.log(\'预览模式：当前在预览窗口中，酒馆 API 不可用\');\n  }\n\n  // ========== 数据持久化示例（使用 localStorage）==========\n  const storageKey = \'my_project_data\'; // 自定义存储键名\n\n  // 加载数据\n  function loadData() {\n    try {\n      const stored = localStorage.getItem(storageKey);\n      return stored ? JSON.parse(stored) : { count: 0 };\n    } catch (e) {\n      console.error(\'加载数据失败:\', e);\n      return { count: 0 };\n    }\n  }\n\n  // 保存数据到 localStorage\n  function saveData(data) {\n    try {\n      localStorage.setItem(storageKey, JSON.stringify(data));\n      console.log(\'数据已保存到 localStorage:\', data);\n    } catch (e) {\n      console.error(\'保存数据失败:\', e);\n    }\n  }\n\n  // 初始化\n  let myData = loadData();\n  console.log(\'加载的数据:\', myData);\n\n  // ========== 示例：点击计数器 ==========\n  const container = $(\'.container\');\n  if (container.length) {\n    container.on(\'click\', function() {\n      myData.count++;\n      saveData(myData);\n      if (typeof toastr !== \'undefined\') {\n        toastr.success(`点击次数: ${myData.count}`);\n      } else {\n        alert(`点击次数: ${myData.count}`);\n      }\n    });\n  }\n\n  // 页面卸载时保存（可选）\n  $(window).on(\'pagehide\', function() {\n    saveData(myData);\n  });\n});'}]};u.value.push(t),console.log('新建项目:',t.name,'项目总数:',u.value.length),be(),h.value=t.id,w.value='index.html',S.value=n,xe(),toastr.success(`项目 "${t.name}" 已创建并保存`)}function pe(){const e=te.value;if(!e||!w.value)return void toastr.error('请先选择一个文件');const n=e.files.find(e=>e.path===w.value);n&&(n.content=S.value,ye&&(clearTimeout(ye),ye=null),be(),xe(),toastr.success('已保存'))}function ue(){const e=te.value;if(!e)return;const n=prompt('请输入文件夹路径：\n例如：css 或 js/utils','');if(!n||!n.trim())return;const t=n.trim().replace(/\/$/,''),a=`${t}/.gitkeep`;if(e.files.some(e=>e.path.startsWith(`${t}/`)))return void window.toastr.warning(`文件夹 "${t}" 已存在（包含文件）`);const o={path:a,name:'.gitkeep',content:'# 此文件用于保持文件夹结构\n'};e.files.push(o),be(),window.toastr.success(`文件夹 "${t}" 已创建`)}function ge(){const e=te.value;if(!e)return;const n=new Set;n.add(''),e.files.forEach(e=>{const t=e.path.split('/');if(t.length>1)for(let a=1;a<t.length;a++){const e=t.slice(0,a).join('/');e&&n.add(e)}});const t=Array.from(n).sort(),a=[{name:'HTML 文件',ext:'.html',icon:'🌐'},{name:'CSS 文件',ext:'.css',icon:'🎨'},{name:'JavaScript 文件',ext:'.js',icon:'⚡'},{name:'TypeScript 文件',ext:'.ts',icon:'📘'},{name:'JSON 文件',ext:'.json',icon:'📄'},{name:'Markdown 文件',ext:'.md',icon:'📝'},{name:'其他文件',ext:'',icon:'📋'}],o=a.map((e,n)=>`${n+1}. ${e.icon} ${e.name} (${e.ext||'自定义'})`).join('\n'),r=prompt(`请选择文件类型（输入序号 1-${a.length}）：\n\n${o}`,'1');if(!r)return;const s=parseInt(r)-1;if(s<0||s>=a.length)return void window.toastr.error('无效的选项');const i=a[s];let l='';if(t.length>1){const e=t.length>5?'输入文件夹路径（留空为根目录）：':`请选择目标文件夹（输入序号）：\n\n${t.map((e,n)=>`${n+1}. ${e||'根目录'}`).join('\n')}\n\n或直接输入文件夹路径：`,n=prompt(e,'1');if(!n)return;const a=parseInt(n)-1;l=a>=0&&a<t.length?t[a]:n.trim().replace(/\/$/,'')}const d=prompt(`请输入文件名${i.ext?`（将自动添加 ${i.ext}）`:'（需包含扩展名）'}：`,i.ext?'new-file':'newfile.txt');if(!d||!d.trim())return;let c=d.trim();i.ext&&!c.endsWith(i.ext)&&(c+=i.ext);const p=l?`${l}/${c}`:c;if(e.files.some(e=>e.path===p))return void window.toastr.error(`文件 "${p}" 已存在！`);const u=c.split('.').pop()?.toLowerCase();let g='';switch(u){case'html':g='<!DOCTYPE html>\n<html lang="zh-CN">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>'+c.replace('.html','')+'</title>\n  <link rel="stylesheet" href="style.css">\n</head>\n<body>\n  <div class="container">\n    <h1>欢迎</h1>\n  </div>\n  <script src="script.js"><\/script>\n</body>\n</html>';break;case'css':case'scss':case'sass':g=`/* ${c} */\n\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\n`;break;case'js':case'ts':g=`// ${c}\n\nconsole.log('${c} 已加载');\n\n$(function() {\n  // 在这里编写代码\n});\n`;break;case'json':g=`{\n  "name": "${c.replace('.json','')}",\n  "version": "1.0.0"\n}`;break;case'md':g=`# ${c.replace(/\.md$/,'')}\n\n`;break;default:g=''}const f={path:p,name:c,content:g};e.files.push(f),w.value=p,S.value=g,be(),xe(),window.toastr.success(`文件 "${p}" 已创建`)}function fe(e){const n=e.split('.').pop()?.toLowerCase();return'html'===n?'fa-brands fa-html5':'css'===n?'fa-brands fa-css3-alt':'js'===n?'fa-brands fa-js':'fa-solid fa-file-code'}function me(e){const n=e.find(e=>e.path.endsWith('.html')),t=e.find(e=>e.path.endsWith('.css')),a=e.find(e=>e.path.endsWith('.js'));if(!n)return'';const o=n.content,r='head',s='body',i=o.match(new RegExp(`<${r}[^>]*>([\\s\\S]*?)</${r}>`,'i')),l=o.match(new RegExp(`<${s}[^>]*>([\\s\\S]*?)</${s}>`,'i'));let d=i?i[1]:'',c=l?l[1]:o;const p=new RegExp('<script[^>]*><\/script>','gi');d=d.replace(/<link[^>]*rel=["']stylesheet["'][^>]*>/gi,''),c=c.replace(p,'');const u='script',g='style';return`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  ${d}\n  <${g}>\n    html, body {\n      margin: 0 !important;\n      padding: 0 !important;\n      width: 100% !important;\n      height: auto !important;\n      min-height: 800px !important;\n      overflow: visible !important;\n    }\n    ${t?.content||''}\n  </${g}>\n  <${u} src="https://code.jquery.com/jquery-3.7.1.min.js"></${u}>\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></${u}>\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></${u}>\n  <${u} src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></${u}>\n</head>\n<body>\n  ${c}\n  <${u}>${a?.content||''}</${u}>\n</body>\n</html>`}function xe(){const e=te.value;A.value=e?me(e.files):''}function be(){try{const e=SillyTavern.chatId;console.log('保存数据到 localStorage，聊天 ID:',e);const n={frontend_projects_files:u.value,frontend_ai_history:B.value},t=T(),a=e?`${t}_frontend_projects_${e}`:`${t}_frontend_projects_global`;localStorage.setItem(a,JSON.stringify(n)),console.log('保存成功到 localStorage！',n.frontend_projects_files.length,'个项目')}catch(e){console.error('保存失败:',e)}}function he(){try{const n=O();console.log('正在从 localStorage 加载数据，聊天 ID:',n);const t=T(),a=n?`${t}_frontend_projects_${n}`:`${t}_frontend_projects_global`,o=localStorage.getItem(a);let r=null;if(o)try{r=JSON.parse(o),console.log('从 localStorage 读取到的数据:',r)}catch(e){console.error('解析 localStorage 数据失败:',e)}r?.frontend_projects_files&&Array.isArray(r.frontend_projects_files)?(u.value=r.frontend_projects_files,console.log('成功加载项目:',u.value.length,'个')):(console.log('没有找到已保存的项目数据'),u.value=[]),r?.frontend_ai_history?(B.value=r.frontend_ai_history,console.log('成功加载历史记录')):B.value={}}catch(n){console.error('加载失败:',n)}}he(),t(()=>O(),()=>{he(),h.value='',w.value='',S.value='',A.value=''});let ye=null;j(()=>{if(w.value&&void 0!==S.value){const e=te.value;if(e){const n=e.files.find(e=>e.path===w.value);n&&n.content!==S.value&&(n.content=S.value,ye&&clearTimeout(ye),ye=setTimeout(()=>{be(),console.log('自动保存:',w.value)},1e3))}}});let ve=null;function we(){C.value=!0,E.value=''}function ke(){C.value=!1,E.value=''}function _e(){X.value=!0,K.value='',Q.value='',ee.value=''}function Te(){X.value=!1,K.value='',Q.value='',ee.value=''}async function ze(){const e=te.value;if(!e)return void window.toastr.error('请先选择项目');if(!K.value.trim())return void window.toastr.error('请描述问题');P.value=!0,Z.value=!0;let n='';const t=W.createTask('ui_modify',`🐛 修复 Bug: ${K.value.slice(0,30)}...`);try{G.value?.setProgress(5),G.value?.setMessage('正在准备 Bug 修复请求...'),W.updateTaskProgress(t,5,'正在准备 Bug 修复请求...'),await new Promise(e=>setTimeout(e,100));if(!T())throw new Error('无法获取脚本 ID');const a=b().settings,o=a.api_endpoint,r=a.api_key,s=a.model||'gpt-4o-mini';if(!o||!r)throw new Error('请先在"设置"标签中配置 API');n=M(o),G.value?.setProgress(15),G.value?.setMessage('正在构建 Bug 修复提示词...'),W.updateTaskProgress(t,15,'正在构建 Bug 修复提示词...'),await new Promise(e=>setTimeout(e,100));const i='你是专业的前端 Bug 修复专家。\n\n# 修复要求\n\n1. **专注性**：只修复用户描述的具体问题，不要改动其他功能\n2. **最小化改动**：只修改必要的代码，保持其他部分不变\n3. **精准定位**：优先根据 Console 错误信息定位问题\n4. **保持风格**：修复后的代码要保持原有的命名、格式、缩进风格\n\n# 常见 Bug 类型和修复策略\n\n**点击无响应：**\n- 检查事件绑定是否正确（ID 是否匹配）\n- 检查函数是否在 `$(function() {})` 内正确定义\n- 检查是否有 JavaScript 错误阻止了执行\n\n**显示异常：**\n- 检查 CSS 样式（display、visibility、z-index）\n- 检查 DOM 结构是否正确\n- 检查数据绑定是否正常\n\n**数据保存失败：**\n- 检查 insertOrAssignVariables 调用\n- 检查数据格式是否正确\n- 检查变量作用域\n\n**逻辑错误：**\n- 检查条件判断\n- 检查异步处理\n- 检查变量作用域\n\n# 输出格式\n\n只输出需要修改的文件，使用以下格式：\n\n```\nFILE_START: 文件名\n[修改后的完整文件内容，并在关键修复位置添加注释]\nFILE_END\n```\n\n不要输出任何其他文字或解释！',l=`# 当前项目文件：\n${e.files.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n')}\n\n# Bug 描述：\n${K.value}\n\n${Q.value.trim()?`# Console 错误信息：\n\`\`\`\n${Q.value}\n\`\`\`\n`:''}\n\n${ee.value?`# 问题可能在文件：\n${ee.value}\n`:''}\n\n# 修复要求：\n1. 专注修复上述 bug，不要改其他地方\n2. 只输出需要修改的文件\n3. 在修复的关键位置添加注释说明修复内容\n4. 保持代码风格一致\n\n请严格按 system 中的格式输出，不要添加解释！`;G.value?.setProgress(25),G.value?.setMessage('正在发送请求到 AI 服务器...'),W.updateTaskProgress(t,25,'正在发送请求到 AI 服务器...'),await new Promise(e=>setTimeout(e,100)),G.value?.setProgress(30),G.value?.setMessage('等待 AI 分析 bug...'),W.updateTaskProgress(t,30,'等待 AI 分析 bug...'),await new Promise(e=>setTimeout(e,100));const d=await fetch(n,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${r}`},body:JSON.stringify({model:s,messages:[{role:'system',content:i},{role:'user',content:l}],temperature:.3})});if(!d.ok){const e=await d.text();throw new Error(`API 请求失败 (${d.status}): ${e}`)}G.value?.setProgress(60),G.value?.setMessage('正在接收 AI 修复方案...'),W.updateTaskProgress(t,60,'正在接收 AI 修复方案...'),await new Promise(e=>setTimeout(e,100));const c=await d.json(),p=c.choices?.[0]?.message?.content||'';if(!p)throw new Error('AI 未返回修复方案');G.value?.setProgress(75),G.value?.setMessage('正在解析修复方案...'),W.updateTaskProgress(t,75,'正在解析修复方案...'),await new Promise(e=>setTimeout(e,100));const u=/FILE_START:\s*(.+?)\s*\n([\s\S]*?)\nFILE_END/g,g=[];let f;for(;null!==(f=u.exec(p));){const n=f[1].trim(),t=f[2].trim(),a=e.files.find(e=>e.path===n);a&&g.push({path:n,oldContent:a.content,newContent:t})}if(0===g.length)throw new Error('AI 未返回有效的修复方案');G.value?.setProgress(85),G.value?.setMessage('正在准备对比预览...'),W.updateTaskProgress(t,85,'正在准备对比预览...'),await new Promise(e=>setTimeout(e,100)),B.value[e.id]||(B.value[e.id]=[]),B.value[e.id].unshift({timestamp:(new Date).toISOString(),prompt:`Bug 修复: ${K.value}`,changes:I(g)}),U.value=g,V.value=!0,J.value='after',G.value?.setProgress(95),G.value?.setMessage(`Bug 修复方案已生成 (${g.length} 个文件)`),W.updateTaskProgress(t,95,`Bug 修复方案已生成 (${g.length} 个文件)`),await new Promise(e=>setTimeout(e,100)),G.value?.setProgress(100),G.value?.setMessage('Bug 修复方案已生成！'),W.updateTaskProgress(t,100,'Bug 修复方案已生成！'),W.completeTask(t,{changedFiles:g.length}),setTimeout(()=>{Z.value=!1,X.value=!1,window.toastr.success('AI 已生成修复方案，请在对比窗口中查看')},800)}catch(a){console.error('Bug 修复失败:',a);const e=a?.message||String(a);window.toastr.error(`Bug 修复失败: ${e}`),W.failTask(t,e),Z.value=!1}finally{P.value=!1}}async function Ie(){if(!E.value.trim()||P.value)return;const e=te.value;if(!e)return void toastr.error('请先选择一个项目');const n=E.value.trim();if(['完善','优化','改进','美化','修改','调整','更新'].some(e=>new RegExp(`^${e}[一下了吧呗啊吗。！？\\s]*$`,'i').test(n)))return void toastr.warning('请详细描述你的需求！\n\n例如：\n❌ "优化一下"\n✅ "优化按钮样式，添加悬停动画和圆角效果"\n\n❌ "完善"\n✅ "添加响应式布局，支持移动端显示"','需求太模糊了',{timeOut:6e3});P.value=!0,Z.value=!0;let t='';const a=W.createTask('ui_generate',`🤖 AI 生成: ${E.value.slice(0,30)}...`);try{G.value?.setProgress(5),G.value?.setMessage('正在准备 AI 请求...'),W.updateTaskProgress(a,5,'正在准备 AI 请求...'),await new Promise(e=>setTimeout(e,100));if(!T())return toastr.error('无法获取脚本 ID'),P.value=!1,void(Z.value=!1);const n=b().settings,r=n.api_endpoint,s=n.api_key,i=n.model||'gpt-4o-mini',l=n.temperature||.7,d=n.max_tokens||4e3;if(!r||!s)return toastr.error('请先在"设置"标签页配置 API'),P.value=!1,void(Z.value=!1);try{t=M(r),console.log('📍 原始端点:',r),console.log('🔗 规范化后的端点:',t)}catch(o){return toastr.error('API 端点格式不正确：'+o.message),P.value=!1,void(Z.value=!1)}d<2e3&&toastr.warning(`当前 max_tokens 设置为 ${d}，可能导致 AI 返回内容被截断。建议设置为 4000 以上。`),G.value?.setProgress(15),G.value?.setMessage('正在构建提示词...'),W.updateTaskProgress(a,15,'正在构建提示词...'),await new Promise(e=>setTimeout(e,100));const c=`你是专业的前端开发助手。这是一个在 SillyTavern（酒馆）中运行的前端界面项目。\n\n# 当前项目文件：\n${e.files.map(e=>`- ${e.path}`).join('\n')}\n\n# 可用的 API 和库（可直接使用，无需导入）：\n## 第三方库：\n- jQuery ($): DOM 操作、事件处理\n- toastr: 消息提示\n- gsap: 动画效果\n- lodash (_): 工具函数\n- zod (z): 数据校验\n\n## 酒馆助手 API（全局可用）：\n**数据持久化（重要！）：**\n- \`getVariables({ type: 'chat' })\`: 获取聊天变量（对象形式）\n- \`insertOrAssignVariables(data, { type: 'chat' })\`: 保存数据到聊天变量（推荐用这个）\n- \`replaceVariables(data, { type: 'chat' })\`: 完全替换聊天变量\n\n**数据持久化示例代码：**\n\`\`\`javascript\n// ⚠️ 重要：需要检测是否在酒馆环境中（预览模式下酒馆 API 不可用）\nconst isInTavern = typeof SillyTavern !== 'undefined' && typeof getVariables !== 'undefined';\n\n// 加载数据\nfunction loadData() {\n  if (isInTavern) {\n    const data = getVariables({ type: 'chat' });\n    return data.my_key || { count: 0 };\n  } else {\n    // 预览模式：使用 localStorage\n    const stored = localStorage.getItem('my_key');\n    return stored ? JSON.parse(stored) : { count: 0 };\n  }\n}\n\n// 保存数据\nfunction saveData(data) {\n  if (isInTavern) {\n    insertOrAssignVariables({ my_key: data }, { type: 'chat' });\n  } else {\n    localStorage.setItem('my_key', JSON.stringify(data));\n  }\n}\n\n// 使用\nlet myData = loadData();\nmyData.count++;\nsaveData(myData);\n\`\`\`\n\n**其他 API：**\n- getChatMessages(): 获取当前聊天的所有消息\n- getCurrentCharacter(): 获取当前角色卡信息\n- getWorldbook(): 获取世界书\n- replaceWorldbook(data): 替换世界书\n- eventOn(event, callback): 监听酒馆事件\n- getIframeName(): 获取当前 iframe 名称\n- triggerSlash(command): 执行 STScript 命令\n- SillyTavern.getCurrentChatId(): 获取当前聊天 ID\n\n## 从消息中读取数据并更新界面\n\n**场景：** 创建状态栏界面，需要从最新的 AI 消息中提取角色状态并实时显示。\n\n**核心代码示例：**\n\n\`\`\`javascript\n// 1. 读取最新消息内容\nasync function updateStatusFromMessages() {\n  // 使用 TavernHelper 获取消息\n  if (typeof (window as any).TavernHelper === 'undefined' || \n      typeof (window as any).TavernHelper.getChatMessages !== 'function') {\n    return; // TavernHelper 不可用，跳过\n  }\n\n  const messages = (window as any).TavernHelper.getChatMessages('0-{{lastMessageId}}');\n  if (!messages || messages.length === 0) return;\n\n  // 获取最新的 AI 消息（从后往前找第一条 is_user: false）\n  const latestAIMessage = messages.slice().reverse().find(m => !m.is_user);\n  if (!latestAIMessage) return;\n\n  const content = latestAIMessage.mes; // 消息文本内容\n\n  // 2. 使用正则提取状态数据（示例：提取代码块中的状态）\n  const statusMatch = content.match(/\`\`\`json([\\s\\S]*?)\`\`\`/);\n  if (statusMatch) {\n    try {\n      const status = JSON.parse(statusMatch[1]);\n      // 3. 更新界面显示\n      $('#health').text(status.health || 100);\n      $('#level').text(status.level || 1);\n    } catch (e) {\n      console.error('解析状态失败:', e);\n    }\n  }\n\n  // 或者用正则直接提取特定格式（例如：【生命值：80】）\n  const healthMatch = content.match(/【生命值[：:](\\d+)】/);\n  if (healthMatch) {\n    $('#health').text(healthMatch[1]);\n  }\n}\n\n// 4. 页面加载时更新\n$(function() {\n  updateStatusFromMessages();\n});\n\n// 5. 监听新消息事件，自动更新（可选）\nif (typeof eventOn === 'function') {\n  eventOn('MESSAGE_RECEIVED', () => {\n    updateStatusFromMessages();\n  });\n}\n\`\`\`\n\n---\n\n## 🎯 状态栏 XML 美化（重要！）\n\n**场景：** AI 回复中包含 XML 格式的状态栏（如 \`<state_bar><i>【内容】</i></state_bar>\`），需要将其美化显示。\n\n**核心功能：**\n1. 提取 \`<state_bar>\` 标签内容\n2. 将 XML 标签转换为美化的 HTML\n3. 实时显示在界面上\n\n**完整实现示例：**\n\n\`\`\`typescript\n// ===== 1. 提取状态栏内容 =====\nfunction extractStateBar(text: string): string | null {\n  const match = text.match(/<state_bar>([\\s\\S]*?)<\\/state_bar>/i);\n  return match ? match[1].trim() : null;\n}\n\n// ===== 2. XML 转 HTML（支持多种标签格式）=====\nfunction convertXmlToHtml(xml: string): string {\n  let html = xml;\n\n  // 处理缩进标签：<i>、<2i>、<3i> 等\n  html = html.replace(/<i>([\\s\\S]*?)<\\/i>/g, '<div class="state-item indent-1">$1</div>');\n  html = html.replace(/<2i>([\\s\\S]*?)<\\/2i>/g, '<div class="state-item indent-2">$1</div>');\n  html = html.replace(/<3i>([\\s\\S]*?)<\\/3i>/g, '<div class="state-item indent-3">$1</div>');\n\n  // 处理语义化标签（常见的状态栏标签）\n  html = html.replace(/<日期>([\\s\\S]*?)<\\/日期>/g, '<div class="state-date">📅 $1</div>');\n  html = html.replace(/<时间>([\\s\\S]*?)<\\/时间>/g, '<div class="state-time">🕐 $1</div>');\n  html = html.replace(/<地点>([\\s\\S]*?)<\\/地点>/g, '<div class="state-location">📍 $1</div>');\n  html = html.replace(/<角色生理状态>([\\s\\S]*?)<\\/角色生理状态>/g, '<div class="state-physical">💓 $1</div>');\n  html = html.replace(/<角色心理状态>([\\s\\S]*?)<\\/角色心理状态>/g, '<div class="state-mental">🧠 $1</div>');\n  html = html.replace(/<当前状态>([\\s\\S]*?)<\\/当前状态>/g, '<div class="state-current">✨ $1</div>');\n\n  // 处理颜色标签（如 <角色生理状态>【描述角色当前生理状态】</角色生理状态>）\n  html = html.replace(/<角色生理状态>([\\s\\S]*?)<\\/角色生理状态>/g,\n    '<div class="state-colored" style="border-left: 3px solid #ff6b6b; background: rgba(255,107,107,0.1);">$1</div>');\n\n  // 通用标签处理（兜底方案）\n  html = html.replace(/<([^>\\/\\s]+)>([\\s\\S]*?)<\\/\\1>/g, '<div class="state-generic">$2</div>');\n\n  return html;\n}\n\n// ===== 3. 监听消息并更新 =====\nasync function updateStateBar() {\n  // 使用 TavernHelper 获取消息\n  if (typeof (window as any).TavernHelper === 'undefined' || \n      typeof (window as any).TavernHelper.getChatMessages !== 'function') {\n    return; // TavernHelper 不可用，跳过\n  }\n\n  const messages = (window as any).TavernHelper.getChatMessages('0-{{lastMessageId}}');\n  if (!messages || messages.length === 0) return;\n\n  // 获取最新的 AI 消息\n  const latestAI = messages.slice().reverse().find(m => !m.is_user);\n  if (!latestAI) return;\n\n  // 提取状态栏\n  const stateBarXml = extractStateBar(latestAI.mes);\n  if (stateBarXml) {\n    const stateBarHtml = convertXmlToHtml(stateBarXml);\n\n    // 更新界面（带动画）\n    const container = $('#state-bar-container');\n    container.fadeOut(200, () => {\n      container.html(stateBarHtml);\n      container.fadeIn(200);\n    });\n  }\n}\n\n// ===== 4. 初始化和监听 =====\n$(function() {\n  updateStateBar(); // 页面加载时更新\n\n  // 监听消息接收事件\n  if (typeof eventOn === 'function') {\n    eventOn('MESSAGE_RECEIVED', updateStateBar);\n  }\n});\n\`\`\`\n\n**配套 CSS 样式：**\n\n\`\`\`scss\n#state-bar-container {\n  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  border-radius: 12px;\n  padding: 16px;\n  color: white;\n  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);\n  margin-bottom: 16px;\n}\n\n.state-item {\n  padding: 8px 12px;\n  margin: 6px 0;\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 6px;\n  backdrop-filter: blur(10px);\n  transition: all 0.3s ease;\n\n  &:hover {\n    background: rgba(255, 255, 255, 0.15);\n    transform: translateX(4px);\n  }\n}\n\n// 缩进样式\n.indent-1 { margin-left: 20px; }\n.indent-2 { margin-left: 40px; }\n.indent-3 { margin-left: 60px; }\n\n// 语义化标签样式\n.state-date, .state-time, .state-location {\n  font-weight: 600;\n  font-size: 14px;\n  padding: 8px 12px;\n  margin: 8px 0;\n  border-radius: 6px;\n}\n\n.state-date { background: rgba(100, 181, 246, 0.2); }\n.state-time { background: rgba(129, 199, 132, 0.2); }\n.state-location { background: rgba(255, 167, 38, 0.2); }\n\n.state-physical {\n  padding: 10px 14px;\n  margin: 8px 0;\n  background: rgba(255, 107, 107, 0.15);\n  border-left: 4px solid #ff6b6b;\n  border-radius: 4px;\n}\n\n.state-mental {\n  padding: 10px 14px;\n  margin: 8px 0;\n  background: rgba(149, 117, 205, 0.15);\n  border-left: 4px solid #9575cd;\n  border-radius: 4px;\n}\n\n.state-colored {\n  padding: 10px 14px;\n  margin: 8px 0;\n  border-radius: 4px;\n  backdrop-filter: blur(5px);\n}\n\n.state-generic {\n  padding: 6px 10px;\n  margin: 4px 0;\n  opacity: 0.9;\n}\n\`\`\`\n\n**使用 GSAP 制作高级动画（可选）：**\n\n\`\`\`typescript\n// 使用 GSAP 制作更流畅的动画\nfunction updateStateBarWithAnimation(stateBarHtml: string) {\n  const container = $('#state-bar-container');\n\n  // 淡出\n  gsap.to(container, {\n    opacity: 0,\n    y: -10,\n    duration: 0.2,\n    onComplete: () => {\n      container.html(stateBarHtml);\n\n      // 淡入\n      gsap.to(container, {\n        opacity: 1,\n        y: 0,\n        duration: 0.3,\n        ease: 'power2.out'\n      });\n\n      // 子元素依次出现\n      gsap.from('.state-item', {\n        opacity: 0,\n        x: -20,\n        duration: 0.4,\n        stagger: 0.05,\n        ease: 'back.out(1.2)'\n      });\n    }\n  });\n}\n\`\`\`\n\`\`\`\n\n**关键点：**\n- 使用 \`getChatMessages()\` 获取所有消息\n- 通过正则表达式从消息文本中提取数据\n- 用 jQuery 更新 DOM 元素显示\n- 监听 MESSAGE_RECEIVED 事件实现自动更新\n\n## 实现同层对话（流式传输前端界面）\n\n**核心概念：**\n同层对话是一个**独立的前端界面**（有自己的 index.html），玩家只在界面内游玩，不看酒馆主聊天。\n\n**🚨🚨🚨 绝对禁止（否则功能完全不工作！）🚨🚨🚨**\n\n\`\`\`javascript\n// ❌❌❌ 绝对禁止！绝对禁止！绝对禁止！\n$(function() {\n  let chatHistory = [];           // ❌ 外部访问不到！\n  function renderMessages() {}    // ❌ 外部访问不到！\n  function handleSend() {}        // ❌ 外部访问不到！\n\n  // 所有代码都在这里 ❌❌❌\n});\n\n// ✅✅✅ 必须这样写！必须这样写！必须这样写！\nlet chatHistory = [];              // ✅ 全局变量\nfunction renderMessages() {}       // ✅ 全局函数\nfunction handleSend() {}           // ✅ 全局函数\n\n$(function() {\n  // 只在这里调用函数，不定义！\n  loadChatHistory();\n  setupStreamListeners();\n});\n\`\`\`\n\n**代码结构必须严格按以下顺序（不能改！）：**\n1. 全局变量定义（let/const）\n2. 全局函数定义（function）\n3. \`$(function() {})\` - 只用于调用上面定义的函数\n4. \`$(window).on('pagehide', ...)\` - 卸载事件\n\n**⚠️⚠️⚠️ 第二重要的注意事项：generation_id 过滤**\n同层对话的流式监听器会监听到**所有**酒馆的生成事件（包括主界面的生成）。因此**必须使用 generation_id 过滤**，否则会出现：\n- 同层对话接收到主界面的 AI 回复\n- 状态管理混乱，生成状态对不上\n- 按钮状态异常\n\n**实现要点：**\n1. 创建**前端界面项目**（index.html + index.ts）\n2. 界面内设计输入框和发送按钮\n3. 点击发送时，调用 \`generate(text)\`，并**保存返回的 generation_id**\n4. **监听流式传输事件**时，必须检查 \`id === currentGenerationId\`：\n   - \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\`: 每个 token 的增量更新\n   - \`iframe_events.STREAM_TOKEN_RECEIVED_FULLY\`: 流式传输完成，获取完整文本\n   - \`iframe_events.GENERATION_ENDED\`: 生成结束（备用方案）\n5. 后台操作消息楼层（可选）：使用 \`setChatMessages\`、\`createChatMessages\` 配合 \`{ refresh: 'none' }\` 参数\n\n**⚠️⚠️⚠️ 关键 API（必须使用此方法！禁止使用 generate()！）：**\n- **\`triggerSlashWithResult(command)\`**: 执行 STScript 命令并获取返回值\n  - 返回值：\`Promise<string>\`（AI 生成的完整文本）\n  - 示例：\`const result = await triggerSlashWithResult('/gen lock=on "对话内容"');\`\n  - **重要**：使用 \`/gen\` 命令会自动使用角色卡、预设、世界书\n  - **关键优势**：不需要流式监听，不需要 generation_id，直接返回完整结果\n- **\`getRegexScripts()\`**: 获取当前启用的正则脚本列表\n  - 用于过滤思维链、调试信息等\n  - **必须在显示 AI 回复前应用正则过滤**\n- **构建对话历史为提示词**：将对话历史拼接成文本，而不是用 API 参数\n- **\`triggerSlash(command)\`**: 执行 STScript 命令但不等待返回值\n\n**⚠️⚠️⚠️ AI 回复的标签清理（非常重要！）：**\nAI 可能会在回复中生成思维链标签，如：\`<guide>\`、\`<dream>\`、\`<plot>\`、\`<status>\`、\`<think>\` 等。\n这些标签**必须在显示前移除**，否则会破坏界面效果！\n\n**清理策略（参考梦星大佬的方案）：**\n1. **优先提取正文标签**：如果 AI 用特定标签包裹正文（如 \`<gametxt>\`），优先提取\n2. **备用方案**：移除所有思维链标签\n3. **可选增强**：应用酒馆的全局正则和预设正则\n\n**完整的清理函数模板（梦星方案）：**\n\`\`\`typescript\n// 辅助函数：提取标签内容（从后往前查找最后一个）\nfunction extractLastTagContent(tagName: string, text: string, ignoreCase = false): string | null {\n  if (!text || typeof text !== 'string') return null;\n\n  const endTag = \`</\${tagName}>\`;\n  let searchPool = text;\n  let endTagPattern = endTag;\n\n  if (ignoreCase) {\n    searchPool = text.toLowerCase();\n    endTagPattern = endTag.toLowerCase();\n  }\n\n  const lastEndIndex = searchPool.lastIndexOf(endTagPattern);\n  if (lastEndIndex !== -1) {\n    const startTag = \`<\${tagName}>\`;\n    let startTagPattern = startTag;\n    if (ignoreCase) startTagPattern = startTag.toLowerCase();\n\n    const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);\n    if (lastStartIndex !== -1) {\n      const startIndex = lastStartIndex + startTag.length;\n      return text.substring(startIndex, lastEndIndex).trim();\n    }\n  }\n  return null;\n}\n\n// 主清理函数\nfunction applyRegexFilters(text: string): string {\n  console.log('🔍 开始清理，原始长度:', text.length);\n\n  if (!text || typeof text !== 'string') return '';\n\n  // ===== 步骤 0: 修复未闭合的标签（容错处理）=====\n  // 哈基米流口水时经常不闭合标签，导致"前端失踪"、"代码暴露"等问题\n  // 检测常见的未闭合标签并自动闭合\n  // ⚠️ dream 和 gametxt 是正文标签，需要补齐以便提取内容\n  const criticalTags = ['thinking', 'UpdateVariable', 'guide', 'plot', 'status', 'dream', 'gametxt'];\n  criticalTags.forEach(tag => {\n    const openTagRegex = new RegExp(\`<\${tag}([^>]*)>\`, 'gi');\n    const closeTagRegex = new RegExp(\`</\${tag}>\`, 'gi');\n\n    const openMatches = text.match(openTagRegex);\n    const closeMatches = text.match(closeTagRegex);\n\n    const openCount = openMatches ? openMatches.length : 0;\n    const closeCount = closeMatches ? closeMatches.length : 0;\n\n    if (openCount > closeCount) {\n      // 有未闭合的标签，自动补齐闭合标签\n      const missing = openCount - closeCount;\n      console.log(\`⚠️ 发现 \${missing} 个未闭合的 <\${tag}> 标签，自动补齐\`);\n      text = text + \`</\${tag}>\`.repeat(missing);\n    }\n  });\n\n  // ===== 步骤 1: 优先提取正文标签（梦星方案）=====\n  // 如果 AI 用特定标签包裹正文，优先提取该标签的内容\n  // ⚠️⚠️⚠️ dream 是常见的正文标签！必须优先提取！\n  const gameTextTags = ['dream', 'gametxt', 'output', 'display', 'text', 'content'];\n  for (const tag of gameTextTags) {\n    const extracted = extractLastTagContent(tag, text);\n    if (extracted !== null) {\n      console.log(\`✅ 提取了 <\${tag}> 标签的内容，长度:\`, extracted.length);\n      return extracted; // 直接返回正文，不需要进一步清理\n    }\n  }\n\n  // ===== 步骤 2: 备用方案 - 移除所有思维链标签 =====\n  let cleanedText = text;\n\n  // 常见的固定标签（注意：dream/gametxt 是正文标签，不应移除！）\n  const tagsToRemove = [\n    'guide', 'plot', 'status',\n    'UpdateVariable', '角色提取', '本世历程', '往世涟漪'\n  ];\n\n  tagsToRemove.forEach(tag => {\n    // 移除 <tag>...</tag> 结构\n    const regexWithContent = new RegExp(\`<\${tag}[^>]*>[\\\\s\\\\S]*?</\${tag}>\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regexWithContent, '');\n\n    // 移除自闭合的 <tag/> 结构\n    const regexSelfClosing = new RegExp(\`<\${tag}\\\\s*\\\\/>\`, 'gi');\n    cleanedText = cleanedText.replace(regexSelfClosing, '');\n\n    if (before !== cleanedText) {\n      console.log(\`  🧹 移除了 <\${tag}> 标签\`);\n    }\n  });\n\n  // ⚠️⚠️⚠️ 特殊处理：移除所有包含 think/thinking 的标签（思维链）\n  // 匹配 <xxx_think>、<thinking_xxx>、<think>、<thinking> 等所有变体\n  const thinkingRegex = /<[^>]*think[^>]*>[\\\\s\\\\S]*?<\\/[^>]*think[^>]*>/gi;\n  const beforeThinking = cleanedText;\n  cleanedText = cleanedText.replace(thinkingRegex, '');\n  if (beforeThinking !== cleanedText) {\n    console.log('  🧹 移除了包含 think/thinking 的思维链标签');\n  }\n\n  // 移除自闭合的 think 标签\n  const thinkingSelfClosing = /<[^>]*think[^>]*\\\\/>/gi;\n  cleanedText = cleanedText.replace(thinkingSelfClosing, '');\n\n  // 清理 HTML 注释\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  if (cleanedText !== text) {\n    console.log('✅ 标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 2-3: 尝试应用酒馆正则（可选）=====\n  let allRegexScripts: any[] = [];\n\n  // 方式 1: 全局正则\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegexes = getRegexScripts();\n      if (globalRegexes && globalRegexes.length > 0) {\n        console.log('📋 从全局正则获取到', globalRegexes.length, '个脚本');\n        allRegexScripts = allRegexScripts.concat(globalRegexes);\n      }\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  // 方式 2: 预设内置正则（支持 SoliUmbra 等脚本）\n  try {\n    const parentST = (window as any).parent?.SillyTavern || (window as any).SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find((p: any) => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes: any = null;\n\n              if (Array.isArray(data)) {\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break;\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length > 0) {\n    console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n    // 过滤出适用于 AI 输出后处理的正则（placement 包含 2）\n    // ⚠️ 只检查 disabled 和 placement，不检查 promptOnly\n    // 因为有些预设正则可能没有 promptOnly 字段，或者设置不规范\n    const activeScripts = allRegexScripts.filter((script: any) => {\n      if (script.disabled) return false;\n      if (!script.placement || !Array.isArray(script.placement)) return false;\n      if (!script.placement.includes(2)) return false;\n      return true;\n    });\n\n    console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n    let result = text;\n    activeScripts.forEach((script: any, index: number) => {\n      try {\n        const regex = new RegExp(script.findRegex, 'gim');\n        const beforeLength = result.length;\n        result = result.replace(regex, script.replaceString || '');\n\n        if (beforeLength !== result.length) {\n          console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效');\n        }\n      } catch (e) {\n        console.error('❌ 正则', index + 1, '应用失败:', e);\n      }\n    });\n\n    text = result;\n  }\n\n  console.log('📊 最终长度:', text.length);\n  return text;\n}\n\`\`\`\n\n**使用方式（完整示例）：**\n\`\`\`typescript\n// 全局变量\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\n\n// 发送消息\nasync function handleSend() {\n  const input = $('#user-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 1. 添加用户消息到历史\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  renderMessages();\n\n  // 2. 设置生成状态\n  isGenerating = true;\n  $('#send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    // 3. 构建对话历史提示词\n    let prompt = '';\n    chatHistory.slice(-10).forEach(msg => {\n      prompt += (msg.role === 'user' ? '玩家' : 'AI') + ': ' + msg.content + '\\n';\n    });\n\n    // 4. 调用 AI（不需要流式！）\n    const rawResult = await triggerSlashWithResult('/gen lock=on "' + prompt.replace(/"/g, '\\\\"') + '"');\n\n    // 5. ⭐ 关键：必须先清理标签再显示\n    const cleanedResult = applyRegexFilters(rawResult);\n\n    // 6. 添加到聊天历史并渲染\n    chatHistory.push({ role: 'assistant', content: cleanedResult });\n    renderMessages();\n    saveChatHistory(); // 保存到酒馆变量\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    isGenerating = false;\n    $('#send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// 渲染消息\nfunction renderMessages() {\n  const container = $('#messages');\n  container.empty();\n\n  chatHistory.forEach(msg => {\n    const div = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .text(msg.content); // 使用 text() 防止 XSS\n    container.append(div);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// 保存聊天历史\nfunction saveChatHistory() {\n  if (typeof insertOrAssignVariables === 'function') {\n    insertOrAssignVariables({ chat_history: chatHistory }, { type: 'chat' });\n  } else {\n    localStorage.setItem('chat_history', JSON.stringify(chatHistory));\n  }\n}\n\`\`\`\n\n**⚠️ 重要说明：流式传输的正确实现方式！**\n\n**🚨 同层对话必须使用真流式传输！🚨**\n\n### ⭐ 真流式模式（唯一正确的实现方式）\n- 使用 \`generate({ should_stream: true, generation_id })\` 启用流式\n- 监听 \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\` 实时接收文本\n- 边接收边清理标签边显示\n- ✅ 实时显示 AI 生成，无需等待，体验最佳\n- ✅ 用户可以立即看到 AI 的回复，体验流畅\n\n### ❌ 禁止使用以下方案：\n- ❌ \`triggerSlashWithResult\`（需要等待全部生成，体验差）\n- ❌ 打字机效果（假流式，仍需等待，不是真正的流式）\n- ❌ \`generateRaw\`（不使用角色卡和预设）\n\n**🎯 真流式模式的正确实现（强烈推荐）：**\n\n\`\`\`typescript\n// ===== 全局变量 =====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\nlet currentGenerationId: string | null = null;\n\n// ===== 真流式监听（核心！）=====\nfunction setupStreamListeners() {\n  // ⚠️ 监听增量文本（每次接收一小段）\n  eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text: string, id: string) => {\n    if (!isGenerating || id !== currentGenerationId) return;\n\n    // ⚠️⚠️⚠️ 核心！必须实时清理标签！\n    const cleanedText = applyRegexFilters(text);\n\n    // 更新 DOM（找到最后一条消息并更新）\n    const container = $('#inner-messages');  // 根据实际容器 ID 修改\n    const charName = SillyTavern?.name2 || 'AI';\n    const lastMsg = container.find('.message:last-child');\n\n    if (lastMsg.length && !lastMsg.hasClass('user-message')) {\n      // 更新已有的 AI 消息\n      lastMsg.html('<strong>' + charName + ':</strong> ' + cleanedText);\n    } else {\n      // 创建新的 AI 消息\n      const msgDiv = $('<div>')\n        .addClass('message ai-message')\n        .html('<strong>' + charName + ':</strong> ' + cleanedText);\n      container.append(msgDiv);\n    }\n\n    // 自动滚动到底部\n    container.scrollTop(container[0].scrollHeight);\n  });\n\n  // ⚠️ 监听生成完成\n  eventOn(iframe_events.GENERATION_ENDED, (text: string, id: string) => {\n    if (id === currentGenerationId) {\n      console.log('✅ 流式生成完成');\n\n      // ⚠️⚠️⚠️ 核心！最后清理一次再保存到历史！\n      const cleanedText = applyRegexFilters(text);\n\n      // 保存到聊天历史\n      chatHistory.push({ role: 'assistant', content: cleanedText });\n      saveChatHistory();\n\n      // 重新渲染（确保显示的是清理后的内容）\n      renderMessages();\n\n      // 重置状态\n      isGenerating = false;\n      currentGenerationId = null;\n      $('#inner-send-btn').prop('disabled', false).text('发送');  // 根据实际按钮 ID 修改\n    }\n  });\n}\n\n// ===== 发送消息（真流式版本）=====\nasync function handleSend() {\n  const input = $('#inner-input');  // 根据实际输入框 ID 修改\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 1. 添加用户消息\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  // 2. 生成唯一 ID\n  currentGenerationId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n\n  // 3. 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');  // 根据实际按钮 ID 修改\n\n  try {\n    // 4. ⚠️⚠️⚠️ 核心：调用 generate 并启用流式\n    await generate({\n      user_input: userInput,\n      should_stream: true,           // ⚠️ 必须启用流式\n      generation_id: currentGenerationId,  // ⚠️ 必须传入 ID 用于事件过滤\n      overrides: {\n        chat_history: {\n          prompts: chatHistory.map(msg => ({\n            role: msg.role === 'user' ? 'user' : 'assistant',\n            content: msg.content\n          }))\n        }\n      }\n    });\n\n    // 注意：由于是流式，实际的文本更新是通过事件监听器实时更新的\n    // GENERATION_ENDED 事件会自动保存 AI 回复到历史\n\n  } catch (error) {\n    console.error('❌ 生成失败:', error);\n    toastr.error('生成失败: ' + error.message);\n\n    // 重置状态\n    isGenerating = false;\n    currentGenerationId = null;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 渲染消息 =====\nfunction renderMessages() {\n  const container = $('#messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const div = $('<div>')\n      .attr('id', \\\`message-\\\${index}\\\`)  // ⚠️ 必须有 id\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .text(msg.content);\n    container.append(div);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 初始化 =====\n$(() => {\n  loadChatHistory();\n  setupStreamListeners();  // ⚠️ 必须在加载时就设置监听\n\n  $('#send-btn').on('click', handleSend);\n  $('#user-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n});\n\\\`\\\`\\\`\n\n**🎨 CSS 样式（可选，添加光标效果）：**\n\\\`\\\`\\\`css\n.streaming {\n  border-right: 2px solid #165DFF;\n  animation: blink 1s infinite;\n}\n\n@keyframes blink {\n  0%, 50% { border-right-color: transparent; }\n  51%, 100% { border-right-color: #165DFF; }\n}\n\\\`\\\`\\\`\n\n**💡 模式选择建议（重要！）：**\n- **同层对话（前端界面）**：必须使用真流式模式（模式 3）⭐⭐⭐\n- **脚本后台任务**：可以使用 triggerSlashWithResult（不需要流式）\n- **原因**：同层对话需要实时显示 AI 生成，给用户最佳体验\n- **不要用假流式！** 假流式需要等待完整生成，体验差\n\n**🔑 真流式的关键要点：**\n1. ✅ 必须调用 \`generate({ should_stream: true, generation_id: uniqueId })\`\n2. ✅ 必须在加载时就设置监听：\`setupStreamListeners()\`\n3. ✅ 监听事件：\`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => ...)\`\n4. ✅ 过滤 ID：确保只处理自己的 \`generation_id\`\n5. ✅ 使用 \`overrides.chat_history.prompts\` 传递聊天历史\n\n**🚨🚨🚨 最关键！必须在这些地方调用 \`applyRegexFilters\`：**\n1. ⚠️ **STREAM_TOKEN_RECEIVED_INCREMENTALLY 事件中**：\n   \`\`\`typescript\n   const cleanedText = applyRegexFilters(text);  // 清理后再显示！\n   lastMsg.html('<strong>' + charName + ':</strong> ' + cleanedText);\n   \`\`\`\n\n2. ⚠️ **GENERATION_ENDED 事件中**：\n   \`\`\`typescript\n   const cleanedText = applyRegexFilters(text);  // 清理后再保存！\n   chatHistory.push({ role: 'assistant', content: cleanedText });\n   \`\`\`\n\n**💡 \`applyRegexFilters\` 的容错机制（四层保护）：**\n1. ✅ **自动补齐未闭合的标签**（防止"前端失踪"、"代码暴露"）\n2. ✅ **优先提取正文标签**（如 \`<dream>\`、\`<gametxt>\`）⭐⭐⭐ 最重要！\n3. ✅ **移除思维链标签**（通配符匹配所有包含 \`think\` 的标签）\n4. ✅ **应用预设正则**（支持全局正则和预设内置正则）\n\n**🚨🚨🚨 正文标签提取（核心原理）：**\n- **不同预设使用不同的正文标签**：\`<dream>\`、\`<gametxt>\`、\`<output>\` 等\n- **优先提取顺序**：\`['dream', 'gametxt', 'output', 'display', 'text', 'content']\`\n- **提取逻辑**：找到第一个匹配的标签，提取其内容并直接返回\n- **示例**：\n  \`\`\`\n  原始：<guide>思维</guide><dream>正文内容</dream><plot>元数据</plot>\n  提取：正文内容  ← 只保留 <dream> 里的内容！\n  \`\`\`\n\n**🎯 思维链标签处理（重点！）：**\n- 思维链标签名通常包含 \`think\` 或 \`thinking\`\n- 使用通配符正则：\`/<[^>]*think[^>]*>[\\s\\S]*?<\\/[^>]*think[^>]*>/gi\`\n- 自动匹配所有变体：\`<think>\`、\`<thinking>\`、\`<xxx_think>\`、\`<thinking_xxx>\` 等\n- 即使标签名变化，也能正确清理\n\n**常见问题及解决方案：**\n- ❌ 思考内容暴露 → \`<thinking>\` 未闭合 → 自动补齐 + 清理\n- ❌ 前端失踪 → \`<UpdateVariable>\` 未闭合 → 自动补齐 + 清理\n- ❌ 代码暴露 → 多余的 \`<UpdateVariable>\` → 清理所有 \`<UpdateVariable>\` 标签\n\n**❌ 致命错误（绝对不能犯）：**\n- ❌ 直接显示/保存原始 text，没有调用 \`applyRegexFilters\`\n- ❌ 只在显示时清理，但保存时用原始 text\n- ❌ 只在保存时清理，但显示时用原始 text\n- ❌ 不设置 \`should_stream: true\`\n- ❌ 不设置 \`generation_id\`（会收到所有事件）\n- ❌ 不过滤 ID（会处理其他同层对话的事件）\n- ❌ 不在加载时设置监听（会丢失事件）\n\n**⚠️⚠️⚠️ 作用域问题（最常见错误！）：**\n变量和函数**必须在全局作用域**定义，不能在 \`$(function() {})\` 内部！\n\n\`\`\`javascript\n// ❌ 错误示例：变量在局部作用域\n$(function() {\n  let chatHistory = [];  // ❌ 外部访问不到！\n  function renderMessages() {}  // ❌ 外部访问不到！\n});\n\n// ✅ 正确示例：变量在全局作用域\nlet chatHistory = [];  // ✅ 全局可访问\nfunction renderMessages() {}  // ✅ 全局可访问\n\n$(function() {\n  // 在这里调用上面定义的函数\n  loadChatHistory();\n});\n\`\`\`\n\n**📋 代码结构大纲（必须严格按此顺序！）：**\n\n\`\`\`javascript\n// index.ts 文件结构：\n//\n// 1️⃣ 全局变量定义区（第 1-10 行左右）\n//    let chatHistory = [];\n//    let isGenerating = false;\n//    ...\n//\n// 2️⃣ 全局函数定义区（第 10-250 行左右）\n//    function loadChatHistory() { ... }\n//    function saveChatHistory() { ... }\n//    function renderMessages() { ... }\n//    function applyRegexFilters(text) { ... }  // ⚠️ 必须！用于过滤思维链\n//    function handleSend() { ... }\n//\n// 3️⃣ jQuery 初始化区（第 250-270 行左右）\n//    $(function() {\n//      // 只调用函数，不定义！\n//      loadChatHistory();\n//      $('#btn').on('click', handleSend);\n//    });\n//\n// 4️⃣ 卸载事件（第 270-275 行左右）\n//    $(window).on('pagehide', () => { ... });\n\`\`\`\n\n**完整实现示例（必须 100% 按此结构！）：**\n\n\`\`\`javascript\n// =====================================================\n// ⚠️⚠️⚠️ 以下所有代码都在全局作用域，不要放在 $(function() {}) 内！\n// =====================================================\n\n// ===== 1. 状态管理（必须在全局作用域！）=====\nlet chatHistory = []; // { role: 'user'|'assistant', content: string }\nlet isGenerating = false;\n\n// ===== 2. 数据持久化（使用聊天变量） =====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    // 预览模式\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    // 酒馆模式：从聊天变量读取\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 界面渲染 =====\nfunction renderMessages() {\n  console.log('🎨 renderMessages 开始，聊天历史:', chatHistory.length, '条');\n\n  const container = $('#inner-messages');\n  console.log('📦 消息容器:', container.length > 0 ? '✅ 存在' : '❌ 不存在');\n\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    // 获取显示名称\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    console.log('💬 渲染消息', index + 1, ':', msg.role, '-', name, '- 长度:', msg.content.length);\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  console.log('✅ renderMessages 完成，容器内消息数:', container.find('.message').length);\n\n  // 滚动到底部\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 4. 正则过滤（隐藏思维链等） =====\n/**\n * 应用正则脚本来清理 AI 回复\n * 支持三种清理方式：\n * 1. 酒馆原生全局正则（通过 getRegexScripts）\n * 2. 预设内置正则（通过 SoliUmbra 的预设绑定脚本）\n * 3. 内置的简单标签清理（作为备用方案）\n */\nfunction applyRegexFilters(text) {\n  console.log('🔍 开始应用正则过滤，原始文本长度:', text.length);\n\n  // ===== 步骤 0: 内置的简单标签清理（备用方案）=====\n  // 清理常见的思维链标签：<guide>、<dream>、<plot>、<status>、<think> 等\n  let cleanedText = text;\n  const commonTags = [\n    'guide', 'dream', 'plot', 'status', 'think', 'thinking',\n    'thought', 'reasoning', 'analysis', 'plan', 'reflection',\n    'meta', 'ooc', 'system', 'debug'\n  ];\n\n  commonTags.forEach(tag => {\n    // 匹配 <tag>...</tag> 格式（包括换行）\n    const regex = new RegExp(\`<\${tag}[^>]*>[\\\\s\\\\S]*?</\${tag}>\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regex, '');\n    if (before !== cleanedText) {\n      console.log(\`  🧹 内置清理: 移除了 <\${tag}> 标签\`);\n    }\n  });\n\n  // 清理 HTML 注释中的调试信息\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  // 如果内置清理生效了，先显示结果\n  if (cleanedText !== text) {\n    console.log('✅ 内置标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 1-2: 尝试使用酒馆的正则脚本 =====\n  let allRegexScripts = [];\n\n  // 方式 1: 尝试从酒馆原生全局正则获取\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegex = getRegexScripts();\n      console.log('📋 从全局正则获取到', globalRegex.length, '个脚本');\n      allRegexScripts = allRegexScripts.concat(globalRegex);\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  // 方式 2: 尝试从预设内置正则获取（SoliUmbra 的方案）\n  // ⚠️ 同层对话在 iframe 中，需要通过 window.parent.SillyTavern.getContext() 访问\n  try {\n    const parentST = window.parent?.SillyTavern || window.SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        // 尝试多个可能的 identifier（不同预设使用不同的命名）\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find(p => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes = null;\n\n              // 处理不同的数据格式\n              if (Array.isArray(data)) {\n                // 直接是数组（如 regexes-bindings）\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                // 嵌套对象（如 SPresetSettings.RegexBinding.regexes）\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break; // 找到就退出循环\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length === 0) {\n    console.log('⚠️ 未找到任何正则脚本，跳过过滤');\n    return text;\n  }\n\n  console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n  // 过滤出启用的、适用于 AI 输出后处理的正则\n  // placement 数组:\n  //   0 = 提示词之前\n  //   1 = 提示词之后（发送给 AI 之前）\n  //   2 = AI 输出之后（显示给用户之前）⭐ 这是我们需要的！\n  // promptOnly: true = 仅用于提示词处理\n  // promptOnly: false = 用于输出后处理 ⭐ 这是我们需要的！\n  const activeScripts = allRegexScripts.filter(script => {\n    return !script.disabled &&\n           !script.promptOnly &&  // 只要 promptOnly 为 false 的\n           script.placement &&\n           script.placement.includes(2);  // 只要 placement 包含 2 的（AI 输出后）\n  });\n\n  console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n  let result = text;\n\n  // 依次应用每个正则\n  activeScripts.forEach((script, index) => {\n    try {\n      const regex = new RegExp(script.findRegex, 'gim');\n      const beforeLength = result.length;\n      result = result.replace(regex, script.replaceString || '');\n\n      if (beforeLength !== result.length) {\n        console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效，移除了', beforeLength - result.length, '个字符');\n      }\n    } catch (e) {\n      console.error('❌ 正则', index + 1, '(', script.scriptName, ') 应用失败:', e);\n    }\n  });\n\n  console.log('🎯 正则过滤完成，原始长度:', text.length, '过滤后长度:', result.length);\n\n  return result;\n}\n\n// ===== 5. 发送消息 =====\n// ⚠️ 函数名必须避免与酒馆冲突（不要用 sendChatMessage）\n// ⚠️ 这个函数必须在全局作用域定义！\nasync function handleSend() {\n  const input = $('#inner-user-input');\n  const text = input.val().trim();\n\n  if (!text || isGenerating) return;\n\n  // 添加用户消息\n  chatHistory.push({ role: 'user', content: text });\n  input.val('');\n  renderMessages();\n  saveChatHistory();\n\n  // 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    // ⚠️ 检查 STScript API 可用性\n    if (typeof triggerSlashWithResult !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    // 获取用户名和角色名\n    const userName = SillyTavern?.name1 || 'You';\n    const charName = SillyTavern?.name2 || 'AI';\n\n    // 构建完整的对话上下文（包含历史记录）\n    let fullPrompt = '';\n    if (chatHistory.length > 0) {\n      fullPrompt += '【对话历史】\\n';\n      chatHistory.forEach((msg) => {\n        const name = msg.role === 'user' ? userName : charName;\n        fullPrompt += name + ': ' + msg.content + '\\n';\n      });\n      fullPrompt += '\\n';\n    }\n    fullPrompt += userName + ': ' + text;\n\n    console.log('🚀 开始生成，提示词长度:', fullPrompt.length);\n\n    // ⚠️⚠️⚠️ 使用 /gen 命令（会自动使用角色卡、预设、世界书）\n    const command = '/gen lock=on "' + fullPrompt.replace(/"/g, '\\\\"') + '"';\n    const result = await triggerSlashWithResult(command);\n\n    console.log('📥 AI 返回值长度:', result ? result.length : 0);\n\n    if (result && result.length > 0) {\n      // ⚠️⚠️⚠️ 应用正则过滤（隐藏思维链等调试信息）\n      const cleanedResult = applyRegexFilters(result);\n      console.log('🧹 正则过滤后长度:', cleanedResult.length);\n\n      // 添加 AI 回复到历史\n      chatHistory.push({ role: 'assistant', content: cleanedResult });\n      saveChatHistory();\n      renderMessages();\n      toastr.success('回复成功');\n    } else {\n      toastr.warning('AI 未返回内容');\n    }\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    // 重置状态\n    isGenerating = false;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// =====================================================\n// ⚠️⚠️⚠️ 从这里开始才能用 $(function() {})，上面的代码都是全局的！\n// =====================================================\n\n// ===== 6. 初始化 =====\n// ⚠️⚠️⚠️ 关键：只在这里调用函数，不要在这里定义变量和函数！\n$(function() {\n  // 调试输出，确保代码加载成功\n  console.log('✅ 同层对话初始化开始');\n  console.log('📋 chatHistory 可访问:', typeof chatHistory !== 'undefined');\n  console.log('🔧 renderMessages 可访问:', typeof renderMessages === 'function');\n  console.log('🔧 handleSend 可访问:', typeof handleSend === 'function');\n\n  // ⚠️ 如果上面任何一个是 false，说明函数定义在 $(function() {}) 内部了！\n  if (typeof chatHistory === 'undefined' || typeof renderMessages !== 'function') {\n    console.error('❌❌❌ 严重错误：变量/函数定义在了局部作用域！');\n    console.error('请检查代码，确保所有变量和函数都在 $(function() {}) 外部定义！');\n    toastr.error('代码结构错误：变量作用域问题');\n    return;\n  }\n\n  loadChatHistory();\n\n  // 绑定事件\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-user-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  // 清空按钮\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成');\n  console.log('📊 消息容器:', $('#inner-messages').length > 0 ? '✅ 存在' : '❌ 不存在');\n});\n\n// ===== 7. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  saveChatHistory();\n});\n\`\`\`\n\n**HTML 结构示例（必须包含以下所有元素）：**\n\`\`\`html\n<div class="inner-chat-container">\n  <div class="inner-chat-header">\n    <h3>同层对话</h3>\n    <button id="inner-clear-btn">清空</button>\n  </div>\n\n  \x3c!-- ⚠️ 必需：消息容器，ID 必须是 inner-messages --\x3e\n  <div id="inner-messages" class="inner-messages"></div>\n\n  <div class="inner-input-area">\n    \x3c!-- ⚠️ 必需：输入框，ID 必须是 inner-user-input --\x3e\n    <textarea id="inner-user-input" placeholder="输入消息..."></textarea>\n    \x3c!-- ⚠️ 必需：发送按钮，ID 必须是 inner-send-btn --\x3e\n    <button id="inner-send-btn">发送</button>\n  </div>\n</div>\n\`\`\`\n\n**⚠️ HTML 检查清单：**\n- [ ] 是否有 \`id="inner-messages"\` 的消息容器？\n- [ ] 是否有 \`id="inner-user-input"\` 的输入框？\n- [ ] 是否有 \`id="inner-send-btn"\` 的发送按钮？\n- [ ] 是否有 \`id="inner-clear-btn"\` 的清空按钮？\n- [ ] ID 是否与 JS 代码中使用的完全一致？\n\n**CSS 样式示例（必须严格遵守，确保消息正确左右对齐）：**\n\`\`\`css\n/* 消息容器 */\n.inner-messages {\n  height: 400px;\n  overflow-y: auto;\n  padding: 15px;\n  display: flex;  /* ⚠️ 必须用 flex */\n  flex-direction: column;\n  gap: 10px;\n}\n\n/* 消息基础样式 */\n.message {\n  max-width: 70%;\n  padding: 10px 15px;\n  border-radius: 12px;\n  word-wrap: break-word;\n}\n\n/* ⚠️ 用户消息：右对齐，蓝色 */\n.user-message {\n  align-self: flex-end;  /* ✅ 右对齐关键！*/\n  background: #4a9eff;\n  color: white;\n}\n\n/* ⚠️ AI 消息：左对齐，灰色 */\n.ai-message {\n  align-self: flex-start;  /* ✅ 左对齐关键！*/\n  background: #2a2a2a;\n  color: #e0e0e0;\n}\n\`\`\`\n\n**⚠️ 关键点：**\n- ID 必须用唯一前缀（\`inner-\`）\n- 容器必须 \`display: flex; flex-direction: column\`\n- 用户消息用 \`align-self: flex-end\` 右对齐\n- AI 消息用 \`align-self: flex-start\` 左对齐\n\n**关键 API：**\n- **\`generate(prompt)\`**: **调用 AI 生成（使用当前预设、角色卡、世界书）**\n- \`generateRaw(prompt)\`: 调用 AI 生成（不使用预设，纯文本生成）\n- \`getVariables({ type: 'message', message_id })\`: 读取消息楼层变量\n- \`insertOrAssignVariables(data, { type: 'message', message_id })\`: 保存到消息楼层变量\n- \`getChatMessages()\`: 获取所有消息\n\n**重要区别：**\n- **\`generate\`**: 使用完整的角色预设，适合同层对话（推荐！）\n- **\`generateRaw\`**: 不使用预设，适合纯文本生成任务\n\n**⚠️ 关键注意事项（必读）：**\n1. **作用域问题（最常见错误！80% 的问题都是这个！）**：\n   - ❌ **禁止**：在 \`$(function() {})\` 内部用 \`let\`/\`const\`/\`function\` 定义变量和函数\n   - ✅ **正确**：所有变量和函数都在**全局作用域**定义，\`$(function() {})\` 只用于调用\n   - **验证方法**：在初始化时打印 \`console.log(typeof chatHistory)\`，应该是 \`'object'\` 而非 \`'undefined'\`\n\n1.5. **禁止写模拟/假回复（常见多余代码！）**：\n   - ❌ **禁止**：\`chatHistory.push({ role: 'assistant', content: '这是模拟回复' });\`\n   - ❌ **禁止**：\`chatHistory.push({ role: 'assistant', content: '这是 AI 的回复' });\`\n   - ❌ **禁止**：任何硬编码的假 AI 回复\n   - ✅ **正确**：只调用 \`generate()\`，AI 回复通过 \`STREAM_TOKEN_RECEIVED_FULLY\` 事件自动接收\n   - **原因**：\`generate()\` 会真正调用 AI API，不需要写假回复来测试\n\n2. **generation_id 的正确用法（非常重要！）**：\n   - ❌ 错误：\`const result = await generate(...); const id = result.generation_id;\`\n   - ✅ 正确：\n     \`\`\`javascript\n     const myId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n     await generate({ user_input: text, generation_id: myId });\n     // 监听器中的 id 参数就是 myId\n     \`\`\`\n   - \`generate()\` 返回 \`Promise<string>\`，不返回对象！\n   - 必须自己生成唯一 ID 并传入，不是从返回值获取！\n\n3. **这是前端界面项目，不是消息楼层嵌入！**\n   - 需要创建 \`index.html\` + \`index.ts\`（前端界面项目）\n   - 玩家在界面内游玩，不看酒馆主聊天\n   - 后台可用 \`setChatMessages(..., { refresh: 'none' })\` 操作消息但不刷新\n\n4. **函数命名必须避免冲突**：\n   - ❌ 禁止使用 \`sendChatMessage\`（与酒馆原生函数重名！）\n   - ❌ 禁止使用 \`generate\`、\`getChatMessages\` 等酒馆 API 名作为函数名\n   - ✅ 使用带前缀的名称：\`handleSend\`、\`innerSendMessage\`、\`sendInnerMessage\`\n   - **原因**：重名会导致调用酒馆内部函数 \`sk()\` 等，引发错误\n\n5. **元素 ID 必须唯一**：\n   - 使用 \`inner-\` 等前缀避免与酒馆冲突\n   - 不要用 \`send-button\`、\`user-input\` 等常见名称\n   - **验证方法**：检查 \`$('#inner-messages').length\` 应该是 1，不是 0\n\n6. **流式传输监听（核心！最容易出错！）**：\n   - ⚠️ **事件名：使用常量 \`iframe_events.XXX\`，不要用字符串 \`'iframe_events.XXX'\`**\n   - ⚠️ **回调参数：是 \`(text, id)\`，不是 \`(data)\`！直接用 \`text\` 不要用 \`data.text\`**\n   - ⚠️ **必须启用流式：\`generate({ user_input: text, should_stream: true, generation_id: myId })\`**\n   - 使用 \`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, (text, id) => ...)\` 获取完整回复\n   - 使用 \`eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => ...)\` 获取增量更新\n\n7. **API 使用规范**：\n   - ✅ \`generate(prompt)\`：包含角色卡、预设、世界书（推荐！）\n   - ✅ \`generateRaw(prompt)\`：纯文本生成，不使用预设\n   - 两者都会触发流式传输事件\n\n8. **数据持久化**：\n   - 推荐使用 \`getVariables({ type: 'chat' })\` 和 \`insertOrAssignVariables(data, { type: 'chat' })\`\n   - 或使用消息楼层变量：\`{ type: 'message', message_id }\`\n   - 页面卸载时必须保存数据\n\n**核心示例（必须严格遵守！）：**\n\`\`\`javascript\n// ========== ⚠️ 关键：流式事件监听（最容易出错！）==========\n\n// ❌❌❌ 错误写法（禁止！）：\n// eventOn('iframe_events.STREAM_TOKEN_RECEIVED_FULLY', (data) => { ... })\n// ❌ 不要用字符串 'iframe_events.XXX'\n// ❌ 不要用参数 (data)\n\n// ✅✅✅ 正确写法（必须这样写！）：\neventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text, id) => {\n  // text 是累积的完整文本\n  $('#ai-reply').text(text); // ✅ 直接用 text，不是 text.text 或 data.text\n  console.log('增量更新:', text);\n});\n\neventOn(iframe_events.STREAM_TOKEN_RECEIVED_FULLY, (text, id) => {\n  // text 是最终完整文本\n  console.log('✅ 生成完成:', text); // ✅ 直接用 text\n  chatHistory.push({ role: 'assistant', content: text });\n  saveChatHistory();\n  isGenerating = false;\n  $('#send-btn').prop('disabled', false).text('发送');\n});\n\n// 备选方案：如果流式不工作，用 GENERATION_ENDED\neventOn(iframe_events.GENERATION_ENDED, (text, id) => {\n  console.log('✅ 生成结束:', text);\n  chatHistory.push({ role: 'assistant', content: text });\n  saveChatHistory();\n  isGenerating = false;\n  $('#send-btn').prop('disabled', false).text('发送');\n});\n\n// ========== 发送消息 ==========\nasync function handleSend() {\n  const userInput = $('#user-input').val();\n  chatHistory.push({ role: 'user', content: userInput });\n\n  isGenerating = true;\n  $('#send-btn').prop('disabled', true).text('生成中...');\n\n  // ✅✅✅ 必须这样调用（使用 STScript 命令）：\n  const command = '/gen lock=on "' + userInput.replace(/"/g, '\\\\"') + '"';\n  const result = await triggerSlashWithResult(command);\n\n  if (result) {\n    chatHistory.push({ role: 'assistant', content: result });\n    renderMessages();\n  }\n\n  // ❌❌❌ 禁止使用 generate API：\n  // await generate({ user_input: userInput });  // ❌ 不推荐\n}\n\`\`\`\n\n**为什么用 triggerSlashWithResult？**\n- 使用 \`/gen\` 命令会自动应用角色卡、预设、世界书\n- 返回值直接是生成的文本，简单直接\n- 不需要复杂的流式监听和 generation_id 管理\n\n**\`/gen\` 命令说明：**\n- \`/gen lock=on "提示词"\`：生成时锁定输入框（推荐！）\n- 会自动使用当前角色卡、预设、世界书\n- 返回值是 AI 生成的完整文本\n\n---\n\n# 🌊 同层对话的两种实现方式（AI 自动选择）\n\n当用户需求中提到**"实时显示"、"打字效果"、"流式"、"边生成边显示"**时，使用**真流式方案**（方案B）。\n否则，使用**简单方案**（方案A）。\n\n## ⚠️⚠️⚠️ 必须包含的核心功能（两种方案都要有！）\n\n### 1. 数据持久化（最重要！）\n- ✅ **保存到聊天变量**：使用 \`insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' })\`\n- ✅ **页面加载时恢复**：在 \`$(function() {})\` 中调用 \`loadChatHistory()\`\n- ✅ **切换聊天时重新加载**：监听 \`SillyTavern.getCurrentChatId()\` 变化\n- ✅ **页面卸载时保存**：在 \`$(window).on('pagehide', ...)\` 中保存\n- ✅ **实时保存**：每次发送/接收消息后立即调用 \`saveChatHistory()\`\n\n### 2. 不打断生成（关键！）\n- ✅ **最小化面板不打断**：面板只是隐藏（\`display: none\`），iframe 不卸载\n- ✅ **切换标签页不打断**：数据已保存到变量，切换回来自动恢复\n- ✅ **刷新页面后恢复**：从聊天变量读取 \`chatHistory\`，完整恢复对话\n\n### 3. 跨聊天隔离\n- ✅ **每个聊天独立**：数据存储在 \`{ type: 'chat' }\`，不同聊天文件数据互不影响\n- ✅ **切换聊天自动切换数据**：监听 \`getCurrentChatId()\` 变化，自动加载对应聊天的历史\n\n## 📚 简单方案（triggerSlashWithResult）\n\n**特点：** 代码简单，等待完整生成后一次性显示。\n\n**完整实现（包含数据持久化！）：**\n\n\`\`\`typescript\n// ===== 1. 全局变量（必须在全局作用域！）=====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\n\n// ===== 2. 数据持久化 =====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 正则过滤（核心！）=====\nfunction applyRegexFilters(text: string): string {\n  console.log('🔍 开始清理，原始长度:', text.length);\n\n  if (!text || typeof text !== 'string') return '';\n\n  // ===== 步骤 0: 修复未闭合的标签 =====\n  const criticalTags = ['thinking', 'UpdateVariable', 'guide', 'plot', 'status', 'dream', 'gametxt'];\n  criticalTags.forEach(tag => {\n    const openTagRegex = new RegExp(\\\`<\\\${tag}([^>]*)>\\\`, 'gi');\n    const closeTagRegex = new RegExp(\\\`</\\\${tag}>\\\`, 'gi');\n\n    const openMatches = text.match(openTagRegex);\n    const closeMatches = text.match(closeTagRegex);\n\n    const openCount = openMatches ? openMatches.length : 0;\n    const closeCount = closeMatches ? closeMatches.length : 0;\n\n    if (openCount > closeCount) {\n      const missing = openCount - closeCount;\n      console.log(\\\`⚠️ 发现 \\\${missing} 个未闭合的 <\\\${tag}> 标签，自动补齐\\\`);\n      text = text + \\\`</\\\${tag}>\\\`.repeat(missing);\n    }\n  });\n\n  // ===== 步骤 1: 优先提取正文标签（梦星方案）=====\n  function extractLastTagContent(tagName: string, text: string): string | null {\n    if (!text || typeof text !== 'string') return null;\n\n    const endTag = \\\`</\\\${tagName}>\\\`;\n    const searchPool = text.toLowerCase();\n    const endTagPattern = endTag.toLowerCase();\n\n    const lastEndIndex = searchPool.lastIndexOf(endTagPattern);\n    if (lastEndIndex !== -1) {\n      const startTag = \\\`<\\\${tagName}>\\\`;\n      const startTagPattern = startTag.toLowerCase();\n\n      const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);\n      if (lastStartIndex !== -1) {\n        const startIndex = lastStartIndex + startTag.length;\n        return text.substring(startIndex, lastEndIndex).trim();\n      }\n    }\n    return null;\n  }\n\n  const gameTextTags = ['dream', 'gametxt', 'output', 'display', 'text', 'content'];\n  for (const tag of gameTextTags) {\n    const extracted = extractLastTagContent(tag, text);\n    if (extracted !== null) {\n      console.log(\\\`✅ 提取了 <\\\${tag}> 标签的内容，长度:\\\`, extracted.length);\n      return extracted;\n    }\n  }\n\n  // ===== 步骤 2: 移除所有思维链标签 =====\n  let cleanedText = text;\n\n  const tagsToRemove = [\n    'guide', 'plot', 'status',\n    'UpdateVariable', '角色提取', '本世历程', '往世涟漪'\n  ];\n\n  tagsToRemove.forEach(tag => {\n    const regexWithContent = new RegExp(\\\`<\\\${tag}[^>]*>[\\\\\\\\s\\\\\\\\S]*?</\\\${tag}>\\\`, 'gi');\n    const before = cleanedText;\n    cleanedText = cleanedText.replace(regexWithContent, '');\n\n    const regexSelfClosing = new RegExp(\\\`<\\\${tag}\\\\\\\\s*\\\\\\\\/>\\\`, 'gi');\n    cleanedText = cleanedText.replace(regexSelfClosing, '');\n\n    if (before !== cleanedText) {\n      console.log(\\\`  🧹 移除了 <\\\${tag}> 标签\\\`);\n    }\n  });\n\n  // 特殊处理：移除所有包含 think/thinking 的标签\n  const thinkingRegex = /<[^>]*think[^>]*>[\\\\s\\\\S]*?<\\\\/[^>]*think[^>]*>/gi;\n  const beforeThinking = cleanedText;\n  cleanedText = cleanedText.replace(thinkingRegex, '');\n  if (beforeThinking !== cleanedText) {\n    console.log('  🧹 移除了包含 think/thinking 的思维链标签');\n  }\n\n  const thinkingSelfClosing = /<[^>]*think[^>]*\\\\/>/gi;\n  cleanedText = cleanedText.replace(thinkingSelfClosing, '');\n\n  cleanedText = cleanedText.replace(/\x3c!--[\\s\\S]*?--\x3e/g, '');\n\n  if (cleanedText !== text) {\n    console.log('✅ 标签清理完成，清理后长度:', cleanedText.length);\n    text = cleanedText;\n  }\n\n  // ===== 步骤 3: 尝试应用酒馆正则（可选）=====\n  let allRegexScripts: any[] = [];\n\n  if (typeof getRegexScripts === 'function') {\n    try {\n      const globalRegexes = getRegexScripts();\n      if (globalRegexes && globalRegexes.length > 0) {\n        console.log('📋 从全局正则获取到', globalRegexes.length, '个脚本');\n        allRegexScripts = allRegexScripts.concat(globalRegexes);\n      }\n    } catch (e) {\n      console.warn('⚠️ 获取全局正则失败:', e);\n    }\n  }\n\n  try {\n    const parentST = (window as any).parent?.SillyTavern || (window as any).SillyTavern;\n    if (parentST && typeof parentST.getContext === 'function') {\n      const context = parentST.getContext();\n      const prompts = context?.chatCompletionSettings?.prompts;\n\n      if (prompts && Array.isArray(prompts)) {\n        const possibleIdentifiers = ['regexes-bindings', 'SPresetSettings', 'regex-bindings'];\n\n        for (const identifier of possibleIdentifiers) {\n          const regexPrompt = prompts.find((p: any) => p.identifier === identifier);\n          if (regexPrompt?.content) {\n            try {\n              const data = JSON.parse(regexPrompt.content);\n              let presetRegexes: any = null;\n\n              if (Array.isArray(data)) {\n                presetRegexes = data;\n              } else if (data && typeof data === 'object') {\n                if (data.RegexBinding?.regexes && Array.isArray(data.RegexBinding.regexes)) {\n                  presetRegexes = data.RegexBinding.regexes;\n                } else if (data.regexes && Array.isArray(data.regexes)) {\n                  presetRegexes = data.regexes;\n                }\n              }\n\n              if (presetRegexes && presetRegexes.length > 0) {\n                console.log('📋 从预设内置正则获取到', presetRegexes.length, '个脚本 (identifier:', identifier + ')');\n                allRegexScripts = allRegexScripts.concat(presetRegexes);\n                break;\n              }\n            } catch (parseError) {\n              console.warn('⚠️ 解析 identifier', identifier, '失败:', parseError);\n            }\n          }\n        }\n      }\n    }\n  } catch (e) {\n    console.warn('⚠️ 获取预设内置正则失败:', e);\n  }\n\n  if (allRegexScripts.length > 0) {\n    console.log('📋 总共获取到', allRegexScripts.length, '个正则脚本');\n\n    const activeScripts = allRegexScripts.filter((script: any) => {\n      if (script.disabled) return false;\n      if (!script.placement || !Array.isArray(script.placement)) return false;\n      if (!script.placement.includes(2)) return false;\n      return true;\n    });\n\n    console.log('✅ 找到', activeScripts.length, '个适用的正则脚本');\n\n    let result = text;\n    activeScripts.forEach((script: any, index: number) => {\n      try {\n        const regex = new RegExp(script.findRegex, 'gim');\n        const beforeLength = result.length;\n        result = result.replace(regex, script.replaceString || '');\n\n        if (beforeLength !== result.length) {\n          console.log('🧹 正则', index + 1, '(', script.scriptName, ') 生效');\n        }\n      } catch (e) {\n        console.error('❌ 正则', index + 1, '应用失败:', e);\n      }\n    });\n\n    text = result;\n  }\n\n  console.log('📊 最终长度:', text.length);\n  return text;\n}\n\n// ===== 4. 发送消息 =====\nasync function handleSend() {\n  const input = $('#inner-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    if (typeof triggerSlashWithResult !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    const userName = SillyTavern?.name1 || 'You';\n    const charName = SillyTavern?.name2 || 'AI';\n\n    let fullPrompt = '';\n    if (chatHistory.length > 1) {\n      fullPrompt += '【对话历史】\\n';\n      chatHistory.slice(0, -1).forEach((msg) => {\n        const name = msg.role === 'user' ? userName : charName;\n        fullPrompt += name + ': ' + msg.content + '\\n';\n      });\n      fullPrompt += '\\n';\n    }\n    fullPrompt += userName + ': ' + userInput;\n\n    console.log('🚀 开始生成，提示词长度:', fullPrompt.length);\n\n    const command = '/gen lock=on "' + fullPrompt.replace(/"/g, '\\\\"') + '"';\n    const result = await triggerSlashWithResult(command);\n\n    console.log('📥 AI 返回值长度:', result ? result.length : 0);\n\n    if (result && result.length > 0) {\n      const cleanedResult = applyRegexFilters(result);\n      console.log('🧹 正则过滤后长度:', cleanedResult.length);\n\n      chatHistory.push({ role: 'assistant', content: cleanedResult });\n      saveChatHistory();\n      renderMessages();\n      toastr.success('回复成功');\n    } else {\n      toastr.warning('AI 未返回内容');\n    }\n\n  } catch (error) {\n    console.error('生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n  } finally {\n    isGenerating = false;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 5. 渲染消息 =====\nfunction renderMessages() {\n  const container = $('#inner-messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 6. 监听聊天切换（重要！）=====\nlet currentChatId = SillyTavern.getCurrentChatId();\nif (typeof eventOn === 'function') {\n  eventOn('CHAT_CHANGED', (newChatId: string) => {\n    if (currentChatId !== newChatId) {\n      console.log('🔄 检测到聊天切换:', currentChatId, '->', newChatId);\n      currentChatId = newChatId;\n\n      // 重新加载新聊天的历史\n      loadChatHistory();\n\n      // 重置生成状态（如果正在生成，会被打断）\n      if (isGenerating) {\n        isGenerating = false;\n        $('#inner-send-btn').prop('disabled', false).text('发送');\n        console.log('⚠️ 切换聊天，已中断生成');\n      }\n    }\n  });\n}\n\n// ===== 7. 初始化 =====\n$(function() {\n  console.log('✅ 同层对话初始化开始（方案A）');\n  console.log('📊 当前聊天 ID:', currentChatId);\n\n  // 加载聊天历史（从聊天变量恢复）\n  loadChatHistory();\n\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成（方案A）');\n  console.log('💾 已加载', chatHistory.length, '条历史消息');\n});\n\n// ===== 8. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  console.log('💾 页面卸载，保存数据');\n  saveChatHistory();\n});\n\`\`\`\n\n---\n\n## 🌊 真流式方案（generate + 事件监听）\n\n**特点：** 实时显示 AI 打字效果，体验最佳。\n\n**完整实现：**\n\n\`\`\`typescript\n// ===== 1. 全局变量（必须在全局作用域！）=====\nlet chatHistory: Array<{ role: string; content: string }> = [];\nlet isGenerating = false;\nlet currentGenerationId: string | null = null;\n\n// ===== 2. 数据持久化（与方案A相同）=====\nfunction loadChatHistory() {\n  const isInTavern = typeof getVariables === 'function';\n  if (!isInTavern) {\n    const saved = localStorage.getItem('inner_chat_history');\n    chatHistory = saved ? JSON.parse(saved) : [];\n  } else {\n    const data = getVariables({ type: 'chat' });\n    chatHistory = data?.inner_chat_history || [];\n  }\n  renderMessages();\n}\n\nfunction saveChatHistory() {\n  const isInTavern = typeof insertOrAssignVariables === 'function';\n  if (!isInTavern) {\n    localStorage.setItem('inner_chat_history', JSON.stringify(chatHistory));\n  } else {\n    insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' });\n  }\n}\n\n// ===== 3. 正则过滤（与方案A相同）=====\nfunction applyRegexFilters(text: string): string {\n  // ... 与方案A完全相同，此处省略 ...\n  // （请复制方案A中的 applyRegexFilters 完整实现）\n  return text;\n}\n\n// ===== 4. 真流式监听（核心！）=====\nfunction setupStreamListeners() {\n  // ⚠️ 监听增量文本（实时更新）\n  eventOn(iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY, (text: string, id: string) => {\n    if (!isGenerating || id !== currentGenerationId) return;\n\n    console.log('📥 收到增量文本，长度:', text.length);\n\n    // ⚠️ 实时清理标签\n    const cleanedText = applyRegexFilters(text);\n\n    // 更新 DOM\n    const container = $('#inner-messages');\n    const charName = (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n    const lastMsg = container.find('.message:last-child');\n\n    if (lastMsg.length && lastMsg.hasClass('ai-message')) {\n      // 更新已有的 AI 消息\n      lastMsg.html('<strong>' + charName + ':</strong> <span class="streaming">' + cleanedText + '</span>');\n    } else {\n      // 创建新的 AI 消息\n      const msgDiv = $('<div>')\n        .addClass('message ai-message')\n        .html('<strong>' + charName + ':</strong> <span class="streaming">' + cleanedText + '</span>');\n      container.append(msgDiv);\n    }\n\n    // 自动滚动到底部\n    container.scrollTop(container[0].scrollHeight);\n  });\n\n  // ⚠️ 监听生成完成\n  eventOn(iframe_events.GENERATION_ENDED, (text: string, id: string) => {\n    if (id === currentGenerationId) {\n      console.log('✅ 流式生成完成，长度:', text.length);\n\n      // ⚠️ 最后清理一次再保存\n      const cleanedText = applyRegexFilters(text);\n\n      // 保存到聊天历史\n      chatHistory.push({ role: 'assistant', content: cleanedText });\n      saveChatHistory();\n\n      // 重新渲染（移除光标效果）\n      renderMessages();\n\n      // 重置状态\n      isGenerating = false;\n      currentGenerationId = null;\n      $('#inner-send-btn').prop('disabled', false).text('发送');\n\n      toastr.success('回复完成');\n    }\n  });\n}\n\n// ===== 5. 发送消息（真流式版本）=====\nasync function handleSend() {\n  const input = $('#inner-input');\n  const userInput = input.val().trim();\n  if (!userInput || isGenerating) return;\n\n  // 添加用户消息\n  chatHistory.push({ role: 'user', content: userInput });\n  input.val('');\n  saveChatHistory();\n  renderMessages();\n\n  // 生成唯一 ID\n  currentGenerationId = 'chat-' + Date.now() + '-' + Math.random().toString(36).slice(2);\n\n  // 设置生成状态\n  isGenerating = true;\n  $('#inner-send-btn').prop('disabled', true).text('生成中...');\n\n  try {\n    if (typeof generate !== 'function') {\n      throw new Error('请在酒馆中使用此功能');\n    }\n\n    console.log('🚀 开始生成（真流式），generation_id:', currentGenerationId);\n\n    // ⚠️ 核心：调用 generate 并启用流式\n    await generate({\n      user_input: userInput,\n      should_stream: true,           // ⚠️ 必须启用流式\n      generation_id: currentGenerationId,  // ⚠️ 必须传入 ID\n      overrides: {\n        chat_history: {\n          prompts: chatHistory.map(msg => ({\n            role: msg.role === 'user' ? 'user' : 'assistant',\n            content: msg.content\n          }))\n        }\n      }\n    });\n\n    // 注意：实际的文本更新是通过事件监听器实时更新的\n    // GENERATION_ENDED 事件会自动保存 AI 回复到历史\n\n  } catch (error) {\n    console.error('❌ 生成失败:', error);\n    toastr.error('生成失败: ' + (error?.message || String(error)));\n\n    // 重置状态\n    isGenerating = false;\n    currentGenerationId = null;\n    $('#inner-send-btn').prop('disabled', false).text('发送');\n  }\n}\n\n// ===== 6. 渲染消息（与方案A相同）=====\nfunction renderMessages() {\n  const container = $('#inner-messages');\n  container.empty();\n\n  chatHistory.forEach((msg, index) => {\n    const name = msg.role === 'user'\n      ? (typeof getCurrentUser === 'function' ? getCurrentUser()?.name : null) || '{{user}}'\n      : (typeof getCurrentCharacter === 'function' ? getCurrentCharacter()?.name : null) || '{{char}}';\n\n    const msgDiv = $('<div>')\n      .addClass('message')\n      .addClass(msg.role === 'user' ? 'user-message' : 'ai-message')\n      .html('<strong>' + name + ':</strong> ' + msg.content);\n    container.append(msgDiv);\n  });\n\n  container.scrollTop(container[0].scrollHeight);\n}\n\n// ===== 7. 监听聊天切换（重要！）=====\nlet currentChatId = SillyTavern.getCurrentChatId();\nif (typeof eventOn === 'function') {\n  eventOn('CHAT_CHANGED', (newChatId: string) => {\n    if (currentChatId !== newChatId) {\n      console.log('🔄 检测到聊天切换:', currentChatId, '->', newChatId);\n      currentChatId = newChatId;\n\n      // 重新加载新聊天的历史\n      loadChatHistory();\n\n      // 重置生成状态（如果正在生成，会被打断）\n      if (isGenerating) {\n        isGenerating = false;\n        currentGenerationId = null;\n        $('#inner-send-btn').prop('disabled', false).text('发送');\n        console.log('⚠️ 切换聊天，已中断生成');\n      }\n    }\n  });\n}\n\n// ===== 8. 初始化 =====\n$(function() {\n  console.log('✅ 同层对话初始化开始（方案B - 真流式）');\n  console.log('📊 当前聊天 ID:', currentChatId);\n\n  // 加载聊天历史（从聊天变量恢复）\n  loadChatHistory();\n\n  // 设置流式监听（⚠️ 必须在加载时就设置）\n  setupStreamListeners();\n\n  $('#inner-send-btn').on('click', handleSend);\n  $('#inner-input').on('keypress', (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  });\n\n  $('#inner-clear-btn').on('click', () => {\n    if (confirm('确定清空对话历史？')) {\n      chatHistory = [];\n      renderMessages();\n      saveChatHistory();\n    }\n  });\n\n  console.log('✅ 同层对话初始化完成（方案B）');\n  console.log('💾 已加载', chatHistory.length, '条历史消息');\n});\n\n// ===== 9. 卸载时保存 =====\n$(window).on('pagehide', () => {\n  console.log('💾 页面卸载，保存数据');\n  saveChatHistory();\n});\n\`\`\`\n\n**CSS 样式（为方案B添加光标效果）：**\n\n\`\`\`css\n.streaming {\n  border-right: 2px solid #165DFF;\n  padding-right: 4px;\n  animation: blink 1s infinite;\n}\n\n@keyframes blink {\n  0%, 50% { border-right-color: #165DFF; }\n  51%, 100% { border-right-color: transparent; }\n}\n\`\`\`\n\n---\n\n## 🤖 AI 选择策略\n\n**分析用户需求描述，自动选择合适方案：**\n\n1. **使用真流式方案（第二种）**，如果用户提到：\n   - "实时显示"、"边生成边显示"\n   - "打字效果"、"流式"\n   - "不想等待"、"即时反馈"\n   - 或明确要求同层对话\n\n2. **使用简单方案（第一种）**，如果：\n   - 用户没有明确要求流式显示\n   - 或用户说"简单的对话界面"\n\n**⚠️ 默认推荐：** 当用户提到"同层对话"时，默认使用**真流式方案**（体验更好）。\n\n## 需求收集与界面设计引导（重要！）\n\n**当用户需求不够详细时，必须先引导用户补充信息，不要立即生成代码！**\n\n### AI 交互流程（必须遵守）\n\n**步骤1：检查用户需求是否完整**\n\n检查用户是否明确了以下内容：\n- 界面布局（对话框、输入区域、功能区的排布）\n- 配色方案（深色/浅色模式、主色调）\n- 特殊效果（动画、过渡效果）\n- 额外功能（文件上传、语音输入、消息编辑等）\n\n**步骤2：根据需求完整度决定输出**\n\n### 情况A：需求不完整（用户只说了"同层对话"、"流式对话"等核心功能）\n\n**不要立即生成代码！应该先引导用户补充需求！**\n\n输出格式：\n\`\`\`\nFILE_START: NEED_MORE_INFO\n\n你好！我看到你想要创建一个对话前端界面，核心功能包括：\n- 真流式传输（实时显示 AI 生成）\n- 消息历史自动管理（保存到聊天变量）\n- 正文标签实时清理（过滤思维链等）\n\n但是，为了给你生成最符合需求的界面，我需要了解更多细节：\n\n**1. 界面布局**\n- 对话框的位置和大小？\n- 输入区域放在底部还是其他位置？\n- 是否需要侧边栏、顶部栏或底部功能区？\n- 消息列表如何滚动（自动滚动到底部？）\n\n**2. 配色方案**\n- 偏好深色模式还是浅色模式？\n- 主色调偏好（蓝色、绿色、紫色等）？\n- 用户消息和 AI 消息如何区分颜色？\n\n**3. 特殊效果**\n- 是否需要动画效果（淡入淡出、滑动等）？\n- 消息出现时的过渡效果？\n- 按钮点击、输入框聚焦的交互反馈？\n\n**4. 额外功能**\n- 是否需要文件上传功能？\n- 是否需要语音输入？\n- 是否需要消息编辑/删除功能？\n- 是否需要清空历史按钮？\n- 是否需要正则预设切换（下拉菜单或按钮组）？\n\n---\n\n**在你提供这些详细信息之前，我先说明一下核心功能的实现原理：**\n\n### 核心组件结构\n\n一个基本的对话界面包含：\n\n1. **消息显示区**：用于渲染所有历史消息和正在进行的流式消息，支持滚动显示\n2. **消息输入区**：用户输入文本的区域，通常包含发送按钮\n3. **功能控制区**（可选）：切换正则预设、清除历史等功能按钮\n\n### 真流式对话的实现机制\n\n**流程：**\n1. 用户发送消息 → 调用 \`generate({ should_stream: true, generation_id })\`\n2. 监听 \`iframe_events.STREAM_TOKEN_RECEIVED_INCREMENTALLY\` 事件实时接收文本片段\n3. 每接收一个片段 → 清理标签 → 附加到显示区（形成打字机效果）\n4. 流式结束 → 保存完整的清理后消息到 \`chatHistory\` → 持久化到聊天变量\n\n**关键点：**\n- 使用 \`generation_id\` 过滤事件（避免接收其他对话的消息）\n- 实时清理标签（\`applyRegexFilters\`）防止思维链暴露\n- 禁用发送按钮防止用户重复发送\n\n### 消息历史自动保存\n\n**数据结构：**\n\`\`\`javascript\nlet chatHistory = [\n  { role: 'user', content: '用户消息', timestamp: '...' },\n  { role: 'assistant', content: 'AI回复（已清理标签）', timestamp: '...' }\n];\n\`\`\`\n\n**保存时机：**\n- 用户消息：点击发送后立即保存\n- AI 消息：流式传输完成后，清理标签再保存\n\n**持久化：**\n使用 \`insertOrAssignVariables({ inner_chat_history: chatHistory }, { type: 'chat' })\` 保存到聊天变量\n\n### 正文标签实时清理\n\n**\`applyRegexFilters\` 函数的核心逻辑：**\n1. 自动补齐未闭合的标签（防止"前端失踪"）\n2. 优先提取正文标签（\`<dream>\`、\`<gametxt>\` 等）\n3. 移除思维链标签（\`<think>\`、\`<guide>\`、\`<plot>\` 等）\n4. 应用酒馆全局正则和预设正则\n\n**调用时机：**\n- 流式接收时：每个片段都清理后再显示\n- 保存时：完整消息清理后再保存到历史\n\n---\n\n**请补充上述细节，我会为你生成完整的代码！**\n\n如果你现在不想纠结这些细节，也可以直接说"用默认设计"，我会使用以下默认配置：\n- 深色模式（背景 #1a1a1a）\n- 用户消息：右对齐蓝色（#4a9eff）\n- AI 消息：左对齐灰色（#3a3a3a）\n- 圆角设计 + 基础动画\n- 自动滚动到底部\n\nFILE_END\n\`\`\`\n\n### 情况B：需求完整（用户提供了详细的界面设计需求）\n\n**直接生成代码！**\n\n输出格式：\n\`\`\`\nFILE_START: index.html\n[完整的 HTML 代码]\nFILE_END\n\nFILE_START: style.css\n[完整的 CSS 代码]\nFILE_END\n\nFILE_START: script.js\n[完整的 JavaScript 代码]\nFILE_END\n\`\`\`\n\n### 情况C：用户明确说"用默认设计"或"简单的对话界面就行"\n\n**使用默认设计规范生成代码**\n\n**默认界面设计规范：**\n- 深色模式（背景 #1a1a1a，消息区 #2a2a2a）\n- 用户消息：右对齐，蓝色背景（#4a9eff）\n- AI 消息：左对齐，灰色背景（#3a3a3a）\n- 圆角设计（border-radius: 12px）\n- 基础过渡动画（fadeIn/fadeOut）\n- 自动滚动到底部\n- 清空历史按钮\n- 基础的消息列表和输入框\n\n---\n\n### 正则预设切换功能（可选）\n\n如果用户明确需要支持不同的正则清理预设：\n\n\`\`\`typescript\n// 定义正则预设\nconst regexPresets = {\n  "默认清理": [\n    { pattern: /<tag1>/g, replacement: "" },\n    { pattern: /\\[tag2\\]/g, replacement: "" },\n  ],\n  "特殊格式清理": [\n    { pattern: /\\{\\{some_meta_data\\}\\}/g, replacement: "" },\n  ]\n};\n\nlet currentPreset = "默认清理";\n\nfunction applyRegexFilters(text: string, presetName?: string): string {\n  const preset = presetName || currentPreset;\n  const rules = regexPresets[preset] || regexPresets["默认清理"];\n\n  let cleanedText = text;\n  rules.forEach(rule => {\n    cleanedText = cleanedText.replace(rule.pattern, rule.replacement);\n  });\n\n  // 仍然应用酒馆的全局正则\n  // ... 原有逻辑 ...\n\n  return cleanedText;\n}\n\nfunction switchPreset(presetName: string) {\n  currentPreset = presetName;\n  renderMessages(); // 重新渲染应用新预设\n}\n\`\`\`\n\n**界面实现：**在顶部添加下拉菜单或按钮组切换预设\n\n---\n\n# 输出格式（必须严格遵守）：\n只在 FILE_START 和 FILE_END 之间输出代码，不要添加任何其他文字。\n\n**示例（创建界面时必须输出三个文件）：**\n\nFILE_START: index.html\n[完整的 HTML 代码，包含 head、body、引用 CSS 和 JS]\nFILE_END\n\nFILE_START: style.css\n[完整的 CSS 样式代码]\nFILE_END\n\nFILE_START: script.js\n[完整的 JavaScript 代码，使用 jQuery]\nFILE_END\n\n**⚠️ 代码规范（必须遵守）：**\n1. **函数命名**：必须使用唯一前缀（如 \`inner\`、\`my\`），避免与酒馆函数重名\n   - ❌ 禁止：\`sendChatMessage\`、\`generate\`、\`getChatMessages\`\n   - ✅ 正确：\`innerSendMessage\`、\`handleSendMessage\`、\`sendInnerMessage\`\n2. **元素 ID**：必须使用唯一前缀（如 \`inner-\`、\`my-\`）\n   - ❌ 禁止：\`#send-button\`、\`#user-input\`\n   - ✅ 正确：\`#inner-send-btn\`、\`#inner-user-input\`\n3. **每个文件都要输出完整内容，不能省略！**\n\n# 🔑 核心原则：优先增量修改，避免重写！\n**除非用户明确要求"重写"、"从头开始"、"重新创建"，否则必须基于现有代码进行最小化修改！**\n\n- ✅ 用户说"把按钮改成绿色" → **只输出 style.css**（只改颜色）\n- ✅ 用户说"添加一个重置功能" → **只输出 script.js**（只加函数）\n- ✅ 用户说"修复点击无响应" → **只输出 script.js**（只改事件）\n- ❌ 禁止：因为小改动就重写整个文件！\n\n# 输出文件策略：\n## 小改动（只输出必要的文件）：\n- 只修改颜色/字体/边距/动画 → **只输出 style.css**\n- 只修改一个函数逻辑/修复 bug → **只输出 script.js**\n- 只添加一个按钮/输入框 → **只输出 index.html**\n- 只修改文案/标签内容 → **只输出 index.html**\n\n## 大改动（输出所有相关文件）：\n- 创建新界面/新功能 → **输出 index.html、style.css、script.js**\n- 重构整体布局/完全重设计 → **输出所有文件**\n- 添加需要新样式和新逻辑的复杂功能 → **输出相关的所有文件**\n\n# 其他规则：\n1. **⚠️ 数据持久化：涉及用户数据必须使用 getVariables/insertOrAssignVariables！**\n2. **⚠️ 预览兼容：必须检测 \`typeof SillyTavern !== 'undefined'\`，预览模式下用 localStorage 替代酒馆 API**\n3. 必须输出完整内容，即使文件很长也不能省略（但优先只输出需要修改的文件）\n4. 不要在代码外添加任何解释文字\n5. CSS 要美观且符合现代设计\n6. JavaScript 使用 \`$(function() { ... })\` 确保 DOM 加载\n7. 数据存储：\`{ type: 'chat' }\` 绑定聊天，\`{ type: 'global' }\` 为全局\n8. 保持现有代码的命名风格、缩进、格式，不要随意重构`,p=`# 当前项目文件：\n${e.files.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n')}\n\n# 用户需求：\n${E.value}\n\n# ⚠️ 核心提醒：\n1. **优先增量修改**：除非用户明确要求重写，否则基于现有代码最小化修改\n2. **只输出需要改的文件**：小改动只输出 1 个文件，大改动才输出多个\n3. **保持代码风格一致**：不要随意重构现有代码\n4. **数据持久化**：使用 getVariables/insertOrAssignVariables\n\n请严格按 system 中的格式输出，不要添加解释！`;H.value='';let u='';if(G.value?.setProgress(25),G.value?.setMessage('正在发送请求到 AI 服务器...'),W.updateTaskProgress(a,25,'正在发送请求到 AI 服务器...'),await new Promise(e=>setTimeout(e,100)),L.value){G.value?.setProgress(30),G.value?.setMessage('等待 AI 流式响应...'),W.updateTaskProgress(a,30,'等待 AI 流式响应...'),await new Promise(e=>setTimeout(e,100));const e=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${s}`},body:JSON.stringify({model:i,messages:[{role:'system',content:c},{role:'user',content:p}],temperature:l,max_tokens:d,stream:!0})});if(!e.ok){let n=`API 请求失败: ${e.status} ${e.statusText}`;try{const t=await e.json();console.error('API 错误详情:',t),n+=`\n${JSON.stringify(t,null,2)}`}catch(o){console.error('无法解析错误响应')}throw new Error(n)}const n=e.body?.getReader(),r=new TextDecoder;if(!n)throw new Error('无法读取响应流');let g=0;for(;;){const{done:e,value:t}=await n.read();if(e)break;const a=r.decode(t,{stream:!0}).split('\n');for(const n of a)if(n.startsWith('data: ')){const e=n.slice(6);if('[DONE]'===e)continue;try{const n=JSON.parse(e),t=n.choices?.[0]?.delta?.content||'';if(t){u+=t,H.value+=t,g++;const e=Math.min(60,30+g/10);G.value?.setProgress(e),g%10==0&&G.value?.setMessage(`正在接收 AI 响应... (${u.length} 字符)`)}}catch(o){}}}}else{G.value?.setProgress(30),G.value?.setMessage('等待 AI 响应...'),W.updateTaskProgress(a,30,'等待 AI 响应...'),await new Promise(e=>setTimeout(e,100));const e=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${s}`},body:JSON.stringify({model:i,messages:[{role:'system',content:c},{role:'user',content:p}],temperature:l,max_tokens:d})});if(!e.ok){let n=`API 请求失败: ${e.status} ${e.statusText}`;try{const t=await e.json();console.error('API 错误详情:',t),n+=`\n${JSON.stringify(t,null,2)}`}catch(o){console.error('无法解析错误响应')}throw new Error(n)}G.value?.setProgress(60),G.value?.setMessage('正在接收 AI 响应...'),W.updateTaskProgress(a,60,'正在接收 AI 响应...');const n=await e.json();u=n.choices?.[0]?.message?.content||''}if(G.value?.setProgress(75),G.value?.setMessage('正在解析 AI 生成的代码...'),W.updateTaskProgress(a,75,'正在解析 AI 生成的代码...'),console.log('AI 原始回复:',u),console.log('AI 回复长度:',u.length),!u||0===u.trim().length)throw new Error('AI 返回内容为空，请检查 API 配置或重试');const g=[],f=/FILE_START:\s*(.+?)[\r\n]+([\s\S]*?)FILE_END/gi;let m;console.log('开始解析 AI 返回内容...');const x=u.match(/FILE_START:\s*NEED_MORE_INFO\s*[\r\n]+([\s\S]*?)FILE_END/i);if(x){const e=x[1].trim();return console.log('🤖 AI 需要更多信息，显示引导内容'),ke(),toastr.info('AI 需要更多信息','',{timeOut:3e3}),alert(e),void(P.value=!1)}for(;null!==(m=f.exec(u));){const n=m[1].trim(),t=m[2].trim();console.log(`找到文件: ${n}, 内容长度: ${t.length}`);const a=e.files.find(e=>e.path===n);a?g.push({path:n,oldContent:a.content,newContent:t}):console.warn(`文件 ${n} 不存在于项目中，已忽略`)}if(0===g.length){if(console.error('未能从 AI 回复中解析出文件修改'),console.error('AI 返回内容预览:',u.substring(0,500)),u.length<500||!u.includes('FILE_END'))throw new Error(`AI 返回内容被截断（仅 ${u.length} 字符）。请在"设置"中增加 max_tokens（建议 4000 以上），然后重试。`);throw new Error('AI 未返回有效的文件修改格式。请确保 AI 返回的内容包含 FILE_START 和 FILE_END 标记。')}console.log('解析到的修改:',g.length,'个文件'),G.value?.setProgress(85),G.value?.setMessage('正在准备对比预览...'),W.updateTaskProgress(a,85,'正在准备对比预览...'),1===g.length&&'index.html'===g[0].path&&toastr.warning('AI 可能只生成了 HTML，建议重新生成或手动补充 CSS/JS');(u.trim().split('FILE_START').pop()||'').includes('FILE_END')||toastr.error('AI 回复可能被截断，建议简化需求或重试');const h={changes:g};if(!h.changes||!Array.isArray(h.changes))throw new Error('AI 返回格式错误');U.value=h.changes,G.value?.setProgress(95),G.value?.setMessage(`正在生成预览... (${g.length} 个文件)`),W.updateTaskProgress(a,95,`正在生成预览... (${g.length} 个文件)`),ke(),V.value=!0,J.value='after',G.value?.setProgress(100),G.value?.setMessage('✅ AI 生成完成！'),W.updateTaskProgress(a,100,'✅ AI 生成完成！'),W.completeTask(a,{changedFiles:g.length}),setTimeout(()=>{Z.value=!1,toastr.success(`✅ AI 生成完成！已更新 ${g.length} 个文件`)},800)}catch(r){console.error('AI 生成失败:',r);const e=r.message||String(r);W.failTask(a,e),Z.value=!1,e.includes('CORS')||e.includes('Failed to fetch')||e.includes('Access-Control-Allow-Origin')?toastr.error(`⚠️ CORS 错误：无法访问 API\n\n原因：API 服务器（${new URL(t).origin}）未配置 CORS 头\n\n解决方案：\n1. 在 API 服务器配置 CORS\n2. 或使用支持 CORS 的 API 端点\n3. 或通过酒馆的 API 代理功能调用`):e.includes('307')||e.includes('Temporary Redirect')?toastr.error(`⚠️ URL 重定向错误\n\n端点：${t}\n\n可能原因：URL 格式不正确\n请检查端点设置，确保格式为：https://服务器/v1`):toastr.error(`AI 生成失败: ${e}`)}finally{P.value=!1}}function Se(){const e=te.value;if(!e)return;const n={timestamp:(new Date).toISOString(),prompt:E.value,changes:U.value};if(B.value[h.value]||(B.value[h.value]=[]),B.value[h.value].unshift(n),console.log('添加 AI 历史记录，当前项目历史数:',B.value[h.value].length),U.value.forEach(n=>{const t=e.files.find(e=>e.path===n.path);t&&(t.content=n.newContent)}),be(),xe(),w.value){const n=e.files.find(e=>e.path===w.value);n&&(S.value=n.content)}V.value=!1,U.value=[],toastr.success('更改已应用')}function Ae(){V.value=!1,U.value=[],toastr.info('已拒绝更改')}function $e(){F.value=!0}function Ce(){F.value=!1}function Ee(){const e=te.value;if(!e)return void toastr.error('请先选择一个项目');const n=e.files.find(e=>e.name===w.value);if(n&&S.value!==n.content){if(!confirm('检测到有未保存的修改，建议先手动保存。\n\n是否继续导出（将使用上次保存的版本）？'))return}const t=prompt(`正在导出项目：${e.name}\n\n请输入触发词（正则表达式）：\n例如：【开场白】 或 /开场白/g`,`【${e.name}】`);if(t)try{const n=me(e.files),a='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const n=16*Math.random()|0;return('x'===e?n:3&n|8).toString(16)});let o=n.replace(/\r/g,'');o=o.replace(/^<!DOCTYPE html>\n/,'');const r={id:a,scriptName:e.name,findRegex:t.startsWith('/')?t:`/${t}/g`,replaceString:'```html\n\n'+o+'\n```',trimStrings:[],placement:[1,2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null},s=JSON.stringify(r,null,4),i=new Blob([s],{type:'application/json'}),l=URL.createObjectURL(i),d=document.createElement('a');d.href=l,d.download=`${e.name}_regex.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(l),console.log('导出的正则 JSON:',r),toastr.success(`项目 "${e.name}" 已导出为正则 JSON`)}catch(a){console.error('导出失败:',a),toastr.error(`导出失败: ${a.message}`)}else toastr.info('已取消导出')}function Me(){if(!A.value)return void toastr.error('没有可预览的内容');const e=te.value,n=e?e.name:'预览',t=window.open('','_blank','width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');t?(t.document.write(A.value),t.document.close(),t.document.title=n,toastr.success('已在新窗口打开预览')):toastr.error('无法打开新窗口，请检查浏览器弹窗设置')}return t(()=>[w.value,S.value],()=>{ve&&clearTimeout(ve),ve=setTimeout(xe,500)},{deep:!0}),R(()=>{if(console.log('组件卸载，保存数据...'),ye&&clearTimeout(ye),ve&&clearTimeout(ve),w.value&&void 0!==S.value){const e=te.value;if(e){const n=e.files.find(e=>e.path===w.value);n&&(n.content=S.value)}}be(),console.log('数据已保存')}),(e,n)=>(r(),a('div',Qr,[i('div',es,[n[68]||(n[68]=i('h3',{style:{margin:'0',color:'#fff','font-size':'16px !important','font-weight':'600',display:'flex','align-items':'center',gap:'12px','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-laptop-code',style:{color:'#4a9eff','font-size':'18px'}}),d(' 前端项目管理器 ')],-1)),i('div',ns,[h.value?(r(),a('button',{key:0,style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:Ee,onMouseenter:n[0]||(n[0]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[1]||(n[1]=e=>e.currentTarget.style.background='#444')},[...n[61]||(n[61]=[i('i',{class:'fa-solid fa-download',style:{'margin-right':'6px'}},null,-1),d(' 导出为正则 ',-1)])],32)):o('',!0),h.value?(r(),a('button',{key:1,style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:$e,onMouseenter:n[2]||(n[2]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[3]||(n[3]=e=>e.currentTarget.style.background='#444')},[...n[62]||(n[62]=[i('i',{class:'fa-solid fa-history',style:{'margin-right':'6px'}},null,-1),d(' 历史记录 ',-1)])],32)):o('',!0),h.value?(r(),a('button',{key:2,style:{padding:'8px 16px',background:'#8b5cf6',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:we,onMouseenter:n[4]||(n[4]=e=>e.currentTarget.style.background='#7c3aed'),onMouseleave:n[5]||(n[5]=e=>e.currentTarget.style.background='#8b5cf6')},[...n[63]||(n[63]=[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能编写 ',-1)])],32)):o('',!0),h.value?(r(),a('button',{key:3,style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:_e,onMouseenter:n[6]||(n[6]=e=>e.currentTarget.style.background='#dc2626'),onMouseleave:n[7]||(n[7]=e=>e.currentTarget.style.background='#ef4444')},[...n[64]||(n[64]=[i('i',{class:'fa-solid fa-bug',style:{'margin-right':'6px'}},null,-1),d(' Bug 修复 ',-1)])],32)):o('',!0),i('button',{style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:se,onMouseenter:n[8]||(n[8]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[9]||(n[9]=e=>e.currentTarget.style.background='#444')},[...n[65]||(n[65]=[i('i',{class:'fa-solid fa-file-lines',style:{'margin-right':'6px'}},null,-1),d(' 使用模板 ',-1)])],32),i('button',{style:{padding:'8px 16px',background:'#444',border:'none','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:le,onMouseenter:n[10]||(n[10]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[11]||(n[11]=e=>e.currentTarget.style.background='#444')},[...n[66]||(n[66]=[i('i',{class:'fa-solid fa-folder-open',style:{'margin-right':'6px'}},null,-1),d(' 导入文件夹 ',-1)])],32),i('button',{style:{padding:'8px 16px',background:'#10b981',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:ce,onMouseenter:n[12]||(n[12]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[13]||(n[13]=e=>e.currentTarget.style.background='#10b981')},[...n[67]||(n[67]=[i('i',{class:'fa-solid fa-plus',style:{'margin-right':'6px'}},null,-1),d(' 新建项目 ',-1)])],32)])]),i('input',{ref_key:'folderInputRef',ref:ne,type:'file',webkitdirectory:'',directory:'',multiple:'',style:{display:'none'},onChange:de},null,544),i('div',ts,[i('div',as,[n[73]||(n[73]=i('h4',{style:{margin:'0 0 15px 0',color:'#fff','font-size':'14px','font-weight':'600'}},'项目列表',-1)),0===u.value.length?(r(),a('div',os,[...n[69]||(n[69]=[d(' 暂无项目',-1),i('br',null,null,-1),d(' 点击"新建项目"开始 ',-1)])])):o('',!0),(r(!0),a(f,null,m(u.value,e=>(r(),a('div',{key:e.id,style:g({padding:'10px 12px',marginBottom:'8px',background:h.value===e.id?'#4a9eff':'#1e1e1e',borderRadius:'8px',cursor:'pointer',transition:'all 0.2s ease',display:'flex',justifyContent:'space-between',alignItems:'center',color:h.value===e.id?'#fff':'#e0e0e0'}),onClick:n=>function(e){h.value=e;const n=te.value;n&&n.files.length>0?(w.value=n.files[0].path,S.value=n.files[0].content,xe()):(w.value='',S.value='',A.value='')}(e.id),onMouseenter:n=>h.value!==e.id&&(n.currentTarget.style.background='#3a3a3a'),onMouseleave:n=>h.value!==e.id&&(n.currentTarget.style.background='#1e1e1e')},[i('span',ss,c(e.name),1),i('button',{style:{width:'20px',height:'20px',background:'rgba(239, 68, 68, 0.2)',border:'none','border-radius':'4px',color:'#ff4444','font-size':'14px','line-height':'1',cursor:'pointer',opacity:'0.6',transition:'all 0.2s ease'},onClick:s(n=>function(e){const n=u.value.find(n=>n.id===e);n&&confirm(`确定删除项目 "${n.name}" 吗？`)&&(u.value=u.value.filter(n=>n.id!==e),console.log('删除项目后，剩余项目数:',u.value.length),h.value===e&&(h.value='',w.value='',S.value='',A.value=''),be(),toastr.success(`项目 "${n.name}" 已删除`))}(e.id),['stop']),onMouseenter:n[14]||(n[14]=e=>(e.currentTarget.style.opacity='1',e.currentTarget.style.background='#ef4444',e.currentTarget.style.color='#fff')),onMouseleave:n[15]||(n[15]=e=>(e.currentTarget.style.opacity='0.6',e.currentTarget.style.background='rgba(239, 68, 68, 0.2)',e.currentTarget.style.color='#ff4444'))},' × ',40,is)],44,rs))),128)),h.value&&te.value?(r(),a('div',ls,[i('div',ds,[n[72]||(n[72]=i('h4',{style:{margin:'0',color:'#fff','font-size':'13px','font-weight':'600'}},'文件',-1)),i('div',cs,[i('button',{style:{padding:'4px 8px',background:'#444',border:'none','border-radius':'5px',color:'#e0e0e0','font-size':'11px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center',gap:'4px'},title:'新建文件夹',onClick:ue,onMouseenter:n[16]||(n[16]=e=>e.currentTarget.style.background='#555'),onMouseleave:n[17]||(n[17]=e=>e.currentTarget.style.background='#444')},[...n[70]||(n[70]=[i('i',{class:'fa-solid fa-folder-plus',style:{'font-size':'10px'}},null,-1)])],32),i('button',{style:{padding:'4px 8px',background:'#10b981',border:'none','border-radius':'5px',color:'white','font-size':'11px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center',gap:'4px'},title:'新建文件',onClick:ge,onMouseenter:n[18]||(n[18]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[19]||(n[19]=e=>e.currentTarget.style.background='#10b981')},[...n[71]||(n[71]=[i('i',{class:'fa-solid fa-plus',style:{'font-size':'10px'}},null,-1)])],32)])]),(r(!0),a(f,null,m(te.value.files,e=>(r(),a('div',{key:e.path,style:g({padding:'8px 10px',marginBottom:'5px',background:w.value===e.path?'#10b981':'#1e1e1e',borderRadius:'6px',cursor:'pointer',transition:'all 0.2s ease',color:w.value===e.path?'#fff':'#e0e0e0',fontSize:'12px',display:'flex',justifyContent:'space-between',alignItems:'center'}),onClick:n=>function(e){w.value=e;const n=te.value;if(n){const t=n.files.find(n=>n.path===e);t&&(S.value=t.content)}}(e.path),onMouseenter:n=>w.value!==e.path&&(n.currentTarget.style.background='#3a3a3a'),onMouseleave:n=>w.value!==e.path&&(n.currentTarget.style.background='#1e1e1e')},[i('span',null,[i('i',{class:x(fe(e.path)),style:{'margin-right':'6px'}},null,2),d(' '+c(e.name),1)]),i('button',{style:{width:'18px',height:'18px',background:'rgba(239, 68, 68, 0.2)',border:'none','border-radius':'3px',color:'#ff4444','font-size':'12px','line-height':'1',cursor:'pointer',opacity:'0',transition:'all 0.2s ease'},title:'删除文件',onClick:s(n=>function(e){const n=te.value;if(!n)return;const t=n.files.find(n=>n.path===e);t&&confirm(`确定删除文件 "${t.path}" 吗？`)&&(n.files=n.files.filter(n=>n.path!==e),w.value===e&&(n.files.length>0?(w.value=n.files[0].path,S.value=n.files[0].content):(w.value='',S.value='')),be(),xe(),window.toastr.success(`文件 "${t.path}" 已删除`))}(e.path),['stop']),onMouseenter:n[20]||(n[20]=e=>(e.currentTarget.style.opacity='1',e.currentTarget.style.background='#ef4444',e.currentTarget.style.color='#fff')),onMouseleave:n[21]||(n[21]=e=>(e.currentTarget.style.opacity='0.6',e.currentTarget.style.background='rgba(239, 68, 68, 0.2)',e.currentTarget.style.color='#ff4444'))},' × ',40,us)],44,ps))),128))])):o('',!0)]),i('div',gs,[h.value?w.value?(r(),a('div',xs,[i('div',bs,[i('div',hs,[i('i',{class:x(fe(w.value)),style:{color:'#4a9eff'}},null,2),i('span',ys,c(w.value),1)]),i('div',vs,[n[75]||(n[75]=i('span',{style:{color:'#888','font-size':'11px'}},[i('i',{class:'fa-solid fa-circle-check',style:{color:'#10b981','margin-right':'4px'}}),d(' 自动保存 ')],-1)),i('button',{style:{padding:'6px 12px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},onClick:pe,onMouseenter:n[22]||(n[22]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[23]||(n[23]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[74]||(n[74]=[i('i',{class:'fa-solid fa-floppy-disk',style:{'margin-right':'4px'}},null,-1),d(' 手动保存 ',-1)])],32)])]),l(i('textarea',{'onUpdate:modelValue':n[24]||(n[24]=e=>S.value=e),placeholder:`在这里编写 ${w.value.split('.').pop()?.toUpperCase()} 代码...`,style:{flex:'1',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'13px','line-height':'1.6',padding:'15px',resize:'none',outline:'none','min-height':'400px'}},null,8,ws),[[p,S.value]])])):(r(),a('div',ms,' ← 请选择一个文件 ')):(r(),a('div',fs,' ← 请选择一个项目 '))]),i('div',ks,[i('div',_s,[n[77]||(n[77]=i('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-eye',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 实时预览 ')],-1)),i('div',Ts,[A.value?(r(),a('button',{key:0,title:'新窗口打开',style:{width:'28px',height:'28px',padding:'0',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0',cursor:'pointer',display:'flex','align-items':'center','justify-content':'center',transition:'all 0.2s ease'},onClick:Me,onMouseenter:n[25]||(n[25]=e=>e.currentTarget.style.background='#4a9eff'),onMouseleave:n[26]||(n[26]=e=>e.currentTarget.style.background='#3a3a3a')},[...n[76]||(n[76]=[i('i',{class:'fa-solid fa-external-link-alt',style:{'font-size':'12px'}},null,-1)])],32)):o('',!0)])]),i('div',zs,[A.value?(r(),a('iframe',{key:0,srcdoc:A.value,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,Is)):(r(),a('div',Ss,' 保存代码后将显示预览 '))])])]),C.value?(r(),a('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:s(ke,['self'])},[i('div',As,[n[85]||(n[85]=i('h3',{style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{color:'#8b5cf6'}}),d(' AI 智能编写 ')],-1)),i('div',$s,[n[79]||(n[79]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px'}},[i('i',{class:'fa-solid fa-pencil',style:{color:'#8b5cf6','margin-right':'6px'}}),d(' 详细描述你的需求（越详细效果越好）： ')],-1)),n[80]||(n[80]=i('div',{style:{'margin-bottom':'10px',padding:'10px 12px',background:'rgba(139, 92, 246, 0.1)','border-left':'3px solid #8b5cf6','border-radius':'4px','font-size':'12px',color:'#ccc','line-height':'1.6'}},[i('strong',{style:{color:'#8b5cf6'}},'💡 提示：'),d(' 不要只说"优化"、"完善"，要具体说明你想要什么效果、什么样式、什么功能！ ')],-1)),l(i('textarea',{'onUpdate:modelValue':n[27]||(n[27]=e=>E.value=e),placeholder:'请详细描述你的需求，例如：添加一个响应式导航栏，带汉堡菜单和平滑滚动效果...',style:{width:'100%',height:'120px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','line-height':'1.6',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,E.value]]),i('div',Cs,[n[78]||(n[78]=i('div',{style:{color:'#888','font-size':'12px','margin-bottom':'8px'}},[i('i',{class:'fa-solid fa-lightbulb',style:{color:'#fbbf24','margin-right':'4px'}}),d(' 快捷建议（点击填入）： ')],-1)),i('div',Es,[(r(),a(f,null,m(Y,e=>i('button',{key:e,style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#ccc','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>E.value=e,onMouseenter:n[28]||(n[28]=e=>e.currentTarget.style.background='#3a3a3a'),onMouseleave:n[29]||(n[29]=e=>e.currentTarget.style.background='#2a2a2a')},c(e),41,Ms)),64))])])]),i('div',Ps,[i('label',Os,[l(i('input',{'onUpdate:modelValue':n[30]||(n[30]=e=>L.value=e),type:'checkbox',style:{width:'16px',height:'16px',cursor:'pointer'}},null,512),[[N,L.value]]),n[81]||(n[81]=i('i',{class:'fa-solid fa-water',style:{color:'#4a9eff'}},null,-1)),n[82]||(n[82]=d(' 启用流式传输 ',-1))]),n[83]||(n[83]=i('span',{style:{color:'#888','font-size':'12px'}},' （实时查看生成过程，体验更流畅） ',-1))]),P.value&&L.value&&H.value?(r(),a('div',js,[d(c(H.value)+' ',1),n[84]||(n[84]=i('span',{style:{animation:'blink 1s infinite'}},'▊',-1))])):o('',!0),i('div',Rs,[i('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:ke,onMouseenter:n[31]||(n[31]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[32]||(n[32]=e=>e.currentTarget.style.background='#3a3a3a')},' 取消 ',32),i('button',{disabled:P.value||!E.value.trim(),style:g([{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},{opacity:P.value||!E.value.trim()?.5:1,cursor:P.value||!E.value.trim()?'not-allowed':'pointer'}]),onClick:Ie},[P.value?(r(),a('i',Ls)):(r(),a('i',Ds)),d(' '+c(P.value?'生成中...':'开始生成'),1)],12,Ns)])])])):o('',!0),X.value?(r(),a('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:s(Te,['self'])},[i('div',Hs,[n[90]||(n[90]=i('h3',{style:{margin:'0 0 20px 0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-bug',style:{color:'#ef4444'}}),d(' Bug 修复助手 ')],-1)),i('div',Vs,[n[86]||(n[86]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[i('i',{class:'fa-solid fa-circle-exclamation',style:{color:'#f59e0b','margin-right':'6px'}}),d(' 哪里有问题？（必填） ')],-1)),l(i('textarea',{'onUpdate:modelValue':n[33]||(n[33]=e=>K.value=e),placeholder:'例如：点击发送按钮没有反应\n或者：消息列表不显示内容\n或者：输入框输入后数据没有保存',style:{width:'100%',height:'90px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','line-height':'1.6',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,K.value]])]),i('div',Us,[n[87]||(n[87]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[i('i',{class:'fa-solid fa-terminal',style:{color:'#ef4444','margin-right':'6px'}}),d(' 浏览器 Console 错误信息（按 F12 查看） ')],-1)),l(i('textarea',{'onUpdate:modelValue':n[34]||(n[34]=e=>Q.value=e),placeholder:'如果浏览器 Console 中有红色错误，请复制粘贴到这里\n例如：Uncaught TypeError: xxx is not a function\n\n如果没有错误，留空即可',style:{width:'100%',height:'80px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#ff6b6b','font-size':'12px','font-family':'\'Consolas\', monospace','line-height':'1.5',padding:'12px',resize:'none',outline:'none'}},null,512),[[p,Q.value]])]),i('div',Js,[n[89]||(n[89]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'600'}},[i('i',{class:'fa-solid fa-file-code',style:{color:'#4a9eff','margin-right':'6px'}}),d(' 问题可能在哪个文件？ ')],-1)),l(i('select',{'onUpdate:modelValue':n[35]||(n[35]=e=>ee.value=e),style:{width:'100%',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px',padding:'10px 12px',outline:'none',cursor:'pointer'}},[...n[88]||(n[88]=[i('option',{value:''},'让 AI 自动判断',-1),i('option',{value:'index.html'},'HTML 文件（index.html）',-1),i('option',{value:'style.css'},'CSS 文件（style.css）',-1),i('option',{value:'script.js'},'JavaScript 文件（script.js）',-1)])],512),[[D,ee.value]])]),n[91]||(n[91]=i('div',{style:{padding:'12px',background:'rgba(74, 158, 255, 0.1)',border:'1px solid rgba(74, 158, 255, 0.3)','border-radius':'6px','margin-bottom':'15px'}},[i('p',{style:{margin:'0',color:'#4a9eff','font-size':'12px','line-height':'1.6'}},[i('i',{class:'fa-solid fa-lightbulb',style:{'margin-right':'6px'}}),i('strong',null,'提示：'),d('AI 会专注于修复这个具体的 bug，不会改动其他功能。如果有 Console 错误信息，修复成功率会更高！ ')])],-1)),i('div',Fs,[i('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:Te,onMouseenter:n[36]||(n[36]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[37]||(n[37]=e=>e.currentTarget.style.background='#3a3a3a')},' 取消 ',32),i('button',{disabled:P.value||!K.value.trim(),style:g([{padding:'8px 16px',background:'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.2s ease'},{opacity:P.value||!K.value.trim()?.5:1,cursor:P.value||!K.value.trim()?'not-allowed':'pointer'}]),onClick:ze},[P.value?(r(),a('i',Zs)):(r(),a('i',Ys)),d(' '+c(P.value?'修复中...':'开始修复'),1)],12,Bs)])])])):o('',!0),V.value?(r(),a('div',Gs,[i('div',Ws,[i('div',qs,[n[94]||(n[94]=i('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-code-compare',style:{color:'#8b5cf6'}}),d(' AI 生成结果对比 ')],-1)),i('div',Xs,[i('button',{style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer',transition:'all 0.2s ease'},onClick:Ae,onMouseenter:n[38]||(n[38]=e=>e.currentTarget.style.background='#dc2626'),onMouseleave:n[39]||(n[39]=e=>e.currentTarget.style.background='#ef4444')},[...n[92]||(n[92]=[i('i',{class:'fa-solid fa-xmark',style:{'margin-right':'6px'}},null,-1),d(' 拒绝 ',-1)])],32),i('button',{style:{padding:'8px 16px',background:'#10b981',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:Se,onMouseenter:n[40]||(n[40]=e=>e.currentTarget.style.background='#059669'),onMouseleave:n[41]||(n[41]=e=>e.currentTarget.style.background='#10b981')},[...n[93]||(n[93]=[i('i',{class:'fa-solid fa-check',style:{'margin-right':'6px'}},null,-1),d(' 应用更改 ',-1)])],32)])]),i('div',Ks,[i('div',Qs,[n[95]||(n[95]=i('div',{style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a'}},[i('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-file-code',style:{'margin-right':'8px',color:'#ef4444'}}),d(' 修改前 ')])],-1)),i('div',ei,[(r(!0),a(f,null,m(U.value,e=>(r(),a('div',{key:e.path,style:{'margin-bottom':'20px'}},[i('div',ni,[i('i',{class:x(fe(e.path))},null,2),d(' '+c(e.path),1)]),i('pre',ti,c(e.oldContent),1)]))),128))])]),i('div',ai,[n[96]||(n[96]=i('div',{style:{padding:'12px 15px',background:'#2a2a2a','border-bottom':'1px solid #3a3a3a'}},[i('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-file-code',style:{'margin-right':'8px',color:'#10b981'}}),d(' 修改后 ')])],-1)),i('div',oi,[(r(!0),a(f,null,m(U.value,e=>(r(),a('div',{key:e.path,style:{'margin-bottom':'20px'}},[i('div',ri,[i('i',{class:x(fe(e.path))},null,2),d(' '+c(e.path),1)]),i('pre',si,c(e.newContent),1)]))),128))])]),i('div',ii,[i('div',li,[n[97]||(n[97]=i('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-eye',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 预览效果 ')],-1)),i('div',di,[i('button',{style:g({padding:'4px 10px',background:'before'===J.value?'#ef4444':'#3a3a3a',border:'none',borderRadius:'4px',color:'white',fontSize:'11px',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n[42]||(n[42]=e=>J.value='before')},' 修改前 ',4),i('button',{style:g({padding:'4px 10px',background:'after'===J.value?'#10b981':'#3a3a3a',border:'none',borderRadius:'4px',color:'white',fontSize:'11px',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n[43]||(n[43]=e=>J.value='after')},' 修改后 ',4)])]),i('div',ci,[i('iframe',{srcdoc:oe.value,sandbox:'allow-scripts allow-same-origin allow-modals allow-forms',style:{width:'100%',height:'100%',border:'none'}},null,8,pi)])])])])])):o('',!0),F.value?(r(),a('div',{key:3,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:s(Ce,['self'])},[i('div',ui,[i('div',gi,[n[98]||(n[98]=i('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-history',style:{color:'#f59e0b'}}),d(' AI 编写历史 ')],-1)),i('button',{style:{width:'28px',height:'28px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#e0e0e0',cursor:'pointer',transition:'all 0.2s ease'},onClick:Ce,onMouseenter:n[44]||(n[44]=e=>e.currentTarget.style.background='#4a4a4a'),onMouseleave:n[45]||(n[45]=e=>e.currentTarget.style.background='#3a3a3a')},' × ',32)]),i('div',fi,[0===ae.value.length?(r(),a('div',mi,[...n[99]||(n[99]=[i('i',{class:'fa-solid fa-inbox',style:{'font-size':'48px','margin-bottom':'15px',opacity:'0.3'}},null,-1),i('p',null,'暂无历史记录',-1)])])):o('',!0),(r(!0),a(f,null,m(ae.value,(e,t)=>(r(),a('div',{key:t,style:{background:'#1e1e1e','border-radius':'8px',padding:'15px','margin-bottom':'15px',border:'1px solid #3a3a3a'}},[i('div',xi,[i('div',null,[i('div',bi,c(e.prompt),1),i('div',hi,c(new Date(e.timestamp).toLocaleString('zh-CN')),1)]),i('button',{style:{padding:'6px 12px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'500',cursor:'pointer',transition:'all 0.2s'},onClick:n=>function(e){if(!confirm(`确定要恢复到这个历史版本吗？\n\n"${e.prompt}"\n\n当前的修改将被覆盖。`))return;const n=te.value;if(n){if(e.changes.forEach(e=>{const t=n.files.find(n=>n.path===e.path);t&&(t.content=e.newContent)}),console.log('恢复历史版本:',e.prompt),be(),xe(),w.value){const e=n.files.find(e=>e.path===w.value);e&&(S.value=e.content)}Ce(),toastr.success('已恢复到历史版本')}}(e),onMouseenter:n[46]||(n[46]=e=>e.currentTarget.style.background='#3b82f6'),onMouseleave:n[47]||(n[47]=e=>e.currentTarget.style.background='#4a9eff')},[...n[100]||(n[100]=[i('i',{class:'fa-solid fa-undo',style:{'margin-right':'4px'}},null,-1),d(' 恢复 ',-1)])],40,yi)]),i('div',vi,[n[101]||(n[101]=i('strong',null,'修改的文件：',-1)),i('div',wi,[(r(!0),a(f,null,m(e.changes,e=>(r(),a('span',{key:e.path,style:{background:'#2a2a2a',padding:'4px 10px','border-radius':'4px','font-size':'12px',display:'inline-flex','align-items':'center',gap:'6px'}},[i('i',{class:x(fe(e.path))},null,2),d(' '+c(e.path),1)]))),128))])])]))),128))])])])):o('',!0),q.value?(r(),a('div',{key:4,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000',padding:'20px'},onClick:n[60]||(n[60]=s(e=>q.value=!1,['self']))},[i('div',ki,[i('div',_i,[n[103]||(n[103]=i('h3',{style:{margin:'0',color:'#fff','font-size':'20px','font-weight':'600',display:'flex','align-items':'center',gap:'12px'}},[i('span',{style:{width:'40px',height:'40px',background:'#2a2a2a','border-radius':'10px',display:'flex','align-items':'center','justify-content':'center','font-size':'20px'}},' 📁 '),d(' 选择项目模板 ')],-1)),i('button',{style:{width:'36px',height:'36px',background:'#2a2a2a',border:'none','border-radius':'8px',color:'#888','font-size':'18px',cursor:'pointer',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center'},onClick:n[48]||(n[48]=e=>q.value=!1),onMouseenter:n[49]||(n[49]=e=>{e.currentTarget.style.background='#333',e.currentTarget.style.color='#fff'}),onMouseleave:n[50]||(n[50]=e=>{e.currentTarget.style.background='#2a2a2a',e.currentTarget.style.color='#888'})},[...n[102]||(n[102]=[i('i',{class:'fa-solid fa-times'},null,-1)])],32)]),i('div',Ti,[i('div',zi,[i('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[51]||(n[51]=e=>ie('同层对话界面')),onMouseenter:n[52]||(n[52]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[53]||(n[53]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[104]||(n[104]=[i('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 💬 ',-1),i('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'同层对话界面',-1),i('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'流式对话、消息历史、正则清理',-1)])],32),i('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[54]||(n[54]=e=>ie('状态栏面板')),onMouseenter:n[55]||(n[55]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[56]||(n[56]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[105]||(n[105]=[i('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 📊 ',-1),i('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'状态栏面板',-1),i('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'HP/MP/经验值，进度条动画',-1)])],32),i('div',{style:{background:'#252525',border:'1px solid transparent','border-radius':'16px',padding:'24px',cursor:'pointer',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.3)'},onClick:n[57]||(n[57]=e=>ie('好感度面板')),onMouseenter:n[58]||(n[58]=e=>{e.currentTarget.style.transform='translateY(-4px)',e.currentTarget.style.borderColor='#555',e.currentTarget.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.5)'}),onMouseleave:n[59]||(n[59]=e=>{e.currentTarget.style.transform='translateY(0)',e.currentTarget.style.borderColor='transparent',e.currentTarget.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'})},[...n[106]||(n[106]=[i('div',{style:{width:'56px',height:'56px',background:'#2a2a2a','border-radius':'16px',display:'flex','align-items':'center','justify-content':'center','font-size':'28px','margin-bottom':'16px'}},' 💝 ',-1),i('h4',{style:{margin:'0 0 8px 0',color:'#fff','font-size':'17px','font-weight':'600'}},'好感度面板',-1),i('p',{style:{margin:'0',color:'#999','font-size':'13px','line-height':'1.6'}},'多角色卡片，爱心图标',-1)])],32)]),n[107]||(n[107]=i('div',{style:{'margin-top':'24px',padding:'16px 18px',background:'#252525',border:'1px solid #333','border-radius':'10px'}},[i('div',{style:{color:'#ccc','font-weight':'500','margin-bottom':'6px','font-size':'13px',display:'flex','align-items':'center',gap:'8px'}},[i('span',{style:{color:'#fbbf24','font-size':'16px'}},'💡'),d(' 使用提示 ')]),i('p',{style:{margin:'0',color:'#888','font-size':'13px','line-height':'1.7'}},' 选择模板后，会自动创建包含完整代码的项目，你可以直接预览和编辑 ')],-1))])])])):o('',!0),k(Kr,{ref_key:'progressDialogRef',ref:G,show:Z.value,title:'AI 正在处理'},null,8,['show'])]))}}),Si=xo(Ii,[['__scopeId','data-v-60228402']]);'undefined'!=typeof WorkerGlobalScope&&(globalThis,WorkerGlobalScope);const Ai=()=>{};const $i=e=>e();function Ci(e,n={}){let t,a,o=Ai;const r=e=>{clearTimeout(e),o(),o=Ai};let s;return i=>{const l=L(e),d=L(n.maxWait);return t&&r(t),l<=0||void 0!==d&&d<=0?(a&&(r(a),a=void 0),Promise.resolve(i())):new Promise((e,c)=>{o=n.rejectOnCancel?c:e,s=i,d&&!a&&(a=setTimeout(()=>{t&&r(t),a=void 0,e(s())},d)),t=setTimeout(()=>{a&&r(a),a=void 0,e(i())},l)})}}function Ei(e,n,a={}){const{eventFilter:o=$i,...r}=a;return t(e,(s=o,i=n,function(...e){return new Promise((n,t)=>{Promise.resolve(s(()=>i.apply(this,e),{fn:i,thisArg:this,args:e})).then(n).catch(t)})}),r);var s,i}const Mi={class:'regex-ui-generator',style:{padding:'25px !important',background:'#1a1a1a !important'}},Pi={style:{display:'grid','grid-template-columns':'1fr 1fr',gap:'20px','margin-bottom':'20px'}},Oi={style:{display:'flex','flex-direction':'column',gap:'20px'}},ji={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px'}},Ri={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px',flex:'1',display:'flex','flex-direction':'column'}},Ni={style:{display:'flex',gap:'12px','margin-top':'15px'}},Di=['disabled'],Li=['disabled'],Hi={style:{background:'#2a2a2a',padding:'20px','border-radius':'8px',display:'flex','flex-direction':'column'}},Vi={style:{color:'#51cf66',margin:'0 0 15px 0','font-size':'16px',display:'flex','align-items':'center',gap:'8px'}},Ui={key:0,style:{'margin-left':'auto',background:'#51cf66',color:'white',padding:'4px 12px','border-radius':'16px','font-size':'12px'}},Ji={style:{flex:'1',background:'#1a1a1a',border:'2px solid #444','border-radius':'6px',overflow:'hidden',display:'flex','align-items':'center','justify-content':'center','min-height':'400px'}},Fi={key:0,style:{'text-align':'center',color:'#666',padding:'40px'}},Bi=['srcdoc'],Yi={key:0,style:{background:'#2a2a2a',padding:'20px','border-radius':'8px'}},Zi={key:0,style:{background:'#1a1a1a',padding:'15px','border-radius':'4px',border:'1px solid #444','max-height':'300px','overflow-y':'auto'}},Gi={style:{margin:'0',color:'#e0e0e0','font-family':'\'Consolas\', monospace','font-size':'13px','white-space':'pre-wrap','word-wrap':'break-word'}},Wi={style:{display:'flex',gap:'12px'}},qi=['disabled'],Xi=xo(e({__name:'RegexUIGenerator',setup(e){const t=b(),{settings:f}=h(t),m=y(),v=n('【开场白】'),k=n(''),I=n(''),C=n(''),E=n(!1),P=n(!1),O=n(!1),j=n(!1),R=n(''),N=n(null);w(()=>{(()=>{try{const n=T();if(!n)return;const t=`${n}_regex_ui_generator`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);v.value=e.triggerKeyword||'【开场白】',k.value=e.interfaceDescription||'',I.value=e.generatedCode||'',C.value=e.generatedRegex||'',console.log('✅ [界面生成器] 数据已从 localStorage 加载')}catch(e){console.error('❌ [界面生成器] 解析数据失败:',e)}}catch(n){console.error('❌ [界面生成器] 加载数据失败:',n)}})()}),function(e,n,t={}){const{debounce:a=0,maxWait:o,...r}=t;Ei(e,n,{...r,eventFilter:Ci(a,{maxWait:o})})}([v,k,I,C],()=>{(()=>{try{const e=T();if(!e)return;const n={triggerKeyword:v.value,interfaceDescription:k.value,generatedCode:I.value,generatedRegex:C.value},t=`${e}_regex_ui_generator`;localStorage.setItem(t,JSON.stringify(n)),console.log('💾 [界面生成器] 数据已保存到 localStorage')}catch(e){console.error('❌ [界面生成器] 保存数据失败:',e)}})()},{debounce:500});const D=async()=>{if(!v.value||!k.value)return void window.toastr.warning('请填写触发关键词和界面描述');const e=m.createTask('ui_generate',`生成界面：${v.value}`);E.value=!0;try{m.updateTaskProgress(e,10,'正在构建提示词...');const n='你是专业的前端开发专家，擅长生成完整的单文件 HTML 应用。\n\n# 核心任务\n根据用户的自然语言描述，生成**完整**的 HTML 代码（包含 CSS 和 JS）。\n\n# 代码结构要求\n1. **必须是完整的HTML文档**：从 `<!DOCTYPE html>` 开始到 `</html>` 结束\n2. **所有样式内嵌**：使用 `<style>` 标签，不要外部CSS\n3. **所有脚本内嵌**：使用 `<script>` 标签，不要外部JS\n4. **无外部依赖**：不要引入 CDN 或外部库（除非用户明确要求）\n\n# 关键原则\n1. **完整性第一**：确保生成的代码是完整的，不要截断\n2. **美观现代**：使用现代 CSS 特性（flexbox, grid, 动画等）\n3. **符合描述**：严格按照用户的风格需求和功能需求\n4. **可直接运行**：代码可以直接在浏览器中运行，无需修改\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用 markdown 代码块（```html）\n❌ 不要生成不完整的代码\n❌ 不要省略任何部分（如"...省略..."）\n❌ 不要引入外部依赖（除非用户明确要求）\n\n# 输出格式\n直接输出完整的 HTML 代码，从 `<!DOCTYPE html>` 开始。',t=`**触发关键词**：${v.value}\n\n**界面需求**：\n${k.value}\n\n---\n\n**生成要求**：\n1. 生成完整的单文件 HTML（包含 <style> 和 <script>）\n2. 风格：${k.value.includes('风格')?'按描述风格':'现代简洁风格'}\n3. 确保代码完整，不要截断\n4. 可以直接在浏览器中运行\n\n立即生成完整的HTML代码：`;m.updateTaskProgress(e,20,'正在发送请求到 AI 服务器...'),m.addTaskDetail(e,`触发词: ${v.value}`);const a=M(f.value.api_endpoint),o={model:f.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:f.value.temperature||.7,max_tokens:f.value.max_tokens||16e3,top_p:f.value.top_p,presence_penalty:f.value.presence_penalty,frequency_penalty:f.value.frequency_penalty},{filterApiParams:r}=await S(async()=>{const{filterApiParams:e}=await import('./index.js').then(e=>e.R);return{filterApiParams:e}},__vite__mapDeps([0,1])),s=r(o,f.value.api_endpoint),i=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${f.value.api_key}`},body:JSON.stringify(s)});if(m.updateTaskProgress(e,40,'等待AI响应...'),!i.ok)throw new Error(`API 请求失败: ${i.status}`);m.updateTaskProgress(e,50,'正在等待 AI 生成代码...'),m.addTaskDetail(e,'AI 正在思考并生成完整的HTML代码...');const l=await i.json();let d=l.choices?.[0]?.message?.content||'';m.updateTaskProgress(e,70,'正在处理 AI 返回的代码...'),console.log('📝 [界面生成] AI 原始返回长度:',d.length),console.log('📝 [界面生成] AI 原始返回前500字符:',d.substring(0,500)),d=d.replace(/```html\n?/g,'').replace(/```\n?/g,'').trim();const c=d.match(/<!DOCTYPE html>[\s\S]*/i);if(c)d=c[0].trim(),console.log('✅ [界面生成] 提取到完整的HTML文档（含DOCTYPE）');else{const e=d.match(/<html[\s\S]*/i);if(e)d=e[0].trim(),console.log('✅ [界面生成] 提取到HTML文档（不含DOCTYPE）');else{if(!d.includes('<')||!d.includes('>'))throw console.error('❌ [界面生成] AI未返回有效的HTML代码'),console.error('AI返回内容:',d),new Error('AI未返回有效的HTML代码，请尝试更详细的界面描述或更换模型');console.log('⚠️ [界面生成] 包含HTML标签但格式不标准，尝试包装'),d.includes('<html')||(d=`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n${d}\n</body>\n</html>`,console.log('✅ [界面生成] 已自动包装为完整HTML文档'))}}console.log('📝 [界面生成] 最终HTML长度:',d.length),m.updateTaskProgress(e,85,'正在生成正则配置...'),I.value=d;const p=v.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),u={id:`regex_ui_${Date.now()}`,scriptName:`界面_${v.value}`,findRegex:p,replaceString:d,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null};C.value=JSON.stringify(u,null,2),m.addTaskDetail(e,`✅ HTML代码长度: ${d.length} 字符`),m.completeTask(e,{code:d,regex:C.value}),window.toastr.success('AI 生成成功！')}catch(n){console.error('AI 生成失败:',n),m.failTask(e,n.message),window.toastr.error('AI 生成失败: '+n.message)}finally{E.value=!1}},L=()=>{R.value='',j.value=!0},H=async()=>{if(!R.value)return void window.toastr.warning('请输入修改建议');const e=m.createTask('ui_modify',`修改界面：${v.value}`);P.value=!0;try{m.updateTaskProgress(e,10,'正在构建修改提示词...');const n='你是专业的前端开发专家，擅长根据用户反馈修改和优化界面代码。\n\n# 核心任务\n根据用户的原始需求和修改建议，生成**完整**的优化后的 HTML 代码。\n\n# 修改原则\n1. **保持原有风格**：不要改变原始描述中的核心风格\n2. **精准修改**：只修改用户明确要求修改的部分\n3. **完整输出**：确保修改后的代码是完整的，不要截断\n4. **向下兼容**：确保修改不会破坏原有功能\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用 markdown 代码块（```html）\n❌ 不要生成不完整的代码\n❌ 不要省略任何部分\n\n# 输出格式\n直接输出完整的 HTML 代码，从 `<!DOCTYPE html>` 开始。',t=`**触发关键词**：${v.value}\n\n**原始界面需求**：\n${k.value}\n\n**用户修改建议**：\n${R.value}\n\n---\n\n**修改要求**：\n1. 在原始需求的基础上，精准应用修改建议\n2. 保持代码完整性，不要截断\n3. 确保可以直接在浏览器中运行\n\n立即生成修改后的完整HTML代码：`;m.updateTaskProgress(e,20,'正在发送修改请求...'),m.addTaskDetail(e,`修改建议: ${R.value}`);const a=M(f.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${f.value.api_key}`},body:JSON.stringify({model:f.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],temperature:f.value.temperature||.7,max_tokens:f.value.max_tokens||16e3,top_p:f.value.top_p,presence_penalty:f.value.presence_penalty,frequency_penalty:f.value.frequency_penalty})});if(m.updateTaskProgress(e,40,'等待AI响应...'),!o.ok)throw new Error(`API 请求失败: ${o.status}`);m.updateTaskProgress(e,50,'正在等待 AI 修改代码...'),m.addTaskDetail(e,'AI 正在根据修改建议重新生成代码...');const r=await o.json();let s=r.choices?.[0]?.message?.content||'';m.updateTaskProgress(e,70,'正在处理修改后的代码...'),console.log('📝 [界面修改] AI 原始返回长度:',s.length),console.log('📝 [界面修改] AI 原始返回前500字符:',s.substring(0,500)),s=s.replace(/```html\n?/g,'').replace(/```\n?/g,'').trim();const i=s.match(/<!DOCTYPE html>[\s\S]*/i);if(i)s=i[0].trim(),console.log('✅ [界面修改] 提取到完整的HTML文档（含DOCTYPE）');else{const e=s.match(/<html[\s\S]*/i);if(e)s=e[0].trim(),console.log('✅ [界面修改] 提取到HTML文档（不含DOCTYPE）');else{if(!s.includes('<')||!s.includes('>'))throw console.error('❌ [界面修改] AI未返回有效的HTML代码'),console.error('AI返回内容:',s),new Error('AI未返回有效的HTML代码，请尝试更详细的修改建议或更换模型');console.log('⚠️ [界面修改] 包含HTML标签但格式不标准，尝试包装'),s.includes('<html')||(s=`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n</head>\n<body>\n${s}\n</body>\n</html>`,console.log('✅ [界面修改] 已自动包装为完整HTML文档'))}}console.log('📝 [界面修改] 最终HTML长度:',s.length),m.updateTaskProgress(e,85,'正在更新正则配置...'),I.value=s;const l=v.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),d={id:`regex_ui_${Date.now()}`,scriptName:`界面_${v.value}`,findRegex:l,replaceString:s,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null};C.value=JSON.stringify(d,null,2),k.value=`${k.value}\n\n【已应用的修改】：\n${R.value}`,m.addTaskDetail(e,`✅ 修改后代码长度: ${s.length} 字符`),m.completeTask(e,{code:s,regex:C.value}),window.toastr.success('AI 修改成功！'),j.value=!1}catch(n){console.error('AI 修改失败:',n),m.failTask(e,n.message),window.toastr.error('AI 修改失败: '+n.message)}finally{P.value=!1}},V=()=>{A(C.value,'正则代码已复制到剪贴板')};return(e,n)=>(r(),a('div',Mi,[n[21]||(n[21]=u('<div style="background:linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);padding:20px;border-radius:16px;margin-bottom:20px;border:1px solid rgba(102, 126, 234, 0.2);" data-v-632b3b07><h3 style="color:#4a9eff;margin:0 0 10px 0;font-size:20px;font-weight:600;" data-v-632b3b07>🔧 酒馆正则界面生成器</h3><p style="color:#888;margin:0;font-size:14px;line-height:1.6;" data-v-632b3b07> AI 辅助生成酒馆正则替换界面，用自然语言描述即可生成完整的 HTML/CSS/JS 代码 </p></div><div style="background:#2a2a2a;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #ffc107;" data-v-632b3b07><h4 style="color:#ffc107;margin:0 0 15px 0;font-size:16px;display:flex;align-items:center;gap:8px;" data-v-632b3b07><i class="fa-solid fa-lightbulb" data-v-632b3b07></i> 新手使用流程（超简单！）： </h4><ol style="margin:0;padding-left:20px;color:#ccc;line-height:2;" data-v-632b3b07><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第1步：</strong> 输入触发词（比如 <code style="background:#1a1a1a;padding:2px 6px;border-radius:3px;color:#4a9eff;" data-v-632b3b07>【状态栏】</code> ） </li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第2步：</strong> 用自然语言描述你想要的界面（省略技术细节）</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第3步：</strong> 点击&quot;AI 生成&quot;，等几秒钟，AI 自动生成代码</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第4步：</strong> 看右侧<strong style="color:#51cf66;" data-v-632b3b07>实时预览</strong>，不满意就点&quot;AI 修改&quot;继续调整 </li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>第5步：</strong> 点击&quot;复制正则&quot;，直接粘贴到酒馆正则里就完了！</li><li data-v-632b3b07><strong style="color:#fff;" data-v-632b3b07>完成！</strong> 现在在聊天中输入 <code style="background:#1a1a1a;padding:2px 6px;border-radius:3px;color:#51cf66;" data-v-632b3b07>【状态栏】</code> 就会显示你的界面了！ </li></ol></div>',2)),i('div',Pi,[i('div',Oi,[i('div',ji,[n[7]||(n[7]=i('h4',{style:{color:'#4a9eff',margin:'0 0 15px 0','font-size':'16px'}},[i('i',{class:'fa-solid fa-key'}),d(' 触发关键词: ')],-1)),l(i('input',{'onUpdate:modelValue':n[0]||(n[0]=e=>v.value=e),type:'text',placeholder:'输入触发词，例如：【开场白】',style:{width:'100%',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px'}},null,512),[[p,v.value]])]),i('div',Ri,[n[10]||(n[10]=i('h4',{style:{color:'#4a9eff',margin:'0 0 15px 0','font-size':'16px'}},[i('i',{class:'fa-solid fa-magic'}),d(' 界面描述（AI 生成）: ')],-1)),n[11]||(n[11]=i('p',{style:{color:'#888',margin:'0 0 10px 0','font-size':'13px'}},' 用自然语言描述你想要的界面，比如：一个RPG游戏风格的状态栏，显示生命值、魔力值、经验值... ',-1)),l(i('textarea',{'onUpdate:modelValue':n[1]||(n[1]=e=>k.value=e),placeholder:'详细描述你想要的界面（越详细越好）：\n- 说清楚你想要什么功能（如：生命值、魔力值、经验值）\n- 说清楚你想要什么样式（如：RPG游戏风格、赛博朋克、可爱风等）\n- 如果想要特殊效果（如：进度条、动画、按钮），也写清楚\n\n例如：\n我想要一个现代简洁风格的状态栏，显示当前日期、时间、地点、天气温度。',style:{width:'100%',flex:'1','min-height':'200px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','font-family':'\'Consolas\', monospace',resize:'none','line-height':'1.6'}},null,512),[[p,k.value]]),i('div',Ni,[i('button',{disabled:!v.value||!k.value||E.value,style:g([{flex:'1',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.3s'},{opacity:v.value&&k.value&&!E.value?1:.5}]),onClick:D},[n[8]||(n[8]=i('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(E.value?'AI 生成中...':I.value?'AI 重新生成':'AI 生成界面'),1)],12,Di),I.value?(r(),a('button',{key:0,disabled:P.value,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.3s'},{opacity:P.value?.5:1}]),onClick:L},[n[9]||(n[9]=i('i',{class:'fa-solid fa-edit'},null,-1)),d(' '+c(P.value?'修改中...':'AI 修改界面'),1)],12,Li)):o('',!0)])])]),i('div',Hi,[i('h4',Vi,[n[12]||(n[12]=i('i',{class:'fa-solid fa-eye'},null,-1)),n[13]||(n[13]=d(' 实时预览 ',-1)),I.value?(r(),a('span',Ui,'已生成')):o('',!0)]),i('div',Ji,[I.value?(r(),a('iframe',{key:1,ref_key:'previewFrame',ref:N,srcdoc:I.value,sandbox:'allow-scripts allow-same-origin',style:{width:'100%',height:'100%',border:'none',background:'white'}},null,8,Bi)):(r(),a('div',Fi,[...n[14]||(n[14]=[i('i',{class:'fa-solid fa-image',style:{'font-size':'64px','margin-bottom':'20px',opacity:'0.3'}},null,-1),i('p',{style:{'font-size':'16px',margin:'0'}},'等待生成...',-1),i('p',{style:{'font-size':'14px',margin:'10px 0 0 0'}},'点击"AI 生成界面"后，预览将显示在这里',-1)])]))]),I.value?(r(),a('button',{key:0,style:{'margin-top':'15px',background:'#51cf66',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600',transition:'all 0.2s'},onClick:V},[...n[15]||(n[15]=[i('i',{class:'fa-solid fa-copy'},null,-1),d(' 复制正则代码 ',-1)])])):o('',!0)])]),C.value?(r(),a('div',Yi,[i('div',{style:{display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','margin-bottom':'15px'},onClick:n[2]||(n[2]=e=>O.value=!O.value)},[n[16]||(n[16]=i('h4',{style:{color:'#4a9eff',margin:'0'}},[i('i',{class:'fa-solid fa-code'}),d(' 生成的正则代码 ')],-1)),i('i',{class:x(O.value?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888',transition:'transform 0.3s'}},null,2)]),O.value?(r(),a('div',Zi,[i('pre',Gi,c(C.value),1)])):o('',!0)])):o('',!0),j.value?(r(),a('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)','z-index':'1000000',display:'flex','align-items':'center','justify-content':'center',padding:'20px'},onClick:n[6]||(n[6]=s(e=>j.value=!1,['self']))},[i('div',{style:{background:'#2a2a2a',border:'2px solid #ffc107','border-radius':'16px',padding:'30px','max-width':'600px',width:'100%'},onClick:n[5]||(n[5]=s(()=>{},['stop']))},[n[18]||(n[18]=i('h3',{style:{color:'#ffc107',margin:'0 0 20px 0'}},[i('i',{class:'fa-solid fa-edit'}),d(' AI 修改界面 ')],-1)),n[19]||(n[19]=i('p',{style:{color:'#888',margin:'0 0 15px 0','line-height':'1.6'}},' 描述你想要修改的地方，AI 会在当前界面的基础上进行调整。例如： ',-1)),n[20]||(n[20]=i('ul',{style:{color:'#888',margin:'0 0 20px 0','padding-left':'20px','line-height':'1.8'}},[i('li',null,'把生命值进度条改成红色'),i('li',null,'增加一个金币显示'),i('li',null,'调整整体布局，改成竖向排列'),i('li',null,'添加一个按钮，点击后显示详细信息')],-1)),l(i('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>R.value=e),placeholder:'输入修改建议...',style:{width:'100%','min-height':'150px',background:'#1a1a1a',color:'#e0e0e0',border:'1px solid #444','border-radius':'4px',padding:'12px','font-size':'14px','margin-bottom':'20px',resize:'vertical'}},null,512),[[p,R.value]]),i('div',Wi,[i('button',{disabled:!R.value||P.value,style:g([{flex:'1',background:'#ffc107',color:'#000',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600'},{opacity:!R.value||P.value?.5:1}]),onClick:H},[n[17]||(n[17]=i('i',{class:'fa-solid fa-wand-magic-sparkles'},null,-1)),d(' '+c(P.value?'修改中...':'确认修改'),1)],12,qi),i('button',{style:{flex:'1',background:'#666',color:'white',border:'none',padding:'12px 24px','border-radius':'6px',cursor:'pointer','font-size':'14px','font-weight':'600'},onClick:n[4]||(n[4]=e=>j.value=!1)},' 取消 ')])])])):o('',!0)]))}}),[['__scopeId','data-v-632b3b07']]),Ki={class:'settings-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},Qi={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},el={class:'form-group',style:{'margin-bottom':'18px !important'}},nl={class:'form-group',style:{'margin-bottom':'18px !important'}},tl={class:'form-group',style:{'margin-bottom':'18px !important'}},al={class:'form-group'},ol={class:'model-controls',style:{display:'flex','flex-direction':'column',gap:'10px'}},rl={style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},sl={key:0,style:{color:'#888','font-size':'11px','margin-left':'8px'}},il={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},ll=['disabled'],dl=['value'],cl={class:'form-group',style:{'margin-bottom':'18px !important'}},pl={class:'form-group',style:{'margin-bottom':'18px !important'}},ul={class:'form-group',style:{'margin-bottom':'18px !important'}},gl={class:'form-group',style:{'margin-bottom':'18px !important'}},fl={class:'form-group',style:{'margin-bottom':'18px !important'}},ml={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},xl={class:'form-group',style:{'margin-bottom':'18px !important'}},bl={class:'checkbox-label',style:{display:'flex','align-items':'center',gap:'10px',color:'#ccc','font-size':'13px',cursor:'pointer'}},hl={key:0,class:'form-group',style:{'margin-bottom':'18px !important'}},yl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},vl={class:'form-group',style:{'margin-bottom':'18px !important'}},wl={class:'form-group',style:{'margin-bottom':'18px !important'}},kl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},_l=['disabled'],Tl=['disabled'],zl={key:0,class:'fa-solid fa-magic'},Il={key:1,class:'fa-solid fa-spinner fa-spin'},Sl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},Al={class:'form-group',style:{'margin-bottom':'18px !important'}},$l={class:'form-group',style:{'margin-bottom':'18px !important'}},Cl={class:'form-group',style:{'margin-bottom':'18px !important'}},El={style:{display:'flex',gap:'8px','margin-bottom':'8px'}},Ml=['value'],Pl={key:0,style:{display:'flex',gap:'8px'}},Ol={class:'form-group',style:{'margin-bottom':'18px !important'}},jl={style:{display:'flex',gap:'12px','align-items':'center'}},Rl={style:{display:'flex','align-items':'center',gap:'6px'}},Nl={style:{display:'flex','align-items':'center',gap:'6px'}},Dl={key:0,style:{'margin-left':'auto'}},Ll={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},Hl=['disabled'],Vl={key:0,class:'fa-solid fa-robot'},Ul={key:1,class:'fa-solid fa-spinner fa-spin'},Jl={class:'config-section',style:{padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},Fl={class:'form-group',style:{'margin-bottom':'18px !important'}},Bl={class:'button-group',style:{display:'flex',gap:'12px','flex-wrap':'wrap','margin-top':'5px'}},Yl=['disabled'],Zl={key:0,class:'hidden-messages-section'},Gl={class:'form-group'},Wl={class:'flex-label'},ql={key:0,class:'hidden-messages-list'},Xl={class:'message-info'},Kl={class:'message-id'},Ql={class:'message-preview'},ed=['onClick'],nd={key:1,class:'empty-state'},td=e({__name:'SettingsTab',setup(e){const t=b(),{settings:s}=h(t),v=H(),A=y(),C=n({api:!0,autoSummary:!0,manualSummary:!0,tableGeneration:!0,messageManagement:!0}),M=e=>{C.value[e]=!C.value[e]},P=n([]),j=n(!1),R=n(''),L=n([]),U=n(!1),J=n(!1),F=n(!1),B=n(!1),Y=n(null),Z=n([]),G=n(''),W=n({name:'',headers:''}),q=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存生成状态');const n=`${e}_generation_status`,t={is_summarizing:J.value,is_generating_table:F.value};localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 已保存生成状态到 localStorage')}catch(e){console.error('保存生成状态失败:',e)}},X=()=>{(J.value||F.value)&&(J.value=!1,F.value=!1,q(),window.toastr.info('已停止所有生成任务'))},K=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存列头模板');const n=`${e}_header_templates`;localStorage.setItem(n,JSON.stringify(Z.value)),console.log('✅ 已保存列头模板到 localStorage')}catch(e){console.error('保存列头模板失败:',e)}},Q=()=>{if(''!==G.value){const e=parseInt(G.value);e>=0&&e<Z.value.length&&(W.value={...Z.value[e]})}},ee=()=>{const e=window.prompt('请输入模板名称：');if(e&&e.trim()){const n=window.prompt('请输入列头（用逗号分隔）：');n&&n.trim()&&(Z.value.push({name:e.trim(),headers:n.trim()}),K(),G.value=(Z.value.length-1).toString(),Q(),window.toastr.success('模板添加成功'))}},ne=()=>{if(''!==G.value&&W.value.name.trim()&&W.value.headers.trim()){const e=parseInt(G.value);e>=0&&e<Z.value.length&&(Z.value[e]={...W.value},K(),window.toastr.success('模板保存成功'))}else window.toastr.warning('请填写模板名称和列头')},te=()=>{if(''!==G.value&&confirm('确定要删除这个模板吗？')){const e=parseInt(G.value);e>=0&&e<Z.value.length&&(Z.value.splice(e,1),K(),G.value='',W.value={name:'',headers:''},window.toastr.success('模板删除成功'))}},ae=()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载隐藏楼层数据');console.log('脚本ID:',n);const t=`${n}_hidden_messages`,a=localStorage.getItem(t);if(a)try{L.value=JSON.parse(a),console.log('✅ 从 localStorage 加载隐藏楼层数据:',L.value.length,'个')}catch(e){console.error('解析隐藏楼层数据失败:',e),L.value=[]}else console.log('📝 localStorage 中没有隐藏楼层数据'),L.value=[]}catch(n){console.error('加载隐藏楼层数据失败:',n)}},oe=()=>{try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存隐藏楼层数据');console.log('保存到脚本ID:',e),console.log('要保存的数据:',I(L.value));const n=`${e}_hidden_messages`;localStorage.setItem(n,JSON.stringify(L.value)),console.log('✅ 成功保存隐藏楼层数据到 localStorage:',L.value.length,'个')}catch(e){console.error('保存隐藏楼层数据失败:',e)}};w(()=>{console.log('SettingsTab 组件已挂载，开始加载数据'),(()=>{if(!s.value.api_provider||''===s.value.api_provider){const e=s.value.api_endpoint||'';e.includes('generativelanguage.googleapis.com')?s.value.api_provider='gemini':e.includes('open.bigmodel.cn')?s.value.api_provider='zhipu':s.value.api_provider='openai'}})(),ae(),(()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载列头模板');const t=`${n}_header_templates`,a=localStorage.getItem(t);if(a)try{let e=JSON.parse(a);Array.isArray(e)||(e=[]),Z.value=e,console.log('✅ 从 localStorage 加载列头模板:',Z.value.length,'个')}catch(e){console.error('解析列头模板失败:',e),Z.value=[]}else Z.value=[]}catch(n){console.error('加载列头模板失败:',n),Z.value=[]}})(),(()=>{try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载生成状态');const t=`${n}_generation_status`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);J.value=e.is_summarizing||!1,F.value=e.is_generating_table||!1,console.log('✅ 从 localStorage 加载生成状态:',{summarizing:J.value,generating_table:F.value})}catch(e){console.error('解析生成状态失败:',e),J.value=!1,F.value=!1}else J.value=!1,F.value=!1}catch(n){console.error('加载生成状态失败:',n),J.value=!1,F.value=!1}})()});const re=()=>{console.log('💾 手动保存设置...');t.saveSettings()?console.log('✅ 设置保存成功'):console.error('❌ 设置保存失败')},se=()=>{console.log('🔄 重新加载设置...');t.reloadSettings()?console.log('✅ 设置重新加载成功'):console.error('❌ 设置重新加载失败')},ie=()=>{console.log('🔄 重置自动总结起始楼层...');try{'function'==typeof window.smartResetChat?window.smartResetChat():window.toastr.error('重置函数不可用，请刷新页面后重试')}catch(e){console.error('❌ 重置起始楼层失败:',e),window.toastr.error('重置失败: '+e.message)}},le=()=>{const e=s.value.api_provider,n={openai:'https://api.openai.com/v1',gemini:'https://generativelanguage.googleapis.com/v1beta/openai'};n[e]&&(s.value.api_endpoint=n[e],window.toastr.success('已切换到 '+('openai'===e?'OpenAI':'Gemini AI Studio')))},de=()=>{try{if(!s.value.api_endpoint||!s.value.api_key)return void window.toastr.warning('请先填写 API 端点和 API Key');t.saveSettings()&&console.log('API 配置已保存:',{endpoint:s.value.api_endpoint,model:s.value.model,provider:s.value.api_provider,api_key:s.value.api_key?'***'+s.value.api_key.slice(-4):''})}catch(e){console.error('保存 API 配置失败:',e),window.toastr.error('保存失败：'+e.message)}},ce=async()=>{if(!j.value)try{if(j.value=!0,console.log('🚀 开始拉取模型列表...'),console.log('📍 API 端点:',s.value.api_endpoint),console.log('🔑 API Key:',s.value.api_key?'***'+s.value.api_key.slice(-4):'未设置'),!s.value.api_endpoint||!s.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');window.toastr.info('正在拉取模型列表，请查看控制台了解详细过程...');const{fetchAvailableModels:e}=await S(async()=>{const{fetchAvailableModels:e}=await import('./index.js').then(e=>e.S);return{fetchAvailableModels:e}},__vite__mapDeps([0,1])),n=await e();console.log('✅ 最终获取到的模型列表:',n),n.length>0?(P.value=n,window.toastr.success(`🎉 成功获取 ${n.length} 个模型！\n模型列表: ${n.slice(0,3).join(', ')}${n.length>3?'...':''}`),!s.value.model&&n[0]&&(s.value.model=n[0],console.log('✅ 自动选择模型:',n[0]))):window.toastr.warning('未找到可用模型，请手动输入')}catch(e){console.error('❌ 拉取模型失败:',e);const n=e.message;n.length>200?window.toastr.error('❌ 拉取模型失败\n\n请打开浏览器控制台（F12）查看详细的调试信息\n\n可能的原因：\n• API 不支持 /v1/models 接口\n• API Key 权限不足\n• 网络连接问题或 CORS 限制'):window.toastr.error(`❌ 拉取模型失败\n\n${n}`),console.error('📋 完整错误信息:',n)}finally{j.value=!1}},pe=async()=>{try{if(console.log('测试连接...'),!s.value.api_endpoint||!s.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');window.toastr.info('正在测试连接，请稍候...');const{normalizeApiEndpoint:e,filterApiParams:n}=await S(async()=>{const{normalizeApiEndpoint:e,filterApiParams:n}=await import('./index.js').then(e=>e.R);return{normalizeApiEndpoint:e,filterApiParams:n}},__vite__mapDeps([0,1])),t=e(s.value.api_endpoint);console.log('📍 规范化的端点:',t);const a=n({model:s.value.model||'gpt-3.5-turbo',messages:[{role:'user',content:'Hello'}],max_tokens:5,temperature:s.value.temperature,top_p:s.value.top_p,presence_penalty:s.value.presence_penalty,frequency_penalty:s.value.frequency_penalty},s.value.api_endpoint);console.log('🔍 过滤后的参数:',a);const o=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${s.value.api_key}`},body:JSON.stringify(a)});if(o.ok){const e=await o.json();console.log('API 测试响应:',e);const n=e.choices?.[0]?.message?.content||'(无内容)',t=e.model||s.value.model;window.toastr.success(`✅ 连接成功！\n📦 模型: ${t}\n💬 回复: ${n.substring(0,50)}...`)}else{const e=await o.text();console.error('API 错误响应:',e),window.toastr.error(`❌ 连接失败 (${o.status})\n详情: ${e.substring(0,100)}`)}}catch(e){console.error('连接测试失败:',e),window.toastr.error('连接测试失败: '+e.message)}},ue=async()=>{let e=null;try{if(J.value)return;if(console.log('开始手动总结...'),J.value=!0,q(),e=A.addTask({title:'生成总结',description:`正在总结楼层 ${s.value.start_message_id} - ${s.value.end_message_id}`,category:'总结'}),!s.value.api_endpoint||!s.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');if(void 0===s.value.start_message_id||void 0===s.value.end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');if(s.value.start_message_id<0||s.value.end_message_id<s.value.start_message_id)return void window.toastr.warning('楼层范围无效，请确保结束楼层大于等于开始楼层');console.log(`总结范围: ${s.value.start_message_id} - ${s.value.end_message_id}`),B.value=!0,Y.value?.setProgress(10),Y.value?.setMessage('正在准备生成总结...'),Y.value?.addDetail(`楼层范围: ${s.value.start_message_id} - ${s.value.end_message_id}`),Y.value?.setProgress(30),Y.value?.setMessage('正在调用 AI 生成总结...'),Y.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const{summarizeMessages:n}=await S(async()=>{const{summarizeMessages:e}=await import('./index.js').then(e=>e.S);return{summarizeMessages:e}},__vite__mapDeps([0,1])),t=await n(s.value.start_message_id,s.value.end_message_id);Y.value?.setProgress(90),Y.value?.setMessage('正在保存总结结果...'),console.log('总结完成:',t);const a=T();if(a){const e=`${a}_last_summary`;localStorage.setItem(e,JSON.stringify({last_summary:t})),console.log('✅ 总结已保存到 localStorage')}v.addSummary(s.value.start_message_id??0,s.value.end_message_id??s.value.start_message_id??0,t),window.dispatchEvent(new CustomEvent('summary-history-updated')),Y.value?.setProgress(100),Y.value?.setMessage('✅ 总结完成！'),Y.value?.addDetail('总结已保存到历史记录'),setTimeout(()=>{B.value=!1,window.toastr.success('总结完成并已保存到历史！'),e&&A.completeTask(e)},800)}catch(n){console.error('总结失败:',n),B.value=!1,window.toastr.error('总结失败: '+n.message),e&&A.failTask(e,n.message)}finally{J.value=!1,q()}},ge=async()=>{let e=null;try{if(F.value)return;if(console.log('开始生成表格...'),F.value=!0,q(),e=A.addTask({title:'生成表格',description:`正在生成楼层 ${s.value.table_start_message_id} - ${s.value.table_end_message_id} 的表格`,category:'表格'}),!s.value.api_endpoint||!s.value.api_key)return void window.toastr.warning('请先配置 API 端点和 API Key');if(B.value=!0,Y.value?.setProgress(5),Y.value?.setMessage('正在准备生成表格...'),!s.value.table_start_message_id||!s.value.table_end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');let o=null;if(W.value.headers.trim()){confirm(`是否使用模板"${W.value.name}"的列头？\n列头：${W.value.headers}`)&&(o=W.value.headers)}if(o||(o=window.prompt('请输入表格列头（用逗号分隔，如：时间,事件,地点,人物）：')),!o||!o.trim())return void window.toastr.warning('请设置表格列头');const r=o.split(',').map(e=>e.trim()).filter(e=>e);if(0===r.length)return void window.toastr.warning('请设置有效的表格列头');let i;Y.value?.setProgress(15),Y.value?.setMessage('正在获取聊天消息...'),Y.value?.addDetail(`楼层范围: ${s.value.table_start_message_id} - ${s.value.table_end_message_id}`);try{const e=`${s.value.table_start_message_id}-${s.value.table_end_message_id}`;if(console.log('获取消息范围:',e),void 0===window.TavernHelper||'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');i=window.TavernHelper.getChatMessages(e),console.log('✅ 通过 TavernHelper.getChatMessages() 获取到的消息数量:',i.length),Y.value?.addDetail(`获取到 ${i.length} 条消息`)}catch(n){return console.error('获取聊天消息失败:',n),B.value=!1,void window.toastr.error('获取聊天消息失败: '+n.message)}if(!i||0===i.length)return void window.toastr.warning('指定范围内没有消息');const l=i.map((e,n)=>`[消息${n+1}] ${'user'===e.role?'用户':'AI'}: ${e.message}`).join('\n\n'),d='你是专业的数据提取助手，负责从聊天记录中提取结构化数据并生成表格。\n\n# 核心任务\n从用户提供的聊天记录中，提取与列头相关的信息，生成JSON格式的表格数据。\n\n# 关键原则\n1. **只提取有效信息**：忽略错误消息、系统提示、无关对话\n2. **精准匹配列头**：每一列都要对应列头的含义\n3. **保持结构化**：每行数据必须是数组，长度等于列头数量\n4. **避免空表**：如果聊天内容中确实没有相关信息，生成示例说明"无相关数据"\n\n# 输出格式（严格遵守）\n只输出纯JSON，格式如下：\n{\n  "data": [\n    ["值1", "值2", "值3"],\n    ["值4", "值5", "值6"]\n  ]\n}\n\n# 禁止事项\n❌ 不要输出任何解释、说明、注释\n❌ 不要使用markdown代码块（```json）\n❌ 不要复制错误消息作为数据\n❌ 不要改变列头顺序或数量\n\n现在开始提取数据。',c=`请从以下聊天记录中提取信息，生成表格数据。\n\n**表格列头**：${r.join(', ')}\n（共${r.length}列，每行数据必须包含${r.length}个值）\n\n**聊天记录**：\n${l}\n\n---\n\n**重要提醒**：\n- 每行数据格式：[${r.map(e=>`"${e}对应的值"`).join(', ')}]\n- 如果某列没有信息，填写"无"或"-"\n- 忽略错误消息、系统提示等无关内容\n- 只返回JSON，不要任何其他文字\n\n立即生成表格JSON：`;console.log('发送AI请求...'),console.log('📋 System Prompt:',d),console.log('📝 User Prompt:',c.slice(0,500)+'...'),Y.value?.setProgress(30),Y.value?.setMessage('正在发送请求到 AI 服务器...'),Y.value?.addDetail(`表格列头: ${r.join(', ')}`);const{normalizeApiEndpoint:p,filterApiParams:u}=await S(async()=>{const{normalizeApiEndpoint:e,filterApiParams:n}=await import('./index.js').then(e=>e.R);return{normalizeApiEndpoint:e,filterApiParams:n}},__vite__mapDeps([0,1])),g=p(s.value.api_endpoint);Y.value?.setProgress(40),Y.value?.setMessage('等待 AI 分析并生成表格...'),Y.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const f=u({model:s.value.model,messages:[{role:'system',content:d},{role:'user',content:c}],max_tokens:s.value.max_tokens,temperature:.3,top_p:s.value.top_p,presence_penalty:s.value.presence_penalty,frequency_penalty:s.value.frequency_penalty},s.value.api_endpoint),m=await fetch(g,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${s.value.api_key}`},body:JSON.stringify(f)});if(!m.ok){const e=await m.text();return B.value=!1,console.error('❌ API请求失败:',m.status,m.statusText),console.error('错误详情:',e),void window.toastr.error(`API请求失败！\n\n状态码: ${m.status}\n错误: ${m.statusText}\n\n请检查：\n1. API端点是否正确\n2. API Key是否有效\n3. 网络连接是否正常`,'',{timeOut:1e4})}Y.value?.setProgress(70),Y.value?.setMessage('正在接收 AI 响应...');const x=await m.json();if(console.log('AI响应:',x),!x.choices||!x.choices[0]||!x.choices[0].message)return B.value=!1,console.error('❌ AI响应格式错误:',x),void window.toastr.error('AI响应格式错误，请检查API是否为OpenAI兼容格式','',{timeOut:8e3});const b=x.choices[0].message.content;let h;console.log('AI返回内容:',b),Y.value?.setProgress(85),Y.value?.setMessage('正在解析表格数据...');try{if(b.includes('API密钥')||b.includes('请求失败')||b.includes('轮询日志')||b.includes('error')||!b.includes('{')&&!b.includes('['))return B.value=!1,window.toastr.error(`API调用失败，请检查API配置！\n\n错误信息：\n${b.slice(0,200)}`,'',{timeOut:1e4}),void console.error('❌ API返回错误信息:',b);let e=b.trim();e=e.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/```\s*$/,'');const n=e.match(/\{[\s\S]*\}/);if(!n)throw new Error('无法找到JSON格式的表格数据');h=JSON.parse(n[0])}catch(t){return console.error('解析AI响应失败:',t),console.log('AI原始响应:',b),B.value=!1,void window.toastr.error(`AI返回的数据格式不正确！\n\n原始响应：\n${b.slice(0,200)}`,'',{timeOut:8e3})}if(!h.data||!Array.isArray(h.data))return void window.toastr.error('AI返回的表格数据格式不正确：缺少data数组');for(let e=0;e<h.data.length;e++){if(!Array.isArray(h.data[e]))return void window.toastr.error(`第${e+1}行数据格式错误：不是数组`);if(h.data[e].length!==r.length)return window.toastr.error(`第${e+1}行数据列数不匹配：期望${r.length}列，实际${h.data[e].length}列`),console.log('期望列头:',r),void console.log('实际数据:',h.data[e])}const y={headers:r,data:h.data},v=O();if(v){const n=`${T()}_table_history_${v}`;let t=[];const o=localStorage.getItem(n);if(o)try{t=JSON.parse(o)}catch(a){console.error('解析表格历史失败:',a),t=[]}t.push({start_id:s.value.table_start_message_id,end_id:s.value.table_end_message_id,headers:y.headers,data:y.data}),localStorage.setItem(n,JSON.stringify(t)),console.log('✅ 表格已保存到 localStorage，chat_id:',v),Y.value?.setProgress(100),Y.value?.setMessage('✅ 表格生成完成！'),Y.value?.addDetail(`共生成 ${y.data.length} 行数据`),setTimeout(()=>{B.value=!1,window.toastr.success(`表格生成成功！共${y.data.length}行数据`),e&&A.completeTask(e)},800),console.log('表格已保存到聊天变量:',t)}else B.value=!1,window.toastr.warning('无法获取聊天ID，表格生成失败')}catch(n){console.error('生成表格失败:',n),B.value=!1,window.toastr.error('生成表格失败: '+n.message),e&&A.failTask(e,n.message)}finally{F.value=!1,q()}},fe=()=>{try{if(!s.value.table_start_message_id||!s.value.table_end_message_id)return void window.toastr.warning('请设置开始楼层和结束楼层');const n=window.prompt('请输入表格列头（用逗号分隔，如：时间,事件,地点,人物）：');if(!n||!n.trim())return void window.toastr.warning('请设置表格列头');const t=n.split(',').map(e=>e.trim()).filter(e=>e);if(0===t.length)return void window.toastr.warning('请设置有效的表格列头');const a={start_id:s.value.table_start_message_id,end_id:s.value.table_end_message_id,headers:t,data:[]},o=O();if(o){const n=`${T()}_table_history_${o}`;let r=[];const s=localStorage.getItem(n);if(s)try{r=JSON.parse(s)}catch(e){console.error('解析表格历史失败:',e),r=[]}r.push(a),localStorage.setItem(n,JSON.stringify(r)),console.log('✅ 空表格已保存到 localStorage，chat_id:',o),window.toastr.success(`空表格创建成功！列头：${t.join(', ')}`),console.log('空表格已保存到聊天变量:',a)}else window.toastr.warning('无法获取聊天ID，表格创建失败')}catch(n){console.error('创建表格失败:',n),window.toastr.error('创建表格失败: '+n.message)}},me=async()=>{try{if(console.log('隐藏楼层...'),!R.value.trim())return void window.toastr.warning('请输入要隐藏的楼层范围');const n=R.value.split(',').map(e=>e.trim()),t=[];for(const e of n)if(e.includes('-')){const[n,a]=e.split('-').map(Number);if(n&&a&&n<=a)for(let e=n;e<=a;e++)t.push(e)}else{const n=Number(e);n&&t.push(n)}if(0===t.length)return void window.toastr.warning('请输入有效的楼层范围');let a;try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');a=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',a.length)}}catch(e){return console.error('获取聊天消息失败:',e),void window.toastr.error('获取聊天消息失败: '+e.message)}if(!a||0===a.length)return void window.toastr.warning('当前聊天没有消息');let o=0;const r=[];for(const e of t){if(L.value.some(n=>n.message_id===e)){console.log(`楼层 ${e} 已经被隐藏，跳过`);continue}const n=a.find(n=>n.message_id===e);n&&(r.push({message_id:e,is_hidden:!0}),L.value.push({message_id:e,name:n.name||'Unknown',role:n.role||'user',message:n.message||''}),o++)}if(r.length>0)try{console.log('准备调用 slash 命令隐藏楼层:',t);for(const n of t)try{await triggerSlash(`/hide ${n}`),console.log(`成功隐藏楼层 ${n}`)}catch(e){console.error(`隐藏楼层 ${n} 失败:`,e)}window.toastr.success('楼层已真正隐藏')}catch(e){console.error('调用隐藏API失败:',e),window.toastr.error('隐藏楼层API调用失败: '+e.message)}o>0?(oe(),window.toastr.success(`成功隐藏 ${o} 个楼层`),R.value=''):window.toastr.warning('未找到要隐藏的楼层')}catch(e){console.error('隐藏楼层失败:',e),window.toastr.error('隐藏楼层失败: '+e.message)}},xe=async()=>{try{if(console.log('显示指定楼层...'),!R.value.trim())return void window.toastr.warning('请输入要显示的楼层范围');const n=(e=>{if(!e.trim())return[];const n=[],t=e.split(',');for(const a of t){const e=a.trim();if(e)if(e.includes('-')){const[t,a]=e.split('-').map(e=>parseInt(e.trim()));if(!isNaN(t)&&!isNaN(a)&&t>=0&&a>=0)for(let e=t;e<=a;e++)n.push(e)}else{const t=parseInt(e);!isNaN(t)&&t>=0&&n.push(t)}}return n})(R.value.trim());if(0===n.length)return void window.toastr.warning('请输入有效的楼层范围');let t;try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');t=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',t.length)}}catch(e){return console.error('获取聊天消息失败:',e),void window.toastr.error('获取聊天消息失败: '+e.message)}if(!t||0===t.length)return void window.toastr.warning('当前聊天没有消息');const a=[];let o=0;for(const e of n){t.find(n=>n.message_id===e)&&(a.push({message_id:e,is_hidden:!1}),o++)}if(0===a.length)return void window.toastr.warning('未找到要显示的楼层');try{for(const t of n)try{await triggerSlash(`/unhide ${t}`),console.log(`成功显示楼层 ${t}`)}catch(e){console.error(`显示楼层 ${t} 失败:`,e)}}catch(e){return console.error('调用显示API失败:',e),void window.toastr.error('显示楼层API调用失败: '+e.message)}L.value=L.value.filter(e=>!n.includes(e.message_id)),oe(),window.toastr.success(`成功显示 ${o} 个楼层`),R.value=''}catch(e){console.error('显示楼层失败:',e),window.toastr.error('显示楼层失败: '+e.message)}};return(e,n)=>(r(),a('div',Ki,[i('div',Qi,[i('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[0]||(n[0]=e=>M('api')),onMouseenter:n[1]||(n[1]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[2]||(n[2]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[37]||(n[37]=i('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-cog',style:{color:'#17a2b8','font-size':'18px'}}),d(' API 配置 ')],-1)),i('i',{class:x([C.value.api?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(i('div',null,[i('div',el,[n[39]||(n[39]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'API 提供商',-1)),l(i('select',{'onUpdate:modelValue':n[3]||(n[3]=e=>V(s).api_provider=e),style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s',cursor:'pointer'},onChange:le},[...n[38]||(n[38]=[i('option',{value:'openai'},'OpenAI',-1),i('option',{value:'gemini'},'Gemini AI Studio',-1)])],544),[[D,V(s).api_provider]])]),i('div',nl,[n[40]||(n[40]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' API 端点 '),i('span',{style:{color:'#888','font-size':'11px','margin-left':'8px'}},' (兼容酒馆格式，填写 base URL 即可) ')],-1)),l(i('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>V(s).api_endpoint=e),type:'text',placeholder:'https://你的服务器/v1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).api_endpoint]]),n[41]||(n[41]=u('<div style="margin-top:8px;padding:8px 12px;background:rgba(74, 158, 255, 0.1);border-radius:4px;border-left:3px solid #4a9eff;"><div style="color:#4a9eff;font-size:12px;font-weight:bold;margin-bottom:4px;"> 📌 常见端点示例（与酒馆格式一致）： </div><div style="color:#999;font-size:11px;line-height:1.6;"> • <strong>OpenAI 官方:</strong> https://api.openai.com/v1<br> • <strong>Gemini AI Studio:</strong> https://generativelanguage.googleapis.com/v1beta/openai/<br> • <strong>NewAPI / One API:</strong> https://你的服务器/v1<br> • <strong>本地模型 (Ollama):</strong> http://localhost:11434/v1<br> 💡 <strong>提示：</strong>会自动补全 /chat/completions，也可以直接填完整路径 </div></div>',1))]),i('div',tl,[n[42]||(n[42]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'API Key',-1)),l(i('input',{'onUpdate:modelValue':n[5]||(n[5]=e=>V(s).api_key=e),type:'password',placeholder:'sk-...',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).api_key]])]),i('div',al,[i('div',ol,[i('label',rl,[n[43]||(n[43]=d(' 模型名称 ',-1)),0===P.value.length?(r(),a('span',sl,' (手动输入模型名称，如 gpt-4o-mini) ')):o('',!0)]),i('div',il,[i('button',{disabled:j.value,class:'fetch-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#4a9eff','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.3)',color:'white'},onmouseover:'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(74, 158, 255, 0.4)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(74, 158, 255, 0.3)\'',onClick:ce},c(j.value?'拉取中...':'🔍 拉取模型列表'),9,ll),i('button',{class:'save-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},onmouseover:'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(81, 207, 102, 0.4)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 8px rgba(81, 207, 102, 0.3)\'',onClick:de},' 💾 保存配置 ')])]),0===P.value.length?l((r(),a('input',{key:0,'onUpdate:modelValue':n[6]||(n[6]=e=>V(s).model=e),type:'text',placeholder:'gpt-4o-mini 或 deepseek-chat 等',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512)),[[p,V(s).model]]):l((r(),a('select',{key:1,'onUpdate:modelValue':n[7]||(n[7]=e=>V(s).model=e),class:'model-select',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},[(r(!0),a(f,null,m(P.value,e=>(r(),a('option',{key:e,value:e},c(e),9,dl))),128))],512)),[[D,V(s).model]])]),i('div',cl,[n[44]||(n[44]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'最大 Token 数（建议4000以上获得更详细的总结）',-1)),l(i('input',{'onUpdate:modelValue':n[8]||(n[8]=e=>V(s).max_tokens=e),type:'number',min:'100',max:'16000',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).max_tokens,void 0,{number:!0}]])]),i('div',pl,[n[45]||(n[45]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Temperature (温度) '),i('span',{style:{color:'#888','font-size':'11px'}},'(0-2，推荐 0.7)')],-1)),l(i('input',{'onUpdate:modelValue':n[9]||(n[9]=e=>V(s).temperature=e),type:'number',min:'0',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).temperature,void 0,{number:!0}]]),n[46]||(n[46]=i('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 较高值（如 0.8）使输出更随机，较低值（如 0.2）使其更确定 ',-1))]),i('div',ul,[n[47]||(n[47]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Top P (核采样) '),i('span',{style:{color:'#888','font-size':'11px'}},'(0-1，推荐 1.0)')],-1)),l(i('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>V(s).top_p=e),type:'number',min:'0',max:'1',step:'0.01',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).top_p,void 0,{number:!0}]]),n[48]||(n[48]=i('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' ⚠️ 一般建议只改 Temperature 或 Top P，不要同时修改 ',-1))]),i('div',gl,[n[49]||(n[49]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Presence Penalty (存在惩罚) '),i('span',{style:{color:'#888','font-size':'11px'}},'(-2.0 to 2.0，推荐 0)')],-1)),l(i('input',{'onUpdate:modelValue':n[11]||(n[11]=e=>V(s).presence_penalty=e),type:'number',min:'-2',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).presence_penalty,void 0,{number:!0}]]),n[50]||(n[50]=i('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 正值根据标记是否出现过来惩罚，增加讨论新主题的可能性 ',-1))]),i('div',fl,[n[51]||(n[51]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},[d(' Frequency Penalty (频率惩罚) '),i('span',{style:{color:'#888','font-size':'11px'}},'(-2.0 to 2.0，推荐 0)')],-1)),l(i('input',{'onUpdate:modelValue':n[12]||(n[12]=e=>V(s).frequency_penalty=e),type:'number',min:'-2',max:'2',step:'0.1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).frequency_penalty,void 0,{number:!0}]]),n[52]||(n[52]=i('div',{style:{'margin-top':'4px',color:'#888','font-size':'11px'}},' 正值根据标记频率来惩罚，降低逐字重复同一行的可能性 ',-1))])],512),[[E,C.value.api]])]),i('div',ml,[i('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[13]||(n[13]=e=>M('autoSummary')),onMouseenter:n[14]||(n[14]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[15]||(n[15]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[53]||(n[53]=i('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-bolt',style:{color:'#ffc107','font-size':'18px'}}),d(' 自动总结 ')],-1)),i('i',{class:x([C.value.autoSummary?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(i('div',null,[i('div',xl,[i('label',bl,[l(i('input',{'onUpdate:modelValue':n[16]||(n[16]=e=>V(s).auto_summarize_enabled=e),type:'checkbox',style:{width:'18px',height:'18px',cursor:'pointer','accent-color':'#4a9eff','border-radius':'4px'}},null,512),[[N,V(s).auto_summarize_enabled]]),n[54]||(n[54]=d(' 启用自动总结 ',-1))])]),V(s).auto_summarize_enabled?(r(),a('div',hl,[n[55]||(n[55]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'每多少楼层总结一次',-1)),l(i('input',{'onUpdate:modelValue':n[17]||(n[17]=e=>V(s).summarize_interval=e),type:'number',min:'1',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).summarize_interval,void 0,{number:!0}]]),i('div',{style:{'margin-top':'10px',display:'flex',gap:'10px'}},[i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:re},' 💾 保存设置 '),i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:se},' 🔄 重新加载 '),i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 2px 4px rgba(0, 0, 0, 0.2)'},onmouseover:'this.style.transform=\'translateY(-1px)\'; this.style.boxShadow=\'0 4px 8px rgba(0,0,0,0.3)\'',onmouseout:'this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'0 2px 4px rgba(0,0,0,0.2)\'',onClick:ie},' 🔄 重置起始楼层 ')])])):o('',!0)],512),[[E,C.value.autoSummary]])]),i('div',yl,[i('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[18]||(n[18]=e=>M('manualSummary')),onMouseenter:n[19]||(n[19]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[20]||(n[20]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[56]||(n[56]=i('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-pen-to-square',style:{color:'#28a745','font-size':'18px'}}),d(' 手动总结 ')],-1)),i('i',{class:x([C.value.manualSummary?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(i('div',null,[i('div',vl,[n[57]||(n[57]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'开始楼层',-1)),l(i('input',{'onUpdate:modelValue':n[21]||(n[21]=e=>V(s).start_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).start_message_id,void 0,{number:!0}]])]),i('div',wl,[n[58]||(n[58]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'结束楼层',-1)),l(i('input',{'onUpdate:modelValue':n[22]||(n[22]=e=>V(s).end_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).end_message_id,void 0,{number:!0}]])]),i('div',kl,[i('button',{class:'action-button test-button',disabled:J.value,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'1px solid #4a4a4a','border-radius':'6px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#3a3a3a',color:'#e0e0e0'},onClick:pe},[...n[59]||(n[59]=[i('i',{class:'fa-solid fa-plug'},null,-1),d(' 测试连接 ',-1)])],8,_l),i('button',{class:'action-button summarize-button',disabled:J.value||!V(s).api_key,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'1px solid #5aaeff','border-radius':'6px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'linear-gradient(135deg, #4a9eff 0%, #3a8edf 100%)','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.25),\n                inset 0 1px 0 rgba(255, 255, 255, 0.15)',color:'white'},onClick:ue},[J.value?(r(),a('i',Il)):(r(),a('i',zl)),d(' '+c(J.value?'正在总结...':'手动总结'),1)],8,Tl)])],512),[[E,C.value.manualSummary]])]),i('div',Sl,[i('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[23]||(n[23]=e=>M('tableGeneration')),onMouseenter:n[24]||(n[24]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[25]||(n[25]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[60]||(n[60]=i('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-table',style:{color:'#6f42c1','font-size':'18px'}}),d(' 表格生成 ')],-1)),i('i',{class:x([C.value.tableGeneration?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(i('div',null,[i('div',Al,[n[61]||(n[61]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'开始楼层',-1)),l(i('input',{'onUpdate:modelValue':n[26]||(n[26]=e=>V(s).table_start_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).table_start_message_id,void 0,{number:!0}]])]),i('div',$l,[n[62]||(n[62]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'结束楼层',-1)),l(i('input',{'onUpdate:modelValue':n[27]||(n[27]=e=>V(s).table_end_message_id=e),type:'number',min:'0',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,V(s).table_end_message_id,void 0,{number:!0}]])]),i('div',Cl,[n[67]||(n[67]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'表格列头模板',-1)),i('div',El,[l(i('select',{'onUpdate:modelValue':n[28]||(n[28]=e=>G.value=e),style:{flex:'1',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'},onChange:Q},[n[63]||(n[63]=i('option',{value:''},'选择模板...',-1)),(r(!0),a(f,null,m(Z.value,(e,n)=>(r(),a('option',{key:n,value:n},c(e.name),9,Ml))),128))],544),[[D,G.value]]),i('button',{style:{padding:'8px 12px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:ee},[...n[64]||(n[64]=[i('i',{class:'fa-solid fa-plus'},null,-1),d(' 添加 ',-1)])])]),''!==G.value?(r(),a('div',Pl,[l(i('input',{'onUpdate:modelValue':n[29]||(n[29]=e=>W.value.name=e),type:'text',placeholder:'模板名称',style:{flex:'1',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},null,512),[[p,W.value.name]]),l(i('input',{'onUpdate:modelValue':n[30]||(n[30]=e=>W.value.headers=e),type:'text',placeholder:'列头（用逗号分隔）',style:{flex:'2',padding:'8px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},null,512),[[p,W.value.headers]]),i('button',{style:{padding:'8px 12px',background:'#28a745',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:ne},[...n[65]||(n[65]=[i('i',{class:'fa-solid fa-save'},null,-1),d(' 保存 ',-1)])]),i('button',{style:{padding:'8px 12px',background:'#dc3545',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','white-space':'nowrap'},onClick:te},[...n[66]||(n[66]=[i('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])])])):o('',!0)]),i('div',Ol,[n[71]||(n[71]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'生成状态',-1)),i('div',jl,[i('div',Rl,[i('div',{style:g({width:'8px',height:'8px',borderRadius:'50%',backgroundColor:J.value?'#ff6b6b':'#4caf50',transition:'background-color 0.3s'})},null,4),n[68]||(n[68]=i('span',{style:{color:'#ccc','font-size':'12px'}},'总结生成',-1))]),i('div',Nl,[i('div',{style:g({width:'8px',height:'8px',borderRadius:'50%',backgroundColor:F.value?'#ff6b6b':'#4caf50',transition:'background-color 0.3s'})},null,4),n[69]||(n[69]=i('span',{style:{color:'#ccc','font-size':'12px'}},'表格生成',-1))]),J.value||F.value?(r(),a('div',Dl,[i('button',{style:{padding:'4px 8px',background:'#dc3545',border:'none','border-radius':'4px',color:'white',cursor:'pointer','font-size':'11px'},onClick:X},[...n[70]||(n[70]=[i('i',{class:'fa-solid fa-stop'},null,-1),d(' 停止生成 ',-1)])])])):o('',!0)])]),i('div',Ll,[i('button',{class:'action-button summarize-button',disabled:F.value||!V(s).api_key,style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#4a9eff','box-shadow':'0 2px 8px rgba(74, 158, 255, 0.3)',color:'white'},onClick:ge},[F.value?(r(),a('i',Ul)):(r(),a('i',Vl)),d(' '+c(F.value?'AI填充中...':'AI填充表格'),1)],8,Hl),i('button',{class:'action-button create-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},onClick:fe},[...n[72]||(n[72]=[i('i',{class:'fa-solid fa-plus'},null,-1),d(' 创建空表格 ',-1)])])])],512),[[E,C.value.tableGeneration]])]),i('div',Jl,[i('div',{style:{cursor:'pointer','user-select':'none',display:'flex','align-items':'center','justify-content':'space-between',padding:'20px 28px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'18px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',position:'relative',overflow:'hidden',transition:'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'},onClick:n[31]||(n[31]=e=>M('messageManagement')),onMouseenter:n[32]||(n[32]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(42, 42, 42, 0.98) 0%, rgba(50, 50, 50, 0.95) 50%, rgba(42, 42, 42, 0.98) 100%)',e.currentTarget.style.transform='translateX(4px) scale(1.005)',e.currentTarget.style.borderLeft='3px solid rgba(255, 193, 7, 0.6)'}),onMouseleave:n[33]||(n[33]=e=>{e.currentTarget.style.background='linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(38, 38, 38, 0.9) 50%, rgba(30, 30, 30, 0.95) 100%)',e.currentTarget.style.transform='none',e.currentTarget.style.borderLeft='1px solid rgba(255, 255, 255, 0.06)'})},[n[73]||(n[73]=i('h3',{style:{position:'relative','z-index':'1',display:'flex','align-items':'center',gap:'12px',margin:'0',color:'#fff','font-size':'16px','font-weight':'600','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-layer-group',style:{color:'#dc3545','font-size':'18px'}}),d(' 楼层管理 ')],-1)),i('i',{class:x([C.value.messageManagement?'fa-chevron-up':'fa-chevron-down','fa-solid']),style:{color:'rgba(255, 255, 255, 0.6)','font-size':'14px',transition:'transform 0.3s'}},null,2)],32),l(i('div',null,[i('div',Fl,[n[74]||(n[74]=i('label',{style:{display:'block','margin-bottom':'6px',color:'#ccc','font-size':'13px'}},'隐藏楼层范围（如：1-10 或单个楼层如：5）',-1)),l(i('input',{'onUpdate:modelValue':n[34]||(n[34]=e=>R.value=e),type:'text',placeholder:'1-10',style:{width:'100%',padding:'10px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',transition:'border-color 0.2s'}},null,512),[[p,R.value]])]),i('div',Bl,[i('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#ff6b6b','box-shadow':'0 2px 8px rgba(255, 107, 107, 0.3)',color:'white'},onClick:me},[...n[75]||(n[75]=[i('i',{class:'fa-solid fa-eye-slash'},null,-1),d(' 隐藏楼层 ',-1)])]),i('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#51cf66','box-shadow':'0 2px 8px rgba(81, 207, 102, 0.3)',color:'white'},disabled:!R.value.trim(),onClick:xe},[...n[76]||(n[76]=[i('i',{class:'fa-solid fa-eye'},null,-1),d(' 显示楼层 ',-1)])],8,Yl),i('button',{class:'action-button',style:{flex:'1','min-width':'120px',padding:'12px 16px',border:'none','border-radius':'12px',cursor:'pointer','font-weight':'500','font-size':'13px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px',background:'#ffd43b','box-shadow':'0 2px 8px rgba(255, 212, 59, 0.3)',color:'#333'},onClick:n[35]||(n[35]=()=>(async(e=!1)=>{try{let t;console.log('刷新隐藏楼层',e),0===L.value.length&&(console.log('隐藏楼层列表为空，先加载数据...'),ae());try{if(void 0===window.TavernHelper)throw new Error('TavernHelper 不可用');{const e=window.TavernHelper.getLastMessageId?.()??0;if(console.log('最新消息ID:',e),'function'!=typeof window.TavernHelper.getChatMessages)throw new Error('TavernHelper.getChatMessages 不可用');t=window.TavernHelper.getChatMessages(`0-${e}`),console.log('✅ 通过 TavernHelper 获取到的消息数量:',t.length)}}catch(n){return console.error('获取聊天消息失败:',n),void(e&&window.toastr.error('获取聊天消息失败: '+n.message))}if(!t||0===t.length)return void(e&&window.toastr.warning('当前聊天没有消息'));const a=[];let o=0;for(const e of L.value){const n=t.find(n=>n.message_id===e.message_id);n?a.push({message_id:e.message_id,name:n.name||e.name,role:n.role||e.role,message:n.message||e.message}):o++}L.value=a,oe(),e&&(o>0?window.toastr.success(`刷新完成，移除了 ${o} 个不存在的楼层`):window.toastr.success('刷新完成，所有隐藏楼层仍然有效')),console.log(`刷新完成：${a.length} 个有效隐藏楼层，${o} 个已移除`)}catch(n){console.error('刷新隐藏楼层失败:',n),e&&window.toastr.error('刷新隐藏楼层失败: '+n.message)}})(!0))},[...n[77]||(n[77]=[i('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新 ',-1)])])]),L.value.length>0?(r(),a('div',Zl,[i('div',Gl,[i('label',Wl,[i('span',null,'已隐藏的楼层 ('+c(L.value.length)+' 个)',1),i('button',{class:'mini-button',style:{padding:'6px 14px',background:'#4a9eff',color:'white',border:'none','border-radius':'8px',cursor:'pointer','font-size':'12px','font-weight':'500',transition:'all 0.2s','box-shadow':'0 2px 6px rgba(74, 158, 255, 0.3)'},onClick:n[36]||(n[36]=e=>U.value=!U.value)},c(U.value?'收起':'展开'),1)])]),U.value?(r(),a('div',ql,[(r(!0),a(f,null,m(L.value,e=>(r(),a('div',{key:e.message_id,class:'hidden-message-item'},[i('div',Xl,[i('span',Kl,'#'+c(e.message_id),1),i('span',{class:x(['message-role','role-'+e.role])},c('user'===e.role?'👤':'assistant'===e.role?'🤖':'⚙️')+' '+c(e.name),3),i('span',Ql,c(e.message.substring(0,50))+c(e.message.length>50?'...':''),1)]),i('button',{class:'show-button',style:{padding:'6px 14px',background:'#51cf66',color:'white',border:'none','border-radius':'8px',cursor:'pointer','font-size':'12px','font-weight':'500',transition:'all 0.2s','box-shadow':'0 2px 6px rgba(81, 207, 102, 0.3)'},onClick:()=>(async e=>{try{console.log('显示单个楼层',e);const t=L.value.findIndex(n=>n.message_id===e);if(-1===t)return void window.toastr.warning(`楼层 #${e} 不在隐藏列表中`);try{await triggerSlash(`/unhide ${e}`),console.log('成功显示楼层:',e)}catch(n){return console.error('调用显示API失败:',n),void window.toastr.warning('显示楼层API调用失败')}L.value.splice(t,1),oe(),window.toastr.success(`已显示楼层 #${e}`)}catch(n){console.error('显示单个楼层失败:',n),window.toastr.error('显示单个楼层失败: '+n.message)}})(e.message_id)},' 显示 ',8,ed)]))),128))])):o('',!0)])):(r(),a('div',nd,'暂无隐藏的楼层'))],512),[[E,C.value.messageManagement]])]),k(Kr,{ref_key:'progressDialogRef',ref:Y,show:B.value,title:'AI 正在处理'},null,8,['show'])]))}}),ad={class:'statusbar-generator'},od={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 28px',background:'linear-gradient(\n          135deg,\n          rgba(30, 30, 30, 0.95) 0%,\n          rgba(38, 38, 38, 0.9) 50%,\n          rgba(30, 30, 30, 0.95) 100%\n        )','backdrop-filter':'blur(12px)','border-radius':'14px','margin-bottom':'20px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n          inset 0 1px 0 rgba(255, 255, 255, 0.04),\n          inset 0 -1px 0 rgba(0, 0, 0, 0.2)'}},rd={style:{display:'flex',gap:'10px','flex-wrap':'wrap'}},sd={style:{display:'grid','grid-template-columns':'280px 1fr 500px',gap:'20px','min-height':'600px'}},id={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column','overflow-y':'auto'}},ld={style:{'margin-bottom':'15px'}},dd={style:{flex:'1',display:'flex','flex-direction':'column',gap:'10px','margin-bottom':'15px'}},cd={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'8px'}},pd={style:{color:'#4a9eff','font-size':'11px','font-weight':'600'}},ud=['disabled','onClick'],gd=['onUpdate:modelValue'],fd=['onUpdate:modelValue'],md={style:{display:'flex',gap:'6px','align-items':'center'}},xd=['onUpdate:modelValue'],bd=['onClick'],hd={key:1,class:'fa-solid fa-icons'},yd={style:{background:'#2a2a2a','border-radius':'16px',padding:'15px',border:'1px solid #3a3a3a',display:'flex','flex-direction':'column'}},vd={style:{display:'flex',gap:'8px','margin-bottom':'12px','border-bottom':'1px solid #3a3a3a','padding-bottom':'8px'}},wd=['onClick'],kd={style:{display:'flex','flex-direction':'column',gap:'15px','overflow-y':'auto'}},_d={style:{background:'#2a2a2a','border-radius':'12px',padding:'15px',border:'1px solid #3a3a3a'}},Td={style:{background:'#1e1e1e','border-radius':'8px',padding:'12px',border:'1px solid #3a3a3a',overflow:'auto','max-height':'200px'}},zd={style:{margin:'0',color:'#e0e0e0','font-size':'11px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','font-family':'\'Consolas\', \'Monaco\', monospace'}},Id={style:{background:'#2a2a2a','border-radius':'12px',padding:'15px',border:'1px solid #3a3a3a',flex:'1'}},Sd=['innerHTML'],Ad={style:{background:'#2a2a2a','border-radius':'16px',padding:'20px',width:'600px','max-width':'90vw',border:'1px solid #3a3a3a'}},$d={style:{display:'grid','grid-template-columns':'repeat(8, 1fr)',gap:'8px','margin-bottom':'16px','max-height':'400px','overflow-y':'auto'}},Cd=['title','onClick'],Ed={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Md={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'600px','max-width':'90vw','max-height':'90vh','overflow-y':'auto',border:'1px solid #3a3a3a'}},Pd={style:{background:'linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(37, 99, 235, 0.1) 100%)',border:'1px solid rgba(59, 130, 246, 0.3)','border-radius':'8px',padding:'12px 16px','margin-bottom':'16px'}},Od={style:{display:'flex','align-items':'center','justify-content':'space-between','margin-bottom':'10px'}},jd={style:{display:'flex','align-items':'center',gap:'10px'}},Rd={style:{color:'#93c5fd','font-size':'13px','font-weight':'600'}},Nd={key:0,style:{display:'flex','flex-direction':'column',gap:'8px'}},Dd={style:{color:'#60a5fa','font-weight':'600','font-size':'11px','min-width':'50px'}},Ld=['onUpdate:modelValue'],Hd=['onUpdate:modelValue'],Vd=['onClick'],Ud=['disabled','onClick'],Jd={key:1,style:{color:'#fbbf24','font-size':'12px',padding:'8px 0'}},Fd={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},Bd={key:0,style:{'margin-top':'16px',display:'flex',gap:'10px','justify-content':'flex-end'}},Yd=['disabled'],Zd={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'90%','max-width':'700px','max-height':'80vh','overflow-y':'auto','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'}},Gd={style:{'margin-bottom':'16px'}},Wd={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},qd=['disabled'],Xd=['disabled'],Kd={style:{background:'#2a2a2a','border-radius':'16px',padding:'24px',width:'90%','max-width':'700px','max-height':'80vh','overflow-y':'auto','box-shadow':'0 8px 32px rgba(0, 0, 0, 0.5)'}},Qd={style:{'margin-bottom':'16px'}},ec={style:{display:'flex',gap:'10px','justify-content':'flex-end'}},nc=['disabled'],tc=['disabled'],ac=e({__name:'StatusBarGenerator',setup(e){const I=b(),{settings:S}=h(I),C=y(),E={simple:{name:'简单状态栏',findRegex:'<-CHARACTER_STATUS->',fields:[{name:'姓名',label:'姓名',icon:'fa-solid fa-user'},{name:'性别',label:'性别',icon:'fa-solid fa-venus-mars'},{name:'年龄',label:'年龄',icon:'fa-solid fa-cake-candles'},{name:'好感度',label:'好感度',icon:'fa-solid fa-heart'}]},abo:{name:'ABO设定状态栏',findRegex:'<-ENVIRONMENT_DATA->[\\r\\n]*\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|[\\r\\n]*<-CHARACTER_STATUS->[\\r\\n]*\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|([^|]+)\\|[\\r\\n]*',fields:[{name:'日期',label:'日期',icon:'fa-solid fa-calendar'},{name:'时间',label:'时间',icon:'fa-solid fa-clock'},{name:'地点',label:'地点',icon:'fa-solid fa-location-dot'},{name:'天气温度',label:'天气温度',icon:'fa-solid fa-cloud-sun'},{name:'着装',label:'着装',icon:'fa-solid fa-shirt'},{name:'黏人程度',label:'黏人程度',icon:'fa-solid fa-heart'},{name:'发情状态',label:'发情状态',icon:'fa-solid fa-fire'},{name:'标记情况',label:'标记情况',icon:'fa-solid fa-bookmark'}]}},P=n({name:'角色状态栏',findRegex:'<-CHARACTER_STATUS->',fields:[{name:'姓名',label:'姓名',icon:'fa-solid fa-user'},{name:'性别',label:'性别',icon:'fa-solid fa-venus-mars'},{name:'年龄',label:'年龄',icon:'fa-solid fa-cake-candles'},{name:'好感度',label:'好感度',icon:'fa-solid fa-heart'}]}),O=n([{path:'index.html',content:''},{path:'style.css',content:''},{path:'script.js',content:''}]),j=n(O.value[0]),R=n(!1),N=n(''),D=n(''),L=n(!1),H=n(!1),V=n(null),U=n(!1),J=n(null),F=n(''),B=n(!1),Y=n(!1),Z=n(''),G=n(!1),W=n(!1),q=n(!1),X=n(''),K=n(!1),Q=n(!1),ee=n(''),ne=n(!1),te=['fa-solid fa-cat','fa-solid fa-dog','fa-solid fa-dove','fa-solid fa-fish','fa-solid fa-paw','fa-solid fa-spider','fa-solid fa-horse','fa-solid fa-heart','fa-solid fa-heart-pulse','fa-solid fa-face-smile','fa-solid fa-face-grin-stars','fa-solid fa-face-grin-beam','fa-solid fa-face-laugh','fa-solid fa-star','fa-solid fa-wand-magic-sparkles','fa-solid fa-hat-wizard','fa-solid fa-bolt','fa-solid fa-fire','fa-solid fa-meteor','fa-solid fa-rocket','fa-solid fa-sun','fa-solid fa-moon','fa-solid fa-cloud','fa-solid fa-seedling','fa-solid fa-leaf','fa-solid fa-tree','fa-solid fa-snowflake','fa-solid fa-cake-candles','fa-solid fa-candy-cane','fa-solid fa-apple','fa-solid fa-ice-cream','fa-solid fa-gem','fa-solid fa-crown','fa-solid fa-gift','fa-solid fa-ribbon','fa-solid fa-medal','fa-solid fa-trophy','fa-solid fa-shield','fa-solid fa-scroll','fa-solid fa-book','fa-solid fa-book-open','fa-solid fa-feather','fa-solid fa-pen','fa-solid fa-paintbrush','fa-solid fa-palette','fa-solid fa-music','fa-solid fa-headphones','fa-solid fa-gamepad','fa-solid fa-chess','fa-solid fa-puzzle-piece','fa-solid fa-dice','fa-solid fa-mobile-screen','fa-solid fa-tablet','fa-solid fa-laptop','fa-solid fa-camera','fa-solid fa-video','fa-solid fa-tv','fa-solid fa-bell','fa-solid fa-envelope'],ae=v(()=>{P.value.fields.map(e=>`{{${e.label||e.name}}}`).join('|');const e=P.value.fields.map(e=>{const n=e.icon?`<i class="${e.icon}"></i> `:'',t=e.label||e.name;return`  - ${n}${t}：描述{{char}}的${t}状态`}).join('\n');P.value.fields.map(e=>e.label||e.name||'示例值').join('|');const{formatExample:n,exampleOutput:t}=((e,n)=>{if(0===(e.match(/<-[^>]+->/g)||[]).length){return{formatExample:`|${n.map(e=>`{{${e.label||e.name}}}`).join('|')}|`,exampleOutput:`|${n.map(e=>e.label||e.name).join('|')}|`}}let t=e.replace(/\\\\/g,'\\').replace(/\\\|/g,'|').replace(/\\\(/g,'(').replace(/\\\)/g,')').replace(/\\\[/g,'[').replace(/\\\]/g,']').replace(/\\\+/g,'+');console.log('🔍 原始正则:',e),console.log('🔍 规范化正则:',t);const a=[],o=[];let r=0;const s=t.split(/(<-[^>]+->)/);console.log('🔍 分割后的部分:',s);for(let i=0;i<s.length;i++){const e=s[i];if(e.match(/<-[^>]+->/))a.push(e),o.push(e),console.log(`📍 标记: ${e}`);else if(e.trim().length>0&&!e.match(/<-[^>]+->/)){const t=e.match(/\([^\)]+\)/g)||[],s=t.length;if(console.log(`🔢 部分内容 (前100字符): "${e.substring(0,100)}"`),console.log('🔢 匹配到的捕获组:',t),console.log(`🔢 捕获组数量: ${s}, 当前字段索引: ${r}, 总字段数: ${n.length}`),0===s){console.warn('⚠️ 未找到捕获组，跳过此部分');continue}const i=4;for(let e=0;e<s;e+=i){const t=Math.min(i,s-e);if(t>0){const e=n.slice(r,r+t);for(;e.length<t;)e.push({name:`字段${r+e.length+1}`,label:`字段${r+e.length+1}`,icon:''});const s=e.map(e=>`{{${e.label||e.name}}}`).join('|'),i=e.map(e=>e.label||e.name).join('|');a.push(`|${s}|`),o.push(`|${i}|`),console.log(`✅ 添加字段行: |${i}|`),r+=t}}}}return console.log('📊 最终格式示例:',a.join('\n')),console.log('📊 最终输出示例:',o.join('\n')),{formatExample:a.join('\n'),exampleOutput:o.join('\n')}})(P.value.findRegex,P.value.fields);return`<status_rule>\n#每一次回复都必须在末尾加上完整的状态栏，实时更新{{char}}的状态。\n\n##状态栏格式：\n<status>\n${n}\n</status>\n\n##字段说明\n${e||'  - 暂无字段，请先在生成器中添加字段'}\n\n##输出示例\n此处仅为格式示例，具体内容需根据剧情填写\n<status>\n${t}\n</status>\n\n##格式要求（必读）：\n1. **必须包含 <status> 标签**：\n   - ✅ 开头：<status>\n   - ✅ 结尾：</status>\n   - ❌ 缺少标签将无法正确渲染\n\n2. **严格按照上述示例格式输出**：\n   - 每个标记（如 <-ENVIRONMENT_DATA->）必须独占一行\n   - 每行字段用竖线 | 分隔，字段数量必须完全一致\n   - 不要改变行数、不要合并行、不要调换顺序\n   - 完全按照示例格式，只替换字段内容\n\n3. **字段值格式**：\n   - ❌ 错误：|伴侣: 无|信息素: 雪后冷杉|\n   - ✅ 正确：|无|雪后冷杉|\n   - 只输出实际值，不要加字段名前缀\n\n4. **换行要求**：\n   - 严格遵守示例中的换行\n   - 标记后必须换行\n   - 每行字段后必须换行\n   - 绝不把多行合并成一行\n\n5. **其他要求**：\n   - 状态栏紧贴正文最后一句\n   - {{字段名}} 仅为占位符，输出时替换为实际内容\n   - 这是 {{char}} 的状态，不是 {{user}} 的状态\n</status_rule>`}),oe=v(()=>{const e=O.value.find(e=>'index.html'===e.path),n=O.value.find(e=>'style.css'===e.path),t=O.value.find(e=>'script.js'===e.path);if(!e)return'';const a='script',o='style';let r=e.content||'';return P.value.fields.forEach((e,n)=>{const t=e.name||`示例${n+1}`;r=r.replace(new RegExp(`\\$${n+1}(?!\\d)`,'g'),t)}),`<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">\n  <${o}>\n    html, body {\n      margin: 0;\n      padding: 0;\n      width: 100%;\n      height: auto;\n      min-height: 800px;\n      overflow: visible;\n    }\n    ${n?.content||''}\n  </${o}>\n  <${a} src="https://code.jquery.com/jquery-3.7.1.min.js"></${a}>\n  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></${a}>\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></${a}>\n  <${a} src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></${a}>\n</head>\n<body>\n  ${r}\n  <${a}>${t?.content||''}</${a}>\n</body>\n</html>`});function re(){}function se(){P.value.fields.push({name:'',label:'',icon:''})}function ie(){q.value=!0,X.value=''}function le(){Q.value=!0,ee.value=''}async function de(){if(!X.value.trim())return void toastr.warning('请先输入 XML 代码');if(!S.value.api_endpoint||!S.value.api_key)return void toastr.error('⚠️ API 未配置！请点击右上角"⚙️ 设置"检查 API 配置','',{timeOut:0,extendedTimeOut:0,closeButton:!0});const e=C.createTask('ui_generate','AI解析XML生成字段');F.value=X.value,K.value=!0,U.value=!0;try{J.value?.setProgress(10),J.value?.setMessage('正在准备解析 XML...'),J.value?.addDetail(`XML 长度: ${X.value.length} 字符`),C.updateTaskProgress(e,10,'准备解析XML');const t='你是一个专业的 XML 解析助手。用户会给你一个 XML 格式的状态栏代码，你需要：\n\n1. **识别所有标签**：提取所有的 XML 标签名（如 <i>、<2i>、<日期>、<角色生理状态> 等）\n2. **分析标签含义**：\n   - 如果标签名是 <i>、<2i>、<3i> 等，这表示缩进层级，标签内容才是实际字段名\n   - 如果标签名是中文或英文名称（如 <日期>、<角色生理状态>），这本身就是字段名\n3. **生成字段配置**：为每个字段生成 name、label、icon（可选）\n\n请**严格按照以下 JSON 格式**输出，不要添加任何其他文字：\n\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]\n\n**重要规则**：\n- name 应该是简洁的英文或拼音（如 date, location, status）\n- label 应该是中文描述（如 日期、地点、角色生理状态）\n- icon 可以留空，或者根据字段含义选择合适的 Font Awesome 图标\n- 输出**必须**是有效的 JSON 数组格式\n- **禁止**输出任何解释性文字，只输出 JSON\n\n示例输入：\n<state_bar>\n<i>【内容】</i>\n<日期>【当前日期】</日期>\n<角色生理状态>【描述角色当前生理状态】</角色生理状态>\n</state_bar>\n\n示例输出：\n[\n  { "name": "content", "label": "内容", "icon": "" },\n  { "name": "date", "label": "日期", "icon": "fa-solid fa-calendar" },\n  { "name": "physical_status", "label": "角色生理状态", "icon": "fa-solid fa-heart-pulse" }\n]',a=`请解析以下 XML 状态栏代码，生成字段配置：\n\n\`\`\`xml\n${X.value.trim()}\n\`\`\`\n\n请严格按照 JSON 格式输出，不要添加任何解释。`;console.log('🤖 开始 AI 解析 XML...'),console.log('📍 使用 API:',S.value.api_endpoint),console.log('🤖 使用模型:',S.value.model),J.value?.setProgress(20),J.value?.setMessage('正在发送 XML 到 AI 服务器...'),C.updateTaskProgress(e,20,'发送XML到AI');const o=M(S.value.api_endpoint);console.log('🔗 规范化后的端点:',o),J.value?.setProgress(30),J.value?.setMessage('等待 AI 解析 XML 结构...'),C.updateTaskProgress(e,40,`调用AI (${S.value.model})`);const r=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],max_tokens:2e3,temperature:.7})});if(!r.ok){const e=await r.text();throw new Error(`API请求失败: ${r.status} ${r.statusText}\n${e}`)}const s=await r.json();if(console.log('✅ AI 完整响应:',s),!s.choices||!s.choices[0]||!s.choices[0].message)throw new Error('AI响应格式错误');const i=s.choices[0].message.content;if(console.log('✅ AI 原始返回:',i),!i||'string'!=typeof i)throw new Error('AI 未返回有效内容');let l=i.trim();l=l.replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const d=l.match(/\[\s*{[\s\S]*}\s*\]/);let c;d&&(l=d[0]);try{c=JSON.parse(l)}catch(n){throw new Error(`AI 返回的不是有效的 JSON 格式\n\n请检查 AI 配置，或者手动添加字段。\n\n原始返回（前200字符）:\n${s.slice(0,200)}`)}if(!Array.isArray(c))throw new Error('AI 返回的不是有效的数组格式');const p=c.filter(e=>e.name&&e.label);if(0===p.length)throw new Error('未能从 AI 返回中解析出有效的字段');P.value.fields=p.map(e=>({name:e.name||'',label:e.label||'',icon:e.icon||''})),J.value?.setProgress(100),J.value?.setMessage('✅ 解析完成！'),J.value?.addDetail(`成功解析 ${p.length} 个字段`),C.completeTask(e,{fieldCount:p.length}),setTimeout(()=>{U.value=!1,q.value=!1,X.value='',toastr.success(`成功解析 ${p.length} 个字段！`)},800)}catch(t){console.error('❌ XML 解析失败:',t),U.value=!1;const n=t.message||'未知错误';C.failTask(e,n),n.includes('API请求失败')||n.includes('403')||n.includes('401')||n.includes('Unauthorized')?toastr.error('⚠️ API 请求失败！请检查：\n1. API 密钥是否有效\n2. 模型名称是否正确\n3. 账户余额是否充足','',{timeOut:0,extendedTimeOut:0,closeButton:!0}):toastr.error(`解析失败: ${n}`,'',{timeOut:8e3,closeButton:!0})}finally{K.value=!1}}async function ce(e){if(F.value){Y.value=!0,U.value=!0;try{J.value?.setProgress(20),J.value?.setMessage('正在准备修改字段配置...'),J.value?.addDetail(`修改指令: ${e}`);const n='你是一个专业的 XML 解析助手。根据用户的原始 XML 和修改建议，重新解析并生成字段配置。',t=`# 原始 XML：\n${F.value}\n\n# 修改建议：\n${e}\n\n请根据原始 XML 和修改建议，重新生成字段配置。\n输出格式要求（JSON 数组）：\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]`;J.value?.setProgress(40),J.value?.setMessage('正在调用 AI 修改...');const a=M(S.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],max_tokens:2e3,temperature:.7})});if(!o.ok)throw new Error(`API 错误: ${o.statusText}`);J.value?.setProgress(70),J.value?.setMessage('正在接收 AI 响应...');const r=await o.json(),s=r.choices[0]?.message?.content||'';J.value?.setProgress(85),J.value?.setMessage('正在解析字段配置...');let i=s.trim().replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const l=i.match(/\[\s*{[\s\S]*}\s*\]/);l&&(i=l[0]);const d=JSON.parse(i);if(!Array.isArray(d))throw new Error('AI 返回的不是有效的数组格式');P.value.fields=d.map(e=>({name:e.name||'',label:e.label||e.name||'',icon:e.icon||''})),F.value+=`\n\n【已应用的修改】：${e}`,J.value?.setProgress(100),J.value?.setMessage('✅ 修改完成！'),J.value?.addDetail(`已更新 ${d.length} 个字段`),setTimeout(()=>{U.value=!1,B.value=!1,window.toastr.success('✅ AI 修改完成！')},800)}catch(n){console.error('AI 修改失败:',n),U.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{Y.value=!1}}else window.toastr.warning('请先解析 XML')}async function pe(){if(!ee.value.trim())return void toastr.warning('请先描述你想要的状态栏');if(!S.value.api_endpoint||!S.value.api_key)return void toastr.error('⚠️ API 未配置！请点击右上角"⚙️ 设置"检查 API 配置','',{timeOut:0,extendedTimeOut:0,closeButton:!0});const e=C.createTask('ui_generate','AI智能生成字段');Z.value=ee.value,ne.value=!0,U.value=!0;try{J.value?.setProgress(10),J.value?.setMessage('正在准备智能生成...'),J.value?.addDetail('AI 正在分析你的需求'),C.updateTaskProgress(e,10,'准备智能生成');const t='你是一个专业的状态栏字段设计助手。用户会用自然语言描述他们想要的状态栏，你需要：\n\n1. **理解用户需求**：分析用户描述的场景、类型（如修仙、现代、ABO等）\n2. **设计合理的字段**：根据场景设计完整、实用的字段\n3. **生成字段配置**：为每个字段生成 name、label、icon\n\n请**严格按照以下 JSON 格式**输出，不要添加任何其他文字：\n\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "fa-solid fa-xxx" }\n]\n\n**重要规则**：\n- name 应该是简洁的英文或拼音（如 realm, spiritual_power, location）\n- label 应该是中文描述（如 境界、灵力、位置）\n- icon 必须选择合适的 Font Awesome 图标（如 fa-solid fa-star, fa-solid fa-bolt）\n- 输出**必须**是有效的 JSON 数组格式\n- **禁止**输出任何解释性文字，只输出 JSON\n\n常用图标参考：\n- 人物：fa-solid fa-user, fa-solid fa-user-ninja, fa-solid fa-user-secret\n- 状态：fa-solid fa-heart, fa-solid fa-heart-pulse, fa-solid fa-star\n- 位置：fa-solid fa-location-dot, fa-solid fa-map-marker\n- 时间：fa-solid fa-clock, fa-solid fa-calendar\n- 能量：fa-solid fa-bolt, fa-solid fa-fire, fa-solid fa-droplet\n- 物品：fa-solid fa-book, fa-solid fa-wand-magic-sparkles, fa-solid fa-scroll\n- 情感：fa-solid fa-heart, fa-solid fa-face-smile, fa-solid fa-face-sad-tear\n\n示例：\n用户："帮我生成一个修仙游戏的状态栏"\n输出：\n[\n  { "name": "name", "label": "姓名", "icon": "fa-solid fa-user-ninja" },\n  { "name": "realm", "label": "境界", "icon": "fa-solid fa-star" },\n  { "name": "spiritual_power", "label": "灵力", "icon": "fa-solid fa-bolt" },\n  { "name": "cultivation_method", "label": "功法", "icon": "fa-solid fa-scroll" },\n  { "name": "location", "label": "位置", "icon": "fa-solid fa-location-dot" },\n  { "name": "status", "label": "状态", "icon": "fa-solid fa-heart-pulse" }\n]',a=`请根据以下描述，生成状态栏字段配置：\n\n${ee.value.trim()}\n\n请严格按照 JSON 格式输出，不要添加任何解释。`;console.log('🤖 开始 AI 智能生成字段...'),console.log('📍 使用 API:',S.value.api_endpoint),console.log('🤖 使用模型:',S.value.model),J.value?.setProgress(20),J.value?.setMessage('正在发送需求到 AI...'),C.updateTaskProgress(e,20,'发送需求到AI');const o=M(S.value.api_endpoint);console.log('🔗 规范化后的端点:',o),J.value?.setProgress(30),J.value?.setMessage('等待 AI 设计字段...'),C.updateTaskProgress(e,40,`调用AI (${S.value.model})`);const r=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],max_tokens:3e3,temperature:.8})});if(!r.ok){const e=await r.text();throw new Error(`API请求失败: ${r.status} ${r.statusText}\n${e}`)}const s=await r.json();if(console.log('✅ AI 完整响应:',s),!s.choices||!s.choices[0]||!s.choices[0].message)throw new Error('AI响应格式错误');const i=s.choices[0].message.content;if(console.log('✅ AI 原始返回:',i),!i||'string'!=typeof i)throw new Error('AI 未返回有效内容');let l=i.trim();l=l.replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const d=l.match(/\[\s*{[\s\S]*}\s*\]/);let c;d&&(l=d[0]);try{c=JSON.parse(l)}catch(n){throw new Error(`AI 返回的不是有效的 JSON 格式\n\n请检查 AI 配置，或者手动添加字段。\n\n原始返回（前200字符）:\n${i.slice(0,200)}`)}if(!Array.isArray(c))throw new Error('AI 返回的不是有效的数组格式');const p=c.filter(e=>e.name&&e.label);if(0===p.length)throw new Error('未能从 AI 返回中解析出有效的字段');P.value.fields=p.map(e=>({name:e.name||'',label:e.label||'',icon:e.icon||''})),J.value?.setProgress(100),J.value?.setMessage('✅ 生成完成！'),J.value?.addDetail(`成功生成 ${p.length} 个字段`),C.completeTask(e,{fieldCount:p.length}),setTimeout(()=>{U.value=!1,Q.value=!1,ee.value='',toastr.success(`成功生成 ${p.length} 个字段！`)},800)}catch(t){console.error('❌ AI 生成字段失败:',t),U.value=!1;const n=t.message||'未知错误';C.failTask(e,n),n.includes('API请求失败')||n.includes('403')||n.includes('401')||n.includes('Unauthorized')?toastr.error('⚠️ API 请求失败！请检查：\n1. API 密钥是否有效\n2. 模型名称是否正确\n3. 账户余额是否充足','',{timeOut:0,extendedTimeOut:0,closeButton:!0}):toastr.error(`生成失败: ${n}`,'',{timeOut:8e3,closeButton:!0})}finally{ne.value=!1}}async function ue(e){if(Z.value){W.value=!0,U.value=!0;try{J.value?.setProgress(20),J.value?.setMessage('正在准备修改字段配置...'),J.value?.addDetail(`修改指令: ${e}`);const n='你是一个专业的状态栏字段设计助手。根据用户的原始描述和修改建议，重新生成字段配置。',t=`# 原始描述：\n${Z.value}\n\n# 修改建议：\n${e}\n\n请根据原始描述和修改建议，重新生成字段配置。\n输出格式要求（JSON 数组）：\n[\n  { "name": "字段名1", "label": "字段说明1", "icon": "fa-solid fa-xxx" },\n  { "name": "字段名2", "label": "字段说明2", "icon": "" }\n]`;J.value?.setProgress(40),J.value?.setMessage('正在调用 AI 修改...');const a=M(S.value.api_endpoint),o=await fetch(a,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:n},{role:'user',content:t}],max_tokens:2e3,temperature:.7})});if(!o.ok)throw new Error(`API 错误: ${o.statusText}`);J.value?.setProgress(70),J.value?.setMessage('正在接收 AI 响应...');const r=await o.json(),s=r.choices[0]?.message?.content||'';J.value?.setProgress(85),J.value?.setMessage('正在解析字段配置...');let i=s.trim().replace(/^```(?:json)?\s*\n?/i,'').replace(/\n?```\s*$/i,'');const l=i.match(/\[\s*{[\s\S]*}\s*\]/);l&&(i=l[0]);const d=JSON.parse(i);if(!Array.isArray(d))throw new Error('AI 返回的不是有效的数组格式');P.value.fields=d.map(e=>({name:e.name||'',label:e.label||e.name||'',icon:e.icon||''})),Z.value+=`\n\n【已应用的修改】：${e}`,J.value?.setProgress(100),J.value?.setMessage('✅ 修改完成！'),J.value?.addDetail(`已更新 ${d.length} 个字段`),setTimeout(()=>{U.value=!1,G.value=!1,window.toastr.success('✅ AI 修改完成！')},800)}catch(n){console.error('AI 修改失败:',n),U.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{W.value=!1}}else window.toastr.warning('请先生成字段')}function ge(){const e=P.value.fields,n=e.length;if(0===n)return P.value.findRegex='<-CHARACTER_STATUS->',void console.log('⚠️ 没有字段，使用默认标记');if(n<=4)P.value.findRegex=`<-CHARACTER_STATUS->[\\r\\n]*\\|${e.map(()=>'([^|]+)').join('\\|')}\\|[\\r\\n]*`,console.log('✅ 自动生成的 findRegex (单标记):',P.value.findRegex),console.log('📊 字段数量:',n);else{const t=n<=8?Math.ceil(n/2):4,a=Math.min(Math.ceil(n/2),n<=12?4:Math.ceil(n/3)),o=[];o.push('<-ENVIRONMENT_DATA->[\\r\\n]*');for(let n=0;n<a;n+=t){const r=Math.min(t,a-n);o.push('\\|'+e.slice(n,n+r).map(()=>'([^|]+)').join('\\|')+'\\|[\\r\\n]*')}o.push('<-CHARACTER_STATUS->[\\r\\n]*');for(let r=a;r<n;r+=t){const a=Math.min(t,n-r);o.push('\\|'+e.slice(r,r+a).map(()=>'([^|]+)').join('\\|')+'\\|[\\r\\n]*')}P.value.findRegex=o.join(''),console.log('✅ 自动生成的 findRegex (双标记):',P.value.findRegex),console.log('📊 字段数量:',n),console.log('📊 分配方案:',`第一个标记: ${a}个字段, 第二个标记: ${n-a}个字段, 每行: ${t}个`)}const t=e.map((e,n)=>`        <div class="status-field">\n          <div class="field-label">${e.icon?`<i class="${e.icon}"></i> `:''}${e.label||'字段'+(n+1)}</div>\n          <div class="field-value">$${n+1}</div>\n        </div>`).join('\n'),a=`<details>\n<summary> ${P.value.name} </summary>\n<div class="status-card">\n    <div class="status-header">\n        <span>📋</span>\n        <span>${P.value.name}</span>\n    </div>\n    <div class="status-content">\n        <div class="status-grid">\n${t}\n        </div>\n    </div>\n</div>\n</details>`,o=`// 状态栏交互脚本\n(function() {\n  // 等待内容渲染\n  setTimeout(function() {\n    console.log('${P.value.name} 已加载');\n\n    // 可以添加动画效果\n    if (typeof gsap !== 'undefined') {\n      gsap.from('.status-field', {\n        opacity: 0,\n        y: 20,\n        duration: 0.5,\n        stagger: 0.1,\n        ease: 'power2.out'\n      });\n\n      // 鼠标悬停效果\n      $('.status-field').hover(\n        function() {\n          gsap.to($(this), { scale: 1.05, duration: 0.2 });\n        },\n        function() {\n          gsap.to($(this), { scale: 1, duration: 0.2 });\n        }\n      );\n    }\n  }, 100);\n})();`;O.value[0].content=a,O.value[1].content='.status-card {\n    font-family: \'Microsoft YaHei\', sans-serif;\n    background: linear-gradient(145deg, #1e293b, #334155);\n    border-radius: 14px;\n    margin: 16px 0;\n    box-shadow: 0 8px 25px rgba(15, 23, 42, 0.4);\n    overflow: hidden;\n    border: 1px solid rgba(148, 163, 184, 0.2);\n    max-width: 600px;\n}\n\n.status-header {\n    background: linear-gradient(135deg, #0f172a, #1e293b);\n    color: #e2e8f0;\n    padding: 12px 20px;\n    font-size: 15px;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    border-bottom: 1px solid rgba(148, 163, 184, 0.15);\n}\n\n.status-content {\n    padding: 20px;\n    background: rgba(30, 41, 59, 0.5);\n}\n\n.status-grid {\n    display: grid;\n    grid-template-columns: repeat(2, 1fr);\n    gap: 16px;\n}\n\n.status-field {\n    background: rgba(30, 41, 59, 0.8);\n    padding: 16px;\n    border-radius: 10px;\n    border-left: 3px solid #6366f1;\n}\n\n.field-label {\n    font-size: 11px;\n    color: #94a3b8;\n    margin-bottom: 8px;\n    font-weight: 600;\n    text-transform: uppercase;\n}\n\n.field-value {\n    font-size: 14px;\n    color: #e2e8f0;\n    line-height: 1.5;\n    font-weight: 600;\n}',O.value[2].content=o,j.value=O.value[0],window.toastr.success('✅ 模板已生成！')}function fe(){R.value=!0,N.value=''}function me(){P.value.fields.push({name:`字段${P.value.fields.length+1}`,label:`字段${P.value.fields.length+1}`,icon:''})}async function xe(){if(!N.value.trim())return void window.toastr.error('请输入修改需求');const e=C.createTask('ui_generate','AI生成状态栏界面');D.value=N.value,U.value=!0;try{if(!S.value.api_endpoint||!S.value.api_key)return window.toastr.error('请先在设置页面配置 API 端点和 API Key'),U.value=!1,void C.failTask(e,'API未配置');J.value?.setProgress(10),J.value?.setMessage('正在准备 AI 请求...'),J.value?.addDetail(`字段数量: ${P.value.fields.length} 个`),J.value?.addDetail(`模型: ${S.value.model}`),C.updateTaskProgress(e,10,'准备AI请求');const n=O.value.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n'),t='你是一个专业的前端开发助手，专门为 SillyTavern 状态栏生成 HTML/CSS/JS 代码片段。\n\n【重要】最终代码会被嵌入到 Regex 脚本的 replaceString 字段中，用于替换 AI 输出的纯文本状态栏。\n【重要】这是**{{char}}（角色）的状态栏**，用于显示角色的状态信息，不是{{user}}（用户）的状态。\n\n可用环境：\n- Font Awesome 图标库（已加载）\n- jQuery ($) - 已全局可用\n- toastr（消息提示）- 已全局可用\n- gsap（动画库）- 已全局可用\n- lodash (_) - 已全局可用\n\n字段占位符规则：\n- 用 $1、$2、$3 等表示正则捕获的字段值\n- $1 代表第一个字段，$2 代表第二个字段，以此类推\n- 用户会明确告诉你每个占位符对应的字段名，你必须严格按照用户的字段配置来生成代码\n- **禁止**根据当前代码文件中的字段来推断，必须使用用户明确提供的字段列表\n\n输出格式（三个独立文件）：\nFILE_START: index.html\n<details>\n<summary> 状态栏标题 </summary>\n<div class="status-card">\n  \x3c!-- 使用 $1, $2, $3 等占位符，必须与用户提供的字段一一对应 --\x3e\n  <div class="field-value">$1</div>\n</div>\n</details>\nFILE_END\n\nFILE_START: style.css\n.status-card {\n  /* 完整样式 */\n}\nFILE_END\n\nFILE_START: script.js\n(function() {\n  // 立即执行函数，避免全局污染\n  // 可以直接使用 $ 和 document\n})();\nFILE_END\n\n【关键要求】：\n1. index.html 必须以 <details> 开头，以 </details> 结尾，不要 <!DOCTYPE> 和 <html> 标签\n2. FILE_START 和 FILE_END 之间直接写纯代码，**绝对禁止**添加代码块标记（\\`\\`\\`html、"""html 等）\n3. HTML 中使用的占位符（$1, $2, $3...）必须与用户提供的字段配置完全一致\n4. CSS 样式要完整、美观，使用现代设计\n5. JS 使用立即执行函数 (function() { ... })()，不需要 $(function() { ... })\n6. 代码会直接嵌入到聊天消息中，不需要考虑 DOM 加载时机\n7. **最重要**：如果用户提供的字段配置与当前代码文件中的字段不同，必须使用用户配置的字段，删除代码中不在用户配置列表里的字段',a=`# 【强制要求】字段配置（这是唯一的字段来源，禁止自行添加或删除字段）：\n${P.value.fields.map((e,n)=>`字段${n+1}：${e.label} (变量名: ${e.name}) - 占位符: $${n+1}${e.icon?` - 图标: ${e.icon}`:''}`).join('\n')}\n\n【⚠️ 重要】你的任务：\n1. HTML 中必须且只能包含上述 ${P.value.fields.length} 个字段\n2. 字段顺序必须严格按照：$1 = ${P.value.fields[0]?.label||'字段1'}, $2 = ${P.value.fields[1]?.label||'字段2'}${P.value.fields[2]?`, $3 = ${P.value.fields[2].label}`:''}${P.value.fields[3]?`, $4 = ${P.value.fields[3].label}`:''}${P.value.fields[4]?`, $5 = ${P.value.fields[4].label}`:''}\n3. 禁止添加任何额外的字段（如"姓名"、"性别"、"年龄"等，除非它们在上面的字段列表中）\n4. 禁止使用 $${P.value.fields.length+1} 及以上的占位符\n\n# 【重要说明】状态栏用途：\n这是**{{char}}（角色）的状态栏**，用于显示角色的状态信息（如时间、地点、着装、状态等），**不是{{user}}（用户）的状态**。\n状态栏会通过MVU Beta变量系统读取{{char}}的stat_data变量，显示在聊天消息中。\n\n# 触发正则：\n${P.value.findRegex}\n\n# 用户需求：\n${N.value}\n\n# 当前代码文件（仅供参考样式，字段必须按上面的配置）：\n${n}\n\n【输出要求】：\n1. 根据用户需求设计状态栏样式和布局\n2. 使用上述 ${P.value.fields.length} 个字段，每个占位符（$1, $2, $3...）必须出现在 HTML 中\n3. 可以美化样式、调整布局、添加动画效果\n4. 必须同时输出 index.html、style.css、script.js 三个文件\n5. 如果当前代码中有字段不在上述列表中，请删除它们`;J.value?.setProgress(20),J.value?.setMessage('正在发送请求到 AI 服务器...'),J.value?.addDetail(`API 端点: ${S.value.api_endpoint}`),C.updateTaskProgress(e,20,'发送请求到AI');const o=M(S.value.api_endpoint),r=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],temperature:S.value.temperature||.7,max_tokens:S.value.max_tokens||65500})});if(J.value?.setProgress(40),J.value?.setMessage('等待 AI 响应...'),J.value?.addDetail('这可能需要 10-30 秒，请耐心等待'),C.updateTaskProgress(e,50,`等待AI响应 (${S.value.model})`),!r.ok)throw new Error(`API 错误: ${r.statusText}`);const s=await r.json(),i=s.choices[0]?.message?.content||'';J.value?.setProgress(70),J.value?.setMessage('正在解析 AI 生成的代码...'),J.value?.addDetail(`收到响应，长度: ${i.length} 字符`),C.updateTaskProgress(e,70,'解析AI生成的代码');const l=/FILE_START:\s*([^\n]+)\n([\s\S]*?)(?=FILE_START:|FILE_END:|$)/g,d=[...i.matchAll(l)];if(0===d.length)throw new Error('AI 未返回任何文件修改');for(const e of d){const n=e[1].trim().replace(/^\.\//,'');let t=ye(n,e[2]);t.endsWith('FILE_END')&&(t=t.slice(0,-8).trim());const a=O.value.find(e=>e.path===n);a?a.content=t:'index.html'!==n&&'style.css'!==n&&'script.js'!==n||O.value.push({path:n,content:t})}O.value.forEach(e=>{e.path=e.path.replace(/^\.\//,'')});const c=new Map;O.value.forEach(e=>{c.set(e.path,e)}),O.value=Array.from(c.values()),J.value?.setProgress(90),J.value?.setMessage('正在更新预览界面...'),J.value?.addDetail(`已生成 ${d.length} 个文件`),C.updateTaskProgress(e,90,'更新预览界面');const p=O.value.find(e=>'index.html'===e.path)||O.value[0];j.value=p,J.value?.setProgress(100),J.value?.setMessage('✅ AI 生成完成！'),C.completeTask(e,{fileCount:d.length}),setTimeout(()=>{U.value=!1,R.value=!1,window.toastr.success('✅ AI 生成完成！')},800)}catch(n){console.error('AI 生成失败:',n),U.value=!1,C.failTask(e,n.message),window.toastr.error('AI 生成失败: '+n.message)}}async function be(e){if(D.value){H.value=!0,U.value=!0;try{J.value?.setProgress(10),J.value?.setMessage('正在准备 AI 修改请求...'),J.value?.addDetail(`修改指令: ${e}`);const n=O.value.map(e=>`=== ${e.path} ===\n${e.content}`).join('\n\n'),t='你是一个专业的前端开发助手，专门为 SillyTavern 状态栏生成 HTML/CSS/JS 代码片段。\n\n【关键要求】：\n1. **必须同时输出 index.html、style.css、script.js 三个文件**\n2. 即使用户只提到修改样式，你也必须完整输出所有三个文件\n3. 不要只修改一个文件就停止，一定要输出完整的三个文件\n4. 使用 FILE_START 和 FILE_END 格式严格标记每个文件\n\n请根据用户的原始需求和修改建议，**完整地**重新生成所有代码文件。',a=`# 原始需求：\n${D.value}\n\n# 修改建议：\n${e}\n\n# 字段配置（必须严格遵守）：\n${P.value.fields.map((e,n)=>`字段${n+1}：${e.label} (变量名: ${e.name}) - 占位符: $${n+1}${e.icon?` - 图标: ${e.icon}`:''}`).join('\n')}\n\n# 当前代码（作为修改基础）：\n${n}\n\n【⚠️ 重要】请根据修改建议，**完整地输出以下三个文件**：\n\nFILE_START: index.html\n<details>\n  \x3c!-- 完整的 HTML，必须使用 $1, $2, $3 等占位符 --\x3e\n</details>\nFILE_END\n\nFILE_START: style.css\n/* 完整的 CSS 样式 */\nFILE_END\n\nFILE_START: script.js\n(function() {\n  // 完整的 JS 代码\n})();\nFILE_END\n\n**不要遗漏任何文件**，即使某个文件没有修改也要完整输出！`;J.value?.setProgress(20),J.value?.setMessage('正在发送修改请求到 AI 服务器...'),J.value?.addDetail(`当前文件数: ${O.value.length} 个`);const o=M(S.value.api_endpoint);J.value?.setProgress(30),J.value?.setMessage('等待 AI 修改代码...'),J.value?.addDetail('这可能需要 10-30 秒，请耐心等待');const r=await fetch(o,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${S.value.api_key}`},body:JSON.stringify({model:S.value.model,messages:[{role:'system',content:t},{role:'user',content:a}],temperature:.7,max_tokens:65500})});if(!r.ok)throw new Error(`API 错误: ${r.statusText}`);J.value?.setProgress(60),J.value?.setMessage('正在接收 AI 响应...');const s=await r.json(),i=s.choices[0]?.message?.content||'';J.value?.setProgress(80),J.value?.setMessage('正在解析修改后的代码...'),J.value?.addDetail(`响应长度: ${i.length} 字符`);const l=/FILE_START:\s*([^\n]+)\n([\s\S]*?)(?=FILE_START:|FILE_END:|$)/g,d=[...i.matchAll(l)];if(0===d.length)throw new Error('AI 未返回任何文件修改。请尝试更明确的修改指令。');J.value?.addDetail(`解析到 ${d.length} 个文件`);const c=d.map(e=>e[1].trim().replace(/^\.\//,'')),p=['index.html','style.css','script.js'].filter(e=>!c.includes(e));if(p.length>0&&(J.value?.addDetail(`⚠️ 警告: AI 未生成以下文件: ${p.join(', ')}`),window.toastr.warning(`AI 可能只生成了部分文件，缺少: ${p.join(', ')}`,'',{timeOut:5e3})),d.length>0)for(const e of d){const n=e[1].trim().replace(/^\.\//,'');let t=ye(n,e[2]);t.endsWith('FILE_END')&&(t=t.slice(0,-8).trim());const a=O.value.find(e=>e.path===n);a&&(a.content=t,J.value?.addDetail(`✓ 已更新: ${n}`))}J.value?.setProgress(95),J.value?.setMessage('正在更新预览...'),D.value+=`\n\n【已应用的修改】：${e}`,J.value?.setProgress(100),J.value?.setMessage('✅ AI 修改完成！'),setTimeout(()=>{U.value=!1,L.value=!1,window.toastr.success(`✅ AI 修改完成！已更新 ${d.length} 个文件`)},800)}catch(n){console.error('AI 修改失败:',n),U.value=!1,window.toastr.error('AI 修改失败: '+n.message)}finally{H.value=!1}}else window.toastr.warning('请先生成内容')}async function he(){await A(ae.value,'✅ 世界书内容已复制到剪贴板！')}function ye(e,n){let t=n.trim();const a=t.match(/^```[a-zA-Z0-9]*\s*([\s\S]*?)\s*```$/);a&&(t=a[1].trim());const o=t.match(/^("""|''')[a-zA-Z0-9]*\s*([\s\S]*?)\s*\1$/);return o&&(t=o[2].trim()),t=t.replace(/^(```|"""|''')[a-zA-Z0-9]*\s*\n?/,''),t=t.replace(/\n?\s*(```|"""|''')$/,''),e.endsWith('.html')&&(t=t.replace(/<!DOCTYPE html>/i,e=>e.toUpperCase())),t}function ve(){const e=O.value.find(e=>'index.html'===e.path),n=O.value.find(e=>'style.css'===e.path),t=O.value.find(e=>'script.js'===e.path);if(!e||''===e.content.trim())return void window.toastr.error('请先生成或编辑状态栏代码');const a='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(e){const n=16*Math.random()|0;return('x'===e?n:3&n|8).toString(16)}),o='script',r='style',s=`${e.content.trim()}\n<${r}>\n${n?.content||''}\n</${r}>\n\n<${o}>\n${t?.content||''}\n</${o}>`;let i=P.value.findRegex;const l=(i.match(/\([^)]+\)/g)||[]).length,d=P.value.fields.length;0===l&&(i=`${i.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}[\\r\\n]*${Array(d).fill('\\|([^|]+)').join('')}\\|[\\r\\n]*`);const c=s.replace(/\r\n/g,'\n').replace(/\r/g,'\n'),p={id:a,scriptName:P.value.name,findRegex:i,replaceString:c,trimStrings:[],placement:[2],disabled:!1,markdownOnly:!0,promptOnly:!1,runOnEdit:!0,substituteRegex:0,minDepth:null,maxDepth:null},u=new Blob([JSON.stringify(p,null,2)],{type:'application/json'}),g=URL.createObjectURL(u),f=document.createElement('a');f.href=g,f.download=`regex-${P.value.name}.json`,f.click(),URL.revokeObjectURL(g),window.toastr.success('✅ 正则 JSON 已导出成功！')}return w(()=>{!function(){try{const n=T();if(!n)return void console.warn('script_id 为空，无法加载状态栏配置');const t=`${n}_statusbar_generator_config`,a=localStorage.getItem(t);if(a)try{const e=JSON.parse(a);P.value={...P.value,...e},console.log('✅ 已从 localStorage 加载保存的状态栏配置')}catch(e){console.error('解析状态栏配置失败:',e)}}catch(n){console.error('加载状态栏配置失败:',n)}}()}),t(()=>P.value,()=>{!function(){try{const e=T();if(!e)return void console.warn('script_id 为空，无法保存状态栏配置');const n=`${e}_statusbar_generator_config`;localStorage.setItem(n,JSON.stringify(P.value)),console.log('💾 状态栏配置已保存到 localStorage')}catch(e){console.error('保存状态栏配置失败:',e)}}()},{deep:!0}),(e,n)=>(r(),a('div',ad,[i('div',od,[n[32]||(n[32]=i('h3',{style:{margin:'0',color:'#fff','font-size':'16px !important','font-weight':'600',display:'flex','align-items':'center',gap:'12px','letter-spacing':'0.5px','text-shadow':'0 1px 2px rgba(0, 0, 0, 0.5)'}},[i('i',{class:'fa-solid fa-chart-bar',style:{color:'#4a9eff','font-size':'18px'}}),d(' 状态栏生成器 ')],-1)),i('div',rd,[i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>function(e){const n=E[e];n&&(P.value=JSON.parse(JSON.stringify(n)),window.toastr.success(`✅ 已加载"${n.name}"模板`))}('abo')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[29]||(n[29]=[i('i',{class:'fa-solid fa-magic',style:{'margin-right':'6px'}},null,-1),d(' 快速加载 ABO 模板 ',-1)])],32),i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:fe,onMouseenter:n[3]||(n[3]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[4]||(n[4]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[30]||(n[30]=[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能编辑 ',-1)])],32),i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)',border:'none','border-radius':'8px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},onClick:ve,onMouseenter:n[5]||(n[5]=e=>e.currentTarget.style.transform='translateY(-2px)'),onMouseleave:n[6]||(n[6]=e=>e.currentTarget.style.transform='translateY(0)')},[...n[31]||(n[31]=[i('i',{class:'fa-solid fa-download',style:{'margin-right':'6px'}},null,-1),d(' 导出正则 JSON ',-1)])],32)])]),i('div',sd,[i('div',id,[n[38]||(n[38]=i('h4',{style:{margin:'0 0 15px 0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-cog',style:{color:'#4a9eff'}}),d(' 字段配置 ')],-1)),i('div',ld,[n[33]||(n[33]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#c0c0c0','font-size':'12px','font-weight':'600'}},'触发正则',-1)),l(i('input',{'onUpdate:modelValue':n[7]||(n[7]=e=>P.value.findRegex=e),type:'text',placeholder:'<-CHARACTER_STATUS->',style:{width:'100%',padding:'8px 12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'12px'}},null,512),[[p,P.value.findRegex]])]),i('div',dd,[(r(!0),a(f,null,m(P.value.fields,(e,n)=>(r(),a('div',{key:n,style:{padding:'10px',background:'#1e1e1e','border-radius':'6px',border:'1px solid #3a3a3a'}},[i('div',cd,[i('span',pd,'字段 '+c(n+1),1),i('button',{disabled:P.value.fields.length<=1,style:g({padding:'4px 8px',background:'#ef4444',border:'none',borderRadius:'4px',color:'white',fontSize:'10px',cursor:'pointer',opacity:P.value.fields.length<=1?.4:1}),onClick:e=>function(e){P.value.fields.splice(e,1)}(n)},' 删除 ',12,ud)]),l(i('input',{'onUpdate:modelValue':n=>e.name=n,type:'text',placeholder:'字段名称',style:{width:'100%',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','margin-bottom':'6px'}},null,8,gd),[[p,e.name]]),l(i('input',{'onUpdate:modelValue':n=>e.label=n,type:'text',placeholder:'显示名称',style:{width:'100%',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','margin-bottom':'6px'}},null,8,fd),[[p,e.label]]),i('div',md,[l(i('input',{'onUpdate:modelValue':n=>e.icon=n,type:'text',placeholder:'图标类名（可选，如：fa-solid fa-user）',style:{flex:'1',padding:'6px 10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px','font-family':'monospace'}},null,8,xd),[[p,e.icon]]),i('button',{style:{padding:'6px 10px',background:'#3a3a3a',border:'1px solid #4a4a4a','border-radius':'4px',color:'#fff','font-size':'12px',cursor:'pointer','min-width':'36px'},title:'选择图标',onClick:e=>function(e){V.value=e}(n)},[e.icon?(r(),a('i',{key:0,class:x(e.icon)},null,2)):(r(),a('i',hd))],8,bd)])]))),128))]),i('button',{style:{width:'100%',padding:'8px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:se},[...n[34]||(n[34]=[i('i',{class:'fa-solid fa-plus',style:{'margin-right':'6px'}},null,-1),d(' 添加字段 ',-1)])]),i('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:ie},[...n[35]||(n[35]=[i('i',{class:'fa-solid fa-code',style:{'margin-right':'6px'}},null,-1),d(' AI 解析 XML 生成字段 ',-1)])]),i('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:le},[...n[36]||(n[36]=[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' AI 智能生成字段 ',-1)])]),i('button',{style:{width:'100%',padding:'8px','margin-top':'10px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:ge},[...n[37]||(n[37]=[i('i',{class:'fa-solid fa-sparkles',style:{'margin-right':'6px'}},null,-1),d(' 根据字段生成模板 ',-1)])])]),i('div',yd,[i('div',vd,[(r(!0),a(f,null,m(O.value,e=>(r(),a('div',{key:e.path,style:g({padding:'6px 14px',background:j.value?.path===e.path?'#4a9eff':'#1e1e1e',color:j.value?.path===e.path?'#fff':'#c0c0c0',borderRadius:'6px',fontSize:'12px',fontWeight:'600',cursor:'pointer',transition:'all 0.2s ease'}),onClick:n=>j.value=e},c(e.path),13,wd))),128))]),j.value?l((r(),a('textarea',{key:0,'onUpdate:modelValue':n[8]||(n[8]=e=>j.value.content=e),style:{flex:'1',width:'100%',padding:'12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'8px',color:'#e0e0e0','font-size':'13px','font-family':'\'Consolas\', \'Monaco\', monospace','line-height':'1.6',resize:'none','min-height':'400px'},onInput:re},null,544)),[[p,j.value.content]]):o('',!0)]),i('div',kd,[i('div',_d,[i('div',{style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'12px'}},[n[40]||(n[40]=i('h4',{style:{margin:'0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-book',style:{color:'#4a9eff'}}),d(' 世界书条目 ')],-1)),i('button',{style:{padding:'6px 12px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'12px','font-weight':'600',cursor:'pointer'},onClick:he},[...n[39]||(n[39]=[i('i',{class:'fa-solid fa-copy',style:{'margin-right':'4px'}},null,-1),d(' 复制 ',-1)])])]),i('div',Td,[i('pre',zd,c(ae.value),1)])]),i('div',Id,[n[41]||(n[41]=i('h4',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-eye',style:{color:'#4a9eff'}}),d(' 实时预览 ')],-1)),i('div',{style:{background:'#1e1e1e','border-radius':'8px',padding:'20px','min-height':'400px',border:'1px solid #3a3a3a',overflow:'auto'},innerHTML:oe.value},null,8,Sd)])])]),null!==V.value?(r(),a('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[13]||(n[13]=s(e=>V.value=null,['self']))},[i('div',Ad,[n[42]||(n[42]=i('h3',{style:{margin:'0 0 16px 0',color:'#fff','font-size':'15px','font-weight':'600'}},'选择图标',-1)),i('div',$d,[(r(),a(f,null,m(te,(e,t)=>i('div',{key:t,style:{padding:'14px',background:'#1e1e1e',borderRadius:'8px',cursor:'pointer',textAlign:'center',border:'1px solid #3a3a3a',transition:'all 0.2s ease',display:'flex',alignItems:'center',justifyContent:'center'},title:e,onClick:n=>function(e){null!==V.value&&(P.value.fields[V.value].icon=e,V.value=null)}(e),onMouseenter:n[9]||(n[9]=e=>{e.currentTarget.style.background='#3a3a3a',e.currentTarget.style.borderColor='#4a9eff',e.currentTarget.style.transform='scale(1.1)',e.currentTarget.style.boxShadow='0 4px 12px rgba(74, 158, 255, 0.3)'}),onMouseleave:n[10]||(n[10]=e=>{e.currentTarget.style.background='#1e1e1e',e.currentTarget.style.borderColor='#3a3a3a',e.currentTarget.style.transform='scale(1)',e.currentTarget.style.boxShadow='none'})},[i('i',{class:x(e),style:{'font-size':'20px',color:'#4a9eff'}},null,2)],40,Cd)),64))]),i('div',Ed,[i('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#fff','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[11]||(n[11]=e=>V.value=null)},' 取消 '),i('button',{style:{padding:'8px 16px',background:'#ef4444',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[12]||(n[12]=e=>{P.value.fields[V.value].icon='',V.value=null})},' 清除图标 ')])])])):o('',!0),R.value?(r(),a('div',{key:1,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.8)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[17]||(n[17]=s(e=>R.value=!1,['self']))},[i('div',Md,[n[48]||(n[48]=i('h3',{style:{margin:'0 0 16px 0',color:'#fff','font-size':'16px','font-weight':'600'}},'AI 智能编辑',-1)),i('div',Pd,[i('div',Od,[i('div',jd,[n[43]||(n[43]=i('i',{class:'fa-solid fa-cog',style:{color:'#60a5fa','font-size':'16px'}},null,-1)),i('div',Rd,' 字段配置（共 '+c(P.value.fields.length)+' 个） ',1)]),i('button',{style:{padding:'4px 10px',background:'rgba(16, 185, 129, 0.2)',border:'1px solid rgba(16, 185, 129, 0.4)','border-radius':'4px',color:'#10b981','font-size':'11px',cursor:'pointer'},onClick:me},[...n[44]||(n[44]=[i('i',{class:'fa-solid fa-plus'},null,-1),d(' 添加字段 ',-1)])])]),P.value.fields.length>0?(r(),a('div',Nd,[(r(!0),a(f,null,m(P.value.fields,(e,t)=>(r(),a('div',{key:t,style:{background:'rgba(15, 23, 42, 0.6)',border:'1px solid rgba(148, 163, 184, 0.15)','border-radius':'6px',padding:'8px 10px',display:'flex','align-items':'center',gap:'8px'}},[i('span',Dd,'字段'+c(t+1)+':',1),l(i('input',{'onUpdate:modelValue':n=>e.label=n,type:'text',placeholder:'显示名称',style:{flex:'1',padding:'4px 8px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px'}},null,8,Ld),[[p,e.label]]),l(i('input',{'onUpdate:modelValue':n=>e.name=n,type:'text',placeholder:'变量名',style:{flex:'1',padding:'4px 8px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0','font-size':'11px'}},null,8,Hd),[[p,e.name]]),e.icon?(r(),a('button',{key:0,style:{padding:'4px 8px',background:'rgba(139, 92, 246, 0.2)',border:'1px solid rgba(139, 92, 246, 0.3)','border-radius':'4px',color:'#a78bfa','font-size':'11px',cursor:'pointer','min-width':'30px'},title:'移除图标',onClick:n=>e.icon=''},[i('i',{class:x(e.icon)},null,2)],8,Vd)):o('',!0),i('button',{disabled:P.value.fields.length<=1,style:g([{padding:'4px 8px',background:'rgba(239, 68, 68, 0.2)',border:'1px solid rgba(239, 68, 68, 0.3)','border-radius':'4px',color:'#ef4444','font-size':'11px',cursor:'pointer'},{opacity:P.value.fields.length<=1?.4:1,cursor:P.value.fields.length<=1?'not-allowed':'pointer'}]),title:'删除字段',onClick:e=>{return n=t,void(P.value.fields.length<=1?window.toastr.warning('至少需要保留一个字段'):P.value.fields.splice(n,1));var n}},[...n[45]||(n[45]=[i('i',{class:'fa-solid fa-trash'},null,-1)])],12,Ud)]))),128))])):(r(),a('div',Jd,'⚠️ 暂无字段，请点击"添加字段"按钮'))]),l(i('textarea',{'onUpdate:modelValue':n[14]||(n[14]=e=>N.value=e),placeholder:'描述您想要的样式和效果，例如：\n• 保持现有样式，美化状态栏界面\n• 把背景色改成深蓝色渐变\n• 添加动画效果，让字段淡入显示\n• 使用卡片布局，每个字段独立显示\n\n⚠️ 注意：\n• AI 会基于上方配置的字段生成代码，不会改变字段数量和顺序\n• 代码会使用通用格式，可迁移到任何角色',style:{width:'100%',padding:'12px',background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px','min-height':'120px','margin-bottom':'16px',resize:'vertical'}},null,512),[[p,N.value]]),i('div',Fd,[i('button',{style:{padding:'8px 16px',background:'#3a3a3a',border:'none','border-radius':'6px',color:'#fff','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:n[15]||(n[15]=e=>R.value=!1)},' 取消 '),i('button',{style:{padding:'8px 16px',background:'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer'},onClick:xe},[...n[46]||(n[46]=[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1),d(' 生成 ',-1)])])]),D.value?(r(),a('div',Bd,[i('button',{style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px','font-weight':'600',cursor:'pointer'},disabled:H.value,onClick:n[16]||(n[16]=e=>L.value=!0)},[n[47]||(n[47]=i('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(H.value?'修改中...':'AI 修改'),1)],8,Yd)])):o('',!0)])])):o('',!0),k(Po,{show:L.value,'is-modifying':H.value,title:'AI 修改界面代码',description:'描述你想要修改的地方，AI 会在当前代码的基础上进行调整。',examples:['把背景色改成深蓝色渐变','添加动画效果，让字段淡入显示','使用卡片布局，每个字段独立显示','增加悬停效果'],onClose:n[18]||(n[18]=e=>L.value=!1),onConfirm:be},null,8,['show','is-modifying']),q.value?(r(),a('div',{key:2,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[22]||(n[22]=s(e=>q.value=!1,['self']))},[i('div',Zd,[n[52]||(n[52]=u('<h3 style="margin:0 0 16px 0;color:#f59e0b;font-size:18px;font-weight:600;" data-v-584dacc9><i class="fa-solid fa-robot" style="margin-right:8px;" data-v-584dacc9></i> AI 解析 XML 生成字段 </h3><div style="background:rgba(251, 191, 36, 0.1);border:1px solid rgba(251, 191, 36, 0.3);border-radius:6px;padding:12px;margin-bottom:16px;" data-v-584dacc9><p style="margin:0;color:#fbbf24;font-size:12px;line-height:1.6;" data-v-584dacc9><i class="fa-solid fa-circle-info" style="margin-right:6px;" data-v-584dacc9></i><strong data-v-584dacc9>温馨提示：</strong>此功能需要调用 AI，请确保已在右上角 <i class="fa-solid fa-cog" data-v-584dacc9></i> 设置中配置了有效的 API 密钥。 </p></div>',2)),i('div',Gd,[n[49]||(n[49]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'13px'}},' 粘贴 XML 状态栏代码： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[19]||(n[19]=e=>X.value=e),placeholder:'例如：\n<state_bar>\n<i>【内容】</i>\n<日期>【当前日期】</日期>\n<角色生理状态>【描述角色当前生理状态】</角色生理状态>\n</state_bar>',style:{width:'100%','min-height':'200px',padding:'12px',background:'#1a1a1a',border:'1px solid #404040','border-radius':'6px',color:'#e0e0e0','font-family':'\'Consolas\', \'Monaco\', monospace','font-size':'13px',resize:'vertical'}},null,512),[[p,X.value]])]),i('div',Wd,[i('button',{style:{padding:'10px 20px',background:'#404040',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer'},onClick:n[20]||(n[20]=e=>q.value=!1)},' 取消 '),i('button',{style:{padding:'10px 20px',background:'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer','margin-right':'10px'},disabled:!X.value.trim()||K.value,onClick:de},[n[50]||(n[50]=i('i',{class:'fa-solid fa-robot',style:{'margin-right':'6px'}},null,-1)),d(' '+c(K.value?'AI 解析中...':'开始解析'),1)],8,qd),F.value?(r(),a('button',{key:0,style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px',cursor:'pointer'},disabled:Y.value,onClick:n[21]||(n[21]=e=>B.value=!0)},[n[51]||(n[51]=i('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(Y.value?'修改中...':'AI 修改'),1)],8,Xd)):o('',!0)])])])):o('',!0),k(Po,{show:B.value,'is-modifying':Y.value,title:'AI 修改 XML 解析',description:'描述你想要修改的字段，AI 会在当前解析结果的基础上进行调整。',examples:['添加一个【身高】字段','删除【年龄】字段','把【位置】改成【所在地点】','增加3个用于描述外貌的字段'],onClose:n[23]||(n[23]=e=>B.value=!1),onConfirm:ce},null,8,['show','is-modifying']),Q.value?(r(),a('div',{key:3,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000'},onClick:n[27]||(n[27]=s(e=>Q.value=!1,['self']))},[i('div',Kd,[n[56]||(n[56]=u('<h3 style="margin:0 0 16px 0;color:#10b981;font-size:18px;font-weight:600;" data-v-584dacc9><i class="fa-solid fa-wand-magic-sparkles" style="margin-right:8px;" data-v-584dacc9></i> AI 智能生成字段 </h3><div style="background:rgba(16, 185, 129, 0.1);border:1px solid rgba(16, 185, 129, 0.3);border-radius:6px;padding:12px;margin-bottom:16px;" data-v-584dacc9><p style="margin:0;color:#10b981;font-size:12px;line-height:1.6;" data-v-584dacc9><i class="fa-solid fa-lightbulb" style="margin-right:6px;" data-v-584dacc9></i><strong data-v-584dacc9>使用说明：</strong>用自然语言描述你想要的状态栏，AI 会自动帮你生成字段配置！ </p></div>',2)),i('div',Qd,[n[53]||(n[53]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'13px'}},' 描述你想要的状态栏： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[24]||(n[24]=e=>ee.value=e),placeholder:'例如：\n帮我生成一个修仙游戏的状态栏，包含以下字段：\n- 角色姓名\n- 修炼境界\n- 灵力值\n- 当前功法\n- 所在位置\n- 角色状态（如受伤、中毒等）\n- 好感度',style:{width:'100%','min-height':'180px',padding:'12px',background:'#1a1a1a',border:'1px solid #404040','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','line-height':'1.6'}},null,512),[[p,ee.value]])]),i('div',ec,[i('button',{style:{padding:'10px 20px',background:'#404040',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer'},onClick:n[25]||(n[25]=e=>Q.value=!1)},' 取消 '),i('button',{style:{padding:'10px 20px',background:'linear-gradient(135deg, #10b981 0%, #059669 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px',cursor:'pointer','margin-right':'10px'},disabled:!ee.value.trim()||ne.value,onClick:pe},[n[54]||(n[54]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1)),d(' '+c(ne.value?'AI 生成中...':'开始生成'),1)],8,nc),Z.value?(r(),a('button',{key:0,style:{padding:'10px 20px',background:'#ffc107',border:'none','border-radius':'6px',color:'#000','font-size':'13px',cursor:'pointer'},disabled:W.value,onClick:n[26]||(n[26]=e=>G.value=!0)},[n[55]||(n[55]=i('i',{class:'fa-solid fa-edit',style:{'margin-right':'6px'}},null,-1)),d(' '+c(W.value?'修改中...':'AI 修改'),1)],8,tc)):o('',!0)])])])):o('',!0),k(Po,{show:G.value,'is-modifying':W.value,title:'AI 修改字段配置',description:'描述你想要修改的字段，AI 会在当前字段配置的基础上进行调整。',examples:['添加一个【身高】字段','删除第3个字段','把【好感度】改成【亲密度】','增加2个用于描述状态的字段'],onClose:n[28]||(n[28]=e=>G.value=!1),onConfirm:ue},null,8,['show','is-modifying']),k(Kr,{ref_key:'progressDialogRef',ref:J,show:U.value,title:'AI 正在处理'},null,8,['show'])]))}}),oc=xo(ac,[['__scopeId','data-v-584dacc9']]),rc={class:'summary-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},sc={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},ic={class:'header-actions',style:{display:'flex','align-items':'center',gap:'10px'}},lc={key:0,class:'count-badge',style:{background:'#4a9eff',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},dc={key:0,class:'history-list',style:{display:'flex','flex-direction':'column',gap:'15px','margin-top':'20px'}},cc=['onClick'],pc={class:'history-info',style:{display:'flex','align-items':'center',gap:'10px',flex:'1'}},uc={class:'history-number',style:{color:'#4a9eff','font-weight':'bold'}},gc={class:'history-range',style:{color:'#888','font-size':'12px'}},fc={class:'expand-icon',style:{color:'#888','font-size':'12px'}},mc={key:0,class:'history-content',style:{padding:'15px',background:'#2a2a2a','border-radius':'0 0 6px 6px'}},xc={class:'history-actions',style:{display:'flex',gap:'8px','margin-bottom':'12px','padding-bottom':'8px','border-bottom':'1px solid #3a3a3a'}},bc=['onClick'],hc=['onClick'],yc=['onClick'],vc={class:'history-text',style:{'font-family':'\'Courier New\', monospace','font-size':'13px','line-height':'1.6',color:'#e0e0e0','white-space':'pre-wrap','word-wrap':'break-word','user-select':'text',cursor:'text'}},wc={key:1,class:'empty-state',style:{'text-align':'center',padding:'40px 20px',color:'#888'}},kc=xo(e({__name:'SummaryTab',setup(e){const t=H(),s=n([]),l=n(new Map),p=()=>{try{s.value=t.getSummaryHistory(),console.log('已刷新总结历史，当前聊天记录数:',s.value.length)}catch(e){console.error('刷新总结历史失败:',e),s.value=[]}},u=e=>l.value.get(e)||!1,g=async()=>{console.log('刷新数据按钮被点击');try{await p(),window.toastr.success('数据已刷新')}catch(e){console.error('刷新数据失败:',e),window.toastr.error('刷新数据失败: '+e.message)}},x=async e=>new Promise(n=>{try{const t=window.parent.document,a=window.parent.document.body,o=t.createElement('textarea');o.value=e,o.style.cssText='\n        position: fixed;\n        left: -9999px;\n        top: -9999px;\n        opacity: 0;\n        pointer-events: none;\n        z-index: -1000;\n      ',o.setAttribute('readonly',''),a.appendChild(o),o.focus(),o.select(),o.setSelectionRange(0,e.length);const r=t.execCommand('copy');a.removeChild(o),n(r)}catch(t){console.error('父窗口复制失败:',t),n(!1)}}),b=async e=>new Promise(n=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='-9999px',t.style.opacity='0',t.style.pointerEvents='none',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const a=document.execCommand('copy');document.body.removeChild(t),n(a)}catch(t){console.error('execCommand 复制失败:',t),n(!1)}}),h=e=>{console.log('显示手动复制对话框，文本长度:',e.length);try{const n=window.parent.document,t=window.parent.document.body,a=n.getElementById('manual-copy-overlay');a&&t.removeChild(a);const o=n.createElement('div');o.id='manual-copy-overlay',o.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const r=n.createElement('div');r.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 900px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const s=n.createElement('div');s.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #4a9eff; text-align: center; font-size: 18px; font-weight: 600;">\n        📋 手动复制总结内容\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>操作步骤：</strong>\n        </p>\n        <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>点击下方文本框</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+A</kbd> 全选文本</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+C</kbd> 复制到剪贴板</li>\n          <li>点击"关闭"按钮或按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Esc</kbd> 关闭对话框</li>\n        </ol>\n      </div>\n    ';const i=n.createElement('textarea');i.value=e,i.style.cssText='\n      width: 100%;\n      height: 400px;\n      background: #1a1a1a;\n      border: 2px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      color: #e0e0e0;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 13px;\n      line-height: 1.5;\n      resize: vertical;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      outline: none;\n      margin-bottom: 20px;\n      box-sizing: border-box;\n    ';const l=n.createElement('div');l.style.cssText='\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n      align-items: center;\n    ';const d=n.createElement('button');d.textContent='关闭',d.style.cssText='\n      background: #4a9eff;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',d.onmouseover=()=>{d.style.background='#5ba8ff'},d.onmouseout=()=>{d.style.background='#4a9eff'};const c=n.createElement('button');c.textContent='尝试自动复制',c.style.cssText='\n      background: #28a745;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',c.onmouseover=()=>{c.style.background='#218838'},c.onmouseout=()=>{c.style.background='#28a745'},l.appendChild(c),l.appendChild(d),r.appendChild(s),r.appendChild(i),r.appendChild(l),o.appendChild(r),t.appendChild(o),d.onclick=()=>{console.log('关闭按钮被点击'),t.removeChild(o)},c.onclick=async()=>{console.log('尝试自动复制按钮被点击');try{i.focus(),i.select();document.execCommand('copy')?(window.toastr.success('自动复制成功！'),t.removeChild(o)):window.toastr.warning('自动复制失败，请手动复制')}catch(e){console.error('自动复制失败:',e),window.toastr.warning('自动复制失败，请手动复制')}},o.onclick=e=>{e.target===o&&(console.log('点击背景关闭'),t.removeChild(o))};const p=e=>{'Escape'===e.key&&(console.log('按ESC键关闭'),t.removeChild(o),n.removeEventListener('keydown',p))};n.addEventListener('keydown',p),setTimeout(()=>{console.log('自动选中文本'),i.focus(),i.select()},200),window.toastr.info('手动复制对话框已打开，请按照提示操作')}catch(n){console.error('创建手动复制对话框失败:',n),window.toastr.error('无法显示复制对话框，请检查浏览器权限')}},y=e=>{(async(e,n='内容已复制到剪贴板')=>{console.log('开始复制，文本长度:',e.length);try{if(window.parent&&window.parent!==window&&(console.log('检测到iframe环境，尝试在父窗口复制'),await x(e)))return console.log('父窗口复制成功'),void window.toastr.success(n);if(navigator.clipboard&&window.isSecureContext){console.log('使用现代 Clipboard API');try{return await navigator.clipboard.writeText(e),console.log('Clipboard API 复制成功'),void window.toastr.success(n)}catch(t){console.warn('Clipboard API 失败:',t)}}if(console.log('使用 execCommand 方法'),await b(e))return console.log('execCommand 复制成功'),void window.toastr.success(n);console.log('所有自动复制方法都失败，显示手动复制界面'),h(e)}catch(a){console.error('复制异常:',a),h(e)}})(e,'总结已复制到剪贴板')},v=async()=>{try{let t='未知角色';try{const e=getCharData('current');e&&e.name&&(t=e.name,t=t.replace(/[<>:"/\\|?*]/g,'_').trim())}catch(e){console.warn('获取角色信息失败:',e)}const a=`总结_${t}_${(new Date).toISOString().slice(0,10)}`;console.log('准备创建世界书:',a);if(getWorldbookNames().includes(a))return void window.toastr.warning(`世界书 "${a}" 已存在`);await createWorldbook(a,[]);try{await rebindChatWorldbook('current',a),window.toastr.success(`已创建总结世界书 "${a}" 并绑定到当前聊天`)}catch(n){console.warn('绑定到聊天失败:',n),window.toastr.success(`已创建总结世界书 "${a}"，请手动在聊天知识书中绑定`)}}catch(t){console.error('创建总结世界书失败:',t),window.toastr.error('创建总结世界书失败: '+t.message)}},w=async e=>new Promise(n=>{const t=$(`\n      <div style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        background: #2a2a2a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        padding: 20px;\n        z-index: 1000000;\n        min-width: 300px;\n      ">\n        <h3 style="margin: 0 0 15px 0; color: #e0e0e0;">选择世界书</h3>\n        <div style="margin-bottom: 15px;">\n          ${e.map(e=>`\n            <label style="display: block; margin: 5px 0; color: #e0e0e0;">\n              <input type="radio" name="worldbook" value="${e}" style="margin-right: 8px;">\n              ${e}\n            </label>\n          `).join('')}\n        </div>\n        <div style="text-align: right;">\n          <button id="cancelWorldbook" style="\n            background: #666;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            margin-right: 10px;\n            cursor: pointer;\n          ">取消</button>\n          <button id="confirmWorldbook" style="\n            background: #4a9eff;\n            color: white;\n            border: none;\n            padding: 8px 16px;\n            border-radius: 4px;\n            cursor: pointer;\n          ">确定</button>\n        </div>\n      </div>\n    `),a=$('\n      <div style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.5);\n        z-index: 999999;\n      "></div>\n    ');$('body').append(a).append(t),$('#cancelWorldbook').on('click',()=>{a.remove(),t.remove(),n(null)}),$('#confirmWorldbook').on('click',()=>{const e=$('input[name="worldbook"]:checked').val();a.remove(),t.remove(),n(e||null)}),$('input[name="worldbook"]:first').prop('checked',!0)}),k=()=>{try{const e=window.parent.document,n=window.parent.document.body,t=e.getElementById('debug-panel-overlay');t&&n.removeChild(t);const a=e.createElement('div');a.id='debug-panel-overlay',a.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const o=e.createElement('div');o.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #ffc107;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 800px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const r=e.createElement('div');r.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #ffc107; text-align: center; font-size: 18px; font-weight: 600;">\n        🐛 自动总结调试工具\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>调试功能：</strong>\n        </p>\n        <ul style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>测试自动总结流程</li>\n          <li>同步localStorage数据到酒馆助手变量</li>\n          <li>检查当前楼层状态</li>\n          <li>验证触发条件计算</li>\n        </ul>\n      </div>\n    ';const s=e.createElement('div');s.style.cssText='\n      display: grid;\n      grid-template-columns: 1fr 1fr;\n      gap: 12px;\n      margin-bottom: 20px;\n    ';[{id:'testComplete',text:'🧪 测试完整流程',color:'#4a9eff'},{id:'syncData',text:'🔄 同步数据',color:'#28a745'},{id:'checkFloor',text:'🔍 检查楼层',color:'#17a2b8'},{id:'testCalculation',text:'🧮 验证计算',color:'#6f42c1'},{id:'showStatus',text:'📊 显示状态',color:'#fd7e14'},{id:'resetStartId',text:'🔄 重置起始楼层',color:'#dc3545'}].forEach(n=>{const t=e.createElement('button');t.id=n.id,t.textContent=n.text,t.style.cssText=`\n        background: ${n.color};\n        color: white;\n        border: none;\n        padding: 12px 16px;\n        border-radius: 6px;\n        cursor: pointer;\n        font-size: 13px;\n        font-weight: 500;\n        transition: background 0.2s;\n      `,t.onmouseover=()=>{t.style.opacity='0.8'},t.onmouseout=()=>{t.style.opacity='1'},s.appendChild(t)});const i=e.createElement('div');i.id='debug-output',i.style.cssText='\n      background: #1a1a1a;\n      border: 1px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      height: 200px;\n      overflow-y: auto;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 12px;\n      color: #e0e0e0;\n      white-space: pre-wrap;\n      margin-bottom: 20px;\n    ',i.textContent='点击上方按钮开始调试...\n';const l=e.createElement('button');l.textContent='关闭',l.style.cssText='\n      background: #6c757d;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n      align-self: center;\n    ',o.appendChild(r),o.appendChild(s),o.appendChild(i),o.appendChild(l),a.appendChild(o),n.appendChild(a);const d=n=>{const t=e.getElementById('debug-output');t&&(t.textContent+=n+'\n',t.scrollTop=t.scrollHeight)};l.onclick=()=>{n.removeChild(a)},e.getElementById('testComplete')?.addEventListener('click',()=>{d('🧪 开始测试完整自动总结流程...');try{window.testCompleteAutoSummary?(window.testCompleteAutoSummary(),d('✅ 测试函数已执行，请查看控制台输出')):d('❌ 测试函数不可用')}catch(e){d('❌ 测试失败: '+e.message)}}),e.getElementById('syncData')?.addEventListener('click',()=>{d('🔄 开始同步数据...');try{window.syncAutoSummaryData?(window.syncAutoSummaryData(),d('✅ 同步函数已执行，请查看控制台输出')):d('❌ 同步函数不可用')}catch(e){d('❌ 同步失败: '+e.message)}}),e.getElementById('checkFloor')?.addEventListener('click',()=>{d('🔍 开始检查楼层...');try{window.checkCurrentFloor?(window.checkCurrentFloor(),d('✅ 楼层检查函数已执行，请查看控制台输出')):d('❌ 楼层检查函数不可用')}catch(e){d('❌ 楼层检查失败: '+e.message)}}),e.getElementById('testCalculation')?.addEventListener('click',()=>{d('🧮 开始验证计算...');try{window.testFloorCalculation?(window.testFloorCalculation(),d('✅ 计算验证函数已执行，请查看控制台输出')):d('❌ 计算验证函数不可用')}catch(e){d('❌ 计算验证失败: '+e.message)}}),e.getElementById('showStatus')?.addEventListener('click',()=>{d('📊 开始显示状态...');try{window.checkAutoSummaryStatus?(window.checkAutoSummaryStatus(),d('✅ 状态检查函数已执行，请查看控制台输出')):d('❌ 状态检查函数不可用')}catch(e){d('❌ 状态检查失败: '+e.message)}}),e.getElementById('resetStartId')?.addEventListener('click',()=>{d('🔄 开始重置起始楼层...');try{window.smartResetChat?(window.smartResetChat(),d('✅ 重置函数已执行，请查看控制台输出')):d('❌ 重置函数不可用')}catch(e){d('❌ 重置失败: '+e.message)}}),a.onclick=e=>{e.target===a&&n.removeChild(a)};const c=t=>{'Escape'===t.key&&(n.removeChild(a),e.removeEventListener('keydown',c))};e.addEventListener('keydown',c),window.toastr?.info('调试面板已打开')}catch(e){console.error('创建调试面板失败:',e),window.toastr?.error('无法显示调试面板，请检查浏览器权限')}};return p(),(e,n)=>(r(),a('div',rc,[i('div',sc,[n[3]||(n[3]=i('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},' 📝 历史总结记录 ',-1)),i('div',ic,[s.value.length>0?(r(),a('span',lc,c(s.value.length)+' 条记录',1)):o('',!0),i('button',{class:'mini-button refresh-button',style:{padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:g},[...n[0]||(n[0]=[i('i',{class:'fa-solid fa-refresh'},null,-1),d(' 刷新数据 ',-1)])]),i('button',{class:'mini-button create-worldbook-button',style:{padding:'6px 12px',background:'#51cf66',border:'1px solid #40c057','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:v},[...n[1]||(n[1]=[i('i',{class:'fa-solid fa-plus'},null,-1),d(' 创建总结世界书 ',-1)])]),i('button',{class:'mini-button debug-button',style:{padding:'6px 12px',background:'#ffc107',border:'1px solid #ffb300','border-radius':'4px',color:'#000',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center',gap:'6px'},onClick:k},[...n[2]||(n[2]=[i('i',{class:'fa-solid fa-bug'},null,-1),d(' 调试工具 ',-1)])])])]),s.value&&s.value.length>0?(r(),a('div',dc,[(r(!0),a(f,null,m(s.value,(e,t)=>(r(),a('div',{key:t,class:'history-item',style:{background:'#2a2a2a',border:'1px solid #444','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[i('div',{class:'history-header',style:{padding:'12px 15px',background:'#1a1a1a',display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','user-select':'none',transition:'background 0.2s','border-radius':'6px'},onClick:e=>(e=>{const n=l.value.get(e)||!1;l.value.set(e,!n)})(t)},[i('div',pc,[i('span',uc,'#'+c(t+1),1),i('span',gc,'楼层 '+c(e.start_id)+' - '+c(e.end_id),1)]),i('span',fc,c(u(t)?'▼':'▶'),1)],8,cc),u(t)?(r(),a('div',mc,[i('div',xc,[i('button',{class:'mini-button',style:{flex:'1',padding:'6px 12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'4px',color:'#e0e0e0',cursor:'pointer','font-size':'12px',transition:'background 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:n=>y(e.content)},[...n[4]||(n[4]=[i('i',{class:'fa-solid fa-copy'},null,-1),d(' 复制 ',-1)])],8,bc),i('button',{class:'mini-button worldbook-button',style:{flex:'1',padding:'6px 12px',background:'#4a9eff',border:'1px solid #5aaeff','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:n=>(async(e,n)=>{try{const t=getWorldbookNames();if(0===t.length)return void window.toastr.warning('没有可用的世界书，请先创建总结世界书');const a=1===t.length?t[0]:await w(t);if(!a)return;const o={name:`总结_${n+1}_${(new Date).toLocaleDateString()}`,enabled:!0,strategy:{type:'constant',keys:[],keys_secondary:{logic:'and_any',keys:[]},scan_depth:'same_as_global'},position:{type:'before_character_definition',role:'system',depth:1},content:e,comment:`自动生成的总结条目 - 楼层范围: ${s.value[n]?.start_id||'?'} - ${s.value[n]?.end_id||'?'}`,insertion_order:0,case_sensitive:!1,name_is_regex:!1,keys_are_regex:!1,selective_logic:'and',secondary_keys_logic:'and',activation_threshold:0,disabled:!1,order:0,group:'',local_id:0,depth_entries:[],depth_entries_all:!1,search_range:0,force_activation:!1,disable:!1,exclude_recursion:!1,hidden:!1,priority:0,comment_is_regex:!1,content_is_regex:!1,secondary_keys_are_regex:!1,keys_secondary_are_regex:!1,uid:Date.now()};await createWorldbookEntries(a,[o]),window.toastr.success(`总结已绑定到世界书: ${a}`)}catch(t){console.error('绑定到世界书失败:',t),window.toastr.error('绑定到世界书失败: '+t.message)}})(e.content,t)},[...n[5]||(n[5]=[i('i',{class:'fa-solid fa-book'},null,-1),d(' 绑定到世界书 ',-1)])],8,hc),i('button',{class:'mini-button delete-button',style:{flex:'1',padding:'6px 12px',background:'#ff6b6b',border:'1px solid #ff5252','border-radius':'4px',color:'white',cursor:'pointer','font-size':'12px',transition:'all 0.2s',display:'flex','align-items':'center','justify-content':'center',gap:'6px'},onClick:e=>(e=>{if(confirm('确定要删除这条总结吗？'))try{const n=O();if(!n)return void window.toastr.error('无法获取当前聊天信息');s.value.splice(e,1);const t=`${getScriptIdSafe()}_summary_history_${n}`;localStorage.setItem(t,JSON.stringify(s.value)),console.log('✅ 总结已删除并保存到 localStorage'),window.toastr.success('总结已删除')}catch(n){console.error('删除总结失败:',n),window.toastr.error('删除总结失败')}})(t)},[...n[6]||(n[6]=[i('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])],8,yc)]),i('div',vc,c(e.content),1)])):o('',!0)]))),128))])):(r(),a('div',wc,[...n[7]||(n[7]=[i('i',{class:'fa-solid fa-inbox',style:{'font-size':'48px','margin-bottom':'10px',opacity:'0.3'}},null,-1),i('p',{style:{margin:'10px 0','font-size':'16px'}},'还没有总结记录',-1),i('small',{style:{'font-size':'12px',color:'#666'}},'使用"设置"标签页手动创建总结',-1)])]))]))}}),[['__scopeId','data-v-a83452cc']]),_c={class:'table-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},Tc={class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'20px 25px !important','border-bottom':'1px solid #3a3a3a','margin-bottom':'5px'}},zc={key:0,class:'count-badge',style:{background:'#4a9eff',color:'white',padding:'4px 8px','border-radius':'12px','font-size':'12px'}},Ic={key:0,class:'history-list',style:{display:'flex','flex-direction':'column',gap:'15px','margin-top':'20px'}},Sc=['onClick'],Ac={class:'history-info',style:{display:'flex','align-items':'center',gap:'10px',flex:'1'}},$c={class:'history-number',style:{color:'#4a9eff','font-weight':'bold'}},Cc={class:'history-range',style:{color:'#888','font-size':'12px'}},Ec={class:'expand-icon',style:{color:'#888','font-size':'12px'}},Mc={key:0,class:'history-content',style:{padding:'15px',background:'#2a2a2a','border-radius':'0 0 6px 6px'}},Pc={class:'history-actions',style:{display:'flex',gap:'10px','margin-bottom':'12px','padding-bottom':'8px','border-bottom':'1px solid #3a3a3a','flex-wrap':'wrap'}},Oc=['onClick'],jc=['onClick'],Rc={class:'table-display',style:{'overflow-x':'auto','border-radius':'6px',border:'1px solid #3a3a3a'}},Nc={style:{width:'100%','border-collapse':'collapse',background:'#1a1a1a'}},Dc={style:{background:'#2a2a2a'}},Lc={key:1,class:'empty-state',style:{'text-align':'center',padding:'40px 20px',color:'#888'}},Hc=xo(e({__name:'TableTab',setup(e){const t=n([]),s=n(new Map),l=e=>s.value.get(e)||!1,p=async e=>new Promise(n=>{try{const t=window.parent.document,a=window.parent.document.body,o=t.createElement('textarea');o.value=e,o.style.cssText='\n        position: fixed;\n        left: -9999px;\n        top: -9999px;\n        opacity: 0;\n        pointer-events: none;\n        z-index: -1000;\n      ',o.setAttribute('readonly',''),a.appendChild(o),o.focus(),o.select(),o.setSelectionRange(0,e.length);const r=t.execCommand('copy');a.removeChild(o),n(r)}catch(t){console.error('父窗口复制失败:',t),n(!1)}}),u=async e=>new Promise(n=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='-9999px',t.style.opacity='0',t.style.pointerEvents='none',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,e.length);const a=document.execCommand('copy');document.body.removeChild(t),n(a)}catch(t){console.error('execCommand 复制失败:',t),n(!1)}}),g=e=>{console.log('显示手动复制对话框，文本长度:',e.length);try{const n=window.parent.document,t=window.parent.document.body,a=n.getElementById('manual-copy-overlay');a&&t.removeChild(a);const o=n.createElement('div');o.id='manual-copy-overlay',o.style.cssText='\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0, 0, 0, 0.95);\n      z-index: 999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, sans-serif;\n    ';const r=n.createElement('div');r.style.cssText='\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 16px;\n      padding: 25px;\n      max-width: 900px;\n      width: 95%;\n      max-height: 85vh;\n      display: flex;\n      flex-direction: column;\n      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    ';const s=n.createElement('div');s.innerHTML='\n      <h3 style="margin: 0 0 15px 0; color: #4a9eff; text-align: center; font-size: 18px; font-weight: 600;">\n        📋 手动复制表格内容\n      </h3>\n      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">\n        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">\n          <strong>操作步骤：</strong>\n        </p>\n        <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">\n          <li>点击下方文本框</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+A</kbd> 全选文本</li>\n          <li>按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+C</kbd> 复制到剪贴板</li>\n          <li>点击"关闭"按钮或按 <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Esc</kbd> 关闭对话框</li>\n        </ol>\n      </div>\n    ';const i=n.createElement('textarea');i.value=e,i.style.cssText='\n      width: 100%;\n      height: 400px;\n      background: #1a1a1a;\n      border: 2px solid #444;\n      border-radius: 6px;\n      padding: 15px;\n      color: #e0e0e0;\n      font-family: \'Courier New\', \'Consolas\', monospace;\n      font-size: 13px;\n      line-height: 1.5;\n      resize: vertical;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      outline: none;\n      margin-bottom: 20px;\n      box-sizing: border-box;\n    ';const l=n.createElement('div');l.style.cssText='\n      display: flex;\n      gap: 12px;\n      justify-content: center;\n      align-items: center;\n    ';const d=n.createElement('button');d.textContent='关闭',d.style.cssText='\n      background: #4a9eff;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',d.onmouseover=()=>{d.style.background='#5ba8ff'},d.onmouseout=()=>{d.style.background='#4a9eff'};const c=n.createElement('button');c.textContent='尝试自动复制',c.style.cssText='\n      background: #28a745;\n      color: white;\n      border: none;\n      padding: 12px 24px;\n      border-radius: 6px;\n      cursor: pointer;\n      font-size: 14px;\n      font-weight: 500;\n      transition: background 0.2s;\n    ',c.onmouseover=()=>{c.style.background='#218838'},c.onmouseout=()=>{c.style.background='#28a745'},l.appendChild(c),l.appendChild(d),r.appendChild(s),r.appendChild(i),r.appendChild(l),o.appendChild(r),t.appendChild(o),d.onclick=()=>{console.log('关闭按钮被点击'),t.removeChild(o)},c.onclick=async()=>{console.log('尝试自动复制按钮被点击');try{i.focus(),i.select();document.execCommand('copy')?(window.toastr.success('自动复制成功！'),t.removeChild(o)):window.toastr.warning('自动复制失败，请手动复制')}catch(e){console.error('自动复制失败:',e),window.toastr.warning('自动复制失败，请手动复制')}},o.onclick=e=>{e.target===o&&(console.log('点击背景关闭'),t.removeChild(o))};const p=e=>{'Escape'===e.key&&(console.log('按ESC键关闭'),t.removeChild(o),n.removeEventListener('keydown',p))};n.addEventListener('keydown',p),setTimeout(()=>{console.log('自动选中文本'),i.focus(),i.select()},200),window.toastr.info('手动复制对话框已打开，请按照提示操作')}catch(n){console.error('创建手动复制对话框失败:',n),window.toastr.error('无法显示复制对话框，请检查浏览器权限')}},x=e=>{try{(async(e,n='内容已复制到剪贴板')=>{console.log('开始复制，文本长度:',e.length);try{if(window.parent&&window.parent!==window&&(console.log('检测到iframe环境，尝试在父窗口复制'),await p(e)))return console.log('父窗口复制成功'),void window.toastr.success(n);if(navigator.clipboard&&window.isSecureContext){console.log('使用现代 Clipboard API');try{return await navigator.clipboard.writeText(e),console.log('Clipboard API 复制成功'),void window.toastr.success(n)}catch(t){console.warn('Clipboard API 失败:',t)}}if(console.log('使用 execCommand 方法'),await u(e))return console.log('execCommand 复制成功'),void window.toastr.success(n);console.log('所有自动复制方法都失败，显示手动复制界面'),g(e)}catch(a){console.error('复制异常:',a),g(e)}})([e.headers.join('\t'),...e.data.map(e=>e.join('\t'))].join('\n'),'表格已复制到剪贴板')}catch(n){console.error('复制表格失败:',n),window.toastr.error('复制失败，请手动复制')}};return(()=>{try{const e=O();if(!e)return console.warn('无法获取聊天ID，清空表格历史'),void(t.value=[]);const n=`${getScriptIdSafe()}_table_history_${e}`,a=localStorage.getItem(n);console.log('从 localStorage 读取表格历史，key:',n),t.value=a?JSON.parse(a):[],console.log('已刷新表格历史，当前聊天表格数:',t.value.length)}catch(e){console.error('刷新表格历史失败:',e),t.value=[]}})(),(e,n)=>(r(),a('div',_c,[i('div',Tc,[n[0]||(n[0]=i('h3',{style:{margin:'0',color:'#fff','font-size':'15px !important','font-weight':'bold',display:'flex','align-items':'center',gap:'8px'}},' 📊 表格分析 ',-1)),t.value.length>0?(r(),a('span',zc,c(t.value.length)+' 条记录',1)):o('',!0)]),t.value&&t.value.length>0?(r(),a('div',Ic,[(r(!0),a(f,null,m(t.value,(e,p)=>(r(),a('div',{key:p,class:'history-item',style:{background:'#2a2a2a',border:'1px solid #444','border-radius':'8px',padding:'15px',transition:'all 0.3s ease'}},[i('div',{class:'history-header',style:{padding:'12px 15px',background:'#1a1a1a',display:'flex','justify-content':'space-between','align-items':'center',cursor:'pointer','user-select':'none',transition:'background 0.2s','border-radius':'6px'},onClick:e=>(e=>{const n=s.value.get(e)||!1;s.value.set(e,!n)})(p)},[i('div',Ac,[i('span',$c,'#'+c(p+1),1),i('span',Cc,'楼层 '+c(e.start_id)+' - '+c(e.end_id),1)]),i('span',Ec,c(l(p)?'▼':'▶'),1)],8,Sc),l(p)?(r(),a('div',Mc,[i('div',Pc,[i('button',{class:'copy-button',style:{padding:'8px 16px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'6px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:n=>x(e)},[...n[1]||(n[1]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-copy',style:{'font-size':'12px'}},null,-1),d(' 复制 ',-1)])],8,Oc),i('button',{class:'delete-button',style:{padding:'8px 16px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)',border:'none','border-radius':'6px',color:'white',cursor:'pointer','font-size':'12px','font-weight':'600',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'6px','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:e=>(e=>{if(confirm('确定要删除这个表格吗？')){t.value.splice(e,1);const n=O();if(n){const e=`${getScriptIdSafe()}_table_history_${n}`;localStorage.setItem(e,JSON.stringify(t.value)),window.toastr.success('表格已删除')}}})(p)},[...n[2]||(n[2]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-trash',style:{'font-size':'12px'}},null,-1),d(' 删除 ',-1)])],8,jc)]),i('div',Rc,[i('table',Nc,[i('thead',Dc,[i('tr',null,[(r(!0),a(f,null,m(e.headers,(e,n)=>(r(),a('th',{key:n,style:{padding:'12px 16px','text-align':'left','font-weight':'bold',color:'#fff','border-bottom':'2px solid #3a3a3a','border-right':'1px solid #3a3a3a'}},c(e),1))),128))])]),i('tbody',null,[(r(!0),a(f,null,m(e.data,(e,n)=>(r(),a('tr',{key:n,style:{'border-bottom':'1px solid #3a3a3a'}},[(r(!0),a(f,null,m(e,(e,n)=>(r(),a('td',{key:n,style:{padding:'10px 16px',color:'#e0e0e0','border-right':'1px solid #3a3a3a'}},c(e),1))),128))]))),128))])])])])):o('',!0)]))),128))])):(r(),a('div',Lc,[...n[3]||(n[3]=[i('i',{class:'fa-solid fa-table',style:{'font-size':'48px','margin-bottom':'10px',opacity:'0.3'}},null,-1),i('p',{style:{margin:'10px 0','font-size':'16px'}},'还没有表格记录',-1),i('small',{style:{'font-size':'12px',color:'#666'}},'使用"设置"标签页手动生成表格',-1)])]))]))}}),[['__scopeId','data-v-642c0020']]);var Vc,Uc;var Jc=Uc?Vc:(Uc=1,Vc=_);const Fc={class:'tools-tab',style:{padding:'25px !important',background:'#1a1a1a !important'}},Bc={class:'tool-section'},Yc={key:0,class:'tool-content'},Zc={class:'form-group',style:{margin:'15px 0'}},Gc={class:'form-group',style:{margin:'15px 0'}},Wc={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},qc={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},Xc={class:'progress-bar',style:{width:'100%',height:'8px',background:'#2a2a2a','border-radius':'4px',overflow:'hidden',position:'relative'}},Kc={style:{'text-align':'center','margin-top':'8px',color:'#667eea','font-size':'12px','font-weight':'500'}},Qc={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},ep=['disabled'],np={key:1,class:'output-section'},tp={class:'output-content',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px',color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','max-height':'300px','overflow-y':'auto'}},ap={style:{'margin-top':'20px','padding-top':'20px','border-top':'1px solid #3a3a3a'}},op={class:'form-group',style:{'margin-bottom':'12px'}},rp={style:{display:'flex',gap:'10px'}},sp=['disabled'],ip=['disabled'],lp={class:'tool-section'},dp={key:0,class:'tool-content'},cp={class:'form-group',style:{margin:'15px 0'}},pp={class:'form-group',style:{margin:'15px 0'}},up={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},gp={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},fp={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(255, 193, 7, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},mp={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},xp={style:{color:'#ffc107','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #ffc107 0%, #ff9800 50%, #ffc107 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},bp={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},hp=['disabled'],yp={key:1,class:'output-section'},vp={class:'entry-preview',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px','margin-bottom':'15px'}},wp={class:'entry-field',style:{'margin-bottom':'10px'}},kp={style:{color:'#e0e0e0','font-size':'13px'}},_p={class:'entry-field',style:{'margin-bottom':'10px'}},Tp={style:{color:'#e0e0e0','font-size':'13px'}},zp={class:'entry-field',style:{'margin-bottom':'10px'}},Ip={style:{color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','max-height':'200px','overflow-y':'auto'}},Sp={class:'entry-field'},Ap={style:{color:'#e0e0e0','font-size':'13px'}},$p={class:'modify-section',style:{'margin-top':'25px','border-top':'2px dashed #3a3a3a','padding-top':'20px'}},Cp={class:'form-group',style:{margin:'15px 0'}},Ep={key:0,class:'progress-bar-container',style:{margin:'12px 0'}},Mp={class:'progress-bar',style:{width:'100%',height:'8px',background:'#2a2a2a','border-radius':'4px',overflow:'hidden',position:'relative'}},Pp={style:{'text-align':'center','margin-top':'8px',color:'#ffa500','font-size':'12px','font-weight':'500'}},Op={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'15px'}},jp=['disabled'],Rp={class:'insert-section',style:{background:'#1a1a1a',padding:'15px','border-radius':'6px','margin-top':'20px'}},Np={class:'form-group',style:{'margin-bottom':'12px'}},Dp=['value'],Lp={class:'output-actions',style:{display:'flex',gap:'12px'}},Hp=['disabled'],Vp={class:'tool-section'},Up={key:0,class:'tool-content'},Jp={class:'form-group',style:{'margin-bottom':'20px'}},Fp=['value'],Bp={key:0,class:'form-group',style:{'margin-bottom':'20px'}},Yp={key:1,style:{display:'flex',gap:'10px','margin-bottom':'15px'}},Zp={key:2,style:{'margin-bottom':'15px',color:'#888','font-size':'12px'}},Gp={key:0},Wp={key:1,style:{color:'#ff6b6b'}},qp={key:3,style:{display:'flex','flex-direction':'column',gap:'12px'}},Xp=['onClick'],Kp={style:{flex:'1','line-height':'1.6'}},Qp={style:{display:'flex','align-items':'center',gap:'6px','margin-bottom':'8px'}},eu={key:0,style:{'font-size':'14px'}},nu={key:1,style:{'font-size':'14px'}},tu={key:2,style:{'font-size':'14px'}},au={style:{color:'#fff','font-weight':'600','font-size':'14px'}},ou={style:{'padding-left':'20px','margin-bottom':'6px','font-size':'12px',color:'#ccc'}},ru={key:0},su={key:1},iu={key:2},lu={key:3},du={style:{'padding-left':'20px','font-size':'12px',color:'#999','font-style':'italic'}},cu={key:0,style:{'margin-top':'15px','padding-top':'15px','border-top':'1px solid #3a3a3a'}},pu={style:{'margin-bottom':'12px'}},uu={style:{display:'flex','align-items':'center',gap:'8px'}},gu={key:0,style:{padding:'4px 10px',background:'#4a9eff',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},fu={key:1,style:{padding:'4px 10px',background:'#28a745',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},mu={key:2,style:{padding:'4px 10px',background:'#888',color:'white','border-radius':'12px','font-size':'11px','font-weight':'bold'}},xu={style:{'margin-bottom':'12px'}},bu={style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},hu={key:0,style:{color:'#ffa500','font-size':'10px','margin-left':'6px'}},yu={style:{display:'flex','flex-wrap':'wrap',gap:'6px'}},vu={key:0,style:{color:'#888','font-size':'11px'}},wu={style:{'margin-bottom':'12px'}},ku={style:{padding:'12px',background:'#1a1a1a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#ccc','font-size':'12px','line-height':'1.6','max-height':'200px','overflow-y':'auto','white-space':'pre-wrap'}},_u={style:{display:'flex',gap:'10px','margin-top':'12px'}},Tu=['onClick'],zu=['onClick'],Iu={style:{background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',padding:'25px','max-width':'700px',width:'90%','max-height':'85vh','overflow-y':'auto','box-shadow':'0 10px 40px rgba(0, 0, 0, 0.5)'}},Su={style:{display:'flex','justify-content':'space-between','align-items':'center','margin-bottom':'20px'}},Au={style:{display:'flex','flex-direction':'column',gap:'15px'}},$u={style:{display:'flex','align-items':'center',gap:'10px'}},Cu=['value'],Eu=['value'],Mu=['value'],Pu={style:{display:'grid','grid-template-columns':'1fr 1fr',gap:'10px'}},Ou=['value'],ju=['value'],Ru={style:{background:'#1a1a1a',padding:'15px','border-radius':'8px',border:'1px solid rgba(255, 255, 255, 0.1)'}},Nu={style:{display:'flex','flex-direction':'column',gap:'10px'}},Du={style:{color:'#ccc','font-size':'13px',display:'flex','align-items':'center',gap:'10px',cursor:'pointer'}},Lu=['checked'],Hu={style:{color:'#ccc','font-size':'13px',display:'flex','align-items':'center',gap:'10px',cursor:'pointer'}},Vu=['checked'],Uu=['value'],Ju={style:{display:'flex',gap:'10px','margin-top':'20px','justify-content':'flex-end'}},Fu={class:'tool-section'},Bu={key:0,class:'tool-content'},Yu={class:'form-group',style:{margin:'15px 0'}},Zu={class:'form-group',style:{margin:'15px 0'}},Gu={style:{display:'flex','align-items':'center',gap:'8px',color:'#ccc','font-size':'13px',cursor:'pointer'}},Wu={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},qu={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(23, 162, 184, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},Xu={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},Ku={style:{color:'#17a2b8','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},Qu={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'20px'}},eg=['disabled'],ng={key:1,class:'output-section'},tg={class:'output-content',style:{background:'#1e1e1e',border:'1px solid #3a3a3a','border-radius':'6px',padding:'15px',color:'#e0e0e0','font-size':'13px','line-height':'1.6','white-space':'pre-wrap','word-wrap':'break-word','max-height':'300px','overflow-y':'auto'}},ag={class:'modify-section',style:{'margin-top':'25px','border-top':'2px dashed #3a3a3a','padding-top':'20px'}},og={class:'form-group',style:{margin:'15px 0'}},rg={key:0,class:'progress-bar-container',style:{margin:'15px 0'}},sg={class:'progress-bar',style:{position:'relative',width:'100%',height:'12px',background:'rgba(23, 162, 184, 0.1)','border-radius':'12px',overflow:'hidden','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'}},ig={style:{display:'flex','justify-content':'center','align-items':'center','margin-top':'12px',gap:'8px'}},lg={style:{color:'#17a2b8','font-size':'13px','font-weight':'600',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)','background-size':'200% auto','-webkit-background-clip':'text','-webkit-text-fill-color':'transparent','background-clip':'text',animation:'gradient-shift 2s linear infinite'}},dg={class:'button-group',style:{display:'flex',gap:'12px','margin-bottom':'15px'}},cg=['disabled'],pg=xo(e({__name:'ToolsTab',setup(e){const y=b(),{settings:k}=h(y),I=n(new Map),S=n(''),C=n(''),E=n(!1),P=n(!1),O=n(0),j=n(''),L=n(!1),H=n(''),U=n(''),J=n(!1),F=n(''),B=n(!1),Y=n(!1),Z=n(0),G=n(''),W=n(null),q=n(!1),X=n([]),K=n(''),Q=n(!1),ee=n(''),ne=n(!1),te=n(!1),ae=n(0),oe=n(''),re=n([]),se=n(''),ie=n('original'),le=n(new Map),de=n(!1),ce=n({}),pe=n(null),ue=n(!1),ge=()=>{if(ue.value)try{const e=T();if(!e)return void console.warn('⚠️ script_id 为空，无法保存数据');const n={tools_antiCliche:{input:S.value,output:C.value,enableStreaming:P.value,modifyRequest:j.value},tools_characterCard:{description:H.value,output:U.value,modifyRequest:F.value,enableStreaming:Y.value},tools_worldbookEntry:{description:G.value,output:W.value,selectedWorldbook:K.value,modifyRequest:ee.value,enableStreaming:te.value},tools_worldbookViewer:{selectedWorldbook:oe.value,searchQuery:se.value,sortBy:ie.value},tools_expandedState:Object.fromEntries(I.value)},t=`${e}_tools_data`;localStorage.setItem(t,JSON.stringify(n)),console.log('💾 工具数据已保存到 localStorage:',{antiCliche_input_length:S.value.length,antiCliche_output_length:C.value.length,character_desc_length:H.value.length,character_output_length:U.value.length})}catch(e){console.error('❌ 保存工具数据失败:',e)}else console.log('⏸️ 跳过保存：数据尚未加载完成')},fe=Jc.debounce(ge,300);t([S,C,P,j,H,U,F,Y,G,W,K,ee,te,oe,se,ie,I],()=>{ue.value&&(console.log('📝 数据变化，触发保存...'),fe())},{deep:!0}),w(()=>{console.log('🔧 ToolsTab 组件已挂载，加载数据...'),(()=>{try{ue.value=!1;const e=T();if(!e)return console.warn('⚠️ script_id 为空，无法加载数据'),void(ue.value=!0);const n=`${e}_tools_data`,t=localStorage.getItem(n),a=t?JSON.parse(t):{};console.log('📥 加载工具数据:',a),a.tools_antiCliche&&(S.value=a.tools_antiCliche.input||'',C.value=a.tools_antiCliche.output||'',P.value=a.tools_antiCliche.enableStreaming||!1,j.value=a.tools_antiCliche.modifyRequest||'',console.log('✅ 已恢复反八股数据:',{input:S.value.substring(0,50),output:C.value.substring(0,50),enableStreaming:P.value,modifyRequest:j.value.substring(0,30)})),a.tools_characterCard&&(H.value=a.tools_characterCard.description||'',U.value=a.tools_characterCard.output||'',F.value=a.tools_characterCard.modifyRequest||'',Y.value=a.tools_characterCard.enableStreaming||!1,console.log('✅ 已恢复角色卡数据:',{description:H.value.substring(0,50),output:U.value.substring(0,50),modifyRequest:F.value.substring(0,50),enableStreaming:Y.value})),a.tools_worldbookEntry&&(G.value=a.tools_worldbookEntry.description||'',W.value=a.tools_worldbookEntry.output||null,K.value=a.tools_worldbookEntry.selectedWorldbook||'',ee.value=a.tools_worldbookEntry.modifyRequest||'',te.value=a.tools_worldbookEntry.enableStreaming||!1,console.log('✅ 已恢复世界书条目数据:',{description:G.value.substring(0,50),output:W.value?'有输出':'无输出',selectedWorldbook:K.value,modifyRequest:ee.value.substring(0,50),enableStreaming:te.value})),a.tools_expandedState&&(I.value=new Map(Object.entries(a.tools_expandedState)),console.log('✅ 已恢复展开状态:',Object.fromEntries(I.value))),a.tools_worldbookViewer&&(oe.value=a.tools_worldbookViewer.selectedWorldbook||'',se.value=a.tools_worldbookViewer.searchQuery||'',ie.value=a.tools_worldbookViewer.sortBy||'original',console.log('✅ 已恢复世界书查看器数据:',{selectedWorldbook:oe.value,searchQuery:se.value,sortBy:ie.value}),oe.value&&(console.log('🔄 自动加载已选择的世界书条目...'),setTimeout(()=>{Oe()},200))),setTimeout(()=>{ue.value=!0,console.log('✅ 数据加载完成，启用自动保存')},100)}catch(e){console.error('❌ 加载工具数据失败:',e),ue.value=!0}})(),(()=>{try{void 0!==window.TavernHelper&&'function'==typeof window.TavernHelper.getWorldbookNames?(X.value=window.TavernHelper.getWorldbookNames(),console.log('✅ 已加载世界书列表 (TavernHelper):',X.value)):(X.value=[],console.warn('⚠️ TavernHelper 不可用，世界书功能受限'))}catch(e){console.error('❌ 加载世界书列表失败:',e),X.value=[]}})()}),R(()=>{console.log('🔄 ToolsTab 组件即将卸载，保存数据...'),fe.cancel(),ge()});const me=e=>{console.log('toggleToolExpanded 被调用，工具名称:',e);const n=I.value.get(e)||!1;console.log('当前展开状态:',n),I.value.set(e,!n),console.log('新的展开状态:',!n)},xe=e=>I.value.get(e)||!1,be=async()=>{if(S.value.trim())try{E.value=!0,O.value=0,window.toastr.info('AI正在分析文本...','反八股清理',{timeOut:15e3});const e={model:k.value.model,max_tokens:k.value.max_tokens||8e3,temperature:.7,stream:P.value,messages:[{role:'system',content:'你是专业的文本编辑助手，专注于清理角色卡/世界书/开场白中的AI文学腔和八股表述。\n\n# 🎯 第一原则（最重要！）\n\n## ⚠️ 信息量守恒定律\n**输入500字，输出也应该接近500字！信息量必须相同！**\n\n- ❌ 错误：把五段话压缩成两句话\n- ❌ 错误：删除整个句子或段落\n- ❌ 错误：把详细描述变成简略概括\n- ✅ 正确：只替换/删除八股词汇，保留所有实质内容\n- ✅ 正确：用更自然的表达替换文学腔，而不是简单删除\n\n## 💡 工作方式\n**不是"删除工"，而是"改写师"：**\n- 不要想着"删删删"\n- 要想着"怎么用人话说同样的事"\n- 把文学腔改成日常口语\n- 把套路比喻改成直接描述\n\n---\n\n# 📋 清理规则（三级分类）\n\n## 🔴 第一级：必须删除（最明显的八股）\n\n### 1️⃣ AI套话词汇（见到就删）\n**模糊词**：一丝、一抹、一缕、一股、似乎、几乎、近乎、仿佛\n**比喻词**：如同、宛如、恰似、像是、好像、就像\n**对比句**："不是...而是..."、"既...又..."、"与其...不如"\n**强调词**：猛地、重重地、狂野、激烈地、恨不得、不容置疑\n**修饰废话**："不易察觉"、"难以察觉"、"带着xx意味"、"充满了某种"\n\n### 2️⃣ AI文学腔描写（全部删除）\n- **眼神/视线**："眼里闪过xxx"、"嘴角上扬"、"视线交汇" → 直接删\n- **心理状态**："她感到害怕"、"他内心矛盾" → 改成对白或动作\n- **声音描述**："声音沙哑"、"声音里带着..." → 全删\n- **动物比喻**："像小兽"、"像猫咪"、"野兽般的" → 全删\n- **气氛渲染**："气氛凝重"、"空气凝固" → 全删\n- **对白标注**："（带着不屑的口吻）"、"（轻声说）" → 全删\n\n### 3️⃣ 所有格主语（改写）\n- ❌ "她的声音"、"他的眼神" → 直接删或改主语\n- ❌ "她的性格是..." → 改为 "她很..."\n\n### 4️⃣ 精确数据（模糊化）\n- ❌ "身高168cm"、"一米六八" → ✅ "个子高"\n- ❌ "体重50kg" → ✅ "很瘦" 或直接删\n- ❌ "罩杯C" → ✅ "胸部丰满" 或直接删\n\n---\n\n## 🟡 第二级：改写替换（文学腔 → 人话）\n\n### 文学腔比喻 → 直接描述\n| 文学腔 | 人话 |\n|--------|------|\n| 醇厚的香气扑面而来 | 闻到酒味了 / 有股酒香 |\n| 如同黑曜石般璀璨的眼眸 | 黑眼睛 / 眼睛很黑 |\n| 心中涌起复杂的情绪 | 心里矛盾 / 又怕又期待 |\n| 冷暖交织的气息 | 冷香和酒味混在一起 |\n| 致命的诱惑 | 忍不住想靠近 |\n| 矛盾而极具吸引力 | 说不上来，但就是想看 |\n\n### 对仗结构 → 口语化\n- "既冷冽又醇厚" → "冷香和酒味"\n- "既矛盾又复杂" → "很矛盾"\n- "不是温柔而是傲慢" → "傲慢，不温柔"\n\n---\n\n## 🟢 第三级：必须保留（核心内容）\n\n### ✅ 完全保留：\n1. **所有对白**：包括""内的所有台词\n2. **核心设定**：人物背景、职业、关系\n3. **基础动作**：走、坐、站、拿、放\n4. **简单情绪**：开心、难过、生气（这些可以保留）\n5. **具体信息**：年龄、地点、时间、事件\n\n### ✅ 可以保留：\n- 自然的形容词（不是套话比喻）\n- 日常化的描述\n- 有意义的细节\n\n---\n\n# 💡 对比示例（学习正确做法）\n\n## 示例1：角色卡八股清理\n\n**❌ 输入（AI八股）：**\n角色A似乎有些困惑，眼里闪过一丝不易察觉的疑惑，她用不容置疑的语气说："你是谁？"她的声音低沉而富有磁性，如同野兽般的低吼。\n\n角色A出生于贵族家庭，她有着一头如同黑曜石般的长发，双眸宛如深邃的湖泊，身高168cm，罩杯C。她的性格并不是温柔的，而是傲慢且狂热的。\n\n她对魔法有着近乎狂热的追求，仿佛那是她生命的全部意义。语料："哼，你这种凡人怎么会理解我的想法。"（带着不屑的口吻）\n\n**❌ 错误输出（过度删减，信息量丢失）：**\n角色A问："你是谁？"\n角色A出生于贵族家庭，有黑色长发。\n语料："你不会理解我的想法。"\n\n**✅ 正确输出（保持信息量，只去八股）：**\n角色A停了停。"你是谁？"\n\n角色A出生于贵族家庭，黑色长发，黑眼睛，个子高，胸部丰满。傲慢，对很多事都很热情。喜欢阅读，经常一个人待在图书馆。\n\n角色A对魔法很痴迷，投入了很多时间研究。她怕一些东西。\n\n语料："哼，你这种凡人怎么会理解我的想法。"\n\n**改写思路：**\n- "似乎有些困惑，眼里闪过..." → "停了停"（行为代替心理+眼神）\n- "她的声音...如同野兽..." → 全删（声音描写+比喻）\n- "如同黑曜石般的长发" → "黑色长发"（删套话比喻）\n- "身高168cm，罩杯C" → "个子高，胸部丰满"（模糊化数字）\n- "并不是...而是..." → "傲慢"（删对比句）\n- "（带着不屑的口吻）" → 删（对白标注）\n- **对白完全保留**，设定信息全保留\n\n---\n\n## 示例2：信息素描写清理\n\n**❌ 输入（文学腔）：**\n一阵既冷冽又醇厚的香气飘来，混合着冬日雪松与温热白兰地的味道，矛盾而极具吸引力。浓郁而滚烫的信息素正从他身上源源不断地散发出来，那冰冷的雪杉气息已经被醇厚的白兰地酒香彻底包裹，充满了毫无防备的、致命的诱惑。\n\n**✅ 正确输出（人话）：**\n闻到香味，雪松和白兰地混在一起。滚烫的信息素从他身上散出来，雪杉味被酒香盖过了。\n\n**改写思路：**\n- "一阵" → "闻到"（删"一"+量词）\n- "既...又..." → 删（删对仗结构）\n- "矛盾而极具吸引力" → 删（删文学腔评价）\n- "浓郁而滚烫" → "滚烫"（删冗余形容词）\n- "充满了...致命的诱惑" → 删（删夸张描述）\n- **保留核心信息**：雪松、白兰地、信息素、滚烫、混合、盖过\n\n---\n\n# 🎯 最终执行要求\n\n1. **信息量守恒**：输入多少字，输出接近多少字\n2. **段落数守恒**：输入几段，输出几段\n3. **对白完整**：所有""内的台词必须100%保留\n4. **设定保留**：背景、职业、关系等核心设定全保留\n5. **只改八股**：只处理上述明确列出的八股表述\n6. **直接输出**：不要任何解释、标注、说明，直接给清理后的文本\n\n---\n\n**现在开始清理，记住：你是"改写师"而不是"删除工"！**'},{role:'user',content:S.value}]};let n;if(P.value)n=await Se(e,O);else{const t=M(k.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),O.value=100}C.value=n,ge(),window.toastr.success('文本清理完成！')}catch(e){console.error('反八股清理失败:',e),window.toastr.error('清理失败：'+e.message)}finally{E.value=!1,O.value=0}else window.toastr.warning('请输入需要清理的文本')},he=()=>{C.value?A(C.value,'清理结果已复制到剪贴板'):window.toastr.warning('没有可复制的内容')},ye=async()=>{if(j.value.trim())if(C.value)try{L.value=!0,O.value=0,window.toastr.info('AI正在修改...','反八股修改',{timeOut:15e3});const e={model:k.value.model,max_tokens:k.value.max_tokens||8e3,temperature:.7,stream:P.value,messages:[{role:'system',content:'你是一个文本编辑助手。根据用户的修改需求，对提供的文本进行修改。直接输出修改后的结果，不要添加任何解释或说明。'},{role:'user',content:`当前文本：\n${C.value}\n\n修改需求：${j.value}`}]};let n;if(P.value)n=await Se(e,O);else{const t=M(k.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),O.value=100}C.value=n,ge(),window.toastr.success('修改完成！')}catch(e){console.error('反八股修改失败:',e),window.toastr.error('修改失败：'+e.message)}finally{L.value=!1,O.value=0}else window.toastr.warning('没有可修改的内容');else window.toastr.warning('请输入修改需求')},ve=()=>{j.value='',ge(),window.toastr.success('修改需求已清空')},we=async()=>{if(H.value.trim())try{J.value=!0,Z.value=0,window.toastr.info('AI正在生成角色卡，请稍候...');const e={model:k.value.model||'gpt-3.5-turbo',max_tokens:k.value.max_tokens||16e3,temperature:.8,stream:Y.value,messages:[{role:'system',content:'你是一位专业的角色设计师，擅长创造真实、立体、有血有肉的角色。\n\n# 核心原则\n1. **真实性第一**：角色必须像真实存在的人，有优点也有缺点，有逻辑也有矛盾\n2. **避免刻板印象**：拒绝"温柔体贴"、"成熟稳重"、"活泼开朗"等空洞标签\n3. **展现而非告知**：用具体行为、习惯、反应来展现性格，而非直接描述\n4. **矛盾与冲突**：性格要有张力，内心要有挣扎，行为要有动机\n\n# 输出格式\n严格使用 YAML 格式，纯中文，结构如下：\n\n```yaml\n基础信息:\n  姓名: "全名（只写中文，不带英文）"\n  年龄: 具体数字\n  出生年月: "YYYY年MM月"\n  性别: "男/女"\n  第二性别: "Alpha/Beta/Omega/无"\n  身高体重: "用描述性词语，如\'身材高挑\'\'体型匀称\'\'略显瘦削\'，禁用数字和单位"\n  信息素: "如适用ABO设定，描述气味和特征，否则写\'无\'"\n  性取向: "明确但自然的描述"\n  恋爱经验: "具体描述过往经历和对感情的态度，不要写\'丰富\'这种模糊词"\n  身份职业: "具体职业+当前状态，如\'互联网公司产品经理，正处于职业瓶颈期\'"\n  标志性特征:\n    微信昵称: "符合角色性格的昵称"\n    头像: "简短描述，体现性格"\n    其他: "1-2个独特的外在特征"\n\n外貌与身材:\n  整体印象: "第一眼给人的感觉，用生动的比喻"\n  面容特征:\n    发型发色: "具体描述+日常打理习惯"\n    肤色肤质: "不只说白/黑，要有质感描述"\n    眼睛: "形状+神态+眼神特点（如\'总是微微眯起，带着审视\'）"\n    五官: "1-2个最突出的特点+细节"\n  穿搭风格: "日常3种场景的穿着+品味倾向+为什么这样穿"\n  声音气质: "音色+语速+说话习惯（如\'会在句尾拖长音\'\'习惯用鼻音哼声\'）"\n  习惯动作: "3-5个自然的小动作，注明在什么情况下会做"\n\n性格与心理:\n  核心性格:\n    主导特质: "1个最核心的性格特点，用行为模式解释"\n    次要特质: "2-3个补充特质，说明如何体现"\n    隐藏面: "不轻易展现但确实存在的一面"\n  性格矛盾: "至少1组内在矛盾（如：渴望亲密却害怕受伤，追求完美却容易自我怀疑）"\n  情绪模式:\n    基线情绪: "日常的情绪基调，不要用\'平和\'\'稳定\'这种词"\n    易触发点: "具体场景+为什么会触发"\n    情绪表现: "高兴/生气/难过时的具体表现，要有细节"\n    自我调节: "心情不好时会做什么，效果如何"\n  压力应对: "面对压力的第一反应+长期策略+极限状态"\n  自我认知: "TA如何看待自己+与他人眼中形象的差异"\n\n对话风格:\n  语言特征: "用词习惯+句式特点+说话节奏，给出具体例子"\n  对不同对象:\n    熟人: "如何说话+举例"\n    生人: "如何说话+举例"\n    上级/长辈: "如何说话+举例"\n    下属/晚辈: "如何说话+举例"\n  情绪化时: "生气时语气如何变化+难过时说话方式+兴奋时的特点"\n  口头禅: ["2-3个符合角色的口头禅，要自然"]\n  言外之意: "常用的委婉表达或暗示方式"\n\n背景经历:\n  家庭背景: "家庭结构+成长环境+家庭氛围+对性格的影响"\n  教育经历: "学习经历+成绩表现+对知识/权威的态度"\n  重要事件:\n    - "具体事件1+当时年龄+如何影响了TA"\n    - "具体事件2+当时年龄+如何影响了TA"\n    - "具体事件3+当时年龄+如何影响了TA"\n  转折点: "人生中最重要的改变+前后对比"\n  当前状况: "具体的生活状态+面临的问题+应对方式"\n  未来规划: "想要什么+为什么想要+有何行动"\n\n人际关系:\n  对{{user}}: "初次见面的态度+相处模式+内心真实想法+可能的发展"\n  社交模式: "喜欢什么样的社交+讨厌什么+社交能量来源"\n  群体定位: "在团体中的角色+如何获得这个位置+是否满意"\n  关系处理: "如何建立关系+如何维持关系+如何结束关系"\n  冲突模式: "冲突时第一反应+沟通方式+底线在哪"\n\n行为模式:\n  日常习惯: "3-5个具体的生活习惯+背后原因"\n  决策模式: "做决定的方式+考虑因素+犹豫点"\n  主动行为: "TA会主动去做的事+动机"\n  回避行为: "TA避免做的事+为什么回避"\n  应激反应: "突发情况的本能反应+事后如何处理"\n  行为底线: "绝对不会做的事+为什么"\n\n内在动机:\n  核心驱动: "推动TA行动的最深层原因（不是\'想成功\'这种泛泛之谈）"\n  深层需求: "TA真正缺失和渴望的（可能自己都未意识到）"\n  价值排序: "TA认为最重要的3-5个价值观，按优先级排序"\n  内在冲突: "价值观之间的矛盾+如何权衡"\n  隐秘想法: "不愿说出口的真实想法+为什么隐藏"\n  自我欺骗: "TA对自己撒的谎+真相是什么"\n\n情绪管理:\n  失控阈值: "什么情况会失控+失控时的表现"\n  恢复机制: "如何平复下来+需要多久+谁能帮助"\n  情绪模式: "是压抑型/爆发型/渐进型"\n  脆弱时刻: "什么时候最脆弱+会向谁示弱"\n```\n\n# 写作要求\n\n## ✅ 这样写（好例子）：\n- "会在紧张时咬指甲，咬到出血也不自觉"\n- "表面上说无所谓，但会在深夜反复刷对方的社交账号"\n- "习惯在句尾加\'吧\'\'呢\'这些不确定的语气词，显得不够坚定"\n- "对陌生人冷淡，但遇到流浪猫会蹲下来哄半天"\n\n## ❌ 不要这样写（坏例子）：\n- "性格温柔善良" → 太空洞，要写具体行为\n- "是个负责任的人" → 太抽象，要写如何体现\n- "很关心朋友" → 太笼统，要写具体怎么关心\n- "成熟稳重" → 太刻板，真人有复杂性\n\n## 关键原则：\n1. **每个描述都要有"为什么"**：不只说TA是什么样，要说为什么是这样\n2. **展现矛盾**：真实的人都有自相矛盾的地方\n3. **具体场景**：用"会在XX情况下做XX"而非"是个XX的人"\n4. **避免完美**：缺陷和局限让角色真实\n5. **语言生动**：用比喻、对比、细节，不要用形容词堆砌\n\n现在请根据用户描述，创造一个真实可信的角色。记住：你在创造一个人，不是填写表格。'},{role:'user',content:H.value}]};let n;if(Y.value)n=await Se(e,Z);else{const t=M(k.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),Z.value=100}U.value=n,ge(),window.toastr.success('角色卡生成完成！')}catch(e){console.error('角色卡生成失败:',e),window.toastr.error('生成失败：'+e.message)}finally{J.value=!1,Z.value=0}else window.toastr.warning('请输入角色描述')},ke=()=>{H.value='',U.value='',F.value='',ge(),window.toastr.success('内容已清空')},_e=()=>{U.value?A(U.value,'角色卡已复制到剪贴板'):window.toastr.warning('没有可复制的内容')},Te=()=>{S.value='',C.value='',ge(),window.toastr.success('内容已清空')},ze=async()=>{if(F.value.trim())if(U.value)try{B.value=!0,Z.value=0,window.toastr.info('AI正在根据你的需求修改角色卡，请稍候...');const e={model:k.value.model||'gpt-3.5-turbo',max_tokens:k.value.max_tokens||16e3,temperature:.8,stream:Y.value,messages:[{role:'system',content:'你是一个角色卡编辑助手。用户会提供一个现有的 YAML 格式角色卡和修改需求，请根据修改需求调整角色卡内容。\n\n**修改原则**：\n1. 必须保持 YAML 格式，所有字段名和内容都使用中文\n2. 只修改用户明确要求修改的部分\n3. 确保修改后的内容与原有角色卡风格一致\n4. 如果用户的要求与原有设定冲突，以用户的要求为准\n5. 输出完整的修改后的角色卡，不要截断\n6. 保持原有的字段结构，除非用户要求添加或删除字段\n\n**重要注意事项**：\n- 身高体重必须用文字描述（高大/中等/娇小/匀称/纤瘦等），不要用数字和单位\n- 保持性格的多面性和复杂性，避免单一化\n- 行为模式要从角色视角出发，描述角色会如何思考和行动\n- 避免AI刻板化，保持角色的真实感和多样性\n\n请输出完整的 YAML 格式角色卡。'},{role:'user',content:`以下是现有的角色卡：\n\n${U.value}\n\n---\n\n请根据以下修改需求调整角色卡：\n${F.value}`}]};let n;if(Y.value)n=await Se(e,Z);else{const t=M(k.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(e)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);n=(await a.json()).choices[0].message.content.trim(),Z.value=100}U.value=n,F.value='',ge(),window.toastr.success('角色卡修改完成！')}catch(e){console.error('角色卡修改失败:',e),window.toastr.error('修改失败：'+e.message)}finally{B.value=!1,Z.value=0}else window.toastr.warning('没有可修改的角色卡，请先生成角色卡');else window.toastr.warning('请输入修改需求')},Ie=()=>{F.value='',ge(),window.toastr.success('修改需求已清空')},Se=async(e,n)=>{const t=M(k.value.api_endpoint),a=await fetch(t,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(e)});if(!a.ok){const e=await a.text();throw new Error(`流式请求失败：${a.status} ${a.statusText}\n${e.slice(0,400)}`)}if(!a.body)throw new Error('该 API 未返回可读流，请关闭流式模式或检查端点支持情况');const o=a.body.getReader(),r=new TextDecoder('utf-8');let s='',i=!1,l='';n.value=0;const d=e=>{const t=e.trim();if(!t)return!1;if('data: [DONE]'===t||'[DONE]'===t)return!0;const a=t.startsWith('data:')?t.slice(5).trim():t;if(!a||'[DONE]'===a)return!1;try{const e=JSON.parse(a),t=(o=e,o.choices?.[0]?.delta?.content?o.choices[0].delta.content:o.delta?.text?o.delta.text:'string'==typeof o.content?o.content:'string'==typeof o.text?o.text:'string'==typeof o.response?o.response:null);t&&(l+=t,n.value=Math.min(n.value+2,98))}catch(r){console.warn('无法解析流式数据块:',a.slice(0,100),r)}var o;return!1};for(;!i;){const{value:e,done:n}=await o.read();if(e){s+=r.decode(e,{stream:!0});const n=s.split('\n');s=n.pop()??'';for(const e of n)if(d(e)){i=!0;break}}n&&(i=!0)}return s&&!i&&d(s),n.value=100,l},Ae=async()=>{if(G.value.trim())try{q.value=!0,ae.value=0,window.toastr.info('AI正在生成世界书条目，请稍候...','',{timeOut:15e3});const n={model:k.value.model||'gpt-3.5-turbo',max_tokens:k.value.max_tokens||4e3,temperature:.7,stream:te.value,messages:[{role:'system',content:'你是SillyTavern世界书条目生成专家，负责将用户需求转换为标准JSON格式的世界书条目。\n\n# JSON结构规范\n\n{\n  "name": "条目名称",\n  "enabled": true,\n  "strategy": {\n    "type": "selective或constant",\n    "keys": ["关键字数组"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "条目正文内容",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n---\n\n# 字段填写规则\n\n## 1️⃣ name（条目名称）\n- 简短明确（2-6字最佳）\n- 反映核心主题\n- 示例："林潜"、"魔法学院"、"火焰剑"\n\n## 2️⃣ strategy.type（激活类型）\n**selective（绿灯）** - 关键字触发：\n- 角色、地点、物品\n- 特定事件、特定概念\n- 需要按需激活的内容\n\n**constant（蓝灯）** - 始终生效：\n- 世界观基础设定\n- 通用规则\n- 全局背景信息\n\n## 3️⃣ strategy.keys（关键字）\n- 3-6个关键词\n- 包含：全名、简称、别名、相关概念\n- 示例：["林潜", "林", "潜"]、["魔法学院", "学院", "星辉"]\n\n## 4️⃣ content（正文内容）⚠️ 最重要！\n\n### ❌ 严禁使用的格式\n**禁止Markdown语法**：\n- ❌ 不用 # 标题、## 二级标题\n- ❌ 不用 **粗体**、*斜体*\n- ❌ 不用 - 列表、1. 数字列表\n- ❌ 不用 > 引用\n- ❌ 不用 `代码`\n\n**禁止AI八股文**：\n- ❌ 不用"一丝"、"一抹"、"如同"、"宛如"\n- ❌ 不用"眼里闪过"、"嘴角上扬"\n- ❌ 不用"既...又..."、"不是...而是..."\n- ❌ 不描写心理、眼神、声音、气氛\n\n### ✅ 正确的写法\n**纯文本 + 冒号分隔**：\n- 用"。"句号分隔信息\n- 用"："冒号引出具体内容\n- 用"、"顿号列举\n\n**陈述式 + 信息密集**：\n- 直接陈述事实\n- 简洁有力，不绕弯子\n- 每句话都有实质信息\n\n**结构化组织**：\n- 从基础信息到详细设定\n- 逻辑顺序：身份→特征→背景→能力→关系\n- 用换行段落分隔不同主题\n\n### 📋 内容模板\n\n**角色类**：\n[姓名]，[性别]，[年龄]，[职业/身份]。[外貌特征1-2句]。[性格核心特点]。[重要背景]。[能力/特长]。[与其他角色的关系]。\n\n**地点类**：\n[地点名]位于[位置]，[基本描述]。[功能用途]。[历史背景]。[重要特征]。[相关规则]。\n\n**物品类**：\n[物品名]，[类型]，[外观]。[功能/效果]。[获取方式]。[使用限制]。[特殊说明]。\n\n**概念/事件类**：\n[概念名]指[定义]。[具体表现]。[影响范围]。[相关规则]。[注意事项]。\n\n---\n\n# 完整示例\n\n## 示例1：角色条目\n\n用户需求："创建角色林潜的条目，16岁，男，高中生，普通家庭"\n\n输出：\n{\n  "name": "林潜",\n  "enabled": true,\n  "strategy": {\n    "type": "selective",\n    "keys": ["林潜", "林", "潜", "男生", "同学"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "林潜，男性，16岁，目前就读高中。出身于普通家庭，家庭经济状况中等。性格内向，不太擅长社交。学习成绩中等偏上，理科比文科好。平时喜欢独自看书，经常一个人待在图书馆。对陌生人保持警惕，熟悉后会放松一些。",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n## 示例2：地点条目\n\n用户需求："创建魔法学院的条目，包含历史和规则"\n\n输出：\n{\n  "name": "星辉魔法学院",\n  "enabled": true,\n  "strategy": {\n    "type": "selective",\n    "keys": ["星辉魔法学院", "魔法学院", "学院", "星辉", "校园"],\n    "keys_secondary": { "logic": "and_any", "keys": [] },\n    "scan_depth": "same_as_global"\n  },\n  "position": {\n    "type": "after_character_definition",\n    "role": "system",\n    "depth": 4,\n    "order": 100\n  },\n  "content": "星辉魔法学院位于浮空岛上，建立于三百年前。学院有七座高塔，对应七大魔法流派：元素、心灵、转化、召唤、预言、防护、幻术。学院采用学分制，学生需完成基础课程和专精课程才能毕业。\n\n学院规则：禁止在教学区施展未经许可的魔法。禁止擅自进入禁书区。禁止私下决斗，违者将被停学。学生需佩戴学院徽章，按时参加每周的全体集会。",\n  "probability": 100,\n  "recursion": {\n    "prevent_incoming": false,\n    "prevent_outgoing": false,\n    "delay_until": null\n  },\n  "effect": {\n    "sticky": null,\n    "cooldown": null,\n    "delay": null\n  }\n}\n\n---\n\n# 最终要求\n\n1. **只输出JSON**：不要任何解释、注释、说明\n2. **格式正确**：确保可被JSON.parse()解析\n3. **信息完整**：用户提供的所有信息都必须在content中体现\n4. **禁用Markdown**：content必须是纯文本，不用任何Markdown语法\n5. **避免八股文**：不用套话、比喻、心理描写\n6. **结构清晰**：用句号、冒号、换行组织内容，不用列表符号\n\n现在根据用户需求生成世界书条目JSON。'},{role:'user',content:G.value}]};let t;if(te.value)t=await Se(n,ae);else{const e=M(k.value.api_endpoint),a=await fetch(e,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(n)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);t=(await a.json()).choices[0].message.content.trim(),ae.value=100}try{const e=(t.match(/```(?:json)?\s*([\s\S]*?)```/)||[null,t])[1]||t,n=JSON.parse(e);W.value=n,ge(),window.toastr.success('世界书条目生成完成！')}catch(e){console.error('JSON 解析失败:',e),console.log('原始响应:',t),window.toastr.error('生成的内容格式错误，请重试')}}catch(n){console.error('世界书条目生成失败:',n),window.toastr.error('生成失败：'+n.message)}finally{q.value=!1,ae.value=0}else window.toastr.warning('请输入条目描述')},$e=()=>{G.value='',W.value=null,K.value='',ee.value='',ge(),window.toastr.success('内容已清空')},Ce=async()=>{if(K.value)if(W.value)try{Q.value=!0,window.toastr.info(`正在插入条目到「${K.value}」...`),await createWorldbookEntries(K.value,[W.value],{render:'immediate'}),window.toastr.success(`✅ 条目已成功插入到「${K.value}」`)}catch(e){console.error('插入条目失败:',e),window.toastr.error('插入失败：'+e.message)}finally{Q.value=!1}else window.toastr.warning('没有可插入的条目');else window.toastr.warning('请选择目标世界书')},Ee=()=>{if(!W.value)return void window.toastr.warning('没有可复制的内容');const e=JSON.stringify(W.value,null,2);A(e,'世界书条目 JSON 已复制到剪贴板')},Me=async()=>{if(ee.value.trim())if(W.value)try{ne.value=!0,ae.value=0,window.toastr.info('AI正在根据你的需求修改世界书条目，请稍候...');const n={model:k.value.model||'gpt-3.5-turbo',max_tokens:k.value.max_tokens||4e3,temperature:.7,stream:te.value,messages:[{role:'system',content:'你是一个世界书条目编辑助手。用户会提供一个现有的世界书条目 JSON 和修改需求，请根据修改需求调整条目内容。\n\n**修改原则**：\n1. 必须保持 JSON 格式正确\n2. 只修改用户明确要求修改的部分\n3. 确保修改后的内容与原有条目风格一致\n4. 如果用户的要求与原有设定冲突，以用户的要求为准\n5. 输出完整的修改后的 JSON，不要截断\n6. 保持原有的字段结构，除非用户要求添加或删除字段\n\n**重要注意事项**：\n- 如果修改内容 (content)，务必包含用户要求的所有信息\n- 如果修改关键字 (keys)，要确保关键字与内容匹配\n- 保持激活策略 (strategy.type) 的合理性\n- 只输出 JSON 数据，不要添加任何解释\n\n请输出完整的 JSON 格式世界书条目。'},{role:'user',content:`以下是现有的世界书条目：\n\n${JSON.stringify(W.value,null,2)}\n\n---\n\n请根据以下修改需求调整条目：\n${ee.value}`}]};let t;if(te.value)t=await Se(n,ae);else{const e=M(k.value.api_endpoint),a=await fetch(e,{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${k.value.api_key}`},body:JSON.stringify(n)});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);t=(await a.json()).choices[0].message.content.trim(),ae.value=100}try{const e=(t.match(/```(?:json)?\s*([\s\S]*?)```/)||[null,t])[1]||t,n=JSON.parse(e);W.value=n,ee.value='',ge(),window.toastr.success('世界书条目修改完成！')}catch(e){console.error('JSON 解析失败:',e),console.log('原始响应:',t),window.toastr.error('修改的内容格式错误，请重试')}}catch(n){console.error('世界书条目修改失败:',n),window.toastr.error('修改失败：'+n.message)}finally{ne.value=!1,ae.value=0}else window.toastr.warning('没有可修改的条目，请先生成条目');else window.toastr.warning('请输入修改需求')},Pe=()=>{ee.value='',ge(),window.toastr.success('修改需求已清空')},Oe=async()=>{if(oe.value)try{let e=null;if(void 0===window.TavernHelper||'function'!=typeof window.TavernHelper.getWorldbook)return console.error('❌ TavernHelper.getWorldbook 不可用'),window.toastr.error('世界书功能需要酒馆助手支持'),void(re.value=[]);e=await window.TavernHelper.getWorldbook(oe.value),e&&Array.isArray(e)&&e.length>0?(re.value=e,console.log(`✅ 已加载世界书 "${oe.value}" 的 ${re.value.length} 个条目`),window.toastr.success(`已加载 ${re.value.length} 个条目`)):(re.value=[],window.toastr.info('该世界书没有条目'))}catch(e){console.error('❌ 加载世界书条目失败:',e),window.toastr.error('加载失败：'+e.message),re.value=[]}else re.value=[]},je=v(()=>{let e=[...re.value];if(se.value.trim()){const n=se.value.toLowerCase();e=e.filter(e=>{const t=e.name?.toLowerCase().includes(n),a=e.content?.toLowerCase().includes(n),o=e.strategy?.keys?.some(e=>'string'==typeof e?e.toLowerCase().includes(n):e instanceof RegExp&&e.toString().toLowerCase().includes(n));return t||a||o})}return'enabled'===ie.value?e=e.filter(e=>e.enabled):'disabled'===ie.value&&(e=e.filter(e=>!e.enabled)),e}),Re=e=>le.value.get(e)||!1,Ne=async()=>{if(ce.value.name?.trim())if(pe.value)try{const e=await updateWorldbookWith(oe.value,e=>{const n=e.findIndex(e=>e.uid===pe.value);return-1!==n&&(e[n]={...e[n],...ce.value,uid:pe.value}),e});re.value=e,de.value=!1,ce.value={},pe.value=null,window.toastr.success('条目已保存')}catch(e){console.error('保存条目失败:',e),window.toastr.error('保存失败：'+e.message)}else window.toastr.error('条目ID不存在');else window.toastr.warning('条目名称不能为空')};return(e,n)=>(r(),a('div',Fc,[i('div',Bc,[i('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[0]||(n[0]=e=>me('antiCliche')),onMouseenter:n[1]||(n[1]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[2]||(n[2]=e=>e.currentTarget.style.transform='translateY(0)')},[n[51]||(n[51]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-broom',style:{color:'#ff6b6b','font-size':'18px'}}),d(' 反八股工具 ')],-1)),i('i',{class:x(xe('antiCliche')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),xe('antiCliche')?(r(),a('div',Yc,[n[62]||(n[62]=u('<div class="tool-instructions" data-v-ae874133><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-ae874133></i> 角色卡/世界书/开场白八股清理工具，<strong style="color:#10b981;" data-v-ae874133>适度清理</strong>明显八股，保持原文信息量。 </p><p style="margin:0 0 8px 0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-ae874133> 🎯 <strong data-v-ae874133>清理重点</strong>：模糊词（一丝、似乎）、动物化比喻（像小兽）、否定句式（不是而是）、极端情绪、夸张修辞 </p><p style="margin:0;color:#10b981;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #10b981;" data-v-ae874133> ✅ <strong data-v-ae874133>保持内容</strong>：核心设定、对话内容、具体动作、重要信息 - 输入几段输出几段！ </p></div>',1)),i('div',Zc,[n[52]||(n[52]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 输入文本： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[3]||(n[3]=e=>S.value=e),placeholder:'请输入需要清理的文本...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,S.value]])]),i('div',Gc,[i('label',Wc,[l(i('input',{'onUpdate:modelValue':n[4]||(n[4]=e=>P.value=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,P.value]]),n[53]||(n[53]=d(' 启用流式传输（可查看清理进度） ',-1))])]),E.value&&O.value>0?(r(),a('div',qc,[i('div',Xc,[i('div',{class:'progress-fill',style:g({width:O.value+'%',height:'100%',background:'linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%)',backgroundSize:'200% 100%',animation:P.value?'progress-slide 2s linear infinite':'none',transition:'width 0.3s ease'})},null,4)]),i('div',Kc,' 清理中... '+c(O.value.toFixed(0))+'% ',1)])):o('',!0),i('div',Qc,[i('button',{class:'process-button',disabled:E.value||!S.value.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(102, 126, 234, 0.3)',position:'relative',overflow:'hidden'},onClick:be},[n[54]||(n[54]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[55]||(n[55]=i('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(E.value?'处理中...':'开始清理'),1)],8,ep),i('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:Te},[...n[56]||(n[56]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),C.value?(r(),a('div',np,[n[61]||(n[61]=i('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 清理结果： ')],-1)),i('div',tp,c(C.value),1),i('div',{class:'output-actions',style:{'margin-top':'12px',display:'flex',gap:'12px'}},[i('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:he},[...n[57]||(n[57]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制结果 ',-1)])])]),i('div',ap,[n[60]||(n[60]=i('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px',color:'#ffc107'}}),d(' AI 修改清理结果 ')],-1)),i('div',op,[l(i('textarea',{'onUpdate:modelValue':n[5]||(n[5]=e=>j.value=e),placeholder:'描述你想要的修改，例如：把这段话改得更简洁一些...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,j.value]])]),i('div',rp,[i('button',{disabled:L.value||!j.value.trim(),style:g([{flex:'1',padding:'10px 20px',background:'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',border:'none','border-radius':'6px',color:'#1a1a1a','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 193, 7, 0.3)',opacity:'1'},{opacity:L.value||!j.value.trim()?.5:1,cursor:L.value||!j.value.trim()?'not-allowed':'pointer'}]),onClick:ye},[n[58]||(n[58]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'margin-right':'6px'}},null,-1)),d(' '+c(L.value?'修改中...':'AI 修改'),1)],12,sp),i('button',{disabled:!j.value.trim(),style:g([{padding:'10px 20px',background:'#dc3545',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease'},{opacity:j.value.trim()?1:.5,cursor:j.value.trim()?'pointer':'not-allowed'}]),onClick:ve},[...n[59]||(n[59]=[i('i',{class:'fa-solid fa-eraser',style:{'margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])],12,ip)])])])):o('',!0)])):o('',!0)]),i('div',lp,[i('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[6]||(n[6]=e=>me('worldbookEntry')),onMouseenter:n[7]||(n[7]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[8]||(n[8]=e=>e.currentTarget.style.transform='translateY(0)')},[n[63]||(n[63]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-book-atlas',style:{color:'#ffc107','font-size':'18px'}}),d(' 世界书条目生成工具 ')],-1)),i('i',{class:x(xe('worldbookEntry')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),xe('worldbookEntry')?(r(),a('div',dp,[n[88]||(n[88]=i('div',{class:'tool-instructions'},[i('p',{style:{margin:'0 0 8px 0',color:'#ccc','font-size':'12px'}},[i('i',{class:'fa-solid fa-info-circle',style:{'margin-right':'6px',color:'#ffc107'}}),d(' 输入你想要的世界书条目描述，AI 将自动生成符合格式的条目，并可插入到指定世界书中。 ')]),i('p',{style:{margin:'0',color:'#4a9eff','font-size':'11px',background:'#1a1a1a',padding:'6px','border-radius':'4px','border-left':'3px solid #ffc107'}},' 💡 示例：「生成一个关于魔法学院的条目，包含学院历史和规则」、「创建角色"艾莉丝"的背景条目」 ')],-1)),i('div',cp,[n[64]||(n[64]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 条目描述： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[9]||(n[9]=e=>G.value=e),placeholder:'请描述你想要生成的世界书条目内容...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,G.value]])]),i('div',pp,[i('label',up,[l(i('input',{'onUpdate:modelValue':n[10]||(n[10]=e=>te.value=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,te.value]]),n[65]||(n[65]=d(' 启用流式传输（可查看生成进度） ',-1))])]),q.value&&ae.value>0?(r(),a('div',gp,[i('div',fp,[n[67]||(n[67]=i('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(255, 193, 7, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),i('div',{class:'progress-fill',style:g({position:'relative',width:ae.value+'%',height:'100%',background:'linear-gradient(90deg, #ffc107 0%, #ff9800 50%, #ffc107 100%)',backgroundSize:'200% 100%',animation:te.value?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(255, 193, 7, 0.5)'})},[...n[66]||(n[66]=[i('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),i('div',mp,[i('span',xp,' 生成中... '+c(ae.value.toFixed(0))+'% ',1),n[68]||(n[68]=i('div',{style:{display:'flex',gap:'4px'}},[i('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#ffc107','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):o('',!0),i('div',bp,[i('button',{class:'generate-button',disabled:q.value||!G.value.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffc107 0%, #ff9800 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 193, 7, 0.3)',position:'relative',overflow:'hidden'},onClick:Ae},[n[69]||(n[69]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[70]||(n[70]=i('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(q.value?'生成中...':'生成条目'),1)],8,hp),i('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:$e},[...n[71]||(n[71]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),W.value?(r(),a('div',yp,[n[87]||(n[87]=i('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 生成的条目： ')],-1)),i('div',vp,[i('div',wp,[n[72]||(n[72]=i('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'条目名称：',-1)),i('div',kp,c(W.value.name||'未命名'),1)]),i('div',_p,[n[73]||(n[73]=i('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'主要关键字：',-1)),i('div',Tp,c(W.value.strategy?.keys?.join(', ')||'无'),1)]),i('div',zp,[n[74]||(n[74]=i('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'条目内容：',-1)),i('div',Ip,c(W.value.content),1)]),i('div',Sp,[n[75]||(n[75]=i('label',{style:{color:'#ffc107','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'4px'}},'激活策略：',-1)),i('div',Ap,c('constant'===W.value.strategy?.type?'🔵 常量 (蓝灯)':'selective'===W.value.strategy?.type?'🟢 可选项 (绿灯)':'🔗 向量化'),1)])]),i('div',$p,[n[80]||(n[80]=u('<h5 style="margin:0 0 12px 0;color:#fff;font-size:14px;font-weight:600;" data-v-ae874133><i class="fa-solid fa-edit" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 修改条目 </h5><div class="modify-instructions" style="background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:10px;margin-bottom:15px;" data-v-ae874133><p style="margin:0 0 6px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-lightbulb" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 描述你想要修改的内容，AI会根据你的需求调整条目。例如：&quot;增加更多细节&quot;、&quot;改为女性角色&quot;、&quot;添加技能说明&quot;等。 </p><p style="margin:0;color:#ffa500;font-size:11px;" data-v-ae874133>⚠️ 修改后会保持 JSON 格式。</p></div>',2)),i('div',Cp,[n[76]||(n[76]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 修改需求： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[11]||(n[11]=e=>ee.value=e),placeholder:'请描述你想要修改的内容...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,ee.value]])]),ne.value&&ae.value>0?(r(),a('div',Ep,[i('div',Mp,[i('div',{class:'progress-fill',style:g({width:ae.value+'%',height:'100%',background:'linear-gradient(90deg, #ffa500 0%, #ff8c00 50%, #ffa500 100%)',backgroundSize:'200% 100%',animation:te.value?'progress-slide 2s linear infinite':'none',transition:'width 0.3s ease'})},null,4)]),i('div',Pp,' 修改中... '+c(ae.value.toFixed(0))+'% ',1)])):o('',!0),i('div',Op,[i('button',{class:'modify-button',disabled:ne.value||!ee.value.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffa500 0%, #ff8c00 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 165, 0, 0.3)',position:'relative',overflow:'hidden'},onClick:Me},[n[77]||(n[77]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[78]||(n[78]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(ne.value?'修改中...':'AI修改'),1)],8,jp),i('button',{class:'clear-modify-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(108, 117, 125, 0.3)',position:'relative',overflow:'hidden'},onClick:Pe},[...n[79]||(n[79]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-eraser',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])])])]),i('div',Rp,[n[86]||(n[86]=i('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-file-import',style:{'margin-right':'6px',color:'#17a2b8'}}),d(' 插入到世界书 ')],-1)),i('div',Np,[n[82]||(n[82]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 选择世界书： ',-1)),l(i('select',{'onUpdate:modelValue':n[12]||(n[12]=e=>K.value=e),style:{width:'100%',padding:'10px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px'}},[n[81]||(n[81]=i('option',{value:'',disabled:''},'请选择世界书',-1)),(r(!0),a(f,null,m(X.value,e=>(r(),a('option',{key:e,value:e},c(e),9,Dp))),128))],512),[[D,K.value]])]),i('div',Lp,[i('button',{class:'insert-button',disabled:!K.value||Q.value,style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:Ce},[n[83]||(n[83]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[84]||(n[84]=i('i',{class:'fa-solid fa-plus-circle',style:{'font-size':'14px'}},null,-1)),d(' '+c(Q.value?'插入中...':'插入条目'),1)],8,Hp),i('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #17a2b8 0%, #138496 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(23, 162, 184, 0.3)',position:'relative',overflow:'hidden'},onClick:Ee},[...n[85]||(n[85]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制 JSON ',-1)])])])])])):o('',!0)])):o('',!0)]),i('div',Vp,[i('div',{class:'section-header viewer-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[13]||(n[13]=e=>me('worldbookViewer')),onMouseenter:n[14]||(n[14]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[15]||(n[15]=e=>e.currentTarget.style.transform='translateY(0)')},[n[89]||(n[89]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-list',style:{color:'#20c997','font-size':'18px'}}),d(' 世界书条目查看器 ')],-1)),i('i',{class:x(xe('worldbookViewer')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888','font-size':'14px',transition:'transform 0.3s ease'}},null,2)],32),xe('worldbookViewer')?(r(),a('div',Up,[n[100]||(n[100]=i('div',{class:'tool-instructions',style:{background:'rgba(32, 201, 151, 0.1)','border-left':'3px solid #20c997',padding:'12px 15px','border-radius':'6px','margin-bottom':'20px'}},[i('p',{style:{margin:'0',color:'#a0f0e0','font-size':'13px',display:'flex','align-items':'center',gap:'8px'}},[i('i',{class:'fa-solid fa-info-circle',style:{color:'#20c997'}}),d(' 选择一个世界书，查看其中所有条目的详细信息，支持搜索和筛选。 ')])],-1)),i('div',Jp,[n[91]||(n[91]=i('label',{style:{display:'block','margin-bottom':'10px',color:'#e0e0e0','font-size':'14px','font-weight':'500','letter-spacing':'0.3px'}},' 选择世界书： ',-1)),l(i('select',{'onUpdate:modelValue':n[16]||(n[16]=e=>oe.value=e),style:{width:'100%',padding:'12px 15px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'},onChange:Oe,onFocus:n[17]||(n[17]=e=>e.target.style.borderColor='#20c997'),onBlur:n[18]||(n[18]=e=>e.target.style.borderColor='rgba(255, 255, 255, 0.1)')},[n[90]||(n[90]=i('option',{value:''},'请选择世界书',-1)),(r(!0),a(f,null,m(X.value,e=>(r(),a('option',{key:e,value:e},c(e),9,Fp))),128))],544),[[D,oe.value]])]),oe.value?(r(),a('div',Bp,[n[92]||(n[92]=i('label',{style:{display:'block','margin-bottom':'10px',color:'#e0e0e0','font-size':'14px','font-weight':'500','letter-spacing':'0.3px'}},' 搜索条目： ',-1)),l(i('input',{'onUpdate:modelValue':n[19]||(n[19]=e=>se.value=e),type:'text',placeholder:'搜索条目名称、关键字或内容...',style:{width:'100%',padding:'12px 15px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',transition:'all 0.3s ease','box-shadow':'inset 0 2px 4px rgba(0, 0, 0, 0.2)'},onFocus:n[20]||(n[20]=e=>e.target.style.borderColor='#20c997'),onBlur:n[21]||(n[21]=e=>e.target.style.borderColor='rgba(255, 255, 255, 0.1)')},null,544),[[p,se.value]])])):o('',!0),oe.value&&re.value.length>0?(r(),a('div',Yp,[i('button',{style:g({padding:'8px 16px',background:'original'===ie.value?'#20c997':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[22]||(n[22]=e=>ie.value='original')},' 原始顺序 ',4),i('button',{style:g({padding:'8px 16px',background:'enabled'===ie.value?'#28a745':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[23]||(n[23]=e=>ie.value='enabled')},' ✓ 全选 ',4),i('button',{style:g({padding:'8px 16px',background:'disabled'===ie.value?'#dc3545':'#444',border:'none',borderRadius:'6px',color:'white',fontSize:'12px',cursor:'pointer',transition:'all 0.2s'}),onClick:n[24]||(n[24]=e=>ie.value='disabled')},' ✕ 取消全选 ',4)])):o('',!0),oe.value?(r(),a('div',Zp,[V(je).length>0?(r(),a('span',Gp,' 共找到 '+c(V(je).length)+' 个条目 ',1)):(r(),a('span',Wp,'未找到条目'))])):o('',!0),V(je).length>0?(r(),a('div',qp,[(r(!0),a(f,null,m(V(je),(e,t)=>(r(),a('div',{key:t,style:{background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'12px',padding:'15px',transition:'all 0.3s ease'}},[i('div',{style:{display:'flex','justify-content':'space-between','align-items':'flex-start',cursor:'pointer','user-select':'none'},onClick:e=>(e=>{const n=le.value.get(e)||!1;le.value.set(e,!n)})(t)},[i('div',Kp,[i('div',Qp,['constant'===e.strategy?.type?(r(),a('span',eu,'🔵')):'selective'===e.strategy?.type?(r(),a('span',nu,'🟢')):(r(),a('span',tu,'⚪')),i('span',au,c(e.name||'(无名称)'),1)]),i('div',ou,[e.strategy?.keys&&e.strategy.keys.length>0?(r(),a('span',ru,' 关键词: '+c(e.strategy.keys.map(e=>'string'==typeof e?e:String(e)).join(', ')),1)):(r(),a('span',su,'关键词: (无)')),e.position?.order&&0!==e.position.order?(r(),a('span',iu,[n[93]||(n[93]=i('span',{style:{color:'#666'}},' | ',-1)),d(' 顺序: '+c(e.position.order),1)])):o('',!0),'at_depth'===e.position?.type&&e.position.depth&&0!==e.position.depth?(r(),a('span',lu,[n[94]||(n[94]=i('span',{style:{color:'#666'}},' | ',-1)),d(' 深度: '+c(e.position.depth),1)])):o('',!0)]),i('div',du,c(e.content?e.content.length>50?e.content.substring(0,50)+'...':e.content:'(无内容)'),1)]),i('i',{class:x(Re(t)?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#888','font-size':'12px','margin-top':'2px'}},null,2)],8,Xp),Re(t)?(r(),a('div',cu,[i('div',pu,[n[95]||(n[95]=i('span',{style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},' ⚙️ 触发策略： ',-1)),i('div',uu,['constant'===e.strategy?.type?(r(),a('span',gu,' 🔵 蓝灯（常量）- 无需关键字匹配 ')):'selective'===e.strategy?.type?(r(),a('span',fu,' 🟢 绿灯（可选项）- 需要关键字匹配 ')):(r(),a('span',mu,' ⚪ 未知类型 '))])]),i('div',xu,[i('span',bu,[n[96]||(n[96]=d(' 🔑 关键字： ',-1)),'constant'===e.strategy?.type?(r(),a('span',hu,' (蓝灯条目通常不需要关键字) ')):o('',!0)]),i('div',yu,[(r(!0),a(f,null,m(e.strategy?.keys||[],(e,n)=>(r(),a('span',{key:n,style:{padding:'4px 10px',background:'#667eea',color:'white','border-radius':'12px','font-size':'11px'}},c('string'==typeof e?e:String(e)),1))),128)),e.strategy?.keys&&0!==e.strategy.keys.length?o('',!0):(r(),a('span',vu,c('constant'===e.strategy?.type?'(蓝灯条目无需关键字)':'(无关键字)'),1))])]),i('div',wu,[n[97]||(n[97]=i('span',{style:{color:'#888','font-size':'12px','font-weight':'600',display:'block','margin-bottom':'6px'}},' 📄 条目内容： ',-1)),i('div',ku,c(e.content||'(无内容)'),1)]),i('div',_u,[i('button',{style:{padding:'8px 16px',background:'#4a9eff',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>(e=>{try{ce.value={uid:e.uid,name:e.name||'',enabled:e.enabled??!0,content:e.content||'',strategy:{type:e.strategy?.type||'selective',keys:[...e.strategy?.keys||[]],keys_secondary:{logic:e.strategy?.keys_secondary?.logic||'and_any',keys:[...e.strategy?.keys_secondary?.keys||[]]},scan_depth:e.strategy?.scan_depth||'same_as_global'},position:e.position?{type:e.position.type||'before_character_definition',role:e.position.role||'system',depth:e.position.depth??0,order:e.position.order??0}:{type:'before_character_definition',role:'system',depth:0,order:0},probability:e.probability??100,recursion:e.recursion?{prevent_incoming:e.recursion.prevent_incoming??!1,prevent_outgoing:e.recursion.prevent_outgoing??!1,delay_until:e.recursion.delay_until??null}:{prevent_incoming:!1,prevent_outgoing:!1,delay_until:null},effect:e.effect?{sticky:e.effect.sticky??null,cooldown:e.effect.cooldown??null,delay:e.effect.delay??null}:{sticky:null,cooldown:null,delay:null}},pe.value=e.uid,de.value=!0}catch(n){console.error('打开编辑界面失败:',n),window.toastr.error('打开编辑界面失败：'+n.message)}})(e)},[...n[98]||(n[98]=[i('i',{class:'fa-solid fa-edit'},null,-1),d(' 编辑 ',-1)])],8,Tu),i('button',{style:{padding:'8px 16px',background:'#ff6b6b',border:'none','border-radius':'6px',color:'white','font-size':'12px',cursor:'pointer',transition:'all 0.2s'},onClick:n=>(async e=>{if(confirm(`确定要删除条目 "${e.name}" 吗？`))try{const{worldbook:n}=await deleteWorldbookEntries(oe.value,n=>n.uid===e.uid);re.value=n,window.toastr.success(`已删除条目 "${e.name}"`)}catch(n){console.error('删除条目失败:',n),window.toastr.error('删除失败：'+n.message)}})(e)},[...n[99]||(n[99]=[i('i',{class:'fa-solid fa-trash'},null,-1),d(' 删除 ',-1)])],8,zu)])])):o('',!0)]))),128))])):o('',!0)])):o('',!0)]),de.value?(r(),a('div',{key:0,style:{position:'fixed',top:'0',left:'0',right:'0',bottom:'0',background:'rgba(0, 0, 0, 0.7)',display:'flex','align-items':'center','justify-content':'center','z-index':'10000','backdrop-filter':'blur(4px)'},onClick:n[44]||(n[44]=s(e=>de.value=!1,['self']))},[i('div',Iu,[i('div',Su,[n[102]||(n[102]=i('h3',{style:{margin:'0',color:'#fff','font-size':'18px','font-weight':'600'}},[i('i',{class:'fa-solid fa-edit',style:{'margin-right':'8px',color:'#4a9eff'}}),d(' 编辑世界书条目 ')],-1)),i('button',{style:{background:'transparent',border:'none',color:'#888','font-size':'20px',cursor:'pointer',padding:'5px 10px',transition:'color 0.2s'},onClick:n[25]||(n[25]=e=>de.value=!1),onMouseenter:n[26]||(n[26]=e=>e.target.style.color='#fff'),onMouseleave:n[27]||(n[27]=e=>e.target.style.color='#888')},[...n[101]||(n[101]=[i('i',{class:'fa-solid fa-times'},null,-1)])],32)]),i('div',Au,[i('div',null,[n[103]||(n[103]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 条目名称： ',-1)),l(i('input',{'onUpdate:modelValue':n[28]||(n[28]=e=>ce.value.name=e),type:'text',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'}},null,512),[[p,ce.value.name]])]),i('div',$u,[l(i('input',{id:'entry-enabled','onUpdate:modelValue':n[29]||(n[29]=e=>ce.value.enabled=e),type:'checkbox',style:{width:'18px',height:'18px',cursor:'pointer'}},null,512),[[N,ce.value.enabled]]),n[104]||(n[104]=i('label',{for:'entry-enabled',style:{color:'#e0e0e0','font-size':'14px',cursor:'pointer'}},' 启用此条目 ',-1))]),i('div',null,[n[105]||(n[105]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 主要关键字： ',-1)),i('input',{value:(ce.value.strategy?.keys||[]).map(e=>'string'==typeof e?e:String(e)).join(','),type:'text',placeholder:'用逗号分隔，如：艾莉娅,Aria,精灵,{{char}}',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[30]||(n[30]=e=>{const n=e.target.value.split(',').filter(e=>e.trim()).map(e=>e.trim());ce.value.strategy={...ce.value.strategy,keys:n,keys_secondary:ce.value.strategy?.keys_secondary||{logic:'and_any',keys:[]},scan_depth:ce.value.strategy?.scan_depth||'same_as_global',type:ce.value.strategy?.type||'selective'}})},null,40,Cu)]),i('div',null,[n[107]||(n[107]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 触发类型： ',-1)),i('select',{value:ce.value.strategy?.type||'selective',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer'},onChange:n[31]||(n[31]=e=>ce.value.strategy={...ce.value.strategy,type:e.target.value,keys:ce.value.strategy?.keys||[],keys_secondary:ce.value.strategy?.keys_secondary||{logic:'and_any',keys:[]},scan_depth:ce.value.strategy?.scan_depth||'same_as_global'})},[...n[106]||(n[106]=[i('option',{value:'selective'},'绿灯 (可选项)',-1),i('option',{value:'constant'},'蓝灯 (常量)',-1)])],40,Eu)]),i('div',null,[n[109]||(n[109]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 插入位置： ',-1)),i('select',{value:ce.value.position?.type||'before_character_definition',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',cursor:'pointer'},onChange:n[32]||(n[32]=e=>ce.value.position={...ce.value.position,type:e.target.value,role:ce.value.position?.role||'system',depth:ce.value.position?.depth||0,order:ce.value.position?.order||0})},[...n[108]||(n[108]=[u('<option value="before_character_definition" data-v-ae874133>角色定义之前</option><option value="after_character_definition" data-v-ae874133>角色定义之后</option><option value="before_example_messages" data-v-ae874133>示例消息之前</option><option value="after_example_messages" data-v-ae874133>示例消息之后</option><option value="before_author_note" data-v-ae874133>作者注释之前</option><option value="after_author_note" data-v-ae874133>作者注释之后</option><option value="at_depth" data-v-ae874133>插入到指定深度</option>',7)])],40,Mu)]),i('div',Pu,[i('div',null,[n[110]||(n[110]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 深度： ',-1)),i('input',{value:ce.value.position?.depth||0,type:'number',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[33]||(n[33]=e=>ce.value.position={...ce.value.position,depth:Number(e.target.value)||0,role:ce.value.position?.role||'system',order:ce.value.position?.order||0,type:ce.value.position?.type||'before_character_definition'})},null,40,Ou)]),i('div',null,[n[111]||(n[111]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 顺序： ',-1)),i('input',{value:ce.value.position?.order||0,type:'number',style:{width:'100%',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px'},onInput:n[34]||(n[34]=e=>ce.value.position={...ce.value.position,order:Number(e.target.value)||0,type:ce.value.position?.type||'before_character_definition',role:ce.value.position?.role||'system',depth:ce.value.position?.depth||0})},null,40,ju)])]),i('div',Ru,[n[115]||(n[115]=i('label',{style:{display:'block','margin-bottom':'12px',color:'#e0e0e0','font-size':'14px','font-weight':'600'}},' 递归设置： ',-1)),i('div',Nu,[i('label',Du,[i('input',{type:'checkbox',checked:ce.value.recursion?.prevent_incoming||!1,onChange:n[35]||(n[35]=e=>ce.value.recursion={...ce.value.recursion,prevent_incoming:e.target.checked,prevent_outgoing:ce.value.recursion?.prevent_outgoing||!1,delay_until:ce.value.recursion?.delay_until||null})},null,40,Lu),n[112]||(n[112]=d(' 禁止其他条目递归激活本条目 ',-1))]),i('label',Hu,[i('input',{type:'checkbox',checked:ce.value.recursion?.prevent_outgoing||!1,onChange:n[36]||(n[36]=e=>ce.value.recursion={...ce.value.recursion,prevent_outgoing:e.target.checked,prevent_incoming:ce.value.recursion?.prevent_incoming||!1,delay_until:ce.value.recursion?.delay_until||null})},null,40,Vu),n[113]||(n[113]=d(' 禁止本条目递归激活其他条目 ',-1))]),i('div',null,[n[114]||(n[114]=i('label',{style:{color:'#ccc','font-size':'13px',display:'block','margin-bottom':'5px'}},' 延迟到第 n 级递归： ',-1)),i('input',{value:ce.value.recursion?.delay_until||'',type:'number',placeholder:'留空表示不延迟',style:{width:'100%',padding:'8px',background:'#2a2a2a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'6px',color:'#e0e0e0','font-size':'13px'},onInput:n[37]||(n[37]=e=>ce.value.recursion={...ce.value.recursion,delay_until:''===e.target.value?null:Number(e.target.value),prevent_incoming:ce.value.recursion?.prevent_incoming||!1,prevent_outgoing:ce.value.recursion?.prevent_outgoing||!1})},null,40,Uu)])])]),i('div',null,[n[116]||(n[116]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#e0e0e0','font-size':'14px','font-weight':'500'}},' 条目内容： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[38]||(n[38]=e=>ce.value.content=e),style:{width:'100%','min-height':'200px',padding:'12px',background:'#1a1a1a',border:'1px solid rgba(255, 255, 255, 0.1)','border-radius':'12px',color:'#e0e0e0','font-size':'14px',resize:'vertical','font-family':'inherit'}},null,512),[[p,ce.value.content]])])]),i('div',Ju,[i('button',{style:{padding:'10px 20px',background:'#444',border:'none','border-radius':'12px',color:'white','font-size':'14px',cursor:'pointer',transition:'all 0.2s'},onClick:n[39]||(n[39]=e=>de.value=!1),onMouseenter:n[40]||(n[40]=e=>e.target.style.background='#555'),onMouseleave:n[41]||(n[41]=e=>e.target.style.background='#444')},' 取消 ',32),i('button',{style:{padding:'10px 20px',background:'#4a9eff',border:'none','border-radius':'12px',color:'white','font-size':'14px','font-weight':'600',cursor:'pointer',transition:'all 0.2s'},onClick:Ne,onMouseenter:n[42]||(n[42]=e=>e.target.style.background='#5ba8ff'),onMouseleave:n[43]||(n[43]=e=>e.target.style.background='#4a9eff')},[...n[117]||(n[117]=[i('i',{class:'fa-solid fa-save',style:{'margin-right':'6px'}},null,-1),d(' 保存 ',-1)])],32)])])])):o('',!0),i('div',Fu,[i('div',{class:'section-header',style:{display:'flex','justify-content':'space-between','align-items':'center',padding:'15px 20px',background:'linear-gradient(\n            135deg,\n            rgba(30, 30, 30, 0.95) 0%,\n            rgba(38, 38, 38, 0.9) 50%,\n            rgba(30, 30, 30, 0.95) 100%\n          )','backdrop-filter':'blur(12px)','border-radius':'12px','margin-bottom':'15px',border:'1px solid rgba(255, 255, 255, 0.06)','box-shadow':'0 3px 12px rgba(0, 0, 0, 0.3),\n            inset 0 1px 0 rgba(255, 255, 255, 0.04),\n            inset 0 -1px 0 rgba(0, 0, 0, 0.2)',cursor:'pointer',transition:'all 0.3s ease'},onClick:n[45]||(n[45]=e=>me('characterCard')),onMouseenter:n[46]||(n[46]=e=>e.currentTarget.style.transform='translateY(-1px)'),onMouseleave:n[47]||(n[47]=e=>e.currentTarget.style.transform='translateY(0)')},[n[118]||(n[118]=i('h4',{style:{margin:'0',color:'#fff','font-size':'16px','font-weight':'600',display:'flex','align-items':'center',gap:'10px'}},[i('i',{class:'fa-solid fa-user-plus',style:{color:'#17a2b8','font-size':'18px'}}),d(' 角色卡生成工具 ')],-1)),i('i',{class:x(xe('characterCard')?'fa-solid fa-chevron-up':'fa-solid fa-chevron-down'),style:{color:'#ccc',transition:'transform 0.3s ease','font-size':'14px'}},null,2)],32),xe('characterCard')?(r(),a('div',Bu,[n[137]||(n[137]=u('<div class="tool-instructions" data-v-ae874133><p style="margin:0 0 8px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-info-circle" style="margin-right:6px;color:#17a2b8;" data-v-ae874133></i> 输入角色描述，AI将自动生成角色卡（YAML 格式，纯中文）。 </p><p style="margin:0 0 6px 0;color:#4a9eff;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #17a2b8;" data-v-ae874133> 💡 包含内容：基础信息、外貌身材、核心性格、对话风格、背景经历、人际关系、演绎指导 </p><p style="margin:0 0 6px 0;color:#ffa500;font-size:11px;background:#1a1a1a;padding:6px;border-radius:4px;border-left:3px solid #ffa500;" data-v-ae874133> ⚠️ 注意：身高体重使用文字描述（如&quot;高大匀称&quot;），避免AI刻板化，有性格对立面和修复机制 </p></div>',1)),i('div',Yu,[n[119]||(n[119]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 角色描述： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[48]||(n[48]=e=>H.value=e),placeholder:'请描述角色的基本信息，如外观、性格、背景等...',style:{width:'100%',height:'120px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,H.value]])]),i('div',Zu,[i('label',Gu,[l(i('input',{'onUpdate:modelValue':n[49]||(n[49]=e=>Y.value=e),type:'checkbox',style:{cursor:'pointer'}},null,512),[[N,Y.value]]),n[120]||(n[120]=d(' 启用流式传输（可查看生成进度） ',-1))])]),J.value&&Z.value>0?(r(),a('div',Wu,[i('div',qu,[n[122]||(n[122]=i('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(23, 162, 184, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),i('div',{class:'progress-fill',style:g({position:'relative',width:Z.value+'%',height:'100%',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)',backgroundSize:'200% 100%',animation:Y.value?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(23, 162, 184, 0.5)'})},[...n[121]||(n[121]=[i('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),i('div',Xu,[i('span',Ku,' 生成中... '+c(Z.value.toFixed(0))+'% ',1),n[123]||(n[123]=i('div',{style:{display:'flex',gap:'4px'}},[i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):o('',!0),i('div',Qu,[i('button',{class:'generate-button',disabled:J.value||!H.value.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #17a2b8 0%, #138496 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(23, 162, 184, 0.3)',position:'relative',overflow:'hidden'},onClick:we},[n[124]||(n[124]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[125]||(n[125]=i('i',{class:'fa-solid fa-magic',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(J.value?'生成中...':'生成角色卡'),1)],8,eg),i('button',{class:'clear-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 107, 107, 0.3)',position:'relative',overflow:'hidden'},onClick:ke},[...n[126]||(n[126]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-trash',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空 ',-1)])])]),U.value?(r(),a('div',ng,[n[136]||(n[136]=i('h5',{style:{margin:'0 0 12px 0',color:'#fff','font-size':'14px','font-weight':'600'}},[i('i',{class:'fa-solid fa-check-circle',style:{'margin-right':'6px',color:'#28a745'}}),d(' 生成的角色卡： ')],-1)),i('div',tg,c(U.value),1),i('div',{class:'output-actions',style:{'margin-top':'12px',display:'flex',gap:'12px'}},[i('button',{class:'copy-button',style:{padding:'10px 20px',background:'linear-gradient(135deg, #28a745 0%, #20c997 100%)',border:'none','border-radius':'6px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease',display:'flex','align-items':'center',gap:'8px','box-shadow':'0 3px 12px rgba(40, 167, 69, 0.3)',position:'relative',overflow:'hidden'},onClick:_e},[...n[127]||(n[127]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-copy',style:{'font-size':'14px'}},null,-1),d(' 复制角色卡 ',-1)])])]),i('div',ag,[n[135]||(n[135]=u('<h5 style="margin:0 0 12px 0;color:#fff;font-size:14px;font-weight:600;" data-v-ae874133><i class="fa-solid fa-edit" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 修改角色卡 </h5><div class="modify-instructions" style="background:#1a1a1a;border:1px solid #3a3a3a;border-radius:6px;padding:10px;margin-bottom:15px;" data-v-ae874133><p style="margin:0 0 6px 0;color:#ccc;font-size:12px;" data-v-ae874133><i class="fa-solid fa-lightbulb" style="margin-right:6px;color:#ffa500;" data-v-ae874133></i> 描述你想要修改的内容，AI会根据你的需求调整角色卡。例如：&quot;让角色更活泼一些&quot;、&quot;增加魔法技能&quot;、&quot;改为女性角色&quot;等。 </p><p style="margin:0;color:#ffa500;font-size:11px;" data-v-ae874133>⚠️ 修改后会保持 YAML 格式和中文字段。</p></div>',2)),i('div',og,[n[128]||(n[128]=i('label',{style:{display:'block','margin-bottom':'8px',color:'#ccc','font-size':'13px','font-weight':'500'}},' 修改需求： ',-1)),l(i('textarea',{'onUpdate:modelValue':n[50]||(n[50]=e=>F.value=e),placeholder:'请描述你想要修改的内容...',style:{width:'100%',height:'80px',padding:'12px',background:'#2a2a2a',border:'1px solid #3a3a3a','border-radius':'6px',color:'#e0e0e0','font-size':'13px',resize:'vertical','font-family':'inherit'}},null,512),[[p,F.value]])]),B.value&&Z.value>0?(r(),a('div',rg,[i('div',sg,[n[130]||(n[130]=i('div',{style:{position:'absolute',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent 0%, rgba(23, 162, 184, 0.2) 50%, transparent 100%)','background-size':'200% 100%',animation:'progress-glow 2s linear infinite'}},null,-1)),i('div',{class:'progress-fill',style:g({position:'relative',width:Z.value+'%',height:'100%',background:'linear-gradient(90deg, #17a2b8 0%, #138496 50%, #17a2b8 100%)',backgroundSize:'200% 100%',animation:Y.value?'progress-slide 2s linear infinite':'none',transition:'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',borderRadius:'12px',boxShadow:'0 0 10px rgba(23, 162, 184, 0.5)'})},[...n[129]||(n[129]=[i('div',{style:{position:'absolute',top:'0',left:'0',width:'100%',height:'50%',background:'linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%)','border-radius':'12px 12px 0 0'}},null,-1)])],4)]),i('div',ig,[i('span',lg,' 修改中... '+c(Z.value.toFixed(0))+'% ',1),n[131]||(n[131]=i('div',{style:{display:'flex',gap:'4px'}},[i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.2s infinite'}}),i('div',{style:{width:'6px',height:'6px',background:'#17a2b8','border-radius':'50%',animation:'bounce-small 1.4s ease-in-out 0.4s infinite'}})],-1))])])):o('',!0),i('div',dg,[i('button',{class:'modify-button',disabled:B.value||!F.value.trim(),style:{padding:'12px 24px',background:'linear-gradient(135deg, #ffa500 0%, #ff8c00 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(255, 165, 0, 0.3)',position:'relative',overflow:'hidden'},onClick:ze},[n[132]||(n[132]=i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1)),n[133]||(n[133]=i('i',{class:'fa-solid fa-wand-magic-sparkles',style:{'font-size':'14px','margin-right':'6px'}},null,-1)),d(' '+c(B.value?'修改中...':'AI修改'),1)],8,cg),i('button',{class:'clear-modify-button',style:{padding:'12px 24px',background:'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)',border:'none','border-radius':'12px',color:'white','font-size':'13px','font-weight':'600',cursor:'pointer',transition:'all 0.3s ease','box-shadow':'0 3px 12px rgba(108, 117, 125, 0.3)',position:'relative',overflow:'hidden'},onClick:Ie},[...n[134]||(n[134]=[i('div',{style:{position:'absolute',top:'0',left:'-100%',width:'100%',height:'100%',background:'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent)',transition:'left 0.5s'},class:'shimmer-effect'},null,-1),i('i',{class:'fa-solid fa-eraser',style:{'font-size':'14px','margin-right':'6px'}},null,-1),d(' 清空修改需求 ',-1)])])])])])):o('',!0)])):o('',!0)])]))}}),[['__scopeId','data-v-ae874133']]),ug={class:'memory-panel-container',style:{display:'flex','flex-direction':'column',height:'100%',background:'#1a1a1a',color:'#e0e0e0'}},gg={class:'panel-tabs',style:{display:'flex',background:'#222','border-bottom':'1px solid rgba(255, 255, 255, 0.05)','flex-shrink':'0','overflow-x':'auto','scrollbar-width':'none','-ms-overflow-style':'none'}},fg=['onClick'],mg={class:'tab-label'},xg={class:'panel-content',style:{flex:'1','overflow-y':'auto','overflow-x':'hidden',padding:'0','min-height':'0','scrollbar-width':'thin','scrollbar-color':'#4a9eff #2a2a2a'}},bg=xo(e({__name:'MainPanel',setup(e){const t=[{key:'settings',label:'设置',icon:'fa-solid fa-cog'},{key:'summary',label:'历史总结',icon:'fa-solid fa-list'},{key:'table',label:'表格',icon:'fa-solid fa-table'},{key:'greetings',label:'开场白',icon:'fa-solid fa-comments'},{key:'regex',label:'界面生成器',icon:'fa-solid fa-code'},{key:'status',label:'状态栏生成',icon:'fa-solid fa-chart-bar'},{key:'project',label:'前端项目',icon:'fa-solid fa-laptop-code'},{key:'tools',label:'工具模板',icon:'fa-solid fa-tools'},{key:'mvu',label:'MVU Beta',icon:'fa-solid fa-flask'},{key:'help',label:'帮助',icon:'fa-solid fa-question-circle'}],o=n('settings'),s={settings:td,summary:kc,table:Hc,greetings:pr,status:oc,regex:Xi,project:Si,tools:pg,mvu:Vr,help:br},l=v(()=>s[o.value]),d=v(()=>({activeTab:o.value})),p=()=>{vg()},b=()=>{$('#memoryManagementPanel').fadeOut(200)};return(e,n)=>(r(),a('div',ug,[n[3]||(n[3]=i('div',{style:{background:'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)',color:'#fff','text-align':'center',padding:'8px 16px','font-weight':'700','font-size':'13px','letter-spacing':'1px','text-shadow':'0 1px 3px rgba(0, 0, 0, 0.5)','border-bottom':'2px solid #7f1d1d','flex-shrink':'0'}},' ⚠️ 商业化死全家，贩子死全家 ⚠️ ',-1)),i('div',{class:'panel-header',style:{padding:'16px 24px',background:'#252525','border-bottom':'1px solid rgba(255, 255, 255, 0.05)',display:'flex','justify-content':'space-between','align-items':'center','flex-shrink':'0','box-shadow':'0 2px 8px rgba(0, 0, 0, 0.15)'}},[n[2]||(n[2]=u('<div class="header-left" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;" data-v-27a46729><span class="header-icon" style="font-size:26px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));" data-v-27a46729>🐱</span><div style="display:flex;flex-direction:column;gap:4px;" data-v-27a46729><span class="panel-title" style="font-size:16px;font-weight:600;color:#fff;letter-spacing:0.5px;" data-v-27a46729>猫猫的小破烂 - 商业化死全家，贩子死全家</span><span style="font-size:11px;color:#ef4444;font-weight:700;text-shadow:0 0 8px rgba(239, 68, 68, 0.5);letter-spacing:0.5px;" data-v-27a46729>⚠️ 禁止商业化 | 禁止倒卖 ⚠️</span></div></div>',1)),i('div',{class:'header-actions',style:{display:'flex',gap:'8px','align-items':'center'}},[i('button',{class:'header-button minimize-button',title:'最小化',style:{width:'32px',height:'32px',display:'flex','align-items':'center','justify-content':'center',border:'none',background:'rgba(255, 255, 255, 0.05)',color:'#e0e0e0','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease','font-size':'14px'},onClick:p},[...n[0]||(n[0]=[i('i',{class:'fa-solid fa-minus'},null,-1)])]),i('button',{class:'header-button close-button',title:'关闭',style:{width:'32px',height:'32px',display:'flex','align-items':'center','justify-content':'center',border:'none',background:'rgba(255, 255, 255, 0.05)',color:'#e0e0e0','border-radius':'6px',cursor:'pointer',transition:'all 0.2s ease','font-size':'14px'},onClick:b},[...n[1]||(n[1]=[i('i',{class:'fa-solid fa-times'},null,-1)])])])]),i('div',gg,[(r(),a(f,null,m(t,e=>i('div',{key:e.key,class:x([{'tab-active':o.value===e.key},'tab-item']),style:g({flex:'0 0 auto',minWidth:'120px',padding:'14px 20px',cursor:'pointer',textAlign:'center',transition:'all 0.25s ease',display:'flex',alignItems:'center',justifyContent:'center',gap:'8px',position:'relative',background:o.value===e.key?'#1a1a1a':'transparent',color:o.value===e.key?'#4a9eff':'#999',borderBottom:o.value===e.key?'2px solid #4a9eff':'2px solid transparent',fontSize:'13px',fontWeight:'500'}),onClick:n=>{return t=e.key,console.log('切换标签页:',t),void(o.value=t);var t}},[i('i',{class:x([e.icon,'tab-icon'])},null,2),i('span',mg,c(e.label),1)],14,fg)),64))]),i('div',xg,[(r(),U(J(V(l)),F({key:o.value},V(d)),null,16))])]))}}),[['__scopeId','data-v-27a46729']]),hg=e({__name:'浮动面板',setup:e=>(e,n)=>(r(),U(bg))});function yg(){const e=$('#memoryPanelMinimizeIcon');if(e.length>0)return e.fadeIn(200),e;const n=window.innerWidth<=768,t=$(`\n    <div id="memoryPanelQuickMenu" style="\n      position: fixed;\n      top: 0;\n      left: 0;\n      background: #2a2a2a;\n      border: 2px solid #4a9eff;\n      border-radius: 12px;\n      padding: 8px;\n      display: none;\n      z-index: 999999;\n      box-shadow: 0 8px 32px rgba(74, 158, 255, 0.6), 0 4px 16px rgba(0, 0, 0, 0.8);\n      min-width: 200px;\n      max-height: 80vh;\n      overflow-y: auto;\n    ">\n      <div style="\n        padding: 8px 12px;\n        color: #4a9eff;\n        font-size: 12px;\n        font-weight: 600;\n        border-bottom: 1px solid rgba(74, 158, 255, 0.2);\n        margin-bottom: 4px;\n      ">\n        快捷访问\n      </div>\n      ${[{key:'settings',label:'⚙️ 设置',icon:'fa-solid fa-cog'},{key:'summary',label:'📝 历史总结',icon:'fa-solid fa-list'},{key:'table',label:'📊 表格',icon:'fa-solid fa-table'},{key:'greetings',label:'💬 开场白',icon:'fa-solid fa-comments'},{key:'regex',label:'🎨 界面生成器',icon:'fa-solid fa-code'},{key:'status',label:'📈 状态栏生成',icon:'fa-solid fa-chart-bar'},{key:'project',label:'💻 前端项目',icon:'fa-solid fa-laptop-code'},{key:'tools',label:'🛠️ 工具模板',icon:'fa-solid fa-tools'},{key:'mvu',label:'🧪 MVU Beta',icon:'fa-solid fa-flask'},{key:'help',label:'❓ 帮助',icon:'fa-solid fa-question-circle'}].map(e=>`\n        <div class="quick-menu-item" data-tab="${e.key}" style="\n          padding: 10px 12px;\n          margin: 2px 0;\n          cursor: pointer;\n          border-radius: 8px;\n          transition: all 0.2s;\n          color: #e0e0e0;\n          font-size: 13px;\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          background: transparent;\n        ">\n          ${e.label}\n        </div>\n      `).join('')}\n    </div>\n  `);t.find('.quick-menu-item').hover(function(){$(this).css({background:'rgba(74, 158, 255, 0.15)',color:'#4a9eff',transform:'translateX(-3px)'})},function(){$(this).css({background:'transparent',color:'#e0e0e0',transform:'translateX(0)'})}),t.find('.quick-menu-item').on('click',function(){const e=$(this).data('tab'),n=$('#memoryManagementPanel');n.is(':visible')||n.fadeIn(200),setTimeout(()=>{const t=['settings','summary','table','greetings','regex','status','project','tools','mvu','help'].indexOf(e);if(t>=0){const e=n.find('.tab-item');e.length>t&&e.eq(t).trigger('click')}},150),t.fadeOut(200)}),t.css({'scrollbar-width':'thin','scrollbar-color':'#4a9eff #1a1a1a'});const a=$(`\n    <div id="memoryPanelMinimizeIcon" style="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      width: ${n?'64px':'72px'};\n      height: ${n?'64px':'72px'};\n      background: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);\n      border: 3px solid #4a9eff;\n      border-radius: 50%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      z-index: 999998;\n      box-shadow: 0 4px 16px rgba(74, 158, 255, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);\n      transition: all 0.3s ease;\n      font-size: ${n?'32px':'38px'};\n    ">\n      🐱\n    </div>\n  `);let o=null;return a.hover(function(){o&&(clearTimeout(o),o=null),$(this).css({transform:'scale(1.15) rotate(5deg)',boxShadow:'0 6px 24px rgba(74, 158, 255, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4)',borderColor:'#5ab0ff'}),t.css('opacity','0').show(),function(){const e=a.offset(),n=a.outerWidth()||72,o=a.outerHeight()||72,r=t.outerWidth()||200,s=t.outerHeight()||400;if(console.log('🔍 位置计算开始:',{iconPos:e,iconWidth:n,iconHeight:o,menuWidth:r,menuHeight:s}),!e)return void console.warn('⚠️ 图标位置获取失败');let i=e.left-r-10,l=e.top;console.log('📍 初始位置（图标左侧）:',{left:i,top:l}),i<10&&(i=e.left+n+10,console.log('📍 左侧不够，移到右侧:',i));const d=$(window).width()||1920;i+r>d-10&&(i=e.left-(r-n)/2,e.top>s+10?(l=e.top-s-10,console.log('📍 右侧不够，移到上方:',{left:i,top:l})):(l=e.top+o+10,console.log('📍 右侧不够，移到下方:',{left:i,top:l})));const c=$(window).height()||1080,p=Math.max(10,Math.min(i,d-r-10)),u=Math.max(10,Math.min(l,c-Math.min(s,.8*c)-10));console.log('✅ 最终位置:',{finalLeft:p,finalTop:u,windowWidth:d,windowHeight:c}),t.css({left:p+'px',top:u+'px'})}(),t.css('opacity','1').hide().fadeIn(200),console.log('🎯 快捷菜单已显示，位置:',t.offset())},function(){$(this).css({transform:'scale(1) rotate(0deg)',boxShadow:'0 4px 16px rgba(74, 158, 255, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3)',borderColor:'#4a9eff'}),o=window.setTimeout(()=>{t.is(':hover')||t.fadeOut(200)},200)}),t.hover(function(){o&&(clearTimeout(o),o=null)},function(){t.fadeOut(200)}),a.on('click',()=>{const e=$('#memoryManagementPanel');e.is(':visible')?(e.fadeOut(200),a.fadeIn(200)):e.fadeIn(200)}),a.draggable({containment:'window',scroll:!1,start:function(){$(this).css('transition','none'),t.hide()},stop:function(){$(this).css('transition','all 0.3s ease')}}),$('body').append(t),$('body').append(a),console.log('✅ 最小化图标已创建:',a),console.log('✅ 快捷菜单已创建:',t),console.log('📍 快捷菜单是否在页面中:',$('#memoryPanelQuickMenu').length>0),a}function vg(){const e=$('#memoryManagementPanel');0!==e.length&&(e.fadeOut(200),yg())}function wg(){const e=$('#memoryManagementPanel');0!==e.length&&(e.is(':visible')?e.fadeOut(200):e.fadeIn(200))}$(()=>{if(console.log('浮动面板.ts 开始执行'),0===$('#memory-panel-responsive-css').length){const e='\n      <style id="memory-panel-responsive-css">\n        /* 桌面端（横屏）：隐藏移动端专用标题 */\n        .panel-title-mobile {\n          display: none;\n        }\n        \n        /* 桌面端（横屏）：显示完整标题 */\n        .panel-title {\n          display: inline;\n        }\n        \n        /* 移动端全局样式 - 改用宽度判断，适配所有小屏设备 */\n        @media (max-width: 768px) {\n          /* 移动端：面板容器全屏显示 - 使用最高优先级覆盖内联样式 */\n          body #memoryManagementPanel {\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            transform: none !important;\n            width: 100vw !important;\n            max-width: 100vw !important;\n            height: 100vh !important;\n            max-height: 100vh !important;\n            min-width: 100vw !important;\n            min-height: 100vh !important;\n            border-radius: 0 !important;\n            border: none !important;\n            margin: 0 !important;\n            padding: 0 !important;\n          }\n          \n          /* 移动端：隐藏完整标题，显示简短标题 */\n          .panel-title {\n            display: none !important;\n          }\n          \n          .panel-title-mobile {\n            display: inline !important;\n            font-size: 14px !important;\n          }\n          \n          /* 移动端：隐藏最小化按钮 */\n          .minimize-button {\n            display: none !important;\n          }\n          \n          /* 移动端：调整头部样式 */\n          .panel-header {\n            padding: 12px 16px !important;\n            border-radius: 0 !important;\n          }\n          \n          .panel-header .header-left {\n            gap: 8px !important;\n          }\n          \n          .panel-header .header-left .header-icon {\n            font-size: 24px !important;\n          }\n          \n          .panel-header .header-left .panel-title {\n            font-size: 15px !important;\n          }\n          \n          .panel-header > div:last-child {\n            gap: 8px !important;\n          }\n          \n          /* 移动端：头部按钮 */\n          .panel-header .header-button {\n            width: 40px !important;\n            height: 40px !important;\n            min-width: 40px !important;\n            min-height: 40px !important;\n            padding: 0 !important;\n            font-size: 16px !important;\n            border-radius: 8px !important;\n          }\n          \n          /* 移动端：标签栏可横向滚动 */\n          .panel-tabs {\n            overflow-x: auto !important;\n            overflow-y: hidden !important;\n            white-space: nowrap !important;\n            -webkit-overflow-scrolling: touch !important;\n            padding: 0 8px !important;\n          }\n          \n          .panel-tabs::-webkit-scrollbar {\n            height: 3px !important;\n          }\n          \n          .panel-tabs .tab-item {\n            flex: 0 0 auto !important;\n            padding: 12px 16px !important;\n            font-size: 13px !important;\n            gap: 6px !important;\n            min-width: auto !important;\n            border-radius: 0 !important; /* 移动端标签不需要圆角 */\n          }\n          \n          .panel-tabs .tab-item .tab-icon {\n            font-size: 15px !important;\n          }\n          \n          .panel-tabs .tab-item .tab-label {\n            white-space: nowrap !important;\n            font-weight: 500 !important;\n          }\n          \n          /* 移动端：内容区域优化 */\n          .memory-panel-container {\n            font-size: 14px !important;\n          }\n          \n          /* 移动端：面板内容区域滚动优化 */\n          .panel-content {\n            overflow-y: auto !important;\n            overflow-x: hidden !important;\n            -webkit-overflow-scrolling: touch !important;\n            height: 100% !important;\n            padding: 12px !important;\n          }\n          \n          /* 移动端：确保标签页内容不超出 */\n          .memory-panel-container .tab-content {\n            max-width: 100vw !important;\n            overflow-x: hidden !important;\n          }\n          \n          /* 移动端：按钮优化 */\n          .memory-panel-container button,\n          .memory-panel-container .el-button {\n            padding: 12px 18px !important;\n            font-size: 14px !important;\n            min-height: 48px !important; /* iOS推荐的最小触摸区域 */\n            border-radius: 12px !important; /* 统一圆角 */\n            font-weight: 500 !important;\n          }\n          \n          /* 移动端：小按钮优化 */\n          .memory-panel-container .mini-button,\n          .memory-panel-container .show-button {\n            padding: 10px 16px !important;\n            min-height: 44px !important;\n            font-size: 13px !important;\n            border-radius: 10px !important;\n          }\n          \n          /* 移动端：复选框优化 */\n          .memory-panel-container input[type="checkbox"] {\n            width: 20px !important;\n            height: 20px !important;\n            min-width: 20px !important;\n            min-height: 20px !important;\n            cursor: pointer !important;\n          }\n          \n          /* 移动端：按钮组堆叠（只针对按钮组，不影响主布局） */\n          .memory-panel-container .button-group,\n          .memory-panel-container .project-action-buttons {\n            flex-direction: column !important;\n            gap: 8px !important;\n          }\n          \n          .memory-panel-container .button-group > *,\n          .memory-panel-container .button-group button,\n          .memory-panel-container .project-action-buttons > button {\n            width: 100% !important;\n            margin: 0 !important;\n          }\n          \n          /* 移动端：对话框内的按钮堆叠 */\n          .memory-panel-container .dialog-actions,\n          .memory-panel-container [style*="justify-content: flex-end"] {\n            flex-direction: column !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .dialog-actions > button {\n            width: 100% !important;\n          }\n          \n          /* 移动端：输入框优化 */\n          .memory-panel-container input,\n          .memory-panel-container textarea,\n          .memory-panel-container select {\n            font-size: 16px !important; /* 防止iOS自动缩放 */\n            padding: 12px !important;\n            min-height: 44px !important;\n          }\n          \n          .memory-panel-container textarea {\n            min-height: 120px !important;\n          }\n          \n          /* 移动端：表单项间距 */\n          .memory-panel-container .form-group,\n          .memory-panel-container [style*="margin"] {\n            margin-bottom: 16px !important;\n          }\n          \n          /* 移动端：卡片/面板内边距 */\n          .memory-panel-container .card,\n          .memory-panel-container .panel,\n          .memory-panel-container .section {\n            padding: 12px !important;\n            margin: 8px 0 !important;\n          }\n          \n          /* 移动端：字段组优化 */\n          .memory-panel-container .field-group,\n          .memory-panel-container [class*="field"] {\n            padding: 8px !important;\n            margin-bottom: 12px !important;\n          }\n          \n          /* 移动端：工具区域优化 */\n          .memory-panel-container .tool-section,\n          .memory-panel-container .section-content {\n            padding: 12px 8px !important;\n          }\n          \n          /* 移动端：预览区域优化 */\n          .memory-panel-container .preview-container,\n          .memory-panel-container [class*="preview"] {\n            padding: 8px !important;\n            max-width: 100% !important;\n            overflow-x: auto !important;\n          }\n          \n          /* 移动端：标题字体 */\n          .memory-panel-container h1,\n          .memory-panel-container h2,\n          .memory-panel-container h3,\n          .memory-panel-container h4,\n          .memory-panel-container h5 {\n            font-size: 16px !important;\n            margin-bottom: 12px !important;\n          }\n          \n          /* 移动端：对话框全屏 */\n          .memory-panel-container .modal,\n          .memory-panel-container .dialog {\n            width: 100vw !important;\n            height: 100vh !important;\n            max-width: 100vw !important;\n            max-height: 100vh !important;\n            border-radius: 0 !important;\n            top: 0 !important;\n            left: 0 !important;\n            transform: none !important;\n          }\n          \n          /* 移动端：滚动条优化 */\n          .memory-panel-container ::-webkit-scrollbar {\n            width: 3px !important;\n            height: 3px !important;\n          }\n          \n          /* 移动端：减小字段间的gap */\n          .memory-panel-container [style*="gap: 1"] {\n            gap: 8px !important;\n          }\n          \n          .memory-panel-container [style*="gap: 2"] {\n            gap: 12px !important;\n          }\n          \n          /* 移动端：工具区域按钮组优化 */\n          .memory-panel-container .tool-section .button-group {\n            display: flex !important;\n            flex-direction: column !important;\n            width: 100% !important;\n          }\n          \n          /* 移动端：状态栏生成器字段优化（只针对字段，不影响主布局） */\n          .memory-panel-container .field-item {\n            flex-direction: column !important;\n            align-items: stretch !important;\n          }\n          \n          .memory-panel-container .field-item > * {\n            width: 100% !important;\n            margin-bottom: 8px !important;\n          }\n          \n          /* 移动端：两栏布局改为单列（只针对设置项，不影响主布局） */\n          .memory-panel-container [style*="display: grid"][style*="grid-template-columns: 1fr 1fr"] {\n            grid-template-columns: 1fr !important;\n          }\n          \n          /* 移动端：三栏布局改为单列！！！最重要的修复！ */\n          /* 用更通用的选择器强制覆盖所有grid布局 */\n          .memory-panel-container div[style*="display: grid"],\n          .memory-panel-container > div[style*="display: grid"],\n          .panel-content > div[style*="display: grid"],\n          body [style*="display: grid"][style*="grid-template-columns"] {\n            display: flex !important;\n            flex-direction: column !important;\n            gap: 12px !important;\n          }\n          \n          /* 移动端：所有带固定宽度的元素强制改为100%宽度 */\n          .memory-panel-container div[style*="width: 280px"],\n          .memory-panel-container div[style*="width: 300px"],\n          .memory-panel-container div[style*="width: 500px"],\n          .memory-panel-container div[style*="width: 600px"],\n          .memory-panel-container div[style*="max-width: 600px"],\n          .memory-panel-container div[style*="max-width: 90vw"],\n          body #memoryManagementPanel div[style*="width:"],\n          body #memoryManagementPanel div[style*="min-height: 600px"] {\n            width: 100% !important;\n            max-width: 100% !important;\n            min-width: auto !important;\n          }\n          \n          /* 移动端：强制所有子div在容器内正确显示 */\n          .memory-panel-container > div > div,\n          .panel-content > div > div {\n            max-width: 100% !important;\n            overflow-x: hidden !important;\n          }\n          \n          /* 移动端：开场白管理器整体布局优化 */\n          .memory-panel-container .greetings-tab > div[style*="display: flex"][style*="gap: 20px"] {\n            flex-direction: column !important;\n            gap: 15px !important;\n          }\n          \n          .memory-panel-container .greetings-tab > div > div[style*="flex: 1"] {\n            width: 100% !important;\n            flex: none !important;\n            max-height: 50vh !important;\n          }\n          \n          /* 移动端：开场白管理器顶部操作按钮优化 */\n          .memory-panel-container .header-actions {\n            flex-wrap: wrap !important;\n            justify-content: center !important;\n          }\n          \n          .memory-panel-container .header-actions .mini-button {\n            flex: 1 1 auto !important;\n            min-width: 120px !important;\n          }\n          \n          /* 移动端：开场白管理器底部操作按钮堆叠 */\n          .memory-panel-container .greetings-tab > div > div > div[style*="position: sticky"][style*="bottom: 0"] {\n            flex-direction: column !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .greetings-tab > div > div > div[style*="position: sticky"] button {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n          \n          /* 移动端：开场白管理器配置界面优化 */\n          .memory-panel-container .greeting-item > div:first-child {\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 10px !important;\n          }\n          \n          .memory-panel-container .greeting-item input[placeholder*="图标"] {\n            width: 100% !important;\n            max-width: 80px !important;\n            margin: 0 auto !important;\n          }\n          \n          .memory-panel-container .greeting-item input[placeholder*="开场白"],\n          .memory-panel-container .greeting-item input[placeholder*="默认"] {\n            width: 100% !important;\n            flex: none !important;\n          }\n          \n          .memory-panel-container .greeting-item button {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n          \n          /* 移动端：开场白选择器网格布局优化 */\n          .memory-panel-container iframe,\n          body iframe[srcdoc*="scene-grid"] {\n            width: 100% !important;\n            max-width: 100% !important;\n          }\n          \n          /* 移动端：iframe内的网格布局也要优化（开场白选择器） */\n          @supports (-webkit-touch-callout: none) {\n            /* iOS Safari特殊处理 */\n            body iframe {\n              width: 100% !important;\n              max-width: 100vw !important;\n            }\n          }\n          \n          /* 移动端：删除/操作按钮优化 */\n          .memory-panel-container .delete-button,\n          .memory-panel-container [class*="delete"],\n          .memory-panel-container .action-button {\n            min-width: 44px !important;\n            min-height: 44px !important;\n            padding: 8px !important;\n          }\n          \n          /* 移动端：表单label优化 */\n          .memory-panel-container label {\n            font-size: 13px !important;\n            margin-bottom: 6px !important;\n            display: block !important;\n          }\n          \n          /* 移动端：防止内容超出视口（只针对表单元素和文本） */\n          .memory-panel-container input,\n          .memory-panel-container textarea,\n          .memory-panel-container select,\n          .memory-panel-container button,\n          .memory-panel-container pre,\n          .memory-panel-container code {\n            max-width: 100% !important;\n            word-wrap: break-word !important;\n          }\n          \n          /* 移动端：字段标题区域 */\n          .memory-panel-container .section-header {\n            padding: 16px !important;\n            font-size: 14px !important;\n            flex-direction: column !important;\n            align-items: stretch !important;\n            gap: 12px !important;\n          }\n          \n          .memory-panel-container .section-header h3 {\n            font-size: 15px !important;\n            margin-bottom: 0 !important;\n          }\n          \n          /* 移动端：减少不必要的空白 */\n          .memory-panel-container .empty-space,\n          .memory-panel-container [style*="padding: 20px"],\n          .memory-panel-container [style*="padding: 25px"] {\n            padding: 12px !important;\n          }\n          \n          /* 移动端：缩小最小化图标 */\n          #memoryPanelMinimizeIcon {\n            width: 48px !important;\n            height: 48px !important;\n            top: 15px !important;\n            right: 15px !important;\n          }\n          \n          #memoryPanelMinimizeIcon i {\n            font-size: 22px !important;\n          }\n        }\n      </style>\n    ';$('head').append(e),console.log('📱 移动端响应式CSS已注入')}setTimeout(()=>{console.log('浮动面板.ts setTimeout 回调执行');const e=$('#memoryManagementPanel');e.length>0&&(console.log('mzrodyu猫猫的小破烂浮动面板已存在，强制删除并重新创建...'),e.remove(),setTimeout(()=>{console.log('旧面板已删除，开始创建新面板...')},100)),console.log('🚀🚀🚀 开始创建面板容器 - 时间戳:',(new Date).toISOString());const n=$('\n      <div id="memoryManagementPanel" style="\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 95vw;\n        max-width: 1600px;\n        height: 92vh;\n        max-height: 92vh;\n        background: #1a1a1a;\n        border: 1px solid #3a3a3a;\n        border-radius: 8px;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);\n        z-index: 999999;\n        display: flex;\n        flex-direction: column;\n        overflow: hidden;\n      ">\n      </div>\n    ');$('body').append(n),console.log('面板容器已添加到 body, 容器元素:',n[0]),console.log('准备创建新的 Vue 应用，面板容器:',n[0]);const t=B(hg).use(Y);try{t.mount(n[0]),console.log('Vue 应用已成功挂载'),console.log('Vue 实例:',n[0].__vue_app__)}catch(a){console.error('Vue 应用挂载失败:',a),console.error('错误详情:',JSON.stringify(a,null,2)),console.error('错误堆栈:',a.stack)}console.log('mzrodyu猫猫的小破烂浮动面板已创建，面板元素:',n[0]),setTimeout(()=>{yg(),console.log('📍 常驻最小化图标已创建')},500)},200)});export{vg as minimizeMemoryPanel,wg as toggleMemoryPanel};
//# sourceMappingURL=浮动面板.ffExLTB3.chunk.js.map
